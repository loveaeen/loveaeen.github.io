<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>ETCD</title>
    <link href="/2022/03/28/Container/ETCD/"/>
    <url>/2022/03/28/Container/ETCD/</url>
    
    <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>etcdæ˜¯CoreOSå›¢é˜Ÿäº2013å¹´6æœˆå‘èµ·çš„å¼€æºé¡¹ç›®ï¼Œå®ƒçš„ç›®æ ‡æ˜¯æ„å»ºä¸€ä¸ªé«˜å¯ç”¨çš„åˆ†å¸ƒå¼é”®å€¼(key-value)æ•°æ®åº“ã€‚etcdå†…éƒ¨é‡‡ç”¨Raftåè®®ä½œä¸ºä¸€è‡´æ€§ç®—æ³•ï¼ŒetcdåŸºäºGoè¯­è¨€å®ç°ã€‚</p><ul><li>ç®€å•ï¼šæä¾›å®šä¹‰æ˜ç¡®ä¸”é¢å‘ç”¨æˆ·çš„API</li><li>å®‰å…¨ï¼šæ”¯æŒSSLè¯ä¹¦éªŒè¯</li><li>æ€§èƒ½ï¼šåŸºå‡†å‹æµ‹æ”¯æŒ1w+&#x2F;secå†™å…¥</li><li>å¯é ï¼šé‡‡ç”¨Raftåè®®ä¿è¯åˆ†å¸ƒå¼ç³»ç»Ÿæ•°æ®çš„å¯ç”¨æ€§å’Œä¸€è‡´æ€§ã€‚</li></ul><h2 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h2><p>é…ç½®ä¸­å¿ƒï¼šetcdæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„é”®å€¼å­˜å‚¨ç³»ç»Ÿï¼Œå…¶ä¼˜ç§€çš„è¯»å†™æ€§èƒ½ã€ä¸€è‡´æ€§å’Œå¯ç”¨æ€§çš„æœºåˆ¶ï¼Œéå¸¸é€‚åˆç”¨æ¥åšé…ç½®ä¸­å¿ƒè§’è‰²ã€‚</p><p><strong>åˆ†å¸ƒå¼é”ï¼š</strong>etcdçš„å¼ºä¸€è‡´æ€§ä¿è¯ï¼Œå¯ä»¥ç”¨æ¥åšåˆ†å¸ƒå¼åœºæ™¯ä¸‹çš„åŒæ­¥æœºåˆ¶ä¿è¯ã€‚</p><p>Leaderé€‰ä¸¾ï¼šåˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼Œå¸¸é‡‡ç”¨leader-followeræ¨¡å¼æ¥ä¿è¯æœ‰çŠ¶æ€æœåŠ¡çš„é«˜å¯ç”¨ï¼ˆå³ä½¿leaderæŒ‚æ‰ï¼Œå…¶ä»–followerç«‹é©¬è¡¥ä¸Šï¼‰ï¼Œæ¯”å¦‚k8så’Œkafka partitioné«˜å¯ç”¨æœºåˆ¶ã€‚å¯ä»¥å¾ˆæ–¹ä¾¿çš„å€ŸåŠ©etcdæ¥å®ç°leaderé€‰ä¸¾æœºåˆ¶ã€‚</p><p>æœåŠ¡æ³¨å†Œå‘ç°ï¼šä¸ºäº†è§£å†³å¾®æœåŠ¡åœºæ™¯ä¸‹ï¼ŒæœåŠ¡åœ°å€çš„æ³¨å†Œå’Œå‘ç°é—®é¢˜ã€‚å’Œé…ç½®ä¸­å¿ƒåŠŸèƒ½ç±»ä¼¼ï¼Œä¸åŒä¹‹å¤„åœ¨äºæœåŠ¡æ³¨å†Œå’ŒæœåŠ¡å‘ç°ï¼Œè¿˜ä¼´éšç€çŠ¶æ€æ£€æµ‹ã€‚</p><p>æ¶ˆæ¯è®¢é˜…å’Œå‘å¸ƒï¼šetcdå†…ç½®watchæœºåˆ¶ï¼Œå®Œå…¨å¯ä»¥å®ç°ä¸€ä¸ªå°å‹çš„æ¶ˆæ¯è®¢é˜…å’Œå‘å¸ƒç»„ä»¶ã€‚</p><h2 id="äº§å“å¯¹æ¯”"><a href="#äº§å“å¯¹æ¯”" class="headerlink" title="äº§å“å¯¹æ¯”"></a>äº§å“å¯¹æ¯”</h2><p><strong>Redisï¼š</strong>etcdè¯ç”Ÿä¹‹æ—¥èµ·ï¼Œå°±å®šä½æˆä¸€ç§åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿï¼Œå¹¶åœ¨k8s æœåŠ¡æ³¨å†Œå’ŒæœåŠ¡å‘ç°ä¸­ï¼Œä¸ºå¤§å®¶æ‰€è®¤è¯†ã€‚å®ƒåé‡çš„æ˜¯èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡å’Œä¸€è‡´æ€§çš„æœºåˆ¶ä¿è¯ï¼Œå¹¶ä¸å¼ºè°ƒå•èŠ‚ç‚¹çš„è¯»å†™æ€§èƒ½ã€‚</p><p>è€Œredisæœ€æ—©ä½œä¸ºç¼“å­˜ç³»ç»Ÿå‡ºç°åœ¨å¤§ä¼—è§†é‡ï¼Œä¹Ÿæ³¨å®šäº†rediséœ€è¦æ›´åŠ ä¾§é‡äºè¯»å†™æ€§èƒ½å’Œæ”¯æŒæ›´å¤šçš„å­˜å‚¨æ¨¡å¼ï¼Œå®ƒä¸éœ€è¦careä¸€è‡´æ€§ï¼Œä¹Ÿä¸éœ€è¦ä¾§é‡äº‹åŠ¡ï¼Œå› æ­¤å¯ä»¥è¾¾åˆ°å¾ˆé«˜çš„è¯»å†™æ€§èƒ½ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œrediså¸¸ç”¨æ¥åšç¼“å­˜ç³»ç»Ÿï¼Œetcdå¸¸ç”¨æ¥åšåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸€äº›å…³é”®æ•°æ®çš„å­˜å‚¨æœåŠ¡ï¼Œæ¯”å¦‚æœåŠ¡æ³¨å†Œå’ŒæœåŠ¡å‘ç°ã€‚</p><p><strong>Zookeeperï¼š</strong>ã€ŒæœåŠ¡å‘ç°ã€<strong>æ˜¯å¼€å‘è€…è€ƒè™‘ etcd çš„ä¸»è¦åŸå› ï¼Œ</strong>ã€Œé«˜æ€§èƒ½ï¼Œæ˜“äºç”ŸæˆèŠ‚ç‚¹ç‰¹å®šé…ç½®ã€**è¢«è®¤ä¸ºæ˜¯é€‰æ‹© Zookeeper çš„å…³é”®å› ç´ ã€‚</p><p>è€Œä¸”Zookeeperçš„è™šæ‹ŸèŠ‚ç‚¹å¯ä»¥åœ¨å®¢æˆ·ç«¯æ–­å¼€åç«‹é©¬æ£€æµ‹åˆ°ï¼Œè€Œetcdè¦é keepAliveç»­çº¦æœºåˆ¶ï¼Œè¶…è¿‡å‡ ç§’ä¸ç»­çº¦äº†ï¼Œåˆ™è®¤ä¸ºæ‰çº¿äº†ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Container</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Kubernetes</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Istio</title>
    <link href="/2022/03/28/Container/Istio/"/>
    <url>/2022/03/28/Container/Istio/</url>
    
    <content type="html"><![CDATA[<h2 id="å‡ºç°èƒŒæ™¯"><a href="#å‡ºç°èƒŒæ™¯" class="headerlink" title="å‡ºç°èƒŒæ™¯"></a>å‡ºç°èƒŒæ™¯</h2><p>å½“ã€Œ<strong>å¾®æœåŠ¡æ¶æ„</strong>ã€çš„è¶‹åŠ¿å¼€å§‹åœ¨äº’è”ç½‘ä¸­è”“å»¶ï¼Œä¹‹æ‰€ä»¥å¾®æœåŠ¡æ¶æ„é‡Œï¼Œæˆ‘ä»¬é€‰æ‹©åœ¨åº”ç”¨å±‚é¢è€Œä¸æ˜¯åŸºç¡€è®¾æ–½å±‚é¢å»è§£å†³è¿™äº›åˆ†å¸ƒå¼é—®é¢˜ï¼Œå®Œå…¨æ˜¯å› ä¸ºç”±ç¡¬ä»¶æ„æˆçš„åŸºç¡€è®¾æ–½ï¼Œè·Ÿä¸ä¸Šç”±è½¯ä»¶æ„æˆçš„åº”ç”¨æœåŠ¡çš„çµæ´»æ€§çš„æ— å¥ˆä¹‹ä¸¾ã€‚ä¸ºæ­¤æˆ‘ä»¬è¿›å…¥äº†ã€Œ<strong>åå¾®æœåŠ¡æ¶æ„</strong>ã€çš„æ—¶ä»£ï¼ŒKuberneteså‡ºç°äº†ï¼å½“ Kubernetes ç»Ÿä¸€äº†å®¹å™¨ç¼–æ’ç®¡ç†ç³»ç»Ÿä¹‹åï¼Œè¿™äº›çº¯æŠ€æœ¯æ€§çš„åº•å±‚é—®é¢˜ï¼Œä¾¿å¼€å§‹æœ‰äº†è¢«å¹¿æ³›è®¤å¯å’Œé‡‡çº³çš„åŸºç¡€è®¾æ–½å±‚é¢çš„è§£å†³æ–¹æ¡ˆã€‚</p><p>Kubernetes çš„å®ç°ç‰ˆæœ¬ä¸­ç›´æ¥åˆ é™¤äº†é…ç½®ä¸­å¿ƒã€æœåŠ¡æ³¨å†Œä¸­å¿ƒçš„å·¥ç¨‹ï¼Œåœ¨å…¶ä»–å·¥ç¨‹çš„ pom.xml ä¸­ä¹Ÿåˆ é™¤äº†å¦‚ Eurekaã€Ribbonã€Config ç­‰ç»„ä»¶çš„ä¾èµ–ã€‚å–è€Œä»£ä¹‹çš„æ˜¯æ–°å¢äº†è‹¥å¹²ä»¥ YAML é…ç½®æ–‡ä»¶ä¸ºè½½ä½“çš„<strong>Skaffold</strong>å’Œ Kubernetes çš„èµ„æºæè¿°ï¼Œè¿™äº›èµ„æºæè¿°æ–‡ä»¶ï¼Œå°†ä¼šåŠ¨æ€æ„å»ºå‡º DNS æœåŠ¡å™¨ã€æœåŠ¡è´Ÿè½½å‡è¡¡å™¨ç­‰ä¸€ç³»åˆ—è™šæ‹ŸåŒ–çš„åŸºç¡€è®¾æ–½ï¼Œå»ä»£æ›¿åŸæœ‰çš„åº”ç”¨å±‚é¢çš„æŠ€æœ¯ç»„ä»¶ã€‚</p><p>å¯æ˜¯ï¼Œå•çº¯çš„ Kubernetes ä»ç„¶ä¸èƒ½è§£å†³æˆ‘ä»¬é¢ä¸´çš„æ‰€æœ‰åˆ†å¸ƒå¼æŠ€æœ¯é—®é¢˜ï¼Œå®ƒéš¾ä»¥åšåˆ°ç²¾ç»†åŒ–çš„æœåŠ¡æ²»ç†ï¼Œè­¬å¦‚ç†”æ–­ã€æµæ§ã€è§‚æµ‹ï¼Œç­‰ç­‰ã€‚è€Œå³ä½¿æ˜¯é‚£äº›å®ƒå¯ä»¥æä¾›æ”¯æŒçš„åˆ†å¸ƒå¼èƒ½åŠ›ï¼Œè­¬å¦‚é€šè¿‡ DNS ä¸æœåŠ¡æ¥å®ç°çš„æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡ï¼Œä¹Ÿåªèƒ½è¯´æ˜¯åˆæ­¥è§£å†³äº†çš„åˆ†å¸ƒå¼ä¸­å¦‚ä½•è°ƒç”¨æœåŠ¡çš„é—®é¢˜è€Œå·²ï¼Œåªé  DNS éš¾ä»¥æ»¡è¶³æ ¹æ®ä¸åŒçš„é…ç½®è§„åˆ™ã€åè®®å±‚æ¬¡ã€å‡è¡¡ç®—æ³•ç­‰å»è°ƒèŠ‚è´Ÿè½½å‡è¡¡çš„æ‰§è¡Œè¿‡ç¨‹è¿™ç±»é«˜çº§çš„é…ç½®éœ€æ±‚ã€‚</p><p>Kubernetes ç»™äºˆäº†æˆ‘ä»¬å¼ºå¤§çš„è™šæ‹ŸåŒ–åŸºç¡€è®¾æ–½ï¼Œè¿™æ˜¯ä¸€æŠŠå¥½ç”¨çš„é”¤å­ï¼Œä½†æˆ‘ä»¬å´ä¸å¿…æŠŠæ‰€æœ‰é—®é¢˜éƒ½çœ‹ä½œé’‰å­ï¼Œä¸å¿…åªå±€é™äºçº¯ç²¹åŸºç¡€è®¾æ–½çš„è§£å†³æ–¹æ¡ˆã€‚ç°åœ¨ï¼ŒåŸºäº Kubernetes ä¹‹ä¸Šæ„ç­‘çš„<strong>æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰</strong>æ˜¯ç›®å‰æœ€å…ˆè¿›çš„æ¶æ„é£æ ¼ï¼Œå³é€šè¿‡ä¸­é—´äººæµé‡åŠ«æŒçš„æ–¹å¼ï¼Œä»¥ä»‹ä¹äºåº”ç”¨å’ŒåŸºç¡€è®¾æ–½ä¹‹é—´çš„è¾¹è½¦ä»£ç†ï¼ˆSidecarï¼‰æ¥åšåˆ°æ—¢è®©ç”¨æˆ·ä»£ç å¯ä»¥ä¸“æ³¨ä¸šåŠ¡éœ€æ±‚ï¼Œä¸å¿…å…³æ³¨åˆ†å¸ƒå¼çš„æŠ€æœ¯ï¼Œåˆèƒ½å®ç°å‡ ä¹ä¸äºšäºæ­¤å‰ Spring Cloud æ—¶ä»£çš„é‚£ç§é€šè¿‡ä»£ç æ¥è§£å†³åˆ†å¸ƒå¼é—®é¢˜çš„å¯é…ç½®ã€å®‰å…¨å’Œå¯è§‚æµ‹æ€§ã€‚</p><p>è¿™ä¸€ä¸ªç›®æ ‡ï¼Œç°åœ¨å·²æˆä¸ºäº†æœ€çƒ­é—¨çš„æœåŠ¡ç½‘æ ¼æ¡†æ¶ <font color='blue'><strong>Istio</strong></font> çš„ Sloganï¼šConnect, Secure, Control, And Observe Servicesã€‚</p><h2 id="æµé‡ç®¡ç†"><a href="#æµé‡ç®¡ç†" class="headerlink" title="æµé‡ç®¡ç†"></a>æµé‡ç®¡ç†</h2><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Istioæµé‡ç®¡ç†APIå¯¹æœåŠ¡ç½‘æ ¼ä¸­çš„æµé‡è¿›è¡Œç²¾ç»†æ§åˆ¶ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™äº›APIå°†è‡ªå·±çš„æµé‡é…ç½®æ·»åŠ åˆ°Istioã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Kubernetesè‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼ˆCRDï¼‰å®šä¹‰APIèµ„æºã€‚å¸®åŠ©æˆ‘ä»¬æ§åˆ¶æµé‡è·¯ç”±çš„å…³é”®APIèµ„æºæ˜¯è™šæ‹ŸæœåŠ¡å’Œç›®æ ‡è§„åˆ™ã€‚</p><p>åŸºæœ¬ä¸Šï¼Œè™šæ‹ŸæœåŠ¡ä½¿æˆ‘ä»¬å¯ä»¥é…ç½®å¦‚ä½•å°†è¯·æ±‚è·¯ç”±åˆ°IstioæœåŠ¡ç½‘æ ¼ä¸­çš„æœåŠ¡ã€‚å› æ­¤ï¼Œè™šæ‹ŸæœåŠ¡ç”±ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‰é¡ºåºè¯„ä¼°çš„è·¯ç”±è§„åˆ™ç»„æˆã€‚è¯„ä¼°è™šæ‹ŸæœåŠ¡çš„è·¯ç”±è§„åˆ™åï¼Œå°†åº”ç”¨ç›®æ ‡è§„åˆ™ã€‚ç›®æ ‡è§„åˆ™æœ‰åŠ©äºæˆ‘ä»¬æ§åˆ¶åˆ°è¾¾ç›®æ ‡çš„æµé‡ï¼Œä¾‹å¦‚ï¼ŒæŒ‰ç‰ˆæœ¬å¯¹æœåŠ¡å®ä¾‹è¿›è¡Œåˆ†ç»„ã€‚</p><p><img src="/image/Istio/v2-e6ba4a015d8955c05015d5a41ca9b007_1440w.jpg" alt="img"></p><h2 id="å®‰å…¨æ€§"><a href="#å®‰å…¨æ€§" class="headerlink" title="å®‰å…¨æ€§"></a>å®‰å…¨æ€§</h2><p>Istioä¸ºæ¯ä¸ªæœåŠ¡æä¾›èº«ä»½ã€‚ä¸æ¯ä¸ªEnvoyä»£ç†ä¸€èµ·è¿è¡Œçš„Istioä»£ç†ä¸istiodä¸€èµ·ä½¿ç”¨ä»¥è‡ªåŠ¨è¿›è¡Œå¯†é’¥å’Œè¯ä¹¦è½®æ¢ã€‚</p><p>Istioæä¾›ä¸¤ç§èº«ä»½éªŒè¯ <strong>å¯¹ç­‰èº«ä»½éªŒè¯ã€è¯·æ±‚èº«ä»½éªŒè¯</strong>ã€‚å¯¹ç­‰èº«ä»½éªŒè¯ç”¨äºæœåŠ¡åˆ°æœåŠ¡çš„èº«ä»½éªŒè¯ï¼Œå…¶ä¸­Istioæä¾›åŒå‘TLSä½œä¸ºå…¨æ ˆè§£å†³æ–¹æ¡ˆã€‚è¯·æ±‚èº«ä»½éªŒè¯ç”¨äºæœ€ç»ˆç”¨æˆ·èº«ä»½éªŒè¯ï¼Œå…¶ä¸­Istioä½¿ç”¨è‡ªå®šä¹‰èº«ä»½éªŒè¯æä¾›ç¨‹åºæˆ–OpenID Connectï¼ˆOIDCï¼‰æä¾›ç¨‹åºæä¾›JSON Webä»¤ç‰Œï¼ˆJWTï¼‰éªŒè¯ã€‚</p><p>Istioè¿˜å…è®¸æˆ‘ä»¬é€šè¿‡ç®€å•åœ°å°†æˆæƒç­–ç•¥åº”ç”¨äºæœåŠ¡æ¥å®æ–½å¯¹æœåŠ¡çš„è®¿é—®æ§åˆ¶ã€‚æˆæƒç­–ç•¥å¯¹Envoyä»£ç†ä¸­çš„å…¥ç«™æµé‡å®æ–½è®¿é—®æ§åˆ¶ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å„ç§çº§åˆ«ä¸Šåº”ç”¨è®¿é—®æ§åˆ¶ï¼šç½‘æ ¼ï¼Œå‘½åç©ºé—´å’ŒæœåŠ¡èŒƒå›´ã€‚</p><h2 id="å¯è§‚å¯Ÿæ€§"><a href="#å¯è§‚å¯Ÿæ€§" class="headerlink" title="å¯è§‚å¯Ÿæ€§"></a>å¯è§‚å¯Ÿæ€§</h2><p>Istioä¸ºç½‘æ ¼ç½‘ç»œå†…çš„æ‰€æœ‰æœåŠ¡é€šä¿¡ç”Ÿæˆè¯¦ç»†çš„é¥æµ‹ï¼Œä¾‹å¦‚åº¦é‡ï¼Œåˆ†å¸ƒå¼è·Ÿè¸ªå’Œè®¿é—®æ—¥å¿—ã€‚ Istioç”Ÿæˆä¸€ç»„ä¸°å¯Œçš„ä»£ç†çº§æŒ‡æ ‡ï¼Œé¢å‘æœåŠ¡çš„æŒ‡æ ‡å’Œæ§åˆ¶å¹³é¢æŒ‡æ ‡ã€‚</p><p>ä¹‹å‰ï¼ŒIstioé¥æµ‹ä½“ç³»ç»“æ„å°†Mixerä½œä¸ºæ ¸å¿ƒç»„ä»¶ã€‚ä½†æ˜¯ä»<strong>Telemetry v2</strong>å¼€å§‹ï¼Œæ··éŸ³å™¨æä¾›çš„åŠŸèƒ½å·²æ›¿æ¢ä¸ºEnvoyä»£ç†æ’ä»¶ï¼š</p><p>æ­¤å¤–ï¼ŒIstioé€šè¿‡Envoyä»£ç†ç”Ÿæˆåˆ†å¸ƒå¼è·Ÿè¸ªã€‚ Istioæ”¯æŒè®¸å¤šè·Ÿè¸ªåç«¯ï¼Œä¾‹å¦‚Zipkinï¼ŒJaegerï¼ŒLightstepå’ŒDatadogã€‚æˆ‘ä»¬è¿˜å¯ä»¥æ§åˆ¶è·Ÿè¸ªé€Ÿç‡çš„é‡‡æ ·ç‡ã€‚æ­¤å¤–ï¼ŒIstioè¿˜ä»¥ä¸€ç»„å¯é…ç½®çš„æ ¼å¼ç”ŸæˆæœåŠ¡æµé‡çš„è®¿é—®æ—¥å¿—ã€‚</p><h2 id="ç¼ºé™·"><a href="#ç¼ºé™·" class="headerlink" title="ç¼ºé™·"></a>ç¼ºé™·</h2><ol><li>æœåŠ¡ç½‘æ ¼å¤„ç†æ‰€æœ‰æœåŠ¡åˆ°æœåŠ¡çš„é€šä¿¡ï¼Œè€Œéƒ¨ç½²å’Œæ“ä½œæœåŠ¡ç½‘æ ¼åˆ™éœ€è¦æ”¯ä»˜é¢å¤–çš„è´¹ç”¨ã€‚å¯¹äºè¾ƒç®€å•çš„åº”ç”¨ç¨‹åºï¼Œè¿™å¯èƒ½æ˜¯ä¸åˆç†çš„ã€‚</li><li>ç”±äºæˆ‘ä»¬å·²ç»ä¹ æƒ¯äºå¤„ç†ä¸€äº›æ­¤ç±»é—®é¢˜ï¼Œä¾‹å¦‚åº”ç”¨ç¨‹åºä»£ç ä¸­çš„ç†”æ–­ï¼Œå› æ­¤å¯èƒ½å¯¼è‡´æœåŠ¡ç½‘æ ¼ä¸­çš„é‡å¤å¤„ç†ã€‚</li><li>è¶Šæ¥è¶Šä¾èµ–äºè¯¸å¦‚æœåŠ¡ç½‘æ ¼ä¹‹ç±»çš„å¤–éƒ¨ç³»ç»Ÿå¯èƒ½ä¼šæŸå®³åº”ç”¨ç¨‹åºçš„å¯ç§»æ¤æ€§ï¼Œå°¤å…¶æ˜¯å› ä¸ºæ²¡æœ‰é’ˆå¯¹æœåŠ¡ç½‘æ ¼çš„è¡Œä¸šæ ‡å‡†ã€‚</li><li><strong>ç”±äºæœåŠ¡ç½‘æ ¼é€šå¸¸é€šè¿‡æ‹¦æˆªé€šè¿‡ä»£ç†çš„ç½‘æ ¼æµé‡æ¥å·¥ä½œï¼Œå› æ­¤å®ƒå¯èƒ½ä¼šç»™è¯·æ±‚å¢åŠ ä¸å¸Œæœ›çš„å»¶è¿Ÿã€‚</strong></li><li>æœåŠ¡ç½‘æ ¼å¢åŠ äº†è®¸å¤šå…¶ä»–ç»„ä»¶å’Œé…ç½®ï¼Œéœ€è¦ç²¾ç¡®å¤„ç†ã€‚è¿™éœ€è¦ä¸“ä¸šçŸ¥è¯†ï¼Œå¹¶å¢åŠ äº†å­¦ä¹ æ›²çº¿ã€‚</li></ol><h2 id="æ›¿ä»£å“"><a href="#æ›¿ä»£å“" class="headerlink" title="æ›¿ä»£å“"></a>æ›¿ä»£å“</h2><p>å°½ç®¡Istioéå¸¸å—æ¬¢è¿ï¼Œå¹¶å¾—åˆ°äº†ä¸šå†…ä¸€äº›é¢†å¯¼è€…çš„æ”¯æŒï¼Œä½†å®ƒå½“ç„¶ä¸æ˜¯å”¯ä¸€çš„é€‰æ‹©ã€‚å°½ç®¡æˆ‘ä»¬åœ¨è¿™é‡Œæ— æ³•è¿›è¡Œå…¨é¢çš„æ¯”è¾ƒï¼Œä½†è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹Linkerdå’ŒConsulè¿™ä¸¤ä¸ªé€‰é¡¹ã€‚</p><p><font color='blue'>Linkerd</font> æ˜¯å·²ä¸ºKuberneteså¹³å°åˆ›å»ºçš„å¼€æºæœåŠ¡ç½‘æ ¼ã€‚å®ƒä¹Ÿå¾ˆå—æ¬¢è¿ï¼Œç›®å‰åœ¨CNCFä¸­å…·æœ‰å­µåŒ–é¡¹ç›®çš„åœ°ä½ã€‚å®ƒçš„å·¥ä½œåŸç†ç±»ä¼¼äºIstioç­‰ä»»ä½•å…¶ä»–æœåŠ¡ç½‘æ ¼ã€‚å®ƒè¿˜åˆ©ç”¨TCPä»£ç†æ¥å¤„ç†ç½‘æ ¼æµé‡ã€‚ Linkerdä½¿ç”¨ç”¨Rustç¼–å†™çš„å¾®å‹ä»£ç†ï¼Œç§°ä¸ºLinkerdä»£ç†ã€‚</p><p><font color='blue'>Consul</font> æ˜¯HashiCorpçš„æœåŠ¡ç½‘æ ¼çš„å¼€æºå®ç°ã€‚å®ƒçš„å¥½å¤„æ˜¯å¯ä»¥ä¸HashiCorpçš„å…¶ä»–åŸºç¡€æ¶æ„ç®¡ç†äº§å“å¥—ä»¶å¾ˆå¥½åœ°é›†æˆï¼Œä»¥æä¾›æ›´å¹¿æ³›çš„åŠŸèƒ½ã€‚ Consulä¸­çš„æ•°æ®å¹³é¢å¯ä»¥çµæ´»åœ°æ”¯æŒä»£ç†ä»¥åŠæœ¬æœºé›†æˆæ¨¡å‹ã€‚å®ƒå¸¦æœ‰å†…ç½®ä»£ç†ï¼Œä½†ä¹Ÿå¯ä»¥ä¸Envoyä¸€èµ·ä½¿ç”¨ã€‚å°½ç®¡å®ƒæä¾›äº†æœåŠ¡ç½‘æ ¼ï¼ˆå¦‚Istioï¼‰çš„æ‰€æœ‰æ ‡å‡†åŠŸèƒ½ï¼Œä½†å®ƒæ˜¯<strong>éƒ¨ç½²å’Œç®¡ç†çš„æ›´å¤æ‚çš„ç³»ç»Ÿ</strong>ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Container</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Kubernetes</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Rancher</title>
    <link href="/2022/03/28/Container/Rancher/"/>
    <url>/2022/03/28/Container/Rancher/</url>
    
    <content type="html"><![CDATA[<h2 id="Why-Rancher"><a href="#Why-Rancher" class="headerlink" title="Why Rancher?"></a><a href="https://docs.rancher.cn/docs/rancher2.5/overview/_index">Why Rancher?</a></h2><p>Rancher å¯¹äºé‡‡ç”¨å®¹å™¨çš„å›¢é˜Ÿæ¥è¯´æ˜¯ä¸€ä¸ªå®Œæ•´çš„è½¯ä»¶æ ˆã€‚å®ƒè§£å†³äº†è·¨ä»»ä½•åŸºç¡€è®¾æ–½ç®¡ç†å¤šä¸ªKubernetesé›†ç¾¤çš„æ“ä½œå’Œå®‰å…¨æŒ‘æˆ˜ï¼ŒåŒæ—¶ä¸º DevOps å›¢é˜Ÿæä¾›è¿è¡Œé›†è£…ç®±å¼å·¥ä½œè´Ÿè½½çš„é›†æˆå·¥å…·ã€‚</p><h2 id="K8S-Environment"><a href="#K8S-Environment" class="headerlink" title="K8S Environment"></a>K8S Environment</h2><h3 id="Build-Virtual-Machines"><a href="#Build-Virtual-Machines" class="headerlink" title="Build Virtual Machines"></a>Build Virtual Machines</h3><p>åˆ›å»ºè™šæ‹Ÿæœºæ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒçš„å¤šå°ä¸»æœºã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><pre><code class="hljs Bash"><span class="hljs-comment"># docker run --network=host -p 8080:8080</span><br>docker run -itd --privileged --hostname=master --name centos7-master loveaeen/centos-docker:1.0 /usr/sbin/init<br><br>docker run -itd --privileged --hostname=minio1 --name centos7-minio1 loveaeen/centos-docker:1.0 /usr/sbin/init<br><br>docker run -itd --privileged --hostname=minio2 --name centos7-minio2 loveaeen/centos-docker:1.0 /usr/sbin/init<br><br>docker run -itd --privileged --hostname=minio3 --name centos7-minio3 loveaeen/centos-docker:1.0 /usr/sbin/init<br><br><span class="hljs-comment"># modify hostname</span><br><span class="hljs-comment"># hostnamectl set-hostname master</span><br></code></pre></td></tr></table></figure><h3 id="Network-File-System"><a href="#Network-File-System" class="headerlink" title="Network File System"></a>Network File System</h3><p>NFSï¼ˆNetwork File Systemï¼‰å³ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒå…è®¸ç½‘ç»œä¸­çš„è®¡ç®—æœºä¹‹é—´é€šè¿‡ç½‘ç»œå…±äº«èµ„æºã€‚<strong>å°†NFSä¸»æœºåˆ†äº«çš„ç›®å½•ï¼ŒæŒ‚è½½åˆ°æœ¬åœ°å®¢æˆ·ç«¯å½“ä¸­ï¼Œæœ¬åœ°NFSçš„å®¢æˆ·ç«¯åº”ç”¨å¯ä»¥é€æ˜åœ°è¯»å†™ä½äºè¿œç«¯NFSæœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ï¼Œåœ¨å®¢æˆ·ç«¯ç«¯çœ‹èµ·æ¥ï¼Œå°±åƒè®¿é—®æœ¬åœ°æ–‡ä»¶ä¸€æ ·ã€‚</strong></p><p>Rancheræœ‰æ–¹ä¾¿çš„PV(Persistent volume)é…ç½®ï¼Œå…è®¸å¼€å‘äººå‘˜å°†å®¹å™¨å†…æ–‡ä»¶è¿›è¡Œè¿œç¨‹æŒ‚è½½ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Bash">docker run -itd --privileged --hostname=nfs --name centos7-minio3 loveaeen/centos-docker:1.0 /usr/sbin/init<br></code></pre></td></tr></table></figure><h3 id="Run-Rancher"><a href="#Run-Rancher" class="headerlink" title="Run Rancher"></a>Run Rancher</h3><p>å¯åŠ¨Rancherï¼Œå¹¶æ–°å»ºé›†ç¾¤ï¼Œè¿è¡Œä»–çš„dockerå‘½ä»¤ï¼Œåˆ›å»ºå¥½ä¸»èŠ‚ç‚¹ä¸å·¥ä½œèŠ‚ç‚¹ï¼Œç®¡ç†kubernetesã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Bash">docker run -d --restart=unless-stopped -p 80:80 -p 443:443 -e CATTLE_SYSTEM_DEFAULT_REGISTRY=registry.cn-hangzhou.aliyuncs.com -e CATTLE_BOOTSTRAP_PASSWORD=admin --privileged rancher/rancher:v2.6.0<br></code></pre></td></tr></table></figure><h2 id="K3S-Environment"><a href="#K3S-Environment" class="headerlink" title="K3S Environment"></a>K3S Environment</h2><h3 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h3><p>ä½¿ç”¨<code>docker</code>æ–¹å¼åœ¨ä¸»èŠ‚ç‚¹ä¸Šå®‰è£…k3s serveræœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Bash">curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -s - --docker<br></code></pre></td></tr></table></figure><h3 id="Worker"><a href="#Worker" class="headerlink" title="Worker"></a>Worker</h3><p>ä½¿ç”¨<code>docker</code>æ–¹å¼åœ¨å·¥ä½œèŠ‚ç‚¹ä¸Šå®‰è£…k3s agentæœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Bash"><span class="hljs-comment"># k3s_token å¯ä»¥åœ¨masterèŠ‚ç‚¹çš„/var/lib/rancher/k3s/server/node-tokenæ‰¾åˆ°</span><br><br>curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn K3S_URL=https://110.42.229.50:6443 K3S_TOKEN=K105e759bc78f55939faf9fd8c6018f2df53390e2572ef18d80180b71af65455895::server:992cc950fe1898069d48ff826912bcc6 sh -<br></code></pre></td></tr></table></figure><h3 id="Rancher-UI"><a href="#Rancher-UI" class="headerlink" title="Rancher UI"></a>Rancher UI</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Bash">docker run -d --restart=unless-stopped -p 80:80 -p 443:443 -e CATTLE_SYSTEM_DEFAULT_REGISTRY=registry.cn-hangzhou.aliyuncs.com -e CATTLE_BOOTSTRAP_PASSWORD=admin --privileged rancher/rancher:v2.6.0<br></code></pre></td></tr></table></figure><h2 id="Spring-Cloud"><a href="#Spring-Cloud" class="headerlink" title="Spring Cloud"></a>Spring Cloud</h2><h3 id="Step"><a href="#Step" class="headerlink" title="Step"></a>Step</h3><ol><li>åœ¨è‡ªå·±çš„å¾®æœåŠ¡ä¸­æ·»åŠ <code>docker-compose.yml</code>ï¼Œåˆ›å»ºå¥½æ¯ä¸€ä¸ªå¾®æœåŠ¡çš„æ„å»ºå‘½ä»¤ã€‚</li><li>æ¯ä¸€ä¸ªå¾®æœåŠ¡æœ‰è‡ªå·±çš„<code>Dockerfile</code>ï¼Œä¸»è¦é€‰æ‹©å¥½&#x2F;target&#x2F;jaræ–‡ä»¶å¹¶é…ç½®ç›¸å…³å‚æ•°ï¼Œåœ¨<code>maven install</code>åå¯ä»¥ç›´æ¥æ‰§è¡Œcomposeå‘½ä»¤åšæ„å»ºã€‚</li><li><strong>æ³¨æ„ï¼šæ‰€æœ‰ipåç§°å†™å¯¹åº”çš„å®¹å™¨åå­—ï¼Œè®©dockerå¸®æˆ‘ä»¬ç®¡ç†å®¹å™¨çš„äº’ç›¸è®¿é—®ã€‚</strong></li><li>å°†æ‰€æœ‰é•œåƒæ„å»ºåï¼Œä¸Šä¼ è‡³ç§æœ‰æœåŠ¡å™¨Harborä¸­ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿çš„æ”¾åœ¨å†…ç½‘ä¸­éƒ¨ç½²ã€‚</li><li>Rancherä»Harborä¸­æ‹‰å–é•œåƒå¹¶åˆ›å»ºPodï¼Œåœ¨ä¸€äº›å¯¹å¤–è®¿é—®çš„Podä¸­å‡çº§ç«¯å£æ˜ å°„æˆ–æ·»åŠ Ingressç»„ä»¶ã€‚å¦‚Nacosã€Nginxã€‚</li></ol><p><strong>PLEASE SEE VIDEO</strong> : <a href="https://www.bilibili.com/video/BV1XJ411D7Qu?p=9&amp;spm_id_from=pageDriver">https://www.bilibili.com/video/BV1XJ411D7Qu?p=9&amp;spm_id_from=pageDriver</a></p>]]></content>
    
    
    <categories>
      
      <category>Container</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Kubernetes</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HELM</title>
    <link href="/2022/03/28/Container/HELM/"/>
    <url>/2022/03/28/Container/HELM/</url>
    
    <content type="html"><![CDATA[<h2 id="What-is-Helm"><a href="#What-is-Helm" class="headerlink" title="What is Helm?"></a><a href="https://helm.sh/">What is Helm?</a></h2><p>Helmæ˜¯æŸ¥æ‰¾ï¼Œå…±äº«å’Œä½¿ç”¨ä¸ºKubernetesæ„å»ºçš„è½¯ä»¶çš„æœ€ä½³æ–¹æ³•ã€‚</p><p>Helmå¸®åŠ©æ‚¨ç®¡ç†Kubernetesåº”ç”¨ç¨‹åºã€‚Helm Chartså¸®åŠ©æ‚¨å®šä¹‰ã€å®‰è£…å’Œå‡çº§å³ä½¿æ˜¯æœ€å¤æ‚çš„Kubernetesåº”ç”¨ç¨‹åºã€‚</p><p>Chartsæ˜“äºåˆ›å»ºï¼Œç‰ˆæœ¬ï¼Œå…±äº«å’Œå‘å¸ƒã€‚å› æ­¤ï¼Œè¯·å¼€å§‹ä½¿ç”¨Helmå¹¶åœæ­¢å¤åˆ¶å’Œç²˜è´´ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Container</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Kubernetes</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>K3Så…¥é—¨</title>
    <link href="/2022/03/28/Container/K3S%E5%85%A5%E9%97%A8/"/>
    <url>/2022/03/28/Container/K3S%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="What-is-k3sï¼Ÿ"><a href="#What-is-k3sï¼Ÿ" class="headerlink" title="What is k3sï¼Ÿ"></a><a href="https://docs.rancher.cn/docs/k3s/_index">What is k3sï¼Ÿ</a></h2><p>K3s æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ Kubernetes å‘è¡Œç‰ˆï¼Œå®ƒé’ˆå¯¹è¾¹ç¼˜è®¡ç®—ã€ç‰©è”ç½‘ç­‰åœºæ™¯è¿›è¡Œäº†é«˜åº¦ä¼˜åŒ–ã€‚</p><h2 id="Why-is-k3sï¼Ÿ"><a href="#Why-is-k3sï¼Ÿ" class="headerlink" title="Why is k3sï¼Ÿ"></a>Why is k3sï¼Ÿ</h2><p>ä½¿ç”¨å†…åµŒè½»é‡çº§æ•°æ®åº“ SQLite ä½œä¸ºé»˜è®¤æ•°æ®å­˜å‚¨æ›¿ä»£ etcdï¼Œå½“ç„¶ etcd ä»ç„¶æ˜¯æ”¯æŒçš„ã€‚</p><p>å†…ç½®äº† local storage providerã€service load balancerã€helm controllerã€Traefik ingress controllerï¼Œå¼€ç®±å³ç”¨ã€‚</p><p>æ‰€æœ‰ Kubernetes æ§åˆ¶å¹³é¢ç»„ä»¶å¦‚ api-serverã€scheduler ç­‰å°è£…æˆä¸ºä¸€ä¸ªç²¾ç®€äºŒè¿›åˆ¶ç¨‹åºï¼Œæ§åˆ¶å¹³é¢åªéœ€è¦ä¸€ä¸ªè¿›ç¨‹å³å¯è¿è¡Œã€‚</p><p>åˆ é™¤å†…ç½®æ’ä»¶(æ¯”å¦‚ cloudprovider æ’ä»¶å’Œå­˜å‚¨æ’ä»¶)ã€‚</p><p>å‡å°‘å¤–éƒ¨ä¾èµ–ï¼Œæ“ä½œç³»ç»Ÿåªéœ€è¦å®‰è£…è¾ƒæ–°çš„å†…æ ¸ä»¥åŠæ”¯æŒ cgroup å³å¯ï¼Œk3s å®‰è£…åŒ…å·²ç»åŒ…å«äº† containerdã€Flannelã€CoreDNSï¼Œéå¸¸æ–¹ä¾¿åœ°ä¸€é”®å¼å®‰è£…ï¼Œä¸éœ€è¦é¢å¤–å®‰è£… Dockerã€Flannel ç­‰ç»„ä»¶ã€‚</p><h2 id="Manual-run-k3s"><a href="#Manual-run-k3s" class="headerlink" title="Manual run k3s"></a>Manual run k3s</h2><h3 id="K3S-Environment"><a href="#K3S-Environment" class="headerlink" title="K3S Environment"></a>K3S Environment</h3><h2 id="AutoK3s"><a href="#AutoK3s" class="headerlink" title="AutoK3s"></a><a href="https://docs.rancher.cn/docs/k3s/autok3s/_index">AutoK3s</a></h2><p>AutoK3s æ˜¯ç”¨äºç®€åŒ– K3s é›†ç¾¤ç®¡ç†çš„è½»é‡çº§å·¥å…·ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ AutoK3s åœ¨ä»»ä½•åœ°æ–¹è¿è¡Œ K3s æœåŠ¡ã€‚</p><h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><figure class="highlight bash"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs Bash">docker run -itd --restart=unless-stopped -p 8080:8080 cnrancher/autok3s:v0.4.5<br></code></pre></td></tr></table></figure><h3 id="CLI"><a href="#CLI" class="headerlink" title="CLI"></a>CLI</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Bash">curl -sS http://rancher-mirror.cnrancher.com/autok3s/install.sh  | INSTALL_AUTOK3S_MIRROR=cn sh<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Container</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Kubernetes</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kuberneteså…¥é—¨</title>
    <link href="/2022/03/28/Container/Kubernetes%E5%85%A5%E9%97%A8/"/>
    <url>/2022/03/28/Container/Kubernetes%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="1-MASTER-NODE"><a href="#1-MASTER-NODE" class="headerlink" title="1. MASTER NODE"></a>1. MASTER NODE</h2><ul><li><a href="https://kubernetes.io/zh/docs/concepts/architecture/control-plane-node-communication/">API SERVER</a> : ä½ å¯ä»¥ç†è§£ä¸ºç½‘å…³. å½“ä¸€ä¸ªè¯·æ±‚ (å‘½ä»¤) è¿›å…¥å, é¦–å…ˆå°±ä¼šè¯·æ±‚åˆ° API SERVER , è¯¥ç»„ä»¶ä¹Ÿå¯ä»¥è¿›è¡Œé‰´æƒåŠŸèƒ½</li><li><a href="https://kubernetes.io/zh/docs/concepts/scheduling-eviction/kube-scheduler/">Scheduler</a> : å†³å®šäº†ä½ åº”è¯¥åœ¨å“ªå° Node ä¸Šè¿›è¡Œ Pod ç›¸å…³æ“ä½œ, è¯¥ç»„ä»¶åªæ˜¯å»å¯¹åº”çš„ Node ä¸­è°ƒåº¦ Kubelet ç»„ä»¶, æ¯”å¦‚ä½ éœ€è¦æ–°å¢å‡ ä¸ª Pod , è¯¥ç»„ä»¶å°±ä¼šæ ¹æ® Node ç›®å‰èµ„æºä½¿ç”¨é‡, æ‰¾åˆ°æœ€ä¸ç¹å¿™çš„ä¸€ä¸ª Node ,è¿›è¡Œè°ƒåº¦æ“ä½œ.</li><li><a href="https://kubernetes.io/zh/docs/concepts/architecture/cloud-controller/">Controller Manager</a> : ç®¡ç†é›†ç¾¤å¥åº·çŠ¶å†µ, æ¯”å¦‚æŸä¸ª Pod å®•æœº&#x2F;æ­»å», é‚£ä¹ˆè¯¥ç»„ä»¶æ£€æµ‹åˆ°ä»¥å, é€šçŸ¥ Scheduler é€‰å–ä¸€ä¸ªé€‚åˆçš„ Node , ç„¶åè°ƒåº¦å¯¹åº”çš„ Kubelet ç»„ä»¶è¿›è¡Œèµ„æºé‡å¯</li><li><a href="https://etcd.io/">etcd</a> : é”®å€¼å­˜å‚¨é›†ç¾¤çŠ¶æ€çš„ç»„ä»¶, æƒ³è±¡å®ƒæ˜¯é›†ç¾¤çš„å¤§è„‘ğŸ§  å¦‚æœä¸€ä¸ª Pod æ–°ç”Ÿæˆ–è€…æ­»äº¡, éƒ½ä¼šå°†ä¿¡æ¯å­˜å‚¨åœ¨è¯¥ç»„ä»¶ä¸­. å¾ˆå¤šç»„ä»¶éƒ½ä¼šé€šè¿‡å®ƒæ¥è·å–ä¸€äº›å¿…è¦çš„ä¿¡æ¯</li></ul><h2 id="2-SLAVE-NODE"><a href="#2-SLAVE-NODE" class="headerlink" title="2. SLAVE NODE"></a><strong>2. SLAVE NODE</strong></h2><ul><li><p><a href="https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/">Container Runtime</a> : è´Ÿè´£è¿è¡Œå®¹å™¨çš„è½¯ä»¶, ä¸€èˆ¬æ¥è¯´, å¤§å®¶éƒ½ä¼šä½¿ç”¨ [[Docker]]</p></li><li><p><a href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kubelet/">Kubelet</a> : å®é™…ç®¡ç†ä¸€ä¸ª Pod æˆ–è€…é‡å¯å®ƒ</p></li><li><p><a href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress/">Ingress</a> : å…¬å¼€äº†ä»é›†ç¾¤å¤–éƒ¨åˆ°é›†ç¾¤å†…<a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/">æœåŠ¡</a>çš„ HTTP å’Œ HTTPS è·¯ç”±. æµé‡è·¯ç”±ç”± Ingress èµ„æºä¸Šå®šä¹‰çš„è§„åˆ™æ§åˆ¶, ä¹‹åå†å‘é€è‡³ Service</p></li><li><p><a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/">Service</a> : æä¾› Pod çš„æœåŠ¡å‘ç°, å…¬å¼€ç½‘ç»œæœåŠ¡</p></li><li><p><a href="https://kubernetes.io/zh/docs/concepts/configuration/secret/">Secret</a> : ä¸“é—¨ç”¨äºé‰´æƒé…ç½®çš„ç»„ä»¶, æ¯”å¦‚é…ç½® Mongodb çš„è´¦æˆ·å’Œå¯†ç , å¹¶åœ¨ Mongo é‚£è¾¹å¼•ç”¨ Secret</p></li><li><p><a href="https://kubernetes.io/zh/docs/concepts/configuration/configmap/">ConfigMap</a> : ç”¨äºæ”¾ç½®ä¸€äº›å…¬å…±é…ç½®çš„ç»„ä»¶</p></li><li><p><a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/statefulset/">StatefulSet</a>ï¼šStatefulSet æ˜¯ç”¨æ¥ç®¡ç†æœ‰çŠ¶æ€çš„åº”ç”¨ï¼Œä¾‹å¦‚æ•°æ®åº“ã€‚å‰é¢æˆ‘ä»¬éƒ¨ç½²çš„åº”ç”¨ï¼Œéƒ½æ˜¯ä¸éœ€è¦å­˜å‚¨æ•°æ®ï¼Œä¸éœ€è¦è®°ä½çŠ¶æ€çš„ï¼Œå¯ä»¥éšæ„æ‰©å……å‰¯æœ¬ï¼Œæ¯ä¸ªå‰¯æœ¬éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå¯æ›¿ä»£çš„ã€‚è€Œåƒæ•°æ®åº“ã€Redis è¿™ç±»æœ‰çŠ¶æ€çš„ï¼Œåˆ™ä¸èƒ½éšæ„æ‰©å……å‰¯æœ¬ã€‚StatefulSet ä¼šå›ºå®šæ¯ä¸ª Pod çš„åå­—</p></li><li><p>Deployment</p><p> : Pod çš„å£°æ˜å¼æŠ½è±¡å±‚, è´Ÿè´£ç®¡ç† Pod, ç°åœ¨å·²ç»ä¸ä¼šç›´æ¥åˆ›å»º Pod , è€Œæ˜¯ä½¿ç”¨ Deployment ä»£æ›¿.</p><ul><li><a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/">Pod</a> : Kubernetes ä¸­åˆ›å»ºå’Œç®¡ç†çš„æœ€å°å•å…ƒ</li><li><a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/replicaset/">ReplicaSet</a> : å½“ä½ åˆ›å»ºäº†ä¸€ä¸ª Deployment å, å°±ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªè¯¥ç»„ä»¶å‡ºæ¥, åä¹‹åˆ é™¤ä¹Ÿä¼šä¸€æ ·. ä¸»è¦ç”¨äºç»´æŠ¤ Pod çš„æ•°é‡</li></ul></li></ul><h2 id="3-KUBECTL"><a href="#3-KUBECTL" class="headerlink" title="3. KUBECTL"></a><strong>3. KUBECTL</strong></h2><ul><li>Kubectl å‘½ä»¤è¡Œå·¥å…·ç®¡ç† Kubernetes é›†ç¾¤, æ‰€æœ‰çš„å‘½ä»¤å®é™…éƒ½æ˜¯è°ƒç”¨ REST API , éƒ½ä¼šèµ° API SERVER.</li></ul><h2 id="4-NAMESPACE"><a href="#4-NAMESPACE" class="headerlink" title="4. NAMESPACE"></a><strong>4. NAMESPACE</strong></h2><ul><li>å‘½åç©ºé—´å¯ä»¥éš”ç¦»èµ„æº, å¹¶ä¸” Kubernetes å¯ä»¥é™åˆ¶æ¯ä¸€ä¸ªå‘½åç©ºé—´çš„æœ€å¤§ä½¿ç”¨èµ„æºæƒ…å†µ</li><li>å¯ä»¥ä½¿ç”¨ <code>brew install kubectx</code> å®‰è£…æ’ä»¶, åˆ‡æ¢é»˜è®¤çš„å‘½åç©ºé—´</li></ul><h2 id="5-TOOLS"><a href="#5-TOOLS" class="headerlink" title="5. TOOLS"></a><strong>5. TOOLS</strong></h2><ul><li><p>5.1</p><p>minikube</p><ul><li>Minikube å°† Master ä¸ Slave æ”¾ç½®åœ¨ä¸€ä¸ªè™šæ‹Ÿ Node ä¸­è¿è¡Œ, å¹¶é™„åŠ åŸºæœ¬çš„ Container Runtime(Docker)</li></ul></li><li><p>5.2</p><p>Helm</p><ul><li>Helm æ˜¯æŸ¥æ‰¾ã€åˆ†äº«å’Œä½¿ç”¨è½¯ä»¶æ„å»º <a href="https://kubernetes.io/">Kubernetes</a> çš„æœ€ä¼˜æ–¹å¼</li></ul></li></ul><h2 id="6-Sping-Cloud-amp-Kubernates"><a href="#6-Sping-Cloud-amp-Kubernates" class="headerlink" title="6. Sping Cloud &amp; Kubernates"></a>6. Sping Cloud &amp; Kubernates</h2>]]></content>
    
    
    <categories>
      
      <category>Container</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Kubernetes</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Harbor</title>
    <link href="/2022/03/28/Container/Harbor/"/>
    <url>/2022/03/28/Container/Harbor/</url>
    
    <content type="html"><![CDATA[<h2 id="What-is-Harbor"><a href="#What-is-Harbor" class="headerlink" title="What is Harbor?"></a>What is Harbor?</h2><blockquote><p>Harbor is an open source registry that secures artifacts with policies and role-based access control, ensures(ç¡®ä¿) images are scanned and free from vulnerabilities(è„†å¼±æ€§), and signs images as trusted. Harbor, a CNCF Graduated project, delivers compliance, performance, and interoperability to help you consistently and securely manage artifacts across cloud native compute platforms like Kubernetes and Docker.</p></blockquote><p>Harboræ˜¯ä¸€ä¸ªå¼€æºçš„æ³¨å†Œä¸­å¿ƒï¼Œå®ƒé€šè¿‡æ”¿ç­–å’Œä»¥è§’è‰²ä¸ºåŸºç¡€çš„å­˜å–æ§åˆ¶ä¿æŠ¤å·¥ä»¶ï¼Œç¡®ä¿å›¾åƒè¢«æ‰«æå¹¶ä¸”æ²¡æœ‰æ¼æ´ï¼Œå¹¶ä¸”æ ‡è®°é•œåƒä¸ºå¯ä¿¡çš„ã€‚Harbor æ˜¯ CNCF çš„ä¸€ä¸ªæ¯•ä¸šé¡¹ç›®ï¼Œå®ƒæä¾›äº†éµä»æ€§ã€æ€§èƒ½å’Œäº’æ“ä½œæ€§ï¼Œä»¥å¸®åŠ©æ‚¨åœ¨åƒ Kubernetes å’Œ Docker è¿™æ ·çš„äº‘æœ¬åœ°è®¡ç®—å¹³å°ä¸Šç¨³å®šå’Œå®‰å…¨åœ°ç®¡ç†å·¥ä»¶ã€‚</p><p>ä¸»è¦ç”¨äºä¸ºä¼ä¸šç®¡ç†ç§æœ‰é•œåƒï¼Œç”±Dockeréƒ¨ç½²å¹¶è¿è¡Œã€‚</p><h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a><a href="https://github.com/goharbor/harbor/releases">Installation</a></h2><ul><li><p><font color='gray'><strong>Online installer</strong>: The online installer downloads the Harbor images from Docker hub. For this reason, the installer is very small in size.</font></p><p>åœ¨çº¿ä¸‹è½½ï¼šåœ¨çº¿å®‰è£…ç¨‹åºä» Docker hub ä¸‹è½½ Harbor é•œåƒã€‚å› æ­¤ï¼Œå®‰è£…ç¨‹åºçš„ä½“ç§¯éå¸¸å°ã€‚</p></li><li><p><font color='gray'><strong>Offline installer</strong>: Use the offline installer if the host to which are are deploying Harbor does not have a connection to the Internet. The offline installer contains pre-built images, so it is larger than the online installer.</font></p><p>ç¦»çº¿ä¸‹è½½ï¼šå¦‚æœæ­£åœ¨éƒ¨ç½² Harbor çš„ä¸»æœºæ²¡æœ‰è¿æ¥åˆ° Internetï¼Œè¯·ä½¿ç”¨ç¦»çº¿ä¸‹è½½ã€‚ç¦»çº¿ä¸‹è½½åŒ…å«é¢„å…ˆæ„å»ºçš„é•œåƒï¼Œå› æ­¤å®ƒæ¯”è”æœºå®‰è£…ç¨‹åºå¤§ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><pre><code class="hljs Bash"><span class="hljs-comment"># github install offline installer.tgz</span><br><span class="hljs-comment"># then scp remote linux</span><br>scp harbor-offline-installer-v2.4.1.tgz root@110.42.229.50:/root/harbor-offline-installer-v2.4.1.tgz<br><br><span class="hljs-comment"># tar</span><br>tar -zxvf harbor-offline-installer-v2.4.1.tgz<br><br><span class="hljs-comment"># config yml &amp; modify **hostname to ip**</span><br><span class="hljs-built_in">cd</span> /harbor<br>vim harbor.yml<br>./install.sh<br><br><span class="hljs-comment"># http request</span><br>[http://110.42.229.50/harbor](http://110.42.229.50/harbor)<br></code></pre></td></tr></table></figure><h2 id="Docker-Integrate-é›†æˆ"><a href="#Docker-Integrate-é›†æˆ" class="headerlink" title="Docker Integrate(é›†æˆ)"></a>Docker Integrate(é›†æˆ)</h2><p>å¥½åƒä¹Ÿä¸ç”¨ã€‚ä¸ºäº†è®©harboræ„ŸçŸ¥åˆ°dockerï¼Œæ‰€ä»¥éœ€è¦è®©dockeré‡å¯ï¼Œå†ç”¨composeå¯åŠ¨harborã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Bash"><span class="hljs-comment"># restart docker</span><br><span class="hljs-comment"># systemctl restart docker</span><br><br><span class="hljs-comment"># cd /harbor</span><br><span class="hljs-comment"># docker-compose start</span><br><br><span class="hljs-comment"># docker login &amp; push image</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Container</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Docker</tag>
      
      <tag>kubernetes</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Docker Swarm</title>
    <link href="/2022/03/28/Container/Docker%20Swarm/"/>
    <url>/2022/03/28/Container/Docker%20Swarm/</url>
    
    <content type="html"><![CDATA[<h2 id="What-is-a-swarm"><a href="#What-is-a-swarm" class="headerlink" title="What is a swarm?"></a><a href="https://docs.docker.com/engine/swarm/key-concepts/#what-is-a-swarm">What is a swarm?</a></h2><p><font color='gray'>The cluster management and orchestration features embedded in the Docker Engine are built using swarmkit. Swarmkit is a separate project which implements Dockerâ€™s orchestration layer and is used directly within Docker.</font></p><p>Docker å¼•æ“ä¸­åµŒå…¥çš„é›†ç¾¤ç®¡ç†å’Œç¼–æ’ç‰¹æ€§æ˜¯ä½¿ç”¨ç¾¤é›†æ„å»ºçš„ã€‚Swarmkit æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„é¡¹ç›®ï¼Œå®ƒå®ç°äº† Docker çš„ç¼–æ’å±‚ï¼Œå¹¶ç›´æ¥åœ¨ Docker ä¸­ä½¿ç”¨ã€‚</p><p><font color='gray'>A swarm consists of multiple Docker hosts which run in swarm mode and act as managers (to manage membership and delegation) and workers (which run swarm services). A given Docker host can be a manager, a worker, or perform both roles. When you create a service, you define its optimal state (number of replicas, network and storage resources available to it, ports the service exposes to the outside world, and more). Docker works to maintain that desired state. For instance, if a worker node becomes unavailable, Docker schedules that nodeâ€™s tasks on other nodes. A task is a running container which is part of a swarm service and managed by a swarm manager, as opposed to a standalone container.</font></p><p>ä¸€ä¸ªç¾¤ä½“ç”±å¤šä¸ª Docker ä¸»æœºç»„æˆï¼Œå®ƒä»¬ä»¥ç¾¤ä½“æ¨¡å¼è¿è¡Œï¼Œå……å½“ç®¡ç†è€…(ç®¡ç†æˆå‘˜èµ„æ ¼å’Œæˆæƒ)å’Œå·¥ä½œè€…(è¿è¡Œç¾¤ä½“æœåŠ¡)ã€‚ç»™å®šçš„ Docker ä¸»æœºå¯ä»¥æ˜¯ç®¡ç†è€…ã€å·¥ä½œè€…ï¼Œæˆ–è€…åŒæ—¶æ‰§è¡Œè¿™ä¸¤ä¸ªè§’è‰²ã€‚å½“æ‚¨åˆ›å»ºä¸€ä¸ªæœåŠ¡æ—¶ï¼Œæ‚¨å°†å®šä¹‰å®ƒçš„æœ€ä½³çŠ¶æ€(å‰¯æœ¬çš„æ•°é‡ã€å¯ç”¨çš„ç½‘ç»œå’Œå­˜å‚¨èµ„æºã€æœåŠ¡å‘å¤–éƒ¨ä¸–ç•Œå…¬å¼€çš„ç«¯å£ç­‰)ã€‚å¤šå…‹å°”å·¥ä½œæ˜¯ä¸ºäº†ä¿æŒæ‰€éœ€çš„çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹å˜å¾—ä¸å¯ç”¨ï¼ŒDocker å°†è¯¥èŠ‚ç‚¹çš„ä»»åŠ¡è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šã€‚ä»»åŠ¡æ˜¯ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼Œå®ƒæ˜¯ç¾¤æœåŠ¡çš„ä¸€éƒ¨åˆ†ï¼Œç”±ç¾¤ç®¡ç†å™¨ç®¡ç†ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å®¹å™¨ã€‚</p><p><font color='gray'>One of the key advantages of swarm services over standalone containers is that you can modify a serviceâ€™s configuration, including the networks and volumes it is connected to, without the need to manually restart the service. Docker will update the configuration, stop the service tasks with the out of date configuration, and create new ones matching the desired configuration.</font></p><p>ä¸ç‹¬ç«‹å®¹å™¨ç›¸æ¯”ï¼Œç¾¤æœåŠ¡çš„ä¸€ä¸ªå…³é”®ä¼˜åŠ¿æ˜¯ï¼Œæ‚¨å¯ä»¥ä¿®æ”¹æœåŠ¡çš„é…ç½®ï¼ŒåŒ…æ‹¬å®ƒæ‰€è¿æ¥çš„ç½‘ç»œå’Œå·ï¼Œè€Œæ— éœ€æ‰‹åŠ¨é‡æ–°å¯åŠ¨æœåŠ¡ã€‚Docker å°†æ›´æ–°é…ç½®ï¼Œä½¿ç”¨è¿‡æœŸé…ç½®åœæ­¢æœåŠ¡ä»»åŠ¡ï¼Œå¹¶åˆ›å»ºä¸æ‰€éœ€é…ç½®åŒ¹é…çš„æ–°ä»»åŠ¡ã€‚</p><p><font color='gray'>When Docker is running in swarm mode, you can still run standalone containers on any of the Docker hosts participating in the swarm, as well as swarm services. A key difference between standalone containers and swarm services is that only swarm managers can manage a swarm, while standalone containers can be started on any daemon. Docker daemons can participate in a swarm as managers, workers, or both.</font></p><p>å½“ Docker åœ¨ç¾¤æ¨¡å¼ä¸‹è¿è¡Œæ—¶ï¼Œä½ ä»ç„¶å¯ä»¥åœ¨ä»»ä½•å‚ä¸ç¾¤çš„ Docker ä¸»æœºä¸Šè¿è¡Œç‹¬ç«‹çš„å®¹å™¨ï¼Œä»¥åŠç¾¤æœåŠ¡ã€‚ç‹¬ç«‹å®¹å™¨å’Œç¾¤æœåŠ¡çš„ä¸€ä¸ªå…³é”®åŒºåˆ«æ˜¯ï¼Œåªæœ‰ç¾¤ç®¡ç†å™¨å¯ä»¥ç®¡ç†ç¾¤ï¼Œè€Œç‹¬ç«‹å®¹å™¨å¯ä»¥åœ¨ä»»ä½•å®ˆæŠ¤è¿›ç¨‹ä¸Šå¯åŠ¨ã€‚å¤šå…‹å°”å®ˆæŠ¤è¿›ç¨‹å¯ä»¥ä½œä¸ºç®¡ç†è€…ã€å·¥ä½œè€…æˆ–ä¸¤è€…éƒ½å‚ä¸åˆ°ç¾¤ä¸­ã€‚</p><p><font color='gray'>In the same way that you can use Docker Compose to define and run containers, you can define and run Swarm service stacks.</font></p><p>ä¸ä½¿ç”¨ dockercompose å®šä¹‰å’Œè¿è¡Œå®¹å™¨ä¸€æ ·ï¼Œæ‚¨å¯ä»¥å®šä¹‰å’Œè¿è¡Œ Swarm æœåŠ¡å †æ ˆã€‚</p><p><font color='gray'>Keep reading for details about concepts relating to Docker swarm services, including nodes, services, tasks, and load balancing.</font></p><p>ç»§ç»­é˜…è¯»å…³äº Docker ç¾¤æœåŠ¡ç›¸å…³æ¦‚å¿µçš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬èŠ‚ç‚¹ã€æœåŠ¡ã€ä»»åŠ¡å’Œè´Ÿè½½å¹³è¡¡ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Container</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Docker Compose</title>
    <link href="/2022/03/28/Container/Docker%20Compose/"/>
    <url>/2022/03/28/Container/Docker%20Compose/</url>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>Dockerfile</code>æ–‡ä»¶è®©ç”¨æˆ·å¾ˆæ–¹ä¾¿çš„å®šä¹‰ä¸€ä¸ªå•ç‹¬çš„åº”ç”¨å®¹å™¨ã€‚ç„¶è€Œï¼Œåœ¨æ—¥å¸¸å·¥ä½œä¸­ï¼Œç»å¸¸ä¼šç¢°åˆ°éœ€è¦å¤šä¸ªå®¹å™¨ç›¸äº’é…åˆæ¥å®ŒæˆæŸé¡¹ä»»åŠ¡çš„æƒ…å†µï¼Œæˆ–è€…å¼€å‘ä¸€ä¸ªWebåº”ç”¨ï¼Œé™¤äº†WebæœåŠ¡å®¹å™¨æœ¬èº«ï¼Œè¿˜éœ€è¦æ•°æ®åº“æœåŠ¡å®¹å™¨ã€ç¼“å­˜å®¹å™¨ï¼Œç”šè‡³è¿˜åŒ…æ‹¬è´Ÿè½½å‡è¡¡å®¹å™¨ç­‰ç­‰ã€‚</p><p><code>Docker Compose</code>æ˜¯ç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨Dockeråº”ç”¨ç¨‹åºçš„å·¥å…·ã€‚é€šè¿‡Composeï¼Œæ‚¨å¯ä»¥ä½¿ç”¨YAMLæ–‡ä»¶æ¥é…ç½®åº”ç”¨ç¨‹åºæ‰€éœ€è¦çš„æœåŠ¡ã€‚ç„¶åä½¿ç”¨ä¸€ä¸ªå‘½ä»¤ï¼Œå°±å¯ä»¥é€šè¿‡YAMLé…ç½®æ–‡ä»¶åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡ã€‚</p><h3 id="Samples"><a href="#Samples" class="headerlink" title="Samples"></a>Samples</h3><h4 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h4><ul><li>å¦‚æœä¿®æ”¹äº†jaræ–‡ä»¶å, å¦‚æœç›´æ¥ç”¨docker-compose -f -d ç›´æ¥é‡å¯å®¹å™¨çš„è¯, jaræ–‡ä»¶å¹¶ä¸ä¼šæ”¹å˜, æˆ‘ä»¬éœ€è¦ä½¿ç”¨-buildå‘½ä»¤è¿›è¡Œé‡æ–°æ„å»ºæ‰å¯ä»¥</li><li>springçš„yamlé…ç½®ä¸­, ä¸è¦å†è®¾ç½®å›ºå®šipäº†, å› ä¸ºdocker-composeç®¡ç†ä¸­æ˜¯é»˜è®¤ç»™å®¹å™¨è®¾ç½®åŠ¨æ€ipçš„, å¦‚æœæƒ³ç”¨æœåŠ¡è¿æ¥nacosçš„è¯, æˆ‘ä»¬éœ€è¦åœ¨éœ€è¦çš„æœåŠ¡å®¹å™¨ä¸­æ·»åŠ nacosçš„link, ç„¶ååœ¨springçš„yamlé…ç½®ä¸­ipä¿®æ”¹ä¸ºlinkåç§°å³å¯</li></ul><h4 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h4><figure class="highlight yaml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></div></td><td class="code"><pre><code class="hljs YAML"><span class="hljs-attr">version :</span> <span class="hljs-string">&#x27;3.8&#x27;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">ruoyi-nacos:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">ruoyi-nacos</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nacos/nacos-server</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">./nacos</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">MODE=standalone</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./nacos/logs/:/home/nacos/logs</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./nacos/conf/application.properties:/home/nacos/conf/application.properties</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8848:8848&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9848:9848&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9849:9849&quot;</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ruoyi-mysql</span><br>  <span class="hljs-attr">ruoyi-mysql:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">ruoyi-mysql</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:5.7</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">./mysql</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;3306:3306&quot;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./mysql/conf:/etc/mysql/conf.d</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./mysql/logs:/logs</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./mysql/data:/var/lib/mysql</span><br>    <span class="hljs-attr">command:</span> [<br>          <span class="hljs-string">&#x27;mysqld&#x27;</span>,<br>          <span class="hljs-string">&#x27;--innodb-buffer-pool-size=80M&#x27;</span>,<br>          <span class="hljs-string">&#x27;--character-set-server=utf8mb4&#x27;</span>,<br>          <span class="hljs-string">&#x27;--collation-server=utf8mb4_unicode_ci&#x27;</span>,<br>          <span class="hljs-string">&#x27;--default-time-zone=+8:00&#x27;</span>,<br>          <span class="hljs-string">&#x27;--lower-case-table-names=1&#x27;</span><br>        ]<br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">MYSQL_DATABASE:</span> <span class="hljs-string">&#x27;ry-cloud&#x27;</span><br>      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">password</span><br>  <span class="hljs-attr">ruoyi-redis:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">ruoyi-redis</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">redis</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">./redis</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;6379:6379&quot;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./redis/conf/redis.conf:/home/ruoyi/redis/redis.conf</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./redis/data:/data</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">redis-server</span> <span class="hljs-string">/home/ruoyi/redis/redis.conf</span><br>  <span class="hljs-attr">ruoyi-nginx:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">ruoyi-nginx</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">./nginx</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;80:80&quot;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./nginx/html/dist:/home/ruoyi/projects/ruoyi-ui</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./nginx/conf/nginx.conf:/etc/nginx/nginx.conf</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./nginx/logs:/var/log/nginx</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./nginx/conf.d:/etc/nginx/conf.d</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ruoyi-gateway</span><br>    <span class="hljs-attr">links:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ruoyi-gateway</span><br>  <span class="hljs-attr">ruoyi-gateway:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">ruoyi-gateway</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">./ruoyi/gateway</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8080:8080&quot;</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ruoyi-redis</span><br>    <span class="hljs-attr">links:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ruoyi-redis</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ruoyi-nacos</span><br>  <span class="hljs-attr">ruoyi-auth:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">ruoyi-auth</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">./ruoyi/auth</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9200:9200&quot;</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ruoyi-redis</span><br>    <span class="hljs-attr">links:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ruoyi-redis</span><br>  <span class="hljs-attr">ruoyi-modules-system:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">ruoyi-modules-system</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">./ruoyi/modules/system</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9201:9201&quot;</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ruoyi-redis</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ruoyi-mysql</span><br>    <span class="hljs-attr">links:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ruoyi-redis</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ruoyi-mysql</span><br>  <span class="hljs-attr">ruoyi-modules-gen:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">ruoyi-modules-gen</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">./ruoyi/modules/gen</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9202:9202&quot;</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ruoyi-mysql</span><br>    <span class="hljs-attr">links:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ruoyi-mysql</span><br>  <span class="hljs-attr">ruoyi-modules-job:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">ruoyi-modules-job</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">./ruoyi/modules/job</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9203:9203&quot;</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ruoyi-mysql</span><br>    <span class="hljs-attr">links:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ruoyi-mysql</span><br>  <span class="hljs-attr">ruoyi-modules-file:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">ruoyi-modules-file</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">./ruoyi/modules/file</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9300:9300&quot;</span><br>    <span class="hljs-attr">volumes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">./ruoyi/uploadPath:/home/ruoyi/uploadPath</span><br>  <span class="hljs-attr">ruoyi-visual-monitor:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">ruoyi-visual-monitor</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">./ruoyi/visual/monitor</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9100:9100&quot;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Container</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Dockerå®æˆ˜</title>
    <link href="/2022/03/28/Container/Docker%E5%AE%9E%E6%88%98/"/>
    <url>/2022/03/28/Container/Docker%E5%AE%9E%E6%88%98/</url>
    
    <content type="html"><![CDATA[<h2 id="Nacos-amp-Seata"><a href="#Nacos-amp-Seata" class="headerlink" title="Nacos &amp; Seata"></a>Nacos &amp; Seata</h2><figure class="highlight bash"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><pre><code class="hljs Bash">docker run --name nacos-quick -v /Users/hanzhiguo/docker/nacos/logs:/home/nacos/logs -v /Users/hanzhiguo/docker/nacos/conf:/home/nacos/conf -e MODE=standalone -p 8848:8848 --privileged=<span class="hljs-literal">true</span> --restart=always -d nacos/nacos-server:2.0.0<br><br>docker run --name seata-server \<br>        -v /Users/hanzhiguo/docker/seata/logs:/seata-server/logs -v /Users/hanzhiguo/docker/seata/conf:/seata-server/resources \<br>        -p 8091:8091 \<br>        -e SEATA_IP=172.16.237.63 \<br>        -d seataio/seata-server:1.4.2<br></code></pre></td></tr></table></figure><h2 id="ElasticSearch-amp-Kibana"><a href="#ElasticSearch-amp-Kibana" class="headerlink" title="ElasticSearch &amp; Kibana"></a>ElasticSearch &amp; Kibana</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs Bash"><span class="hljs-comment"># åˆ›å»ºè‡ªå®šä¹‰çš„ç½‘ç»œ(ç”¨äºè¿æ¥åˆ°è¿æ¥åˆ°åŒä¸€ç½‘ç»œçš„å…¶ä»–æœåŠ¡(ä¾‹å¦‚Kibana))</span><br>docker network create somenetwork <br><br><span class="hljs-comment"># es æš´éœ²çš„ç«¯å£å¾ˆå¤š</span><br><span class="hljs-comment"># es è¿è¡Œå ç”¨çš„å†…å­˜è¶…çº§å¤§</span><br><span class="hljs-comment"># es çš„æ•°æ®ä¸€èˆ¬éœ€è¦æ”¾ç½®åˆ°å®‰å…¨ç›®å½•ï¼æŒ‚è½½</span><br><span class="hljs-comment"># å¯åŠ¨ elasticsearch</span><br>docker run -d --name elasticsearch --net somenetwork -p 9200:9200 -p 9300:9300 -e <span class="hljs-string">&quot;discovery.type=single-node&quot;</span> elasticsearch<br><br><span class="hljs-comment"># æŸ¥çœ‹dockerçŠ¶æ€</span><br>docker stats<br><br><span class="hljs-comment"># é™åˆ¶ESå†…å­˜ ä¿®æ”¹é…ç½®æ–‡ä»¶ -e ç¯å¢ƒé…ç½®ä¿®æ”¹</span><br>docker run -d --name elasticsearch --net somenetwork -p 9200:9200 -p 9300:9300 -v /Users/hanzhiguo/docker/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml  -e <span class="hljs-string">&quot;discovery.type=single-node&quot;</span> -e ES\_JAVA\_OPTS=<span class="hljs-string">&quot;-Xms64M -Xmx512M&quot;</span> elasticsearch:6.4.3<br><br><span class="hljs-comment"># è¿è¡Œ Kibana</span><br>docker run -d --name kibana --net somenetwork -p 5601:5601 kibana<br></code></pre></td></tr></table></figure><h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Bash">docker run \<br>-p 6379:6379 \<br>-v /Users/hanzhiguo/docker/redis/data:/data \<br>-v /Users/hanzhiguo/docker/redis/conf/redis.conf:/etc/redis/redis.conf \<br>--privileged=<span class="hljs-literal">true</span> \<br>--name myredis \<br>-d redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf<br></code></pre></td></tr></table></figure><h2 id="loveaeen-x2F-Centos7"><a href="#loveaeen-x2F-Centos7" class="headerlink" title="loveaeen&#x2F;Centos7"></a>loveaeen&#x2F;Centos7</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Bash"><span class="hljs-comment"># docker run</span><br>docker run -itd --privileged --hostname=master --name centos7-master loveaeen/centos-docker:1.0 /usr/sbin/init<br><br>docker run -itd --privileged --hostname=minio1 --name centos7-minio1 loveaeen/centos-docker:1.0 /usr/sbin/init<br><br>docker run -itd --privileged --hostname=minio2 --name centos7-minio2 loveaeen/centos-docker:1.0 /usr/sbin/init<br><br>docker run -itd --privileged --hostname=minio3 --name centos7-minio3 loveaeen/centos-docker:1.0 /usr/sbin/init<br><br><span class="hljs-comment"># modify hostname</span><br><span class="hljs-comment"># hostnamectl set-hostname master</span><br></code></pre></td></tr></table></figure><h2 id="Ubuntu-amp-Tomcat8-amp-JDK8"><a href="#Ubuntu-amp-Tomcat8-amp-JDK8" class="headerlink" title="Ubuntu &amp; Tomcat8 &amp; JDK8"></a>Ubuntu &amp; Tomcat8 &amp; JDK8</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs Bash"><span class="hljs-comment"># åˆ›å»ºdockerfileæ–‡ä»¶</span><br>FROM         ubuntu:14.10<br>MAINTAINER    linx<br><br><span class="hljs-comment"># æŠŠjavaä¸tomcatæ·»åŠ åˆ°å®¹å™¨ä¸­</span><br>ADD jdk-8u261-linux-x64.tar.gz /usr/local/<br>ADD apache-tomcat-8.5.57.tar.gz /usr/local/<br><br><span class="hljs-comment"># é…ç½®javaä¸tomcatç¯å¢ƒå˜é‡</span><br>ENV JAVA\_HOME /usr/local/jdk1.8.0\_261<br>ENV CLASSPATH <span class="hljs-variable">$JAVA</span>\_HOME/lib/dt.jar:<span class="hljs-variable">$JAVA</span>\_HOME/lib/tools.jar<br>ENV CATALINA\_HOME /usr/local/apache-tomcat-8.5.57<br>ENV CATALINA\_BASE /usr/local/apache-tomcat-8.5.57<br>ENV PATH <span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$JAVA</span>\_HOME/bin:<span class="hljs-variable">$CATALINA</span>\_HOME/lib:<span class="hljs-variable">$CATALINA</span>\_HOME/bin<br><br><span class="hljs-comment"># å®¹å™¨è¿è¡Œæ—¶ç›‘å¬çš„ç«¯å£</span><br>EXPOSE  8080<br><br><span class="hljs-comment"># ä½¿ç”¨dockerfile</span><br>docker build -t name .<br><br><span class="hljs-comment"># tomcatå¯åŠ¨å¹¶æŒ‚è½½</span><br>docker run -i -t -p 8084:8080 -v /Users/hanzhiguo/docker/tomcat:/usr/local/apache-tomcat-8.5.57/webapps --name shys\_tomcat shys\_tomcat<br></code></pre></td></tr></table></figure><h2 id="Mysql"><a href="#Mysql" class="headerlink" title="Mysql"></a>Mysql</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Bash">docker run --name mysql -p 3306:3306 -e MYSQL\_ROOT\_PASSWORD=root -d  mysql --lower\_case\_table\_names=1<br><br><span class="hljs-comment"># è‹¥mysqlç‰ˆæœ¬ä¸º8ä»¥ä¸Šã€‚æœ‰äº›å·¥å…·æ— æ³•è¿æ¥ éœ€è¦ä¿®æ”¹ç”¨æˆ·å¯†ç çš„éªŒè¯æ–¹å¼</span><br>ALTER USER <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span> IDENTIFIED WITH mysql\_native\_password BY <span class="hljs-string">&#x27;yourpassword&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="Prometheus-amp-Grafanaç›‘æ§Springboot-amp-Mysql"><a href="#Prometheus-amp-Grafanaç›‘æ§Springboot-amp-Mysql" class="headerlink" title="Prometheus &amp; Grafanaç›‘æ§Springboot &amp; Mysql"></a>Prometheus &amp; Grafanaç›‘æ§Springboot &amp; Mysql</h2><h3 id="1-éœ€è¦åœ¨springbooté¡¹ç›®ä¸­åŠ å…¥ä¾èµ–"><a href="#1-éœ€è¦åœ¨springbooté¡¹ç›®ä¸­åŠ å…¥ä¾èµ–" class="headerlink" title="1. éœ€è¦åœ¨springbooté¡¹ç›®ä¸­åŠ å…¥ä¾èµ–"></a>1. éœ€è¦åœ¨springbooté¡¹ç›®ä¸­åŠ å…¥ä¾èµ–</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Bash">&amp;lt;!-- ä¸ºprometheusæš´éœ²é‡‡é›†ç«¯ç‚¹ --&amp;gt;<br>        &amp;lt;dependency&amp;gt;<br>            &amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;<br>            &amp;lt;artifactId&amp;gt;spring-boot-starter-actuator&amp;lt;/artifactId&amp;gt;<br>        &amp;lt;/dependency&amp;gt;<br><br>        &amp;lt;!-- prometheusæ”¯æŒ --&amp;gt;<br>        &amp;lt;dependency&amp;gt;<br>            &amp;lt;groupId&amp;gt;io.micrometer&amp;lt;/groupId&amp;gt;<br>            &amp;lt;artifactId&amp;gt;micrometer-registry-prometheus&amp;lt;/artifactId&amp;gt;<br>        &amp;lt;/dependency&amp;gt;<br></code></pre></td></tr></table></figure><h3 id="2-ymlæ–‡ä»¶ä¸­å¼€æ”¾åœ°å€"><a href="#2-ymlæ–‡ä»¶ä¸­å¼€æ”¾åœ°å€" class="headerlink" title="2. ymlæ–‡ä»¶ä¸­å¼€æ”¾åœ°å€"></a>2. ymlæ–‡ä»¶ä¸­å¼€æ”¾åœ°å€</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs YAML"><span class="hljs-attr">management:</span><br>  <span class="hljs-attr">endpoints:</span><br>  <span class="hljs-attr">web:</span><br>    <span class="hljs-attr">exposure:</span><br>      <span class="hljs-attr">include:</span> <span class="hljs-string">&quot;*&quot;</span><br></code></pre></td></tr></table></figure><h3 id="3-åˆ›å»ºä¸€ä¸ªprometheus-ymlæ–‡ä»¶"><a href="#3-åˆ›å»ºä¸€ä¸ªprometheus-ymlæ–‡ä»¶" class="headerlink" title="3.åˆ›å»ºä¸€ä¸ªprometheus.ymlæ–‡ä»¶"></a>3.åˆ›å»ºä¸€ä¸ªprometheus.ymlæ–‡ä»¶</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs YAML"><span class="hljs-comment"># å…¨å±€é…ç½®</span><br><span class="hljs-attr">lobal:</span><br> <span class="hljs-attr">scrape_interval:</span>     <span class="hljs-string">15s</span> <span class="hljs-comment"># å¤šä¹… æ”¶é›† ä¸€æ¬¡æ•°æ®</span><br> <span class="hljs-attr">evaluation_interval:</span> <span class="hljs-string">15s</span> <span class="hljs-comment"># å¤šä¹…è¯„ä¼°ä¸€æ¬¡ è§„åˆ™</span><br> <span class="hljs-attr">scrape_timeout:</span>      <span class="hljs-string">10s</span>   <span class="hljs-comment"># æ¯æ¬¡ æ”¶é›†æ•°æ®çš„ è¶…æ—¶æ—¶é—´</span><br><br> <span class="hljs-string">ç›‘æ§é¢„è­¦é…ç½®.æœªå¯ç”¨</span><br><span class="hljs-attr">lerting:</span><br> <span class="hljs-attr">alertmanagers:</span><br> <span class="hljs-bullet">-</span> <span class="hljs-attr">static_configs:</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span><br>     <span class="hljs-comment"># - alertmanager:9093</span><br><br> <span class="hljs-comment"># è§„åˆ™æ–‡ä»¶, å¯ä»¥ä½¿ç”¨é€šé…ç¬¦. æœªå¯ç”¨</span><br><span class="hljs-attr">ule_files:</span><br> <span class="hljs-comment"># - &quot;first_rules.yml&quot;</span><br> <span class="hljs-comment"># - &quot;second_rules.yml&quot;</span><br><br> <span class="hljs-string">prometheusæœåŠ¡é…ç½®</span><br><span class="hljs-attr">crape_configs:</span><br> <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&#x27;prometheus&#x27;</span><br>   <span class="hljs-attr">static_configs:</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;localhost:9090&#x27;</span>]<br><br> <span class="hljs-string">SpringBootåº”ç”¨é…ç½®</span><br> <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&#x27;SpringBootPrometheus&#x27;</span><br>   <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">5s</span><br>   <span class="hljs-attr">metrics_path:</span> <span class="hljs-string">&#x27;/actuator/prometheus&#x27;</span><br>   <span class="hljs-attr">static_configs:</span><br>     <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;192.168.1.145:81&#x27;</span>]<br><br> <span class="hljs-string">mysqlé…ç½®</span><br> <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&#x27;mysql&#x27;</span><br>   <span class="hljs-attr">static_configs:</span><br>     <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;192.168.1.145:9104&#x27;</span>]<br></code></pre></td></tr></table></figure><h3 id="4-dockerå¯åŠ¨prometheus-é€šè¿‡é…ç½®æ–‡ä»¶æŒ‚è½½-åŠgrafana"><a href="#4-dockerå¯åŠ¨prometheus-é€šè¿‡é…ç½®æ–‡ä»¶æŒ‚è½½-åŠgrafana" class="headerlink" title="4.dockerå¯åŠ¨prometheus(é€šè¿‡é…ç½®æ–‡ä»¶æŒ‚è½½)åŠgrafana"></a>4.dockerå¯åŠ¨prometheus(é€šè¿‡é…ç½®æ–‡ä»¶æŒ‚è½½)åŠgrafana</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs Bash"><span class="hljs-comment"># éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ã€‚ç”¨äºæŒ‚è½½</span><br>docker run  -d \<br>  -p 9090:9090 \<br>  --name prometheus \<br>  -v /Users/hanzhiguo/docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml  \<br>  prom/prometheus<br><br><span class="hljs-comment"># å¯åŠ¨Grafana</span><br>docker run -d \<br>  -p 3000:3000 \<br>  --name=grafana \<br>  -v /Users/hanzhiguo/docker/grafana-storage:/var/lib/grafana \<br>  grafana/grafana<br></code></pre></td></tr></table></figure><h3 id="5-å®‰è£…mysql-exporterç›‘æ§mysql"><a href="#5-å®‰è£…mysql-exporterç›‘æ§mysql" class="headerlink" title="5.å®‰è£…mysql-exporterç›‘æ§mysql"></a>5.å®‰è£…mysql-exporterç›‘æ§mysql</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Bash"><span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªç›‘æ§è´¦æˆ·</span><br>CREATE USER <span class="hljs-string">&#x27;exporter&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="hljs-string">&#x27;XXXXXXXX&#x27;</span> WITH MAX\_USER\_CONNECTIONS 10;<br>GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO <span class="hljs-string">&#x27;exporter&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span>;<br><span class="hljs-comment"># å¯åŠ¨mysql-exporter</span><br>docker run -d \<br>  -p 9104:9104 \<br>  -e DATA\_SOURCE\_NAME=<span class="hljs-string">&quot;exporter:exporter@(192.168.1.145:3306)/&quot;</span> \<br>  prom/mysqld-exporter<br><br><span class="hljs-comment"># ç»“æŸåä½¿ç”¨mrbirdçš„mysqlç›‘æ§json</span><br></code></pre></td></tr></table></figure><h2 id="BackUp-amp-Transfer"><a href="#BackUp-amp-Transfer" class="headerlink" title="BackUp &amp; Transfer"></a>BackUp &amp; Transfer</h2><h3 id="BackUp"><a href="#BackUp" class="headerlink" title="BackUp"></a>BackUp</h3><ul><li>è¿è¡Œä¸€ä¸ª Ubuntu çš„å®¹å™¨ï¼ŒæŒ‚è½½mongoå®¹å™¨çš„æ‰€æœ‰ volumeï¼Œæ˜ å°„å®¿ä¸»æœºçš„ backup ç›®å½•åˆ°å®¹å™¨é‡Œé¢çš„ &#x2F;backup ç›®å½•ï¼Œç„¶åè¿è¡Œ tar å‘½ä»¤å°†dataç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶æ‰“åŒ…åˆ°backup.tarä¸­ <code>docker run --rm --volumes-from mongo -v d:/backup:/backup ubuntu tar cvf /backup/backup.tar /data/</code></li><li>è¿™æ ·å®¿ä¸»æœºçš„backupç›®å½•å°±æœ‰äº†mongoå®¹å™¨çš„å¤‡ä»½å‹ç¼©åŒ…äº†</li></ul><h3 id="Transfer"><a href="#Transfer" class="headerlink" title="Transfer"></a>Transfer</h3><ul><li>è¿è¡Œä¸€ä¸ª ubuntu å®¹å™¨ï¼ŒæŒ‚è½½ mongo å®¹å™¨çš„æ‰€æœ‰ volumesï¼Œç„¶åè¯»å– &#x2F;backup ç›®å½•ä¸­çš„å¤‡ä»½æ–‡ä»¶ï¼Œè§£å‹åˆ° &#x2F;data&#x2F; ç›®å½• <code>docker run --rm --volumes-from mongo -v d:/backup:/backup ubuntu bash -c &quot;cd /data/ &amp;&amp; tar xvf /backup/backup.tar --strip 1&quot;</code></li><li>strip 1 è¡¨ç¤ºè§£å‹æ—¶å»æ‰å‰é¢1å±‚ç›®å½•ï¼Œå› ä¸ºå‹ç¼©æ—¶åŒ…å«äº†ç»å¯¹è·¯å¾„</li></ul><h2 id="Push-amp-Pull"><a href="#Push-amp-Pull" class="headerlink" title="Push &amp; Pull"></a>Push &amp; Pull</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs Bash"><span class="hljs-comment"># docker login your account</span><br><span class="hljs-comment"># input your loginname &amp; password</span><br>docker login<br><br><span class="hljs-comment"># tag the image</span><br>docker tag image:1.0 loveaee/image:1.0<br><br><span class="hljs-comment"># push your images to Docker Hub</span><br>docker push loveaee/image:1.0<br><br><span class="hljs-comment"># delete local image</span><br>docker rmi imageId<br><br><span class="hljs-comment"># pull image from docker hub</span><br>docker pull loveaee/image:1.0<br></code></pre></td></tr></table></figure><h2 id="Offline"><a href="#Offline" class="headerlink" title="Offline"></a>Offline</h2><p>åœ¨å†…ç½‘æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥è®©Dockeræ¥å…¥å†…ç½‘ä»“åº“harboræ¥ç®¡ç†æ‰€æœ‰çš„é•œåƒæ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Bash">vim /etc/docker/daemon.json<br><br><span class="hljs-string">&quot;insecure-registries&quot;</span>: [<span class="hljs-string">&quot;172.17.0.3&quot;</span>]<br><br>systemctl restart docker<br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ftpçš„æ–¹å¼æ¥ä½¿ç”¨ç¦»çº¿ç‰ˆé•œåƒã€‚</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-comment"># save image to disk</span><br><span class="hljs-comment"># -o : Write to a file</span><br>docker save image -o image.tar<br><br><span class="hljs-comment"># load image from disk</span><br><span class="hljs-comment"># -i : Read from tar archive file</span><br>docker <span class="hljs-built_in">load</span> -i image.tar<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Container</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Seata</title>
    <link href="/2022/03/28/Distributed%20System/Seata/"/>
    <url>/2022/03/28/Distributed%20System/Seata/</url>
    
    <content type="html"><![CDATA[<p>Seata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºæä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡. Seata å°†ä¸ºç”¨æˆ·æä¾›äº† ATã€TCCã€SAGA å’Œ XA äº‹åŠ¡æ¨¡å¼ï¼Œä¸ºç”¨æˆ·æ‰“é€ ä¸€ç«™å¼çš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆ</p><p><strong>Seata å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œè®¾è®¡äº†ä¸€ä¸ªå…³é”®è§’è‰² UNDO_LOG ï¼ˆå›æ»šæ—¥å¿—è®°å½•è¡¨ï¼‰ï¼Œæˆ‘ä»¬åœ¨æ¯ä¸ªåº”ç”¨åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸šåŠ¡åº“ä¸­åˆ›å»ºè¿™å¼ è¡¨ï¼Œè¿™ä¸ªè¡¨çš„æ ¸å¿ƒä½œç”¨å°±æ˜¯ï¼Œå°†ä¸šåŠ¡æ•°æ®åœ¨æ›´æ–°å‰åçš„æ•°æ®é•œåƒç»„ç»‡æˆå›æ»šæ—¥å¿—ï¼Œå¤‡ä»½åœ¨ UNDO_LOG è¡¨ä¸­ï¼Œä»¥ä¾¿ä¸šåŠ¡å¼‚å¸¸èƒ½éšæ—¶å›æ»šã€‚</strong></p><h2 id="Component"><a href="#Component" class="headerlink" title="Component"></a>Component</h2><p>Transaction Coordinator (TC)ï¼š äº‹åŠ¡åè°ƒå™¨ï¼Œç»´æŠ¤å…¨å±€äº‹åŠ¡çš„è¿è¡ŒçŠ¶æ€ï¼Œè´Ÿè´£åè°ƒå¹¶é©±åŠ¨å…¨å±€äº‹åŠ¡çš„æäº¤æˆ–å›æ»šï¼›</p><p>Transaction Manager (TM)ï¼š æ§åˆ¶å…¨å±€äº‹åŠ¡çš„è¾¹ç•Œï¼Œè´Ÿè´£å¼€å¯ä¸€ä¸ªå…¨å±€äº‹åŠ¡ï¼Œå¹¶æœ€ç»ˆå‘èµ·å…¨å±€æäº¤æˆ–å…¨å±€å›æ»šçš„å†³è®®ï¼›</p><p>Resource Manager (RM)ï¼š æ§åˆ¶åˆ†æ”¯äº‹åŠ¡ï¼Œè´Ÿè´£åˆ†æ”¯æ³¨å†Œã€çŠ¶æ€æ±‡æŠ¥ï¼Œå¹¶æ¥æ”¶äº‹åŠ¡åè°ƒå™¨çš„æŒ‡ä»¤ï¼Œé©±åŠ¨åˆ†æ”¯ï¼ˆæœ¬åœ°ï¼‰äº‹åŠ¡çš„æäº¤å’Œå›æ»šã€‚</p><p><strong>äº‹åŠ¡å¼€å¯è¿‡ç¨‹</strong></p><ul><li><p>TM å‘ TC ç”³è¯·å¼€å¯ä¸€ä¸ªå…¨å±€äº‹åŠ¡ï¼Œå…¨å±€äº‹åŠ¡åˆ›å»ºæˆåŠŸå¹¶ç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ <code>XID</code>ï¼›</p></li><li><p><code>XID</code> åœ¨å¾®æœåŠ¡è°ƒç”¨é“¾è·¯çš„ä¸Šä¸‹æ–‡ä¸­ä¼ æ’­ï¼›</p></li><li><p>RM å‘ TC æ³¨å†Œåˆ†æ”¯äº‹åŠ¡ï¼Œå°†å…¶çº³å…¥ <code>XID</code> å¯¹åº”å…¨å±€äº‹åŠ¡çš„ç®¡è¾–ï¼›</p></li><li><p>TM å‘ TC å‘èµ·é’ˆå¯¹ <code>XID</code> çš„å…¨å±€æäº¤æˆ–å›æ»šå†³è®®ï¼›</p></li><li><p>TC è°ƒåº¦ <code>XID</code> ä¸‹ç®¡è¾–çš„å…¨éƒ¨åˆ†æ”¯äº‹åŠ¡å®Œæˆæäº¤æˆ–å›æ»šè¯·æ±‚ã€‚</p></li></ul><h2 id="AT-http-seata-io-zh-cn-docs-dev-mode-at-mode-html-text-SELECT-è¯­å¥ã€‚-å·¥ä½œæœºåˆ¶-ä»¥ä¸€ä¸ªç¤ºä¾‹-æ¨¡å¼-http-seata-io-zh-cn-docs-dev-mode-at-mode-html-text-SELECT-è¯­å¥ã€‚-å·¥ä½œæœºåˆ¶-ä»¥ä¸€ä¸ªç¤ºä¾‹"><a href="#AT-http-seata-io-zh-cn-docs-dev-mode-at-mode-html-text-SELECT-è¯­å¥ã€‚-å·¥ä½œæœºåˆ¶-ä»¥ä¸€ä¸ªç¤ºä¾‹-æ¨¡å¼-http-seata-io-zh-cn-docs-dev-mode-at-mode-html-text-SELECT-è¯­å¥ã€‚-å·¥ä½œæœºåˆ¶-ä»¥ä¸€ä¸ªç¤ºä¾‹" class="headerlink" title="[AT](http://seata.io/zh-cn/docs/dev/mode/at-mode.html#:~:text=SELECT è¯­å¥ã€‚-,å·¥ä½œæœºåˆ¶,-ä»¥ä¸€ä¸ªç¤ºä¾‹)[æ¨¡å¼](http://seata.io/zh-cn/docs/dev/mode/at-mode.html#:~:text=SELECT è¯­å¥ã€‚-,å·¥ä½œæœºåˆ¶,-ä»¥ä¸€ä¸ªç¤ºä¾‹)"></a>[AT](<a href="http://seata.io/zh-cn/docs/dev/mode/at-mode.html#:~:text=SELECT">http://seata.io/zh-cn/docs/dev/mode/at-mode.html#:~:text=SELECT</a> è¯­å¥ã€‚-,å·¥ä½œæœºåˆ¶,-ä»¥ä¸€ä¸ªç¤ºä¾‹)[æ¨¡å¼](<a href="http://seata.io/zh-cn/docs/dev/mode/at-mode.html#:~:text=SELECT">http://seata.io/zh-cn/docs/dev/mode/at-mode.html#:~:text=SELECT</a> è¯­å¥ã€‚-,å·¥ä½œæœºåˆ¶,-ä»¥ä¸€ä¸ªç¤ºä¾‹)</h2><p>ATæ¨¡å¼æ˜¯ä¸€ç§æ— ä¾µå…¥çš„, åŸºäº 2PC çš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œä½†ä»–å¹¶ä¸æ˜¯å®Œç¾çš„ï¼Œä¸ºäº†è§£å†³äº‹åŠ¡çš„è¡¥å¿ä¸å…¨å±€äº‹åŠ¡ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œå®ƒåŠ å…¥äº†before imageä¸after imageï¼Œå¹¶ä¼šæ’å…¥undo logè¡¨ä¸­ç”¨äºäº‹åŠ¡å›æ»šï¼Œè€Œä¸”è¿˜æœ‰å°‘ä¸äº†çš„RPCåŒæ­¥é€šä¿¡ã€‚ç»„ä»¶çš„é¢å¤–åŠ å…¥å¿…ç„¶å¢åŠ äº†ä¸å°‘çš„å¼€é”€ï¼Œæƒ³ä¸€æƒ³æ¯ä¸€ä¸ªsqlçš„æ‰§è¡Œéƒ½ä¼šæœ‰å¦‚æ­¤å¤šçš„é¢å¤–å¼€é”€ï¼Œé¡¹ç›®çš„åˆ†å¸ƒå¼äº‹åŠ¡æ€§èƒ½å¿…ç„¶ä¼šå¤§å¹…åº¦é™ä½ã€‚ä¸šå†…ä¹Ÿæœ‰ä¸€ç§æ€è·¯ï¼Œé€šè¿‡æ•°æ®åº“binlogè¿˜åŸé•œåƒå‰åçš„SQLï¼Œçœå»äº†undo logç”Ÿæˆè®°å½•çš„åŒæ­¥ï¼Œé™ä½äº†æ€§èƒ½æŸå¤±ï¼ŒåŒæ—¶é›¶ä¸šåŠ¡å…¥ä¾µï¼Œä¸ªäººè§‰å¾—æ˜¯æ›´å¥½çš„æ–¹æ³•ã€‚</p><p>é™¤å¼€æ€§èƒ½æ–¹é¢ï¼ŒATæ¨¡å¼åœ¨ã€Œå…¨å±€äº‹åŠ¡ã€ä¸ã€Œæœ¬åœ°äº‹åŠ¡ã€ä¹‹é—´ä¼šäº§ç”Ÿè„å†™å’Œè„è¯»é—®é¢˜ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨<code>@GlobalLock</code>çš„æ–¹å¼ï¼Œè®©ã€Œæœ¬åœ°äº‹åŠ¡ã€ä¹Ÿå»ç«äº‰å…¨å±€é”ã€‚ä½†æ˜¯è¯¥æ–¹å¼ä¹Ÿç‰ºç‰²äº†ä¸å°‘çš„æ€§èƒ½ã€‚</p><p>ä½†æ˜¯æˆ‘ä»¬ä¸èƒ½å¦è®¤ATæ¨¡å¼æ˜¯æœ€å¸¸è§ä¹Ÿæ˜¯ç›¸å¯¹ä¼˜å¼‚çš„æ–¹æ¡ˆï¼Œé˜¿é‡Œä¸ºäº†æ”¹å–„åŠè§£å†³ATæ¨¡å¼çš„å¼Šç«¯é—®é¢˜ï¼Œä¼˜åŒ–äº†äºŒé˜¶æ®µæ—¶å…¨å±€é”çš„æŒæœ‰ï¼Œå¹¶è®©äºŒé˜¶æ®µæäº¤&#x2F;å›æ»šé‡‡ç”¨äº†å¼‚æ­¥è¿›è¡Œçš„æ–¹å¼ã€‚è€Œä¸”åœ¨ä¿è¯ä¸€è‡´æ€§çš„æ–¹é¢ï¼Œä½¿ç”¨äº†æ›´ä¸ºé«˜æ€§èƒ½çš„Redisæ¥è§£å†³ï¼Œè™½ç„¶è¿™å¯èƒ½ä¼šå› ä¸ºRedisçš„éäº‹åŠ¡æ”¯æŒå¯¼è‡´ä¸€è‡´æ€§çš„é™ä½ï¼Œä½†å‡¡äº‹æ²¡æœ‰å®Œç¾ï¼Œä¸æ˜¯å—ï¼Ÿ</p><p><strong>ä¸€é˜¶æ®µ</strong>ï¼šSeata ä¼šæ‹¦æˆª â€œä¸šåŠ¡ SQLâ€ ï¼Œé¦–å…ˆè§£æ SQL è¯­ä¹‰ï¼Œæ‰¾åˆ° â€œä¸šåŠ¡ SQLâ€ è¦æ›´æ–°çš„ä¸šåŠ¡æ•°æ®ï¼Œåœ¨ä¸šåŠ¡æ•°æ®è¢«æ›´æ–°å‰ï¼Œå°†å…¶ä¿å­˜æˆ â€œbefore imageâ€ï¼Œç„¶åæ‰§è¡Œ â€œä¸šåŠ¡ SQLâ€ æ›´æ–°ä¸šåŠ¡æ•°æ®ï¼Œåœ¨ä¸šåŠ¡æ•°æ®æ›´æ–°ä¹‹åï¼Œå†å°†å…¶ä¿å­˜æˆ â€œafter imageâ€ ï¼Œæäº¤å‰ç”³è¯·å…¨å±€é”ï¼Œå†å°†ä¸šåŠ¡æ•°æ®çš„æ›´æ–°å’Œå‰é¢æ­¥éª¤ä¸­ç”Ÿæˆçš„ UNDO LOG ä¸€å¹¶è¿›è¡Œæœ¬åœ°æäº¤ã€‚ç„¶åé‡Šæ”¾æœ¬åœ°é”ã€‚</p><p>ä¸€é˜¶æ®µæäº¤åï¼Œè‹¥æœ‰å…¶ä»–æœ¬åœ°éåˆ†å¸ƒå¼äº‹åŠ¡æ“ä½œè¯¥æ¡æ•°æ®ï¼Œåˆ™ä¼šå‘ç”Ÿè„å†™&#x2F;è„è¯»é—®é¢˜ã€‚</p><p><img src="/image/Seata/v2-c2df76b462cd22fcc1b1435113e82e49_1440w.jpg" alt="img"></p><p><strong>äºŒé˜¶æ®µæäº¤</strong>: å› ä¸ºâ€œä¸šåŠ¡ SQLâ€åœ¨ä¸€é˜¶æ®µå·²ç»æäº¤è‡³æ•°æ®åº“, æ‰€ä»¥ Seata æ¡†æ¶åªéœ€å¼‚æ­¥å°†ä¸€é˜¶æ®µä¿å­˜çš„å¿«ç…§æ•°æ®å’Œè¡Œé”åˆ æ‰ï¼Œå®Œæˆæ•°æ®æ¸…ç†å¹¶é‡Šæ”¾å…¨å±€é”ã€‚</p><p><img src="/image/Seata/v2-75048a7c0f655654032213658742b7d5_1440w.jpg" alt="img"></p><p><strong>äºŒé˜¶æ®µå›æ»š</strong>ï¼šSeata å°±éœ€è¦å›æ»šä¸€é˜¶æ®µå·²ç»æ‰§è¡Œçš„â€œä¸šåŠ¡ SQLâ€ï¼Œè¿˜åŸä¸šåŠ¡æ•°æ®ã€‚å›æ»šæ–¹å¼ä¾¿æ˜¯ç”¨ â€œbefore imageâ€ è¿˜åŸä¸šåŠ¡æ•°æ®. ä½†åœ¨è¿˜åŸå‰è¦é¦–å…ˆè¦æ ¡éªŒè„å†™, å¯¹æ¯” â€œæ•°æ®åº“å½“å‰ä¸šåŠ¡æ•°æ®â€ å’Œ â€œafter imageâ€ï¼Œå¦‚æœä¸¤ä»½æ•°æ®å®Œå…¨ä¸€è‡´å°±è¯´æ˜æ²¡æœ‰è„å†™ï¼Œå¯ä»¥è¿˜åŸä¸šåŠ¡æ•°æ®ï¼Œå¦‚æœä¸ä¸€è‡´å°±è¯´æ˜æœ‰è„å†™ï¼Œå‡ºç°è„å†™å°±éœ€è¦è½¬äººå·¥å¤„ç†ã€‚</p><p>äºŒé˜¶æ®µå›æ»šæ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ï¼Œæ­¤æ—¶è¯¥è¯¥åˆ†å¸ƒå¼äº‹åŠ¡ä¾ç„¶æŒæœ‰å…¨å±€é”ï¼Œä½†æ˜¯ç¼ºå°‘äº†æœ¬åœ°é”ï¼Œæ‰€ä»¥éœ€è¦ç”³è¯·ã€‚å‡å¦‚åœ¨äºŒé˜¶æ®µå›æ»šå‰ï¼Œæœ‰å…¶ä»–æœ¬åœ°äº‹åŠ¡æ“ä½œäº†è¯¥æ•°æ®ï¼Œåˆ™ä¼šå‘ç”Ÿè„å†™&#x2F;è„è¯»é—®é¢˜ã€‚</p><p><img src="/image/Seata/v2-12a2fb645ded74b2ace2728d052a7bff_1440w.jpg" alt="img"></p><h2 id="TCC"><a href="#TCC" class="headerlink" title="TCC"></a>TCC</h2><p>å…³äºåŸç†æˆ‘ä»¬åœ¨**[åˆ†å¸ƒå¼äº‹åŠ¡]**ä¸€æ–‡ä¸­å·²ç»åšè¿‡è§£ç­”ã€‚åœ¨æ­¤ç±»ç›®ä¸‹ï¼Œæˆ‘ä»¬æ˜¯å¯¹äºSeataä¸‹çš„TCCæ¨¡å¼æ¥åšè®¨è®ºã€‚</p><p>åœ¨Seataä¸­ï¼Œä¸ç®¡æ˜¯ä»»ä½•æ¨¡å¼ï¼Œæˆ‘ä»¬éƒ½æ— æ³•ç»•å¼€TCï¼ŒTMï¼ŒRMä¸‰å¤§ç»„ä»¶ã€‚åœ¨ATæ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬è¯¦è§£äº†å…¨å±€é”åœ¨å…¶ä¸­å……å½“çš„éš”ç¦»æ€§ä½œç”¨ï¼Œè€Œåœ¨TCCæ¨¡å¼ä¸­ï¼Œå®Œå…¨ä¸éœ€è¦å…¨å±€é”çš„å­˜åœ¨ï¼Œè€Œä¸”æ€§èƒ½ç›¸æ¯”ATæ¨¡å¼æ›´ä¸ºä¼˜å¼‚ã€‚é‚£æˆ‘ä»¬å¦‚ä½•ä¿è¯æ•°æ®çš„éš”ç¦»æ€§å‘¢ï¼Ÿæ ¸å¿ƒå°±åœ¨äºTCCæ¥å£çš„è®¾è®¡ï¼Œç”¨æˆ·åœ¨æ¥å…¥TCCæ¨¡å¼æ—¶ï¼Œå¤§éƒ¨åˆ†å·¥ä½œéƒ½é›†ä¸­å¦‚ä½•å®ç°TCCæœåŠ¡ä¸Šã€‚ç›¸å¯¹äºæ™®é€šçš„äº‹åŠ¡æ“ä½œè€Œè¨€ï¼Œåœ¨TCCçš„è®¤çŸ¥ä¸Šæˆ‘ä»¬éœ€è¦æ‡‚å¾—é¢„ç•™èµ„æºçš„æ¦‚å¿µã€‚åœ¨Tryæ¥å£ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¯¹èµ„æºè¿›è¡Œå†»ç»“ä¿ç•™ã€‚å¹¶åœ¨Confirm&#x2F;Cancelæ¥å£å¯¹è¯¥å†»ç»“èµ„æºåšå¯¹åº”å¤„ç†ã€‚Tryæ¥å£çš„æ“ä½œï¼Œå…¶å®å°±æ˜¯é¢„ç•™èµ„æºçš„æ“ä½œï¼Œæˆ‘ä»¬åœ¨äºŒé˜¶æ®µåšçš„æäº¤&#x2F;å›æ»šæ“ä½œï¼Œéƒ½æ˜¯å¤„ç†è¯¥èµ„æºã€‚å¦‚æœå‡ºç°å¹¶å‘é—®é¢˜ï¼Œè¿™æ ·æ¯ä¸€ä¸ªTCCæ¨¡å‹éƒ½åªæ“ä½œå±äºè‡ªå·±çš„é¢„ç•™èµ„æºã€‚</p><p>å…³äºTCCæ¨¡å¼ï¼Œæˆ‘ä»¬ä¹Ÿä¸å…çš„éœ€è¦äº†è§£ç©ºå›æ»šã€é˜²æ‚¬æŒ‚ã€å¹‚ç­‰æ€§çš„ä¸‰ä¸ªéš¾é¢˜ã€‚å½’åŠŸäºä»Šæ—¥äº’è”ç½‘çš„æŠ€æœ¯åˆ†äº«ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆè½»æ¾çš„è§£å†³è¿™ä¸‰ç±»éš¾é¢˜ï¼Œå…¶ä¸­æœ€æ™®éçš„åšæ³•å°±æ˜¯å¢åŠ ä¸€å¼ æœ¬åœ°äº‹åŠ¡æ§åˆ¶è¡¨ã€‚</p><p><strong>ç©ºå›æ»šï¼š</strong>ç©ºå›æ»šçš„æ„æ€å°±æ˜¯å› ä¸ºç½‘ç»œç­‰é—®é¢˜ï¼ŒTryæ¥å£æ²¡æœ‰æ¥æ”¶åˆ°è¯¥äº‹åŠ¡ä¿¡æ¯ï¼Œç›´æ¥è§¦å‘äº†å›æ»šæ“ä½œã€‚ä¸ºäº†è§£å†³è¯¥é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Tryé˜¶æ®µæ—¶ï¼Œå¾€äº‹åŠ¡æ§åˆ¶è¡¨ä¸­å¢åŠ ä¸€æ¡è®°å½•ï¼Œè¡¨ç¤ºç¬¬ä¸€é˜¶æ®µæ‰§è¡Œå®Œæ¯•ï¼Œæ ‡è®°åˆå§‹åŒ–çŠ¶æ€ã€‚Cancel æ¥å£é‡Œè¯»å–è¯¥è®°å½•ï¼Œå¦‚æœè¯¥è®°å½•å­˜åœ¨ï¼Œåˆ™æ­£å¸¸å›æ»šï¼›å¦‚æœè¯¥è®°å½•ä¸å­˜åœ¨ï¼Œåˆ™æ˜¯ç©ºå›æ»šã€‚</p><p><strong>é˜²æ‚¬æŒ‚ï¼š</strong>é˜²æ‚¬æŒ‚çš„æ„æ€æ˜¯æ˜¯ Try ç”±äºç½‘ç»œæ‹¥å µè€Œè¶…æ—¶ï¼ŒCancel æ¯” Try æ¥å£å…ˆæ‰§è¡Œã€‚æˆ‘ä»¬å¯ä»¥åœ¨Cancelé˜¶æ®µæ—¶ï¼Œå…ˆæ£€æŸ¥äº‹åŠ¡æ§åˆ¶è¡¨æ˜¯å¦å­˜åœ¨è®°å½•ï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯ç©ºå›æ»šäº†ï¼Œå¦‚æœæ²¡æœ‰ç›¸å…³è®°å½•ï¼Œåˆ™å¾€äº‹åŠ¡æ§åˆ¶è¡¨ä¸­æ’å…¥ä¸€æ¡è®°å½•ï¼Œæ ‡è¯†å·²å›æ»šçŠ¶æ€ï¼Œå¦‚æœTryå»¶æ—¶æ‰§è¡Œï¼Œé‚£ä¹ˆæ£€æŸ¥äº‹åŠ¡æ§åˆ¶è¡¨çš„å†…å®¹ï¼Œå‘ç°å·²ç»å›æ»šï¼Œé‚£ä¹ˆä¸æ‰§è¡Œä»»ä½•æ“ä½œ</p><p><strong>å¹‚ç­‰æ€§ï¼š</strong>å’Œä¸Šé¢ä¸¤ç§æ–¹æ¡ˆä¸€è‡´ï¼Œé‡‡ç”¨äº‹åŠ¡æ§åˆ¶è¡¨çš„æ–¹å¼æ¥è§£å†³ï¼Œå½“å‡ºç°äºŒé˜¶æ®µé‡å¤æ‰§è¡Œæ—¶ï¼Œæ£€æŸ¥è¡¨å†…åˆ†æ”¯äº‹åŠ¡çš„ä¿¡æ¯ï¼Œå¦‚æœå­˜åœ¨äº†ï¼Œåˆ™ä¸åšæ“ä½œã€‚</p><h2 id="Saga"><a href="#Saga" class="headerlink" title="Saga"></a><a href="http://seata.io/zh-cn/docs/user/saga.html">Saga</a></h2><p>Sagaæ¨¡å¼æ˜¯ä¸€ç§é•¿äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œåœ¨Sagaæ¨¡å¼ä¸­ï¼Œä¸šåŠ¡æµç¨‹ä¸­æ¯ä¸ªå‚ä¸è€…éƒ½æäº¤æœ¬åœ°äº‹åŠ¡ï¼Œå½“å‡ºç°æŸä¸€ä¸ªå‚ä¸è€…å¤±è´¥åˆ™è¡¥å¿å‰é¢å·²ç»æˆåŠŸçš„å‚ä¸è€…ã€‚ä»–çš„æ€§èƒ½å¾ˆé«˜ï¼Œç”šè‡³åœ¨çŠ¶æ€æœºå®šä¹‰æ—¶æ”¯æŒå¼‚æ­¥è°ƒç”¨ï¼Œä½†æ˜¯ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾, ä¸ä¿è¯ <strong>éš”ç¦»æ€§</strong>ã€‚äº‹åŠ¡ä¼šæ ¹æ®jsoné…ç½®çš„stateæ¥æ‰§è¡Œï¼Œå¦‚æœå‰ä¸€ä¸ªstateçš„æ­£å‘æœåŠ¡æ‰§è¡ŒæˆåŠŸï¼Œé‚£ä¹ˆå°±è·¯ç”±åˆ°ä¸‹ä¸€ä¸ªstateå¹¶æ‰§è¡Œä¸‹ä¸€ä¸ªstateçš„æ­£å‘æœåŠ¡ï¼Œå¦‚æœæ‰§è¡Œå¤±è´¥ï¼Œé‚£ä¹ˆåŸºäºCompensateStateå±æ€§æ‰§è¡Œè¡¥å¿æœåŠ¡ã€‚ä½†æ˜¯ç”±äºä¸€é˜¶æ®µå·²ç»æäº¤æœ¬åœ°æ•°æ®åº“äº‹åŠ¡ï¼Œä¸”æ²¡æœ‰è¿›è¡Œâ€é¢„ç•™â€åŠ¨ä½œï¼Œæ‰€ä»¥ä¸èƒ½ä¿è¯éš”ç¦»æ€§ã€‚</p><p>ç›®å‰äº’è”ç½‘ä¸­å¸¸ç”¨çš„è§£å†³éš”ç¦»æ€§çš„æ–¹æ¡ˆæ˜¯åœ¨ä¸šåŠ¡æµç¨‹è®¾è®¡æ—¶éµå¾ªâ€œå®å¯é•¿æ¬¾, ä¸å¯çŸ­æ¬¾â€çš„åŸåˆ™, <strong>é•¿æ¬¾æ„æ€æ˜¯å®¢æˆ·å°‘äº†é’±æœºæ„å¤šäº†é’±, ä»¥æœºæ„ä¿¡èª‰å¯ä»¥ç»™å®¢æˆ·é€€æ¬¾, åä¹‹åˆ™æ˜¯çŸ­æ¬¾, å°‘çš„é’±å¯èƒ½è¿½ä¸å›æ¥äº†</strong>ã€‚æ‰€ä»¥åœ¨ä¸šåŠ¡æµç¨‹è®¾è®¡ä¸Šä¸€å®šæ˜¯å…ˆæ‰£æ¬¾ã€‚æœ‰äº›ä¸šåŠ¡åœºæ™¯å¯ä»¥å…è®¸è®©ä¸šåŠ¡æœ€ç»ˆæˆåŠŸ, åœ¨å›æ»šä¸äº†çš„æƒ…å†µä¸‹å¯ä»¥ç»§ç»­é‡è¯•å®Œæˆåé¢çš„æµç¨‹, æ‰€ä»¥çŠ¶æ€æœºå¼•æ“é™¤äº†æä¾›â€œå›æ»šâ€èƒ½åŠ›è¿˜éœ€è¦æä¾›â€œå‘å‰â€æ¢å¤ä¸Šä¸‹æ–‡ç»§ç»­æ‰§è¡Œçš„èƒ½åŠ›, è®©ä¸šåŠ¡æœ€ç»ˆæ‰§è¡ŒæˆåŠŸ, è¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§çš„ç›®çš„ã€‚</p><h2 id="XA"><a href="#XA" class="headerlink" title="XA"></a><a href="http://seata.io/zh-cn/docs/dev/mode/xa-mode.html">XA</a></h2><p>XAæ¨¡å¼æ˜¯åŸºäºæ•°æ®åº“çš„XAåè®®è€Œæ¥ï¼Œä»–ä¸ATæ¨¡å¼ç›¸ä»¿ï¼Œä½†æ˜¯ä»–çš„é”æœºåˆ¶æ›´ä¸ºä¸¥è‹›ï¼Œå¹¶ä¸”ä¸å…è®¸èµ„æºçš„é‡å…¥ã€‚æˆ‘äº†è§£çš„ä¹Ÿå¾ˆæœ‰é™ï¼Œå› ä¸ºåœ¨äº’è”ç½‘å…¬å¼ä¸­ï¼Œè¯¥æ¨¡å¼çš„ä½¿ç”¨ç‡åä½ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Distributed System</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>åˆ†å¸ƒå¼äº‹åŠ¡</title>
    <link href="/2022/03/28/Distributed%20System/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    <url>/2022/03/28/Distributed%20System/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/</url>
    
    <content type="html"><![CDATA[<p>è‹¥å¯¹æœ¬åœ°äº‹åŠ¡ä¸ç”šäº†è§£çš„è¯»è€…ï¼Œè¯·åœ¨äº†è§£åˆ†å¸ƒå¼äº‹åŠ¡ä¹‹å‰ï¼Œå…ˆé˜…è¯»è¿™ç¯‡æ–‡ç« <a href="https://icyfenix.cn/architect-perspective/general-architecture/transaction/local.html">æœ¬åœ°äº‹åŠ¡</a></p><p>å½“æˆ‘ä»¬çš„é¡¹ç›®åºå¤§ä»¥å, ä¸ºäº†æ€§èƒ½çš„ä¼˜åŒ–, æˆ‘ä»¬é¦–å…ˆéœ€è¦æ‹†åˆ†é¡¹ç›®æ¨¡å—, ä½¿ä¹‹å˜æˆåˆ†å¸ƒå¼é¡¹ç›®. æ•°æ®åº“ä¹Ÿè¦è¿›è¡Œæ¨¡å—åˆ‡å‰². åœ¨ä¼ ç»Ÿçš„å•ä½“æ¶æ„ä¸‹, æˆ‘ä»¬åªä¼šåœ¨ä¸€ä¸ªæ•°æ®åº“ä¸­è¿›è¡Œäº‹åŠ¡æ“ä½œ, è¿™ç§äº‹åŠ¡çš„æ§åˆ¶éå¸¸ç®€å•. ä½†åœ¨åˆ†å¸ƒå¼æ¶æ„ä¸‹ï¼Œä¸€ä¸ªè¯·æ±‚è°ƒç”¨é“¾å¯èƒ½ä¼šç»è¿‡å¤šä¸ªæœåŠ¡ï¼Œæ“ä½œå¤šä¸ªæ•°æ®åº“ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œäº‹åŠ¡è¢«åˆ†æ•£åˆ°äº†å„ä¸ªå­ç³»ç»Ÿä¸­ï¼Œåˆ†å¸ƒå¼æ¶æ„äº‹åŠ¡ï¼ˆä¸‹é¢ç®€ç§°åˆ†å¸ƒå¼äº‹åŠ¡ï¼‰é—®é¢˜æ˜¾å¾—å°¤ä¸ºé‡è¦ï¼Œç‰¹åˆ«æ˜¯åœ¨é‡‘èç”µå•†é¢†åŸŸï¼Œå¦‚æœåˆ†å¸ƒå¼äº‹åŠ¡æ²¡æ§åˆ¶å¥½ï¼ŒæŸå¤±çš„å°±æ˜¯æ˜¯çœŸé‡‘ç™½é“¶</p><p>æ•°æ®åº“æ•°æ®ä¸€è‡´æ€§çš„å¼ºåº¦å¯ä»¥åˆ†ä¸ºä¸‰ç§ï¼š</p><ul><li>å¼ºä¸€è‡´æ€§ï¼šè¦æ±‚æ•°æ®åº“ä¸­æ›´æ–°åçš„æ•°æ®èƒ½ç«‹å³å¯¹å¤–å¯è§ï¼›</li><li>å¼±ä¸€è‡´æ€§ï¼šèƒ½å¤Ÿå®¹å¿æ•°æ®åº“ä¸­éƒ¨åˆ†æ›´æ–°åçš„æ•°æ®ï¼Œå¯¹å¤–ä¸å¯è§ï¼›</li><li>æœ€ç»ˆä¸€è‡´æ€§ï¼šè¦æ±‚æ•°æ®åº“ä¸­æ›´æ–°åçš„æ•°æ®åœ¨ä¸€æ®µæ—¶é—´å (è¿™ä¸ªæ—¶é—´åŒºé—´çš„é•¿åº¦ä¸»è¦å—ç½‘ç»œé€šä¿¡å»¶è¿Ÿ, ç³»ç»Ÿè´Ÿè½½ç­‰å› ç´ å½±å“) å¯¹å¤–å¯è§</li></ul><p><img src="/image/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/format,png-20220328161219693.png" alt="img"></p><h2 id="2PC"><a href="#2PC" class="headerlink" title="2PC"></a><a href="https://icyfenix.cn/architect-perspective/general-architecture/transaction/global.html">2PC</a></h2><p>2PC æ˜¯åŸºäº <code>XA</code> åè®®å®ç°çš„åˆ†å¸ƒå¼äº‹åŠ¡. <code>XA</code> åè®®åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ† : äº‹åŠ¡ç®¡ç†å™¨å’Œæœ¬åœ°èµ„æºç®¡ç†å™¨. å…¶ä¸­æœ¬åœ°èµ„æºç®¡ç†å™¨é€šå¸¸ç”±æ•°æ®åº“å®ç°, æ¯”å¦‚ Oracleã€Mysql. è€Œäº‹åŠ¡ç®¡ç†å™¨åˆ™ä½œä¸ºä¸€ä¸ªå…¨å±€çš„è°ƒåº¦è€….</p><p>2PC å¯¹ä¸šåŠ¡ä¾µå…¥å¾ˆå°, å®ƒæœ€å¤§çš„ä¼˜åŠ¿å°±æ˜¯å¯¹ä½¿ç”¨æ–¹é€æ˜, ç”¨æˆ·å¯ä»¥åƒä½¿ç”¨æœ¬åœ°äº‹åŠ¡ä¸€æ ·ä½¿ç”¨åŸºäº <code>XA</code> åè®®çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œèƒ½å¤Ÿä¸¥æ ¼ä¿éšœäº‹åŠ¡ ACID ç‰¹æ€§</p><p>2PC çš„ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾, å®ƒæ˜¯ä¸€ä¸ªå¼ºä¸€è‡´æ€§çš„åŒæ­¥é˜»å¡åè®®ï¼Œäº‹åŠ¡æ‰§â¾è¿‡ç¨‹ä¸­éœ€è¦å°†æ‰€éœ€èµ„æºå…¨éƒ¨é”å®šï¼Œä¹Ÿå°±æ˜¯ä¿—ç§°çš„ <code>åˆšæ€§äº‹åŠ¡</code>ã€‚æ‰€ä»¥å®ƒæ¯”è¾ƒé€‚â½¤äºæ‰§â¾æ—¶é—´ç¡®å®šçš„çŸ­äº‹åŠ¡ï¼Œæ•´ä½“æ€§èƒ½æ¯”è¾ƒå·®</p><p><strong>å¤§è‡´çš„æµç¨‹ :</strong></p><p><img src="https://img-blog.csdnimg.cn/20201118174832330.png#pic_center" alt="img"></p><p>ç¬¬ä¸€é˜¶æ®µï¼ˆprepareï¼‰ï¼šäº‹åŠ¡ç®¡ç†å™¨å‘æ‰€æœ‰æœ¬åœ°èµ„æºç®¡ç†å™¨å‘èµ·è¯·æ±‚ï¼Œè¯¢é—®æ˜¯å¦æ˜¯ ready çŠ¶æ€ï¼Œæ‰€æœ‰å‚ä¸è€…éƒ½å°†æœ¬äº‹åŠ¡èƒ½å¦æˆåŠŸçš„ä¿¡æ¯åé¦ˆå‘ç»™åè°ƒè€…</p><p><img src="https://img-blog.csdnimg.cn/20201118174947450.png#pic_center" alt="img"></p><p>ç¬¬äºŒé˜¶æ®µ (commit&#x2F;rollback)ï¼šäº‹åŠ¡ç®¡ç†å™¨æ ¹æ®æ‰€æœ‰æœ¬åœ°èµ„æºç®¡ç†å™¨çš„åé¦ˆï¼Œé€šçŸ¥æ‰€æœ‰æœ¬åœ°èµ„æºç®¡ç†å™¨ï¼Œæ­¥è°ƒä¸€è‡´åœ°åœ¨æ‰€æœ‰åˆ†æ”¯ä¸Šæäº¤æˆ–è€…å›æ»šã€‚</p><p><strong>å­˜åœ¨çš„é—®é¢˜ :</strong></p><ul><li>åŒæ­¥é˜»å¡ï¼šå½“å‚ä¸äº‹åŠ¡è€…å­˜åœ¨å ç”¨å…¬å…±èµ„æºçš„æƒ…å†µï¼Œå…¶ä¸­ä¸€ä¸ªå ç”¨äº†èµ„æºï¼Œå…¶ä»–äº‹åŠ¡å‚ä¸è€…å°±åªèƒ½é˜»å¡ç­‰å¾…èµ„æºé‡Šæ”¾ï¼Œå¤„äºé˜»å¡çŠ¶æ€ã€‚</li><li>å•ç‚¹æ•…éšœï¼šä¸€æ—¦äº‹åŠ¡ç®¡ç†å™¨å‡ºç°æ•…éšœï¼Œæ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨</li><li>æ•°æ®ä¸ä¸€è‡´ï¼šåœ¨é˜¶æ®µäºŒï¼Œå¦‚æœäº‹åŠ¡ç®¡ç†å™¨åªå‘é€äº†éƒ¨åˆ† commit æ¶ˆæ¯ï¼Œæ­¤æ—¶ç½‘ç»œå‘ç”Ÿå¼‚å¸¸ï¼Œé‚£ä¹ˆåªæœ‰éƒ¨åˆ†å‚ä¸è€…æ¥æ”¶åˆ° commit æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰éƒ¨åˆ†å‚ä¸è€…æäº¤äº†äº‹åŠ¡ï¼Œä½¿å¾—ç³»ç»Ÿæ•°æ®ä¸ä¸€è‡´ã€‚</li><li>ä¸ç¡®å®šæ€§ï¼šå½“åäº‹åŠ¡ç®¡ç†å™¨å‘é€ commit ä¹‹åï¼Œå¹¶ä¸”æ­¤æ—¶åªæœ‰ä¸€ä¸ªå‚ä¸è€…æ”¶åˆ°äº† commitï¼Œé‚£ä¹ˆå½“è¯¥å‚ä¸è€…ä¸äº‹åŠ¡ç®¡ç†å™¨åŒæ—¶å®•æœºä¹‹åï¼Œé‡æ–°é€‰ä¸¾çš„äº‹åŠ¡ç®¡ç†å™¨æ— æ³•ç¡®å®šè¯¥æ¡æ¶ˆæ¯æ˜¯å¦æäº¤æˆåŠŸã€‚</li></ul><h2 id="3PC"><a href="#3PC" class="headerlink" title="3PC"></a><a href="https://icyfenix.cn/architect-perspective/general-architecture/transaction/global.html#:~:text=%E4%B8%8D%E4%B8%80%E8%87%B4%E7%9A%84%E9%97%AE%E9%A2%98%E3%80%82-,%E4%B8%BA%E4%BA%86,-%E7%BC%93%E8%A7%A3%E4%B8%A4%E6%AE%B5%E5%BC%8F%E6%8F%90%E4%BA%A4"><strong>3PC</strong></a></h2><p>3PC æ˜¯ 2PC çš„ä¸€ç§æ”¹è¿›ç‰ˆæœ¬, ä¸ºè§£å†³ä¸¤é˜¶æ®µæäº¤åè®®çš„<strong>é˜»å¡é—®é¢˜</strong>, ä¸Šè¾¹æåˆ°ä¸¤æ®µæäº¤, å½“åè°ƒè€…å´©æºƒæ—¶, å‚ä¸è€…ä¸èƒ½åšå‡ºæœ€åçš„é€‰æ‹©ï¼Œå°±ä¼šä¸€ç›´ä¿æŒé˜»å¡é”å®šèµ„æº</p><p>2PC ä¸­åªæœ‰åè°ƒè€…æœ‰è¶…æ—¶æœºåˆ¶ï¼Œ3PC åœ¨åè°ƒè€…å’Œå‚ä¸è€…ä¸­éƒ½å¼•å…¥äº†è¶…æ—¶æœºåˆ¶ï¼Œåè°ƒè€…å‡ºç°æ•…éšœåï¼Œå‚ä¸è€…å°±ä¸ä¼šä¸€ç›´é˜»å¡ã€‚</p><p>è€Œä¸”åœ¨ç¬¬ä¸€é˜¶æ®µå’Œç¬¬äºŒé˜¶æ®µä¸­åˆæ’å…¥äº†ä¸€ä¸ªå‡†å¤‡é˜¶æ®µï¼ˆå¦‚ä¸‹å›¾ï¼Œçœ‹ç€æœ‰ç‚¹å•°å—¦ï¼‰ï¼Œä¿è¯äº†åœ¨æœ€åæäº¤é˜¶æ®µä¹‹å‰å„å‚ä¸èŠ‚ç‚¹çš„çŠ¶æ€æ˜¯ä¸€è‡´çš„</p><p><img src="/image/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/20201119154252414.png" alt="img"></p><p>è™½ç„¶ 3PC ç”¨è¶…æ—¶æœºåˆ¶ï¼Œè§£å†³äº†åè°ƒè€…æ•…éšœåå‚ä¸è€…çš„é˜»å¡é—®é¢˜ï¼Œä½†ä¸æ­¤åŒæ—¶å´å¤šäº†ä¸€æ¬¡ç½‘ç»œé€šä¿¡ï¼Œæ€§èƒ½ä¸Šåè€Œå˜å¾—æ›´å·®ï¼Œä¹Ÿä¸å¤ªæ¨èã€‚</p><h2 id="TCC"><a href="#TCC" class="headerlink" title="TCC"></a><a href="https://icyfenix.cn/architect-perspective/general-architecture/transaction/distributed.html#tcc-%E4%BA%8B%E5%8A%A1"><strong>TCC</strong></a></h2><p>TCC ä¹Ÿæ˜¯ä¸€ç§ä¸¤é˜¶æ®µæäº¤åè®®ï¼Œå¯ä»¥çœ‹ä½œ 2PC&#x2F;XA çš„ä¸€ç§å˜ç§ï¼Œä½†æ˜¯ä¸ä¼šé•¿æ—¶é—´æŒæœ‰èµ„æºé”ã€‚è™½ç„¶å¯¹ä»£ç ä¾µå…¥å¾ˆå¤§ï¼Œä½†æ˜¯æ€§èƒ½éå¸¸ä¼˜å¼‚ã€‚</p><p>å…³äº TCCï¼ˆTry-Confirm-Cancelï¼‰çš„æ¦‚å¿µï¼Œæœ€æ—©æ˜¯ç”± Pat Helland äº 2007 å¹´å‘è¡¨çš„ä¸€ç¯‡åä¸ºã€ŠLife beyond Distributed Transactions:an Apostateâ€™s Opinionã€‹çš„è®ºæ–‡æå‡ºã€‚ TCC äº‹åŠ¡æœºåˆ¶ç›¸æ¯”äºä¸Šé¢ä»‹ç»çš„ XAï¼Œè§£å†³äº†å…¶å‡ ä¸ªç¼ºç‚¹ï¼š</p><ul><li>è§£å†³äº†åè°ƒè€…å•ç‚¹ï¼Œç”±ä¸»ä¸šåŠ¡æ–¹å‘èµ·å¹¶å®Œæˆè¿™ä¸ªä¸šåŠ¡æ´»åŠ¨ã€‚ä¸šåŠ¡æ´»åŠ¨ç®¡ç†å™¨ä¹Ÿå˜æˆå¤šç‚¹ï¼Œå¼•å…¥é›†ç¾¤ã€‚</li><li>åŒæ­¥é˜»å¡ï¼šå¼•å…¥è¶…æ—¶ï¼Œè¶…æ—¶åè¿›è¡Œè¡¥å¿ï¼Œå¹¶ä¸”ä¸ä¼šé”å®šæ•´ä¸ªèµ„æºï¼Œå°†èµ„æºè½¬æ¢ä¸ºä¸šåŠ¡é€»è¾‘å½¢å¼ï¼Œç²’åº¦å˜å°ã€‚</li><li>æ•°æ®ä¸€è‡´æ€§ï¼Œæœ‰äº†è¡¥å¿æœºåˆ¶ä¹‹åï¼Œç”±ä¸šåŠ¡æ´»åŠ¨ç®¡ç†å™¨æ§åˆ¶ä¸€è‡´æ€§</li></ul><p><strong>Try :</strong> å°è¯•æ‰§è¡Œï¼Œå®Œæˆæ‰€æœ‰ä¸šåŠ¡æ£€æŸ¥ï¼ˆä¸€è‡´æ€§ï¼‰, é¢„ç•™å¿…é¡»ä¸šåŠ¡èµ„æºï¼ˆå‡†éš”ç¦»æ€§ï¼‰ï¼Œå¦‚å†»ç»“é‡‘é¢ã€‚</p><p><strong>Confirm :</strong> ç¡®è®¤æ‰§è¡ŒçœŸæ­£æ‰§è¡Œä¸šåŠ¡ï¼Œä¸ä½œä»»ä½•ä¸šåŠ¡æ£€æŸ¥ï¼Œåªä½¿ç”¨ Try é˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æºï¼ŒConfirm æ“ä½œæ»¡è¶³å¹‚ç­‰æ€§ã€‚è¦æ±‚å…·å¤‡å¹‚ç­‰è®¾è®¡ï¼ŒConfirm å¤±è´¥åéœ€è¦è¿›è¡Œé‡è¯•ã€‚</p><p><strong>Cancel :</strong> å–æ¶ˆæ‰§è¡Œï¼Œé‡Šæ”¾ Try é˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æº Cancel æ“ä½œæ»¡è¶³å¹‚ç­‰æ€§ Cancel é˜¶æ®µçš„å¼‚å¸¸å’Œ Confirm é˜¶æ®µå¼‚å¸¸å¤„ç†æ–¹æ¡ˆåŸºæœ¬ä¸Šä¸€è‡´ã€‚</p><p>åœ¨ Try é˜¶æ®µï¼Œæ˜¯å¯¹ä¸šåŠ¡ç³»ç»Ÿè¿›è¡Œæ£€æŸ¥åŠèµ„æºé¢„è§ˆï¼Œæ¯”å¦‚è®¢å•å’Œå­˜å‚¨æ“ä½œï¼Œéœ€è¦æ£€æŸ¥åº“å­˜å‰©ä½™æ•°é‡æ˜¯å¦å¤Ÿç”¨ï¼Œå¹¶è¿›è¡Œé¢„ç•™ï¼Œé¢„ç•™æ“ä½œçš„è¯å°±æ˜¯æ–°å»ºä¸€ä¸ªå¯ç”¨åº“å­˜æ•°é‡å­—æ®µï¼ŒTry é˜¶æ®µæ“ä½œæ˜¯å¯¹è¿™ä¸ªå¯ç”¨åº“å­˜æ•°é‡è¿›è¡Œæ“ä½œã€‚</p><p>åŸºäº TCC å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä¼šå°†åŸæ¥åªéœ€è¦ä¸€ä¸ªæ¥å£å°±å¯ä»¥å®ç°çš„é€»è¾‘æ‹†åˆ†ä¸º Tryã€Confirmã€Cancel ä¸‰ä¸ªæ¥å£ï¼Œæ‰€ä»¥ä»£ç å®ç°å¤æ‚åº¦ç›¸å¯¹è¾ƒé«˜ã€‚</p><h3 id="ä¸‰ä¸ªé—®é¢˜"><a href="#ä¸‰ä¸ªé—®é¢˜" class="headerlink" title="ä¸‰ä¸ªé—®é¢˜"></a>ä¸‰ä¸ªé—®é¢˜</h3><p><strong>ç©ºå›æ»š</strong></p><ul><li>Cancel æ¥å£è®¾è®¡æ—¶éœ€è¦å…è®¸ç©ºå›æ»šã€‚åœ¨ Try æ¥å£å› ä¸ºä¸¢åŒ…æ—¶æ²¡æœ‰æ”¶åˆ°ï¼Œäº‹åŠ¡ç®¡ç†å™¨ä¼šè§¦å‘å›æ»šï¼Œè¿™æ—¶ä¼šè§¦å‘ Cancel æ¥å£ï¼Œè¿™æ—¶ Cancel æ‰§è¡Œæ—¶å‘ç°æ²¡æœ‰å¯¹åº”çš„äº‹åŠ¡ xid æˆ–ä¸»é”®æ—¶ï¼Œéœ€è¦è¿”å›å›æ»šæˆåŠŸã€‚è®©äº‹åŠ¡æœåŠ¡ç®¡ç†å™¨è®¤ä¸ºå·²å›æ»šï¼Œå¦åˆ™ä¼šä¸æ–­é‡è¯•ï¼Œè€Œ Cancel åˆæ²¡æœ‰å¯¹åº”çš„ä¸šåŠ¡æ•°æ®å¯ä»¥è¿›è¡Œå›æ»š</li></ul><p><strong>é˜²æ‚¬æŒ‚</strong></p><ul><li>æ‚¬æŒ‚çš„æ„æ€æ˜¯ï¼šCancel æ¯” Try æ¥å£å…ˆæ‰§è¡Œï¼Œå‡ºç°çš„åŸå› æ˜¯ Try ç”±äºç½‘ç»œæ‹¥å µè€Œè¶…æ—¶ï¼Œäº‹åŠ¡ç®¡ç†å™¨ç”Ÿæˆå›æ»šï¼Œè§¦å‘ Cancel æ¥å£ï¼Œè€Œæœ€ç»ˆåˆæ”¶åˆ°äº† Try æ¥å£è°ƒç”¨ï¼Œä½†æ˜¯ Cancel æ¯” Try å…ˆåˆ°ã€‚æŒ‰ç…§å‰é¢å…è®¸ç©ºå›æ»šçš„é€»è¾‘ï¼Œå›æ»šä¼šè¿”å›æˆåŠŸï¼Œäº‹åŠ¡ç®¡ç†å™¨è®¤ä¸ºäº‹åŠ¡å·²å›æ»šæˆåŠŸï¼Œåˆ™æ­¤æ—¶çš„ Try æ¥å£ä¸åº”è¯¥æ‰§è¡Œï¼Œå¦åˆ™ä¼šäº§ç”Ÿæ•°æ®ä¸ä¸€è‡´ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ Cancel ç©ºå›æ»šè¿”å›æˆåŠŸä¹‹å‰å…ˆè®°å½•è¯¥æ¡äº‹åŠ¡ xid æˆ–ä¸šåŠ¡ä¸»é”®ï¼Œæ ‡è¯†è¿™æ¡è®°å½•å·²ç»å›æ»šè¿‡ï¼ŒTry æ¥å£å…ˆæ£€æŸ¥è¿™æ¡äº‹åŠ¡xidæˆ–ä¸šåŠ¡ä¸»é”®å¦‚æœå·²ç»æ ‡è®°ä¸ºå›æ»šæˆåŠŸè¿‡ï¼Œåˆ™ä¸æ‰§è¡Œ Try çš„ä¸šåŠ¡æ“ä½œ</li></ul><p><strong>å¹‚ç­‰æ§åˆ¶</strong></p><ul><li>å¹‚ç­‰æ€§çš„æ„æ€æ˜¯ï¼šå¯¹åŒä¸€ä¸ªç³»ç»Ÿï¼Œä½¿ç”¨åŒæ ·çš„æ¡ä»¶ï¼Œä¸€æ¬¡è¯·æ±‚å’Œé‡å¤çš„å¤šæ¬¡è¯·æ±‚å¯¹ç³»ç»Ÿèµ„æºçš„å½±å“æ˜¯ä¸€è‡´çš„ã€‚å› ä¸ºç½‘ç»œæŠ–åŠ¨æˆ–æ‹¥å µå¯èƒ½ä¼šè¶…æ—¶ï¼Œäº‹åŠ¡ç®¡ç†å™¨ä¼šå¯¹èµ„æºè¿›è¡Œé‡è¯•æ“ä½œï¼Œæ‰€ä»¥å¾ˆå¯èƒ½ä¸€ä¸ªä¸šåŠ¡æ“ä½œä¼šè¢«é‡å¤è°ƒç”¨ï¼Œä¸ºäº†ä¸å› ä¸ºé‡å¤è°ƒç”¨è€Œå¤šæ¬¡å ç”¨èµ„æºï¼Œéœ€è¦å¯¹æœåŠ¡è®¾è®¡æ—¶è¿›è¡Œå¹‚ç­‰æ§åˆ¶ï¼Œé€šå¸¸æˆ‘ä»¬å¯ä»¥ç”¨äº‹åŠ¡ xid æˆ–ä¸šåŠ¡ä¸»é”®åˆ¤é‡æ¥æ§åˆ¶</li></ul><h2 id="æœ€ç»ˆä¸€è‡´æ€§"><a href="#æœ€ç»ˆä¸€è‡´æ€§" class="headerlink" title="æœ€ç»ˆä¸€è‡´æ€§"></a>æœ€ç»ˆä¸€è‡´æ€§</h2><p>æ¶ˆæ¯å¯¹åˆ—+æœ¬åœ°äº‹åŠ¡è¡¨+å®šæ—¶å™¨çš„æ–¹å¼ä¸»è¦æ˜¯ç”¨äºæœ€ç»ˆä¸€è‡´æ€§çš„åœºåˆï¼Œç‰ºç‰²å¼ºä¸€è‡´æ€§ï¼Œæå‡æ€§èƒ½</p><h3 id="æ¶ˆæ¯é˜Ÿåˆ—äº‹åŠ¡"><a href="#æ¶ˆæ¯é˜Ÿåˆ—äº‹åŠ¡" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—äº‹åŠ¡"></a><a href="https://icyfenix.cn/architect-perspective/general-architecture/transaction/distributed.html#%E5%8F%AF%E9%9D%A0%E4%BA%8B%E4%BB%B6%E9%98%9F%E5%88%97">æ¶ˆæ¯é˜Ÿåˆ—äº‹åŠ¡</a></h3><ul><li>åŸºäºæ¶ˆæ¯ä¸­é—´ä»¶çš„ 2PC æ–¹æ¡ˆï¼Œé€šå¸¸ç”¨åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ä½¿ç”¨ï¼Œç‰ºç‰²æ•°æ®çš„å¼ºä¸€è‡´æ€§æ¢å–æ€§èƒ½çš„å¤§å¹…æå‡ï¼Œä¸è¿‡å®ç°è¿™ç§æ–¹å¼çš„æˆæœ¬å’Œå¤æ‚åº¦æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œè¿˜è¦çœ‹å®é™…ä¸šåŠ¡æƒ…å†µ</li><li>æ¶ˆæ¯é˜Ÿåˆ—çš„æ–¹æ¡ˆæ— æ³•éå¸¸ä¼˜ç§€çš„è§£å†³ä¸‹æ¸¸äº‹åŠ¡å¤±è´¥å, è®©ä¸Šæ¸¸è¿›è¡Œæ•°æ®å›æ»š. å› ä¸ºä¸¤è€…æ˜¯å®Œå…¨è§£è€¦çš„, å¤æ‚åº¦å¤ªé«˜. æ¨èçš„åšæ³•æ˜¯è®°å½•å¼‚å¸¸ä¿¡æ¯å¹¶è¿›è¡Œäººå·¥å¤„ç†</li></ul><p><img src="/image/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/362411093-5d882d3d41c8d_articlex.png" alt="img"></p><h3 id="æœ¬åœ°æ¶ˆæ¯è¡¨"><a href="#æœ¬åœ°æ¶ˆæ¯è¡¨" class="headerlink" title="æœ¬åœ°æ¶ˆæ¯è¡¨"></a><del>æœ¬åœ°æ¶ˆæ¯è¡¨</del></h3><p><font color='red'>å¦‚æœä½ çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸æ”¯æŒäº‹åŠ¡æ¶ˆæ¯çš„æƒ…å†µä¸‹, å¹¶ä¸”æ‹…å¿ƒ Mq ä¼šä¸¢å¤±æ¶ˆæ¯çš„è¯. å¯ä»¥ä½¿ç”¨è¯¥æ–¹æ¡ˆ, ä½†æ˜¯ä¼šé¢å¤–å æ®æ•°æ®åº“è´Ÿè½½</font></p><ol><li>ç³»ç»Ÿæ”¶åˆ°ç”¨æˆ·ä¸‹å•è¯·æ±‚ï¼Œå°†è®¢å•ä¸šåŠ¡æ•°æ®å†™å…¥è®¢å•è¡¨ä¸­ï¼ŒåŒæ—¶æŠŠè¯¥è®¢å•å¯¹åº”çš„æ¶ˆæ¯æ•°æ®å†™å…¥æœ¬åœ°æ¶ˆæ¯è¡¨ä¸­ï¼Œè®¢å•è¡¨ä¸æœ¬åœ°æ¶ˆæ¯è¡¨ä¸ºåŒä¸€ä¸ªæ•°æ®åº“ï¼Œæ›´æ–°è®¢å•å’Œå­˜å‚¨æ¶ˆæ¯ä¸ºåŒä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ï¼Œæ•°æ®åº“äº‹åŠ¡å¤„ç†ï¼Œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ã€‚</li><li>è®¢å•æœåŠ¡å‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåº“å­˜æœåŠ¡æ”¶åˆ°æ¶ˆæ¯ï¼Œè¿›è¡Œåº“å­˜ä¸šåŠ¡æ“ä½œï¼Œæ›´æ–°åº“å­˜æ•°æ®</li><li>è¿”å›ä¸šåŠ¡å¤„ç†ç»“æœï¼Œè®¢å•æœåŠ¡æ”¶åˆ°ç»“æœåï¼Œå°†æœ¬åœ°æ¶ˆæ¯è¡¨ä¸­çš„æ•°æ®è®¾ç½®å®ŒæˆçŠ¶æ€æˆ–è€…åˆ é™¤æ•°æ®ã€‚</li><li>å¦èµ·å®šæ—¶ä»»åŠ¡ï¼Œå®šæ—¶æ‰«ææœ¬åœ°æ¶ˆæ¯è¡¨ï¼Œçœ‹æ˜¯å¦æœ‰æœªå®Œæˆçš„ä»»åŠ¡ï¼Œæœ‰åˆ™é‡è¯•ã€‚</li></ol><p><img src="/image/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/ded2a136db5d41b781f5d1ec9e1fed83.png" alt="img"></p><h3 id="æœ€å¤§åŠªåŠ›é€šçŸ¥"><a href="#æœ€å¤§åŠªåŠ›é€šçŸ¥" class="headerlink" title="æœ€å¤§åŠªåŠ›é€šçŸ¥"></a><strong>æœ€å¤§åŠªåŠ›é€šçŸ¥</strong></h3><p><font color='gray'>ç¬¬ä¸‰æ–¹ä½¿ç”¨æ”¯ä»˜å®ä»˜æ¬¾ï¼Œæ”¯ä»˜å®æˆåŠŸåå‘é€ç»“æœå›è°ƒç»™ç¬¬ä¸‰æ–¹ï¼Œè¿™ä¸ªç»“æœå°±éœ€è¦æœ€å¤§åŠªåŠ›é€šçŸ¥çš„æœºåˆ¶æ¥å¤„ç†ã€‚</font></p><p>æœ€å¤§åŠªåŠ›é€šçŸ¥æ˜¯æœ€ç®€å•çš„ä¸€ç§æŸ”æ€§äº‹åŠ¡ï¼Œé€‚ç”¨äºä¸€äº›æœ€ç»ˆä¸€è‡´æ€§æ—¶é—´æ•æ„Ÿåº¦ä½çš„ä¸šåŠ¡ï¼Œä¸”è¢«åŠ¨æ–¹å¤„ç†ç»“æœ ä¸å½±å“ä¸»åŠ¨æ–¹çš„å¤„ç†ç»“æœã€‚</p><p>è¿™ä¸ªæ–¹æ¡ˆçš„å¤§è‡´æ„æ€å°±æ˜¯ï¼š</p><ul><li>ç³»ç»Ÿ A æœ¬åœ°äº‹åŠ¡æ‰§è¡Œå®Œä¹‹åï¼Œå‘é€ä¸ªæ¶ˆæ¯åˆ° MQï¼›</li><li>è¿™é‡Œä¼šæœ‰ä¸ªä¸“é—¨æ¶ˆè´¹ MQ çš„æœåŠ¡ï¼Œè¿™ä¸ªæœåŠ¡ä¼šæ¶ˆè´¹ MQ å¹¶è°ƒç”¨ç³»ç»Ÿ B çš„æ¥å£ï¼›</li><li>è¦æ˜¯ç³»ç»Ÿ B æ‰§è¡ŒæˆåŠŸå°± ok äº†ï¼›è¦æ˜¯ç³»ç»Ÿ B æ‰§è¡Œå¤±è´¥äº†ï¼Œé‚£ä¹ˆæœ€å¤§åŠªåŠ›é€šçŸ¥æœåŠ¡å°±å®šæ—¶å°è¯•é‡æ–°è°ƒç”¨ç³»ç»Ÿ B, åå¤ N æ¬¡ï¼Œæœ€åè¿˜æ˜¯ä¸è¡Œå°±æ”¾å¼ƒã€‚</li></ul><h2 id="æ‰©å±•å»¶ä¼¸"><a href="#æ‰©å±•å»¶ä¼¸" class="headerlink" title="æ‰©å±•å»¶ä¼¸"></a>æ‰©å±•å»¶ä¼¸</h2><p><a href="/2022/03/28/Distributed%20System/Seata/">Seata</a></p>]]></content>
    
    
    <categories>
      
      <category>Distributed System</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>è´Ÿè½½å‡è¡¡ç­–ç•¥</title>
    <link href="/2022/03/28/Distributed%20System/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5/"/>
    <url>/2022/03/28/Distributed%20System/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5/</url>
    
    <content type="html"><![CDATA[<h2 id="éšæœºè°ƒç”¨"><a href="#éšæœºè°ƒç”¨" class="headerlink" title="éšæœºè°ƒç”¨"></a>éšæœºè°ƒç”¨</h2><ul><li>é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å…¨éšæœºçš„ï¼Œæ— æ³•æ§åˆ¶ã€‚</li></ul><h2 id="é¡ºåºè½®è¯¢"><a href="#é¡ºåºè½®è¯¢" class="headerlink" title="é¡ºåºè½®è¯¢"></a>é¡ºåºè½®è¯¢</h2><ul><li>è·å–åˆ°æœåŠ¡æ¶ˆè´¹è€…åˆ—è¡¨åï¼ŒæŒ‰ç…§é¡ºåºå¾ªç¯è°ƒç”¨ã€‚</li></ul><h2 id="éšæœºæƒé‡"><a href="#éšæœºæƒé‡" class="headerlink" title="éšæœºæƒé‡"></a>éšæœºæƒé‡</h2><ul><li>å¯ä»¥å¯¹ provider ä¸åŒå®ä¾‹è®¾ç½®ä¸åŒçš„æƒé‡ï¼Œä¼šæŒ‰ç…§æƒé‡æ¥è´Ÿè½½å‡è¡¡ï¼Œæƒé‡è¶Šå¤§åˆ†é…æµé‡è¶Šé«˜ã€‚</li><li>ç®—æ³•æ€æƒ³å¾ˆç®€å•ã€‚å‡è®¾æœ‰ä¸€ç»„æœåŠ¡å™¨ servers &#x3D; [A, B, C]ï¼Œä»–ä»¬å¯¹åº”çš„æƒé‡ä¸º weights &#x3D; [5, 3, 2]ï¼Œæƒé‡æ€»å’Œä¸º 10ã€‚ç°åœ¨æŠŠè¿™äº›æƒé‡å€¼å¹³é“ºåœ¨ä¸€ç»´åæ ‡å€¼ä¸Šï¼Œ[0, 5) åŒºé—´å±äºæœåŠ¡å™¨ Aï¼Œ[5, 8) åŒºé—´å±äºæœåŠ¡å™¨ Bï¼Œ[8, 10) åŒºé—´å±äºæœåŠ¡å™¨ Cã€‚æ¥ä¸‹æ¥é€šè¿‡éšæœºæ•°ç”Ÿæˆå™¨ç”Ÿæˆä¸€ä¸ªèŒƒå›´åœ¨ [0, 10) ä¹‹é—´çš„éšæœºæ•°ï¼Œç„¶åè®¡ç®—è¿™ä¸ªéšæœºæ•°ä¼šè½åˆ°å“ªä¸ªåŒºé—´ä¸Šã€‚æ¯”å¦‚æ•°å­— 3 ä¼šè½åˆ°æœåŠ¡å™¨ A å¯¹åº”çš„åŒºé—´ä¸Šï¼Œæ­¤æ—¶è¿”å›æœåŠ¡å™¨ A å³å¯ã€‚æƒé‡è¶Šå¤§çš„æœºå™¨ï¼Œåœ¨åæ ‡è½´ä¸Šå¯¹åº”çš„åŒºé—´èŒƒå›´å°±è¶Šå¤§ï¼Œå› æ­¤éšæœºæ•°ç”Ÿæˆå™¨ç”Ÿæˆçš„æ•°å­—å°±ä¼šæœ‰æ›´å¤§çš„æ¦‚ç‡è½åˆ°æ­¤åŒºé—´å†…ã€‚åªè¦éšæœºæ•°ç”Ÿæˆå™¨äº§ç”Ÿçš„éšæœºæ•°åˆ†å¸ƒæ€§å¾ˆå¥½ï¼Œåœ¨ç»è¿‡å¤šæ¬¡é€‰æ‹©åï¼Œæ¯ä¸ªæœåŠ¡å™¨è¢«é€‰ä¸­çš„æ¬¡æ•°æ¯”ä¾‹æ¥è¿‘å…¶æƒé‡æ¯”ä¾‹ã€‚æ¯”å¦‚ï¼Œç»è¿‡ä¸€ä¸‡æ¬¡é€‰æ‹©åï¼ŒæœåŠ¡å™¨ A è¢«é€‰ä¸­çš„æ¬¡æ•°å¤§çº¦ä¸º 5000 æ¬¡ï¼ŒæœåŠ¡å™¨ B è¢«é€‰ä¸­çš„æ¬¡æ•°çº¦ä¸º 3000 æ¬¡ï¼ŒæœåŠ¡å™¨ C è¢«é€‰ä¸­çš„æ¬¡æ•°çº¦ä¸º 2000 æ¬¡ã€‚</li></ul><h2 id="è½®è¯¢æƒé‡-åŠ æƒè½®è¯¢"><a href="#è½®è¯¢æƒé‡-åŠ æƒè½®è¯¢" class="headerlink" title="è½®è¯¢æƒé‡(åŠ æƒè½®è¯¢)"></a>è½®è¯¢æƒé‡(åŠ æƒè½®è¯¢)</h2><ul><li>ç”Ÿæˆä¸€ä¸ªæœåŠ¡å™¨åºåˆ—ï¼Œè¯¥åºåˆ—ä¸­åŒ…å«nä¸ªæœåŠ¡å™¨ã€‚næ˜¯æ‰€æœ‰æœåŠ¡å™¨çš„æƒé‡ä¹‹å’Œã€‚åœ¨è¯¥åºåˆ—ä¸­ï¼Œæ¯ä¸ªæœåŠ¡å™¨çš„å‡ºç°çš„æ¬¡æ•°ï¼Œç­‰äºå…¶æƒé‡å€¼ã€‚å¹¶ä¸”ï¼Œç”Ÿæˆçš„åºåˆ—ä¸­ï¼ŒæœåŠ¡å™¨çš„åˆ†å¸ƒåº”è¯¥å°½å¯èƒ½çš„å‡åŒ€ã€‚æ¯”å¦‚åºåˆ—{a, a, a, a, a, b, c}ä¸­ï¼Œå‰äº”ä¸ªè¯·æ±‚éƒ½ä¼šåˆ†é…ç»™æœåŠ¡å™¨aï¼Œè¿™å°±æ˜¯ä¸€ç§ä¸å‡åŒ€çš„åˆ†é…æ–¹æ³•ï¼Œæ›´å¥½çš„åºåˆ—åº”è¯¥æ˜¯ï¼š{a, a, b, a, c, a, a}ã€‚</li></ul><h2 id="å¹³æ»‘åŠ æƒè½®è¯¢"><a href="#å¹³æ»‘åŠ æƒè½®è¯¢" class="headerlink" title="å¹³æ»‘åŠ æƒè½®è¯¢"></a>å¹³æ»‘åŠ æƒè½®è¯¢</h2><p><img src="/image/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5/iShot2021-09-03%2011.19.39.png" alt="img"></p><ul><li>ä»¥Aä¸¾ä¾‹ï¼Œåˆå§‹åŒ–ä¸º5</li><li><ol><li>å½“å‰æƒé‡é»˜è®¤å€¼ä¸ºæ¯ä¸ªæœåŠ¡å™¨çš„æƒé‡å€¼ï¼Œæ¯æ¬¡è¯·æ±‚è·å–æœ€å¤§çš„ä¸€ä¸ªã€‚</li></ol></li><li><ol><li>æœåŠ¡å™¨è¯·æ±‚ç»“æŸåï¼Œå°†é€‰æ‹©çš„æœåŠ¡å™¨çš„æƒé‡æ”¹ä¸ºæƒé‡&#x3D;å½“å‰æƒé‡-æ€»æƒé‡å’Œã€‚5-5-1-1&#x3D;-2</li></ol></li><li><ol><li>åœ¨æ¯æ¬¡è¯·æ±‚å‰ï¼Œå°†ä»–ä»¬çš„é»˜è®¤æƒé‡å€¼åŠ è¿›å½“å‰æƒé‡å€¼ä¸­ã€‚-2+5&#x3D;3</li></ol></li></ul><h2 id="æœ€å°æ´»è·ƒæ•°"><a href="#æœ€å°æ´»è·ƒæ•°" class="headerlink" title="æœ€å°æ´»è·ƒæ•°"></a>æœ€å°æ´»è·ƒæ•°</h2><ul><li>æ¯ä¸ªæœåŠ¡æä¾›è€…ä¼šå¯¹åº”ç€ä¸€ä¸ªæ´»è·ƒæ•° activeã€‚åˆå§‹æƒ…å†µä¸‹ï¼Œæ‰€æœ‰æœåŠ¡æä¾›è€…çš„ active å‡ä¸º 0ã€‚æ¯å½“æ”¶åˆ°ä¸€ä¸ªè¯·æ±‚ï¼Œå¯¹åº”çš„æœåŠ¡æä¾›è€…çš„ active ä¼šåŠ  1ï¼Œå¤„ç†å®Œè¯·æ±‚åï¼Œactive ä¼šå‡ 1ã€‚æ‰€ä»¥ï¼Œå¦‚æœæœåŠ¡æä¾›è€…æ€§èƒ½è¾ƒå¥½ï¼Œå¤„ç†è¯·æ±‚çš„æ•ˆç‡å°±è¶Šé«˜ï¼Œé‚£ä¹ˆ active ä¹Ÿä¼šä¸‹é™çš„è¶Šå¿«ã€‚å› æ­¤å¯ä»¥ç»™è¿™æ ·çš„æœåŠ¡æä¾›è€…ä¼˜å…ˆåˆ†é…è¯·æ±‚ã€‚</li><li>å½“ç„¶ï¼Œé™¤äº†æœ€å°æ´»è·ƒæ•°ï¼Œ<code>LeastActiveLoadBalance</code> åœ¨å®ç°ä¸Šè¿˜å¼•å…¥äº†æƒé‡å€¼ã€‚æ‰€ä»¥å‡†ç¡®çš„æ¥è¯´ï¼Œ<code>LeastActiveLoadBalance</code> æ˜¯åŸºäºåŠ æƒæœ€å°æ´»è·ƒæ•°ç®—æ³•å®ç°çš„ã€‚</li></ul><h2 id="ä¸€è‡´æ€§HASHç®—æ³•"><a href="#ä¸€è‡´æ€§HASHç®—æ³•" class="headerlink" title="ä¸€è‡´æ€§HASHç®—æ³•"></a>ä¸€è‡´æ€§HASHç®—æ³•</h2><ul><li>ä¸€è‡´æ€§ Hash ç®—æ³•ï¼Œç›¸åŒå‚æ•°çš„è¯·æ±‚ä¸€å®šåˆ†å‘åˆ°ä¸€ä¸ª provider ä¸Šå»ï¼Œprovider æŒ‚æ‰çš„æ—¶å€™ï¼Œä¼šåŸºäºè™šæ‹ŸèŠ‚ç‚¹å‡åŒ€åˆ†é…å‰©ä½™çš„æµé‡ï¼ŒæŠ–åŠ¨ä¸ä¼šå¤ªå¤§ã€‚å¦‚æœä½ éœ€è¦çš„ä¸æ˜¯éšæœºè´Ÿè½½å‡è¡¡ï¼Œæ˜¯è¦ä¸€ç±»è¯·æ±‚éƒ½åˆ°ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‚£å°±èµ°è¿™ä¸ªä¸€è‡´æ€§ Hash ç­–ç•¥ã€‚</li></ul>]]></content>
    
    
    <categories>
      
      <category>Distributed System</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Nacosæ³¨å†Œä¸é…ç½®</title>
    <link href="/2022/03/28/Spring/Nacos%E6%B3%A8%E5%86%8C%E4%B8%8E%E9%85%8D%E7%BD%AE/"/>
    <url>/2022/03/28/Spring/Nacos%E6%B3%A8%E5%86%8C%E4%B8%8E%E9%85%8D%E7%BD%AE/</url>
    
    <content type="html"><![CDATA[<h2 id="æ³¨å†Œ"><a href="#æ³¨å†Œ" class="headerlink" title="æ³¨å†Œ"></a>æ³¨å†Œ</h2><p>Nacos - NacosNamingServiceåˆå§‹åŒ–ä¸­æåˆ°NacosNamingServiceåˆå§‹åŒ–ä¼šåˆå§‹åŒ–EventDispatcherã€NamingProxyã€BeatReactorã€HostReactorã€‚å…¶ä¸­EventDispatcherå·²ç»è¯´äº†ï¼ŒNamingProxyçš„å®šæ—¶ä»»åŠ¡ä¸»è¦æ˜¯é»˜è®¤æ¯30æ¯«ç§’æ›´æ–°æœåŠ¡å™¨åœ°å€ã€é»˜è®¤æ¯5æ¯«ç§’ç™»å½•è·å–tokenç­‰ä¿¡æ¯</p><p>HostReactorçš„å»ºç«‹ä»»åŠ¡åŒ…æ‹¬æ¯5ç§’æ£€æµ‹æ˜¯å¦å¼€å¯æ•…éšœè½¬ç§»ï¼Œè‹¥æ˜¯å¼€å¯ï¼Œåˆ™æŠŠæ–‡ä»¶æ•°æ®è¯»å…¥serviceMapã€å¤©å¤©æŠŠæœåŠ¡ä¿¡æ¯å†™å…¥æœ¬åœ°ã€æ£€æµ‹æœ¬åœ°ç¼“å­˜æ–‡ä»¶ï¼Œè‹¥æ˜¯æ²¡æœ‰åˆ™å»ºç«‹ç¼“å­˜æ–‡ä»¶ã€ç›‘å¬UDPè¯·æ±‚</p><p>åœ¨restTemplates &#x2F; feigné‡‡ç”¨æœåŠ¡åè°ƒç”¨çš„æ—¶å€™, è¿›å…¥<code>excute</code>çš„æ·±å±‚æ–¹æ³•, ä¼šèµ°åˆ°<code>AbstractLoadBalancerRule</code>æŠ½è±¡ç±», nacoså¯¹ä»–è¿›è¡Œäº†å®ç°, å¹¶é€šè¿‡<code>HostReactor</code>è·å–æ‰€æœ‰çš„æœåŠ¡ä¿¡æ¯, å¹¶è¿›è¡Œè´Ÿè½½å‡è¡¡</p><h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><p>Nacos æœåŠ¡ç«¯åˆ›å»ºäº†ç›¸å…³çš„é…ç½®é¡¹åï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥è¿›è¡Œç›‘å¬äº†ã€‚å®¢æˆ·ç«¯æ˜¯é€šè¿‡ä¸€ä¸ªå®šæ—¶ä»»åŠ¡æ¥æ£€æŸ¥è‡ªå·±ç›‘å¬çš„é…ç½®é¡¹çš„æ•°æ®çš„ï¼Œ<strong>ä¸€æ—¦æœåŠ¡ç«¯çš„æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®¢æˆ·ç«¯å°†ä¼šè·å–åˆ°æœ€æ–°çš„æ•°æ®</strong>ï¼Œå¹¶å°†æœ€æ–°çš„æ•°æ®ä¿å­˜åœ¨ä¸€ä¸ª CacheData å¯¹è±¡ä¸­ï¼Œç„¶åä¼šé‡æ–°è®¡ç®— CacheData çš„ md5 å±æ€§çš„å€¼ï¼Œæ­¤æ—¶å°±ä¼šå¯¹è¯¥ CacheData æ‰€ç»‘å®šçš„ Listener è§¦å‘ receiveConfigInfo å›è°ƒã€‚</p><p>è€ƒè™‘åˆ°æœåŠ¡ç«¯æ•…éšœçš„é—®é¢˜ï¼Œå®¢æˆ·ç«¯å°†æœ€æ–°æ•°æ®è·å–åä¼šä¿å­˜åœ¨æœ¬åœ°çš„ snapshot æ–‡ä»¶ä¸­ï¼Œä»¥åä¼šä¼˜å…ˆä»æ–‡ä»¶ä¸­è·å–é…ç½®ä¿¡æ¯çš„å€¼ã€‚</p><h3 id="é‚£ä¹ˆå®¢æˆ·ç«¯å¦‚ä½•æ„ŸçŸ¥åˆ°æ•°æ®å‘ç”Ÿå˜åŒ–çš„å‘¢ï¼Ÿ"><a href="#é‚£ä¹ˆå®¢æˆ·ç«¯å¦‚ä½•æ„ŸçŸ¥åˆ°æ•°æ®å‘ç”Ÿå˜åŒ–çš„å‘¢ï¼Ÿ" class="headerlink" title="é‚£ä¹ˆå®¢æˆ·ç«¯å¦‚ä½•æ„ŸçŸ¥åˆ°æ•°æ®å‘ç”Ÿå˜åŒ–çš„å‘¢ï¼Ÿ"></a>é‚£ä¹ˆå®¢æˆ·ç«¯å¦‚ä½•æ„ŸçŸ¥åˆ°æ•°æ®å‘ç”Ÿå˜åŒ–çš„å‘¢ï¼Ÿ</h3><p>æˆ‘ä»¬çŸ¥é“å®¢æˆ·ç«¯ä¼šæœ‰ä¸€ä¸ªé•¿è½®è®­çš„ä»»åŠ¡å»æ£€æŸ¥æœåŠ¡å™¨ç«¯çš„é…ç½®æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œå¦‚æœå‘ç”Ÿäº†å˜æ›´ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¼šæ‹¿åˆ°å˜æ›´çš„ groupKey å†æ ¹æ® groupKey å»è·å–é…ç½®é¡¹çš„æœ€æ–°å€¼æ›´æ–°åˆ°æœ¬åœ°çš„ç¼“å­˜ä»¥åŠæ–‡ä»¶ä¸­ï¼Œé‚£ä¹ˆè¿™ç§æ¯æ¬¡éƒ½é å®¢æˆ·ç«¯å»è¯·æ±‚ï¼Œé‚£è¯·æ±‚çš„æ—¶é—´é—´éš”è®¾ç½®å¤šå°‘åˆé€‚å‘¢ï¼Ÿ</p><p><strong>é•¿è½®è®­çš„æ¦‚å¿µï¼š</strong></p><p>å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ªè¯·æ±‚åˆ°æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚åï¼Œå¹¶ä¸ä¼šç«‹åˆ»å“åº”ç»™å®¢æˆ·ç«¯ï¼Œè€Œæ˜¯å…ˆæŠŠè¿™ä¸ªè¯·æ±‚holdä½ï¼Œç„¶åæœåŠ¡ç«¯ä¼šåœ¨holdä½çš„è¿™æ®µæ—¶é—´æ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰æ›´æ–°ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å“åº”ç»™å®¢æˆ·ç«¯ï¼Œå¦‚æœä¸€ç›´æ²¡æœ‰æ•°æ®å˜æ›´ï¼Œåˆ™è¾¾åˆ°ä¸€å®šçš„æ—¶é—´ï¼ˆé•¿è½®è®­æ—¶é—´é—´éš”ï¼‰æ‰è¿”å›ã€‚</p><p><img src="/image/Nacos%E6%B3%A8%E5%86%8C%E4%B8%8E%E9%85%8D%E7%BD%AE/2CF311CF-60DC-4520-82CA-75FBC68679E2_2.jpeg" alt="img"></p><p>timeoutæ˜¯åœ¨initè¿™ä¸ªæ–¹æ³•ä¸­èµ‹å€¼çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯30ç§’ï¼Œå¯ä»¥é€šè¿‡configLongPollTimeoutè¿›è¡Œä¿®æ”¹ï¼Œä½†æ˜¯æºç ä¸­delayTimeå­—æ®µç”¨äºä½œä¸ºç»“æŸç›‘å¬è¿”å›æ•°æ®çš„æ—¶é—´é—´éš”ï¼Œæ‰€ä»¥ç­‰å¾…çš„æ—¶é—´ä¸€èˆ¬æ˜¯ç•¥å°äº30ç§’ã€‚</p><p><img src="/image/Nacos%E6%B3%A8%E5%86%8C%E4%B8%8E%E9%85%8D%E7%BD%AE/B1C9C3BA-7663-4D94-A57C-E4ED013ED484_2.jpeg" alt="img"></p><p>ClientLongPolling è¢«æäº¤ç»™ scheduler æ‰§è¡Œä¹‹åï¼Œå®é™…æ‰§è¡Œçš„å†…å®¹å¯ä»¥æ‹†åˆ†æˆä»¥ä¸‹å››ä¸ªæ­¥éª¤ï¼š</p><ul><li>1.åˆ›å»ºä¸€ä¸ªè°ƒåº¦çš„ä»»åŠ¡ï¼Œè°ƒåº¦çš„å»¶æ—¶æ—¶é—´ä¸º 29.5s</li><li>2.å°†è¯¥ ClientLongPolling è‡ªèº«çš„å®ä¾‹æ·»åŠ åˆ°ä¸€ä¸ª allSubs ä¸­å»</li><li>3.å»¶æ—¶æ—¶é—´åˆ°äº†ä¹‹åï¼Œé¦–å…ˆå°†è¯¥ ClientLongPolling è‡ªèº«çš„å®ä¾‹ä» allSubs ä¸­ç§»é™¤</li><li>4.è·å–æœåŠ¡ç«¯ä¸­ä¿å­˜çš„å¯¹åº”å®¢æˆ·ç«¯è¯·æ±‚çš„ groupKeys æ˜¯å¦å‘ç”Ÿå˜æ›´ï¼Œå°†ç»“æœå†™å…¥ response è¿”å›ç»™å®¢æˆ·ç«¯</li></ul><p><strong>åœ¨è¿‡ç¨‹ä¸­æ€»å…±åˆ†ä¸¤ç§æƒ…å†µï¼Œç¬¬ä¸€ç§åœ¨ç›‘å¬è¿‡ç¨‹ä¸­å‘ç”Ÿå˜åŒ–ï¼Œç¬¬äºŒç§å°±æ˜¯è¶…æ—¶ä¹‹åæ‰§è¡Œæ£€æµ‹åè¿”å›</strong></p>]]></content>
    
    
    <categories>
      
      <category>Spring Cloud</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>ConfigServeråŠ¨æ€é…ç½®</title>
    <link href="/2022/03/28/Spring/ConfigServer%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE/"/>
    <url>/2022/03/28/Spring/ConfigServer%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE/</url>
    
    <content type="html"><![CDATA[<p>Spring Cloud Busä¼šå‘å¤–æä¾›ä¸€ä¸ªhttpæ¥å£ï¼Œå³å›¾ä¸­çš„&#x2F;bus&#x2F;refreshã€‚æˆ‘ä»¬å°†è¿™ä¸ªæ¥å£é…ç½®åˆ°è¿œç¨‹çš„gitçš„webhookä¸Šï¼Œå½“gitä¸Šçš„æ–‡ä»¶å†…å®¹å‘ç”Ÿå˜åŠ¨æ—¶ï¼Œå°±ä¼šè‡ªåŠ¨è°ƒç”¨&#x2F;bus-refreshæ¥å£ã€‚Buså°±ä¼šé€šçŸ¥config-serverï¼Œconfig-serverä¼šå‘å¸ƒæ›´æ–°æ¶ˆæ¯åˆ°æ¶ˆæ¯æ€»çº¿çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œå…¶ä»–æœåŠ¡è®¢é˜…åˆ°è¯¥æ¶ˆæ¯å°±ä¼šä¿¡æ¯åˆ·æ–°ï¼Œä»è€Œå®ç°æ•´ä¸ªå¾®æœåŠ¡è¿›è¡Œè‡ªåŠ¨åˆ·æ–°ã€‚</p><p><strong>é…ç½®ä¸­å¿ƒæ‰¿æ‹…é…ç½®åˆ·æ–°çš„èŒè´£</strong></p><p><img src="/image/ConfigServer%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE/28815AD5-AE1B-46D5-84DE-B3BD2A9B1862_2.jpeg" alt="Image"></p><ol><li>æäº¤é…ç½®è§¦å‘postè°ƒç”¨å®¢æˆ·ç«¯Açš„bus&#x2F;refreshæ¥å£</li><li>å®¢æˆ·ç«¯Aæ¥æ”¶åˆ°è¯·æ±‚ä»Serverç«¯æ›´æ–°é…ç½®å¹¶ä¸”å‘é€ç»™Spring Cloud Busæ€»çº¿</li><li>Spring Cloud busæ¥åˆ°æ¶ˆæ¯å¹¶é€šçŸ¥ç»™å…¶å®ƒè¿æ¥åœ¨æ€»çº¿ä¸Šçš„å®¢æˆ·ç«¯ï¼Œæ‰€æœ‰æ€»çº¿ä¸Šçš„å®¢æˆ·ç«¯å‡èƒ½æ”¶åˆ°æ¶ˆæ¯</li><li>å…¶å®ƒå®¢æˆ·ç«¯æ¥æ”¶åˆ°é€šçŸ¥ï¼Œè¯·æ±‚Serverç«¯è·å–æœ€æ–°é…ç½®</li><li>å…¨éƒ¨å®¢æˆ·ç«¯å‡è·å–åˆ°æœ€æ–°çš„é…ç½®</li></ol>]]></content>
    
    
    <categories>
      
      <category>Spring Cloud</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Mysql</title>
    <link href="/2022/03/28/DataBase/Mysql/"/>
    <url>/2022/03/28/DataBase/Mysql/</url>
    
    <content type="html"><![CDATA[<p>Mysqlæ˜¯ç›®å‰ä¸»æµçš„æ•°æ®åº“ä¹‹ä¸€, è·Ÿ<strong>Oracle</strong>ç›¸æ¯”, ä»–æ›´è½»é‡, å¹¶ä¸”äº’è”ç½‘ä¸Šå…³äºå¯¹ä»–çš„æ’ä»¶æ‰©å±•ä¹Ÿæ›´å¤š. ä»–çš„ç´¢å¼•é¡µ, æ•°æ®é¡µ, ç¼“å­˜é¡µ, éƒ½æ˜¯æˆ‘ä»¬éœ€è¦æŒæ¡å¹¶äº†è§£çš„. å½“ä½ æŒæ¡äº†è¿™äº›çŸ¥è¯†ä»¥å, ä½ å¯¹Mysqlæ€§èƒ½è°ƒä¼˜ä¼šæ›´æœ‰æŠŠæ¡, å¹¶ä¸”ä¸äººäº¤è°ˆæ—¶, ä¼šæ˜¾ç¤ºä½ çš„èµ„æœ¬ç§¯ç´¯æ— æ¯”æ·±åš, è‡ªç„¶æ˜¾å¾—æŠ€æœ¯é«˜å¼ºäº›. å½“ç„¶, å…‰çœ‹æ–‡å­—ä¹Ÿæ˜¯ä¸è¡Œçš„, ä½ ä¹Ÿéœ€è¦æ­é…ä¸€äº›å›¾ä¾‹æ¥è®©è„‘æµ·ä¸­çš„çŸ¥è¯†æ›´åŠ æ¸…æ™°åŒ–ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬å¦‚æœéœ€è¦äº†è§£Mysql, é¦–å½“å…¶å†²çš„å°±æ˜¯<strong>Buffer pool</strong>æ¦‚å¿µ. æˆ‘ä»¬çŸ¥é“Mysqlæ˜¯å°†æ•°æ®æ’å…¥è‡³ç£ç›˜çš„, ä½†æ˜¯æˆ‘ä»¬ä¸èƒ½ä¸€ç›´å’Œç£ç›˜æ‰“äº¤é“. è¿™æ ·ä¼šè®©æˆ‘ä»¬çš„è¯»&#x2F;å†™é€Ÿåº¦éƒ½å¾ˆæ…¢. æ‰€ä»¥Mysqlä¼šå°†ä¸€äº›æ•°æ®æ”¾å…¥åˆ°å†…å­˜ä¸­, ä¼˜å…ˆå’Œå†…å­˜æ•°æ®äº¤äº’</p><h2 id="Buffer-pool"><a href="#Buffer-pool" class="headerlink" title="Buffer pool"></a>Buffer pool</h2><ul><li>ç¼“å†²æ± é»˜è®¤æ˜¯ <strong>128Mb</strong> , å­˜å‚¨çš„å…¨éƒ½æ˜¯<strong>æ•°æ®é¡µ</strong><sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="Mysqlçš„æ•°æ®è™½ç„¶æ˜¯ä¸€è¡Œä¸€è¡Œçš„, ä½†æ˜¯è¿™äº›æ•°æ®ä¼šæœ€ç»ˆå­˜å‚¨åœ¨æ•°æ®é¡µé‡Œé¢. å½“ç”¨æˆ·æŸ¥è¯¢&#x2F;æ›´æ–°æŸä¸€æ¡æ•°æ®æ—¶, ä¼šå°†è¯¥æ•°æ®çš„å½“å‰é¡µä»¥åŠç›¸é‚»é¡µå…¨éƒ¨æ”¾å…¥åˆ°ç¼“å†²æ± é‡Œé¢.">[1]</span></a></sup>çš„ä¿¡æ¯. æ•°æ®é¡µä¼šå­˜å‚¨åœ¨ç£ç›˜å’Œç¼“å­˜ä¸­. ä½†æ˜¯å¦‚æœå­˜å‚¨åœ¨ç¼“å­˜çš„è¯, æˆ‘ä»¬ä¸€èˆ¬ç§°ä¹‹ä¸º<strong>ç¼“å­˜é¡µ</strong>. æ—¢ç„¶å­¦ä¹ åˆ°æ•°æ®é¡µçš„æ¦‚å¿µ, é‚£ä¹ˆæˆ‘ä»¬ä¹Ÿè¦ç®€å•çœ‹ä¸€ä¸‹æ•°æ®é¡µé•¿ä»€ä¹ˆæ ·å­. é™¤äº†æ•°æ®é¡µæœ¬èº«, ç¼“å†²æ± é‡Œé¢è¿˜ä¼šè®°å½•æ¯ä¸€ä¸ªæ•°æ®é¡µçš„<strong>æè¿°ä¿¡æ¯</strong><sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" aria-label="æè¿°ä¿¡æ¯æ˜¯æ•°æ®é¡µæ‰€å±çš„è¡¨ç©ºé—´, æ•°æ®é¡µçš„ç¼–å·, åœ¨ç¼“å†²æ± ä¸­çš„åœ°å€ä»¥åŠä¸€äº›é¢å¤–ä¿¡æ¯. æè¿°æ–‡ä»¶å¤§çº¦å æ®ç¼“å†²æ± çš„5%å®¹é‡. æ¯”å¦‚ä½ åˆ›å»ºçš„æ˜¯128Mbçš„ç¼“å†²æ± . é‚£ä¹ˆåŠ ä¸Šæè¿°ä¿¡æ¯, å®é™…ä¸Šåœ¨130+å·¦å³çš„å¤§å°. ">[2]</span></a></sup></li><li>ç¼“å†²æ± åˆå§‹åŒ–æ—¶å¹¶ä¸æ˜¯ç©ºçš„, å®ƒä¼šé»˜è®¤ç”¨ç©ºç¼“å­˜é¡µå¡«å……è‡ªå·±. ç±»ä¼¼äºå ä½ç¬¦ä¸€æ ·çš„å½¢å¼. æ‰€ä»¥éœ€è¦ä½¿ç”¨freeé“¾è¡¨æ¥åˆ¤æ–­å“ªäº›ç¼“å­˜é¡µæ˜¯å¯ä»¥å­˜å…¥çš„.</li><li>é‚£ä¹ˆå¦‚æœæŸä¸ªç¼“å­˜é¡µè¢«ç”¨æˆ·è¯»å–äº†ä¹‹å, ç”¨æˆ·ä¿®æ”¹äº†è¿™ä¸ªç¼“å­˜é¡µæ€ä¹ˆåŠ, é‚£ä¸å°±è·Ÿç£ç›˜æ•°æ®ä¸ä¸€è‡´äº†å—? äºæ˜¯ä¹, flushé“¾è¡¨å‡ºç°äº†.</li><li>ç¼“å­˜é¡µå¯ä»¥è®©æˆ‘ä»¬åŠ é€Ÿæ•°æ®å¤„ç†, ä½†ç¼“å†²æ± çš„ç©ºé—´æ˜¯å›ºå®šçš„, ä»¥å‰æ—§çš„ä¸å¸¸ç”¨çš„ç¼“å­˜é¡µæ€ä¹ˆåˆ é™¤, è…¾å‡ºç©ºé—´ç»™æ–°çš„ç¼“å­˜é¡µå‘¢? LRUé“¾è¡¨</li><li>ç¼“å†²æ± æ˜¯ç”¨æˆ·ä¸»è¦æ‰“äº¤é“çš„ç»„ä»¶, é‚£ä¹ˆç£ç›˜æ•°æ®æ˜¯å¦‚ä½•æ”¾åˆ°ç¼“å†²æ± é‡Œé¢çš„å‘¢? æ•°æ®é¡µä½•æ—¶è¢«ç¼“å­˜</li><li>æ—¢ç„¶æˆ‘ä»¬æœ‰äº†è¿™ä¹ˆå¤šçš„é“¾è¡¨ç»“æ„, é‚£ä¹ˆä¼šä¸ä¼šå®šæ—¶æ¸…ç†ä¸€äº›ä¸ç”¨çš„ç¼“å­˜é¡µå‘¢? å®šæœŸæ¸…ç†ç¼“å­˜é“¾è¡¨</li></ul><h3 id="Freeé“¾è¡¨"><a href="#Freeé“¾è¡¨" class="headerlink" title="Freeé“¾è¡¨"></a>Freeé“¾è¡¨</h3><p>å› ä¸ºç¼“å†²æ± é‡Œé¢ç¼“å­˜é¡µéƒ½æ˜¯å ä½å½¢å¼, æ‰€ä»¥æˆ‘ä»¬ä¸çŸ¥é“å“ªäº›ç¼“å­˜é¡µæ˜¯ç©ºé—²çŠ¶æ€. äºæ˜¯Mysqlå¢åŠ äº†åŒå‘é“¾è¡¨æ¥åˆ¤æ–­. é¦–å…ˆå½“æ•°æ®åº“åˆå§‹åŒ–çš„æ—¶å€™, ç¼“å­˜é¡µå…¨éƒ¨éƒ½æ˜¯ç©ºçš„, é‚£ä¹ˆè¿™äº›ç¼“å­˜é¡µçš„æè¿°ä¿¡æ¯éƒ½ä¼šå­˜å…¥åˆ°é“¾è¡¨é‡Œé¢æ¥. åªè¦æœ‰ç¼“å­˜é¡µéœ€è¦è¢«å­˜å…¥, é‚£ä¹ˆå°±ä¼šæŠŠé“¾è¡¨é‡Œå¯¹åº”çš„æè¿°ä¿¡æ¯åˆ é™¤.</p><h3 id="Flushé“¾è¡¨"><a href="#Flushé“¾è¡¨" class="headerlink" title="Flushé“¾è¡¨"></a>Flushé“¾è¡¨</h3><p>å½“ç”¨æˆ·ä¿®æ”¹äº†ç¼“å­˜é¡µçš„ä¿¡æ¯æ—¶, ç£ç›˜æ•°æ®é¡µå¹¶æ²¡æœ‰è¢«åˆ·æ–°, è¿™æ—¶å€™å°±è¢«ç§°ä¹‹ä¸º[è„é¡µ] æ‰€ä»¥Mysqlè§„å®šäº†, å¦‚æœå½“ç”¨æˆ·ä¿®æ”¹äº†ç¼“å­˜é¡µä¿¡æ¯, åˆ™ä¼šæŠŠç¼“å­˜é¡µçš„æè¿°ä¿¡æ¯å—å­˜æ”¾åˆ°flushé“¾è¡¨é‡Œæ¥. åç»­æ˜¯è¦è¢«flushåˆ°ç£ç›˜é‡Œçš„</p><h3 id="LRUé“¾è¡¨"><a href="#LRUé“¾è¡¨" class="headerlink" title="LRUé“¾è¡¨"></a>LRUé“¾è¡¨</h3><p>ä¸ºäº†åœ¨æœ‰é™çš„ç©ºé—´å†…, å°½é‡è®©çƒ­ç‚¹æ•°æ®å­˜å‚¨è¿›æ¥, äºæ˜¯å‡ºç°äº†LRUé“¾è¡¨. ä½†æ˜¯Mysqlçš„LRUé“¾è¡¨å¹¶ä¸æ˜¯æˆ‘ä»¬è®¤ä¸ºçš„é‚£ç§, ä»–æ˜¯ä¸¤éƒ¨åˆ†é“¾è¡¨, åˆ†ä¸º[<strong>çƒ­æ•°æ®</strong> , <strong>å†·æ•°æ®</strong>] [[LRUé“¾è¡¨å›¾]]. å½“ä¸€ä¸ªæ•°æ®é¡µè¢«å­˜å…¥ç¼“å†²æ± ä¸­æ—¶, LRUé“¾è¡¨å°±ä¼šå°†è¯¥æ¡ç¼“å­˜é¡µçš„æè¿°ä¿¡æ¯åŠ è½½åˆ°<strong>å†·æ•°æ®é“¾è¡¨</strong>çš„å¤´éƒ¨.</p><blockquote><p> é‚£ä¹ˆä»€ä¹ˆæ—¶å€™<strong>å†·æ•°æ®</strong>ä¼šè½¬ç§»åˆ°<strong>çƒ­æ•°æ®</strong>ä¸­å‘¢?</p></blockquote><p>Mysqlå®šä¹‰äº†ä¸€ä¸ªé…ç½®<code>innodb_old_blocks_time</code> é»˜è®¤å€¼æ˜¯1000 æ¯«ç§’. æ„æ€å°±æ˜¯å½“ä¸€ä¸ªæ•°æ®é¡µè¢«åŠ è½½åˆ°ç¼“å­˜é¡µçš„1ç§’å, ä½ åˆä¸€æ¬¡å¯¹ä»–è¿›è¡Œäº†è®¿é—®. é‚£ä¹ˆè¿™æ¡æ•°æ®é¡µå°±ä¼šè¢«ç¼“å­˜åˆ°<strong>çƒ­æ•°æ®</strong>é“¾è¡¨çš„å¤´éƒ¨.</p><p>å¦‚æœä½ è®¿é—®çš„æ˜¯<strong>çƒ­æ•°æ®</strong>é“¾è¡¨çš„æ•°æ®, é‚£ä¹ˆæ ¹æ®è§„åˆ™, å¦‚æœä½ è®¿é—®çš„åŒºåŸŸæ˜¯å3&#x2F;4çš„ç¼“å­˜é¡µ, é‚£ä¹ˆMysqlä¼šå°†è¯¥ç¼“å­˜é¡µç§»åŠ¨è‡³é“¾è¡¨å¤´éƒ¨, ä½†æ˜¯å¦‚æœè®¿é—®çš„æ˜¯å‰1&#x2F;4åŒºåŸŸçš„è¯. è¿™äº›æ•°æ®é¡µçš„ä½ç½®æ˜¯ä¸åŠ¨çš„</p><h3 id="æ•°æ®é¡µç¼“å­˜æ—¶æœº"><a href="#æ•°æ®é¡µç¼“å­˜æ—¶æœº" class="headerlink" title="æ•°æ®é¡µç¼“å­˜æ—¶æœº"></a>æ•°æ®é¡µç¼“å­˜æ—¶æœº</h3><p>å½“æˆ‘ä»¬æ‰§è¡ŒCRUDçš„æ—¶å€™, é¦–å…ˆä¼šå»ç¼“å†²æ± æŸ¥æ•°æ®æ‰€åœ¨çš„æ•°æ®é¡µæ˜¯å¦è¢«ç¼“å­˜äº†. å¦‚æœå·²ç»æœ‰äº†ç¼“å­˜, é‚£ä¹ˆæˆ‘ä»¬ç›´æ¥å°±å°†ç¼“å­˜æ‹¿å‡ºæ¥ç”¨. å¦‚æœæ•°æ®é¡µæ²¡è¢«ç¼“å­˜, é‚£ä¹ˆæˆ‘ä»¬å°±å»freeé“¾è¡¨æ‰¾åˆ°ä¸€ä¸ªç©ºé—²çš„ç¼“å­˜é¡µ. ç„¶åä»ç£ç›˜ä¸Šè¯»å–è¯¥æ•°æ®é¡µ. å†™å…¥æè¿°æ•°æ®, å¹¶ä»freeé“¾è¡¨ä¸­åˆ åˆ é™¤è¿™ä¸ªæè¿°æ•°æ®å—.</p><p>ä½†æ˜¯æˆ‘ä»¬æ€ä¹ˆèƒ½å¿«é€Ÿæ‰¾åˆ°æŸä¸ªæ•°æ®é¡µæ˜¯å¦è¢«ç¼“å­˜äº†å‘¢? æ‰€ä»¥å…¶å®åœ¨æ•°æ®åº“ä¸­, ç»´æŠ¤äº†ä¸€ä¸ªå“ˆå¸Œè¡¨ç»“æ„çš„æ•°æ®. é‡Œé¢æ˜¯<strong>è¡¨ç©ºé—´å·+æ•°æ®é¡µå·</strong>ä¸ºkey, <strong>ç¼“å­˜é¡µåœ°å€</strong>ä¸ºvalueçš„è¿™ä¹ˆä¸€ä¸ªè¡¨. å½“ç”¨æˆ·éœ€è¦ä½¿ç”¨æŸä¸ªæ•°æ®é¡µçš„æ—¶å€™. é€šè¿‡è¯¥è¡¨è¿›è¡ŒæŸ¥æ‰¾, å°±èƒ½å¿«é€Ÿå®šä½åˆ°è¯¥æ•°æ®é¡µæ˜¯å¦è¢«ç¼“å­˜äº†.</p><h3 id="å®šæœŸæ¸…ç†ç¼“å­˜"><a href="#å®šæœŸæ¸…ç†ç¼“å­˜" class="headerlink" title="å®šæœŸæ¸…ç†ç¼“å­˜"></a>å®šæœŸæ¸…ç†ç¼“å­˜</h3><ol><li><p>å®šæ—¶å°†flushé“¾è¡¨çš„ç¼“å­˜é¡µéƒ½åˆ·å…¥åˆ°ç£ç›˜ä¸­, è§£å†³[<strong>è„é¡µ</strong>]é—®é¢˜</p></li><li><p>å®šæ—¶å°†LRUé“¾è¡¨ä¸­<strong>å†·æ•°æ®</strong>å°¾éƒ¨çš„ç¼“å­˜é¡µæ¸…é™¤, å¹¶å¢åŠ freeé“¾è¡¨</p></li></ol><h2 id="TableSpace-amp-DataArea"><a href="#TableSpace-amp-DataArea" class="headerlink" title="TableSpace &amp; DataArea"></a>TableSpace &amp; DataArea</h2><p>å½“äº†è§£å®Œäº†å†…å­˜çŸ¥è¯†ä»¥å, å°±è¯¥å°†ç›®æ ‡è½¬å‘ç£ç›˜äº†. å¹³æ—¶, æˆ‘ä»¬ä¼šåœ¨Mysqlä¸­åˆ›å»ºä¸€ä¸ªè¡¨, è¡¨æœ¬èº«æœ‰ä¸€ä¸ªè¡¨ç©ºé—´çš„æ¦‚å¿µ. åœ¨ç£ç›˜ä¸­å‘½åä¸º<strong>è¡¨å.ibd</strong>æ–‡ä»¶.</p><p>è€Œæ•°æ®æ˜¯å­˜å‚¨åœ¨æ•°æ®é¡µä¸­çš„, ä½†æ˜¯æ•°æ®é¡µé»˜è®¤æ˜¯16kbè€Œå·², ä¸€ä¸ªè¡¨ç©ºé—´æœ‰å¤ªå¤šçš„16kbäº†, ç‰¹åˆ«ä¸æ–¹ä¾¿ç®¡ç†, æ‰€ä»¥Mysqlå¼•å…¥äº†<strong>æ•°æ®åŒº</strong>çš„æ¦‚å¿µ.</p><p>ä¸€ä¸ªæ•°æ®åŒºå¯¹åº”ç€è¿ç»­çš„64ä¸ªæ•°æ®é¡µ, æ¯ä¸ªæ•°æ®é¡µæ˜¯16kb, æ‰€ä»¥ä¸€ä¸ªæ•°æ®åŒºæ­£å¥½æ˜¯1mb. ç„¶å256ä¸ªæ•°æ®åŒºè¢«ç§°ä¸º<strong>ç»„</strong></p><p>åœ¨æ¯ç»„æ•°æ®åŒºçš„ç¬¬ä¸€ä¸ªæ•°æ®åŒºçš„å‰ä¸‰é¡µ, é‡Œé¢å­˜æ”¾çš„æ˜¯<strong>æè¿°æ€§æ•°æ®</strong></p><h2 id="RedoLog"><a href="#RedoLog" class="headerlink" title="RedoLog"></a>RedoLog</h2><p>RedoLogæ–‡ä»¶æˆ‘ä»¬åº”è¯¥éƒ½æœ‰å¬è¯´è¿‡. å…¶å®å°±æ˜¯äº‹åŠ¡è®°å½•æ–‡ä»¶, ä½†æ˜¯ä»–ä¸æ˜¯åœ¨äº‹åŠ¡æäº¤æ—¶æ‰ä¼šè®°å½•, è€Œæ˜¯åœ¨æ•°æ®ä¿®æ”¹æ—¶å°±ä¼šè®°å½•, è®°å½•ä¸º <strong>Prepare</strong> çŠ¶æ€ï¼Œå½“ç”¨æˆ·æäº¤æ—¶ï¼Œæ›´æ–°çŠ¶æ€ä¸º <strong>Commit</strong>. Mysqlé»˜è®¤ä¼šåˆ›å»º2ä¸ªRedoLogæ–‡ä»¶, äº‹åŠ¡è®°å½•ä¼šå¾ªç¯äº¤æ›¿çš„åœ¨ä¸¤ä¸ªæ–‡ä»¶å†…å†™å…¥è¦†ç›–. å¦‚æœæƒ³æ·±å…¥ç ”ç©¶çš„è¯, å¯ä»¥çœ‹ä¸€çœ‹RedoLogæ–‡ä»¶åˆ°åº•å­˜å‚¨äº†ä»€ä¹ˆæ ·çš„ä¿®æ”¹ä¿¡æ¯.</p><p>è™½ç„¶RedoLogæ˜¯ç£ç›˜é¡ºåºå†™, è¿™æ ·çš„å†™å…¥é€Ÿåº¦å¾ˆå¿«, ä½†æ˜¯è¿˜ä¸å¤Ÿå¿«! æˆ‘ä»¬ä¾ç„¶è¦å¢åŠ å†…å­˜æœºåˆ¶æ¥æé«˜å®ƒçš„å†™å…¥é€Ÿåº¦!</p><ul><li><strong>RedoLog buffer</strong>ä¼šåœ¨Mysqlå¯åŠ¨æ—¶, åˆ›å»ºå‡ºæ¥. <strong>é»˜è®¤[16mb]</strong> ç±»ä¼¼äº<strong>Buffer pool</strong> . ä»–ä¼šç”³è¯·ä¸€ç‰‡è¿ç»­çš„å†…å­˜ç©ºé—´, é‡Œé¢åˆ’åˆ†å‡ºNå¤šä¸ªç©ºçš„RedoLog block<sup id="fnref:3" class="footnote-ref"><a href="#fn:3" rel="footnote"><span class="hint--top hint--rounded" aria-label="Mysqlçš„æ•°æ®å­˜å‚¨åœ¨äº†æ•°æ®é¡µé‡Œé¢, åŒæ ·çš„, RedoLogæ—¥å¿—ä¿¡æ¯ä¹Ÿå­˜å‚¨åœ¨äº†Blockä¸­. blockå¤§å°ä¸º512byte. åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†head body trailer">[3]</span></a></sup></li></ul><p>é‚£ä¹ˆå†…å­˜ä¸­çš„RedoLogä»€ä¹ˆæ—¶å€™åˆ·å…¥ç£ç›˜å‘¢?</p><ul><li>å¦‚æœå†™å…¥çš„RedoLog bufferæ—¥å¿—å·²ç»å æ®æ€»å®¹é‡çš„ä¸€åŠäº†. ä¹Ÿå°±æ˜¯å¤§çº¦8mb, äºæ˜¯å°±ä¼šå°†æ—¥å¿—åˆ·å…¥ç£ç›˜.</li><li>äº‹åŠ¡æäº¤çš„æ—¶å€™, ä¼šå°†ä»–å¯¹åº”çš„RedoLogæ‰€åœ¨çš„RedoLog blockåˆ·å…¥åˆ°ç£ç›˜ä¸­<sup id="fnref:4" class="footnote-ref"><a href="#fn:4" rel="footnote"><span class="hint--top hint--rounded" aria-label="å› ä¸ºå­˜åœ¨OS cacheçš„æƒ…å†µ, æ‰€ä»¥å®é™…ä¸Šå¹¶ä¸æ˜¯ç›´æ¥åˆ·å…¥åˆ°ç£ç›˜ä¸­, è€Œæ˜¯ä»å†…å­˜è¿›å…¥åˆ°OS cacheé‡Œ. ä¹‹åç”±æ“ä½œç³»ç»Ÿè¿›è¡Œæ–‡ä»¶å†™å…¥. Mysqlæœ‰å‚æ•°å¯ä»¥ç›´æ¥å°†æ—¥å¿—åˆ·å…¥ç£ç›˜, ä¸èµ°OS cache">[4]</span></a></sup></li><li>å®šæ—¶çº¿ç¨‹æ¯éš”ä¸€ç§’ä¼šå°†blockæ•°æ®åˆ·å…¥ç£ç›˜</li><li>Mysqlå…³é—­æ—¶, ä¼šå°†blockæ•°æ®åˆ·å…¥ç£ç›˜</li></ul><h2 id="UndoLog"><a href="#UndoLog" class="headerlink" title="UndoLog"></a>UndoLog</h2><p>ä¸­æ–‡æ„ [å›æ»šæ—¥å¿—] , çœ‹åå­—å°±çŸ¥é“æ˜¯ä¸“é—¨ç”¨äºäº‹åŠ¡æäº¤å¤±è´¥æˆ–Mysqlçªç„¶å®•æœºæ—¶ç”¨äºæ•°æ®å›æ»šçš„. å®ƒè®°å½•çš„å†…å®¹éå¸¸ç®€å•, æ¯”å¦‚ä½ insertäº†ä¸€æ¡æ•°æ®. é‚£ä¹ˆåœ¨æ—¥å¿—é‡Œ, å°±ä¼šè®°å½•ä¸€æ¡delete idçš„å›æ»šæ•°æ®. æ‰€ä»¥å½“ä½ æ‰§è¡Œäº‹åŠ¡æœŸé—´, ä½ çš„DMLè¯­å¥ä¸æ­¢ä¼šå†™å…¥RedoLog, ä¹Ÿä¼šå†™å…¥UndoLog</p><p>è€ŒUndoLogè¿˜æœ‰å…¶ä»–çš„ä½œç”¨, å°±æ˜¯Mysqlçš„æœ€é‡è¦çš„éš”ç¦»çº§åˆ«æ§åˆ¶ï¼Œè¿™å—å†…å®¹å®¹æˆ‘ç¨åå†è¯´ã€‚</p><h2 id="BinLog"><a href="#BinLog" class="headerlink" title="BinLog"></a>BinLog</h2><p>BinLogä¸æ˜¯é»˜è®¤å¼€å¯çš„, éœ€è¦äººä¸ºæ‰‹åŠ¨å¼€å¯. å®ƒè®°å½•äº†å¯¹Mysqlæ‰§è¡Œ<strong>æäº¤å</strong>çš„æ‰€æœ‰æ“ä½œ. ä½†æ˜¯ç›¸æ¯”RedoLogè€Œè¨€, ä»–è®°å½•çš„ä¿¡æ¯æ²¡æœ‰é‚£ä¹ˆå…¨é¢, ä»…ä»…è®°å½•çš„å¯¹åº”çš„sqlè¯­å¥. ä½†æ˜¯ä¸è¦è§‰å¾—åªè®°å½•sqlæœ‰ä»€ä¹ˆä¸å¥½, æ­£å› ä¸ºæœ‰BinLogæˆ‘ä»¬æ‰å¯ä»¥é€šè¿‡<strong>Canal</strong>æ¥å¯¹æ•°æ®åº“åšç›‘æ§ä¸æ•°æ®sqlè½¬å‘.</p><p>ä½†æ˜¯BinLogæœ‰ä¸€ç‚¹ä¸å‹å¥½, ä»–çš„æ–‡ä»¶æ˜¯ä¸åœå¢å¤šçš„. å¹¶ä¸æ˜¯å¾ªç¯è¦†ç›–çš„åŸåˆ™, æ›¿æˆ‘ä»¬çœç£ç›˜ç©ºé—´. æˆ‘ä»¬è¿˜éœ€è¦è®¾ç½®Mysqlçš„BinLogè¿‡æœŸæ—¶é—´, è®©Mysqlå¸®æˆ‘ä»¬åˆ é™¤æ—§æ–‡ä»¶</p><h2 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a>MVCC</h2><p>ç®€å•çš„æ¥è¯´, åœ¨Mysqlä¸­çš„æ¯ä¸€è¡Œæ•°æ®éƒ½æ˜¯æœ‰ä¸‰ä¸ªéšè—å­—æ®µçš„ <code>rowid</code> <code> trx_id</code>  <code>roll_pointer</code> <code>rowid</code>æˆ‘ä»¬å°±ä¸å¤šè¯´äº†, <code>trx_id</code>å°±æ˜¯è¿™æ¡æ•°æ®æœ€è¿‘çš„ä¸€æ¬¡äº‹åŠ¡id. <code>roll_pointer</code>åˆ™æ˜¯æŒ‡å‘äº†è¿™æ¬¡äº‹åŠ¡ä¹‹å‰çš„UndoLog æ¥ä¸‹æ¥æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­</p><h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><p>å‡å¦‚æˆ‘ä»¬å¼€å¯äº†äº‹åŠ¡A, åœ¨è¿™ä¸ªäº‹åŠ¡é‡Œ, æˆ‘ä»¬æ’å…¥äº†ä¸€æ¡æ•°æ®, è¿™æ¬¡äº‹åŠ¡çš„idä¸º50, æ­¤æ—¶ç‰ˆæœ¬é“¾çš„éšè—å­—æ®µä¸ºä¸‹å›¾æ‰€ç¤º.</p><p><img src="/image/Mysql/imgs%252Fapp%252FRoamWeb%252Fw6_LOfove7.jpeg" alt="img"></p><p>æ¥ç€äº‹åŠ¡Bå¼€å¯äº†, ä»–ä¿®æ”¹äº†è¿™ä¸€æ¡æ•°æ®. äº‹åŠ¡Bçš„idä¸º58, é‚£ä¹ˆç‰ˆæœ¬é“¾å°±äº§ç”Ÿäº†</p><p><img src="/image/Mysql/imgs%252Fapp%252FRoamWeb%252FtfTQCQAYPl.jpeg" alt="img"></p><p>æ¥ç€åˆæ¥äº†ä¸€ä¸ªäº‹åŠ¡C, ä»–ä¹Ÿè€ä¸ä½å¯‚å¯, ä¹Ÿæ¥æ”¹äº†ä¸€ä¸‹è¿™æ¡æ•°æ®</p><p><img src="/image/Mysql/imgs%252Fapp%252FRoamWeb%252FOJDLEbzw8d.jpeg" alt="img"></p><p>ä»¥ä¸Šå°±æ˜¯å¤šç‰ˆæœ¬æ§åˆ¶çš„ç®€è¿°, å…¶å®ä¸éš¾ç†è§£. ä½†æ˜¯å¤šç‰ˆæœ¬æ§åˆ¶åªæ˜¯ä¸€ä¸ªè¾…åŠ©åŠŸèƒ½, å®ƒä¸»è¦æ˜¯ä¸ºäº†ä¸<strong>ReadViewè¯»è§†å›¾</strong>æ­é…, ç”¨äºç®¡ç†éš”ç¦»çº§åˆ«</p><h2 id="ReadView"><a href="#ReadView" class="headerlink" title="ReadView"></a>ReadView</h2><p>ReadViewæ˜¯Mysqlå¯¹äºæ§åˆ¶éš”ç¦»çº§åˆ«çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µ, ç®€å•æ¥è¯´, å°±æ˜¯ä½ åœ¨æ‰§è¡Œä¸€ä¸ªäº‹åŠ¡çš„æ—¶å€™, ä¼šç”Ÿæˆä¸€ä¸ªReadView. é‡Œé¢æ¯”è¾ƒå…³é”®çš„æœ‰å››ä¸ªéƒ¨åˆ†</p><ul><li><code>m_ids</code> : æ­¤æ—¶æœ‰å“ªäº›äº‹åŠ¡åœ¨Mysqlæ‰§è¡Œè¿˜æ²¡æœ‰æäº¤çš„</li><li><code>min_trx_id</code> : å°±æ˜¯m_idsé‡Œé¢æœ€å°çš„å€¼</li><li><code>max_trx_id</code> : å°±æ˜¯Mysqlä¸‹ä¸€ä¸ªè¦ç”Ÿæˆçš„äº‹åŠ¡id, å°±æ˜¯æœ€å¤§çš„äº‹åŠ¡id</li><li><code>creator_trx_id</code> : å½“å‰çš„äº‹åŠ¡id</li></ul><p>è¿™å››ä¸ªéƒ¨åˆ†åœ¨ç®€å•éå¹¶å‘æŸ¥è¯¢æ—¶å¹¶æ²¡æœ‰å¤ªå¤§çš„ä½œç”¨ï¼Œä»–ä»¬å­˜åœ¨çš„æ„ä¹‰æ˜¯è§£å†³å¹¶å‘æŸ¥è¯¢æ—¶å‡ºç°çš„éš”ç¦»çº§åˆ«é—®é¢˜ã€‚</p><h3 id="Example-1"><a href="#Example-1" class="headerlink" title="Example"></a>Example</h3><blockquote><p>å¹¶å‘äº‹åŠ¡æŸ¥è¯¢, å¤§è‡´åˆ†ä¸ºä¸‹åˆ—ä¸‰ç§æƒ…å†µ, æˆ‘ä»¬ç»™å‡ºä¸€ä¸ªå‰ææ¡ä»¶. æŸ¥è¯¢çš„äº‹åŠ¡A(id&#x3D;45) | å¹¶å‘æ›´æ–°çš„äº‹åŠ¡B(id&#x3D;59) | æ“ä½œçš„æ•°æ®(trx_id &#x3D; 32)</p></blockquote><ol><li><p>æ•°æ®çš„<code>trx_id</code>å°äºå½“å‰æ‰§è¡Œäº‹åŠ¡id</p><p>å½“äº‹åŠ¡AæŸ¥è¯¢æ•°æ®çš„æ—¶å€™, ä»–ä¼šåˆ¤æ–­ä¸€ä¸‹, çœ‹ä¸€ä¸‹è¿™æ¡æ•°æ®çš„trx_idæ˜¯å¦å°äºReadViewä¸­çš„min_trx_id. åˆ¤æ–­åå‘ç°æ˜¯å°äºçš„. é‚£ä¹ˆç›´æ¥å°±å¯ä»¥æŸ¥è¯¢è¿™æ¡æ•°æ®çš„ä¿¡æ¯, ä¸ç”¨å»æ‰¾ç‰ˆæœ¬é“¾äº†</p></li><li><p>æ•°æ®çš„<code>trx_id</code>å¤§äºå½“å‰æ‰§è¡Œäº‹åŠ¡id</p><p>åœ¨ä¸Šé¢çš„äº‹åŠ¡AæŸ¥è¯¢å®Œå, äº‹åŠ¡Bä¿®æ”¹äº†è¿™æ¡æ•°æ®, æ•°æ®çš„<code>trx_id</code>å˜æˆäº†59. ç„¶åäº‹åŠ¡Aåˆè¿›è¡Œäº†ä¸€æ¬¡æŸ¥è¯¢. ä»–ä¼šå‘ç°æ•°æ®çš„trx_idæ˜¯å¤§äºmin_trx_id, åŒæ—¶å°äºmax_trx_id. è¿™æ—¶å€™ä»–å°±æ˜ç™½äº†, æœ‰å¹¶å‘äº‹åŠ¡ä¿®æ”¹äº†è¿™æ¡æ•°æ®. ç„¶åçœ‹ä¸€ä¸‹m_idsæ˜¯å¦å­˜åœ¨è¿™æ¡æ•°æ®çš„trx_id, æœç„¶å­˜åœ¨! é‚£ä¹ˆæˆ‘ä»¬å°±ä¸èƒ½æŸ¥è¯¢è¿™æ¡æ•°æ®çš„å½“å‰ä¿¡æ¯äº†. åªèƒ½é€šè¿‡ç‰ˆæœ¬é“¾å›æ»šæŸ¥è¯¢åˆ°å°äºç­‰äºè‡ªå·±äº‹åŠ¡idçš„æ•°æ®ä¿¡æ¯</p></li><li><p>æ•°æ®çš„<code>trx_id</code>ç­‰äºå½“å‰æ‰§è¡Œäº‹åŠ¡id</p><p>è¿™æ¡æ²¡å•¥å¥½è¯´çš„, æ•°æ®çš„äº‹åŠ¡idéƒ½è·Ÿè‡ªå·±çš„äº‹åŠ¡idä¸€æ ·äº†, è¿˜è¦åˆ¤æ–­å•¥å‘¢, è‚¯å®šæ˜¯è‡ªå·±æ”¹çš„å•Š. ç›´æ¥æŸ¥!</p></li></ol><h3 id="RC"><a href="#RC" class="headerlink" title="RC"></a>RC</h3><p>å½“è®¾ç½®äº†RCéš”ç¦»çº§åˆ«æ—¶, æ¯ä¸€æ¬¡çš„æŸ¥è¯¢éƒ½ä¼šç”Ÿæˆä¸€ä¸ªReadView. å¦‚æœæ•°æ®çš„<code>trx_id</code>åœ¨m_idsä¸­çš„è¯, å°±ä¸å…è®¸è¢«è¯»å–, å¿…é¡»å»ç‰ˆæœ¬é“¾æ‰¾â‰¤è‡ªå·±äº‹åŠ¡idçš„æ•°æ®å‡ºæ¥. å¦‚æœåä¹‹çš„è¯, é‚£å°±ç›´æ¥è¯»å–è¯¥æ¡æ•°æ®.</p><h3 id="RR"><a href="#RR" class="headerlink" title="RR"></a>RR</h3><p>ä¸RCä¸ä¸€æ ·çš„æ˜¯, ä¸€ä¸ªäº‹åŠ¡åªä¼šå¼€å¯ä¸€æ¬¡ReadView. æ‰€ä»¥è¿™å°±ä¼šå¯¼è‡´, äº‹åŠ¡å†…åç»­çš„æŸ¥è¯¢æ—¶, å…¶ä»–çš„å¹¶å‘äº‹åŠ¡å·²ç»æäº¤äº†, ä½†æ˜¯ReadViewä¸­çš„m_idsè¿˜æ˜¯ä¿å­˜äº†è¿™äº›å¹¶å‘äº‹åŠ¡ä¿¡æ¯, äºæ˜¯å°±åªèƒ½å»æ‰¾ç‰ˆæœ¬é“¾çš„æ•°æ®.</p><h2 id="Data-Page"><a href="#Data-Page" class="headerlink" title="Data Page"></a>Data Page</h2><p>æˆ‘ä»¬çŸ¥é“, ä¸€è¡Œä¸€è¡Œçš„æ•°æ®æ˜¯å­˜å‚¨åœ¨<strong>æ•°æ®é¡µ</strong>ä¸­çš„ ,ç´¢å¼•ä¹Ÿæ˜¯å­˜å‚¨åœ¨æ•°æ®é¡µä¸­. æ¯ä¸€ä¸ªæ•°æ®é¡µéƒ½ä¼šæœ‰ä»–è‡ªå·±çš„é¡µç›®å½•. æˆ‘ä»¬ä¹ŸçŸ¥é“, InnoDB å¼•æ“é»˜è®¤æ˜¯å¿…é¡»å­˜åœ¨ä¸»é”®çš„, è¿™ä¹Ÿå°±ä¿è¯äº†æ¯å¼ è¡¨éƒ½ä¼šå­˜åœ¨ä¸»é”®ç´¢å¼•, æ—¢ç„¶æœ‰äº†ç´¢å¼•, é‚£ä¹ˆæ‰€æœ‰çš„æ•°æ®éƒ½éœ€è¦æŒ‰ç…§ä¸»é”®é¡ºåºæ’åˆ—, å¦‚æœä¸»é”®æ˜¯ä¸­è‹±æ–‡æ··æ‚çš„è¯, æˆ‘ä»¬è¿˜éœ€è¦å¯¹ä»–åšè½¬æ¢, ä¿è¯å¯ä»¥æ¯”è¾ƒå¤§å°. æ‰€ä»¥ä¸­è‹±æ–‡ä¸»é”®çš„æŸ¥è¯¢é€Ÿåº¦æ˜¯ä¼šæ¯”çº¯æ•°å­—çš„é€Ÿåº¦è¾ƒæ…¢ä¸€äº›.</p><p>é‚£ä¹ˆå¦‚æœæ˜¯æŒ‰ç…§é¡ºåºçš„è¯, æˆ‘å…ˆå¢åŠ äº†ä¸€æ¡idä¸º10çš„æ•°æ®, æˆ‘åˆå¢åŠ äº†ä¸€æ¡idä¸º2çš„æ•°æ®. å®é™…ä¸Šä¼šæ€ä¹ˆå­˜å‚¨å‘¢? äºæ˜¯Mysqlé¡µåˆ†è£‚<sup id="fnref:5" class="footnote-ref"><a href="#fn:5" rel="footnote"><span class="hint--top hint--rounded" aria-label="é¡µåˆ†è£‚çš„æ¦‚å¿µæ˜¯å½“å­˜åœ¨åä¸€ä¸ªæ•°æ®é¡µçš„éƒ¨åˆ†æ•°æ®ä¸»é”®æ¯”å‰ä¸€ä¸ªæ•°æ®é¡µä¸­çš„ä¸»é”®å°æ—¶, Mysqlä¼šè‡ªåŠ¨å¸®ä½ è°ƒæ•´ä¸»é”®å¤§å°, ä»–ä¼šä¿è¯è¿™ä¸¤ä¸ªæ•°æ®é¡µä¸­çš„ä¸»é”®å€¼ä¸€å®šæ˜¯æŒ‰ç…§ä»å°åˆ°å¤§çš„é¡ºåºæ’åˆ—">[5]</span></a></sup>å‡ºç°äº†, ä»–èƒ½å¸®æˆ‘ä»¬è§£å†³ä¸»é”®é¡ºåºé—®é¢˜.</p><p>æ—¢ç„¶æˆ‘ä»¬çŸ¥é“äº†æ•°æ®é¡µçš„ä¸€äº›ç®€å•æ¦‚å¿µ, é‚£ä¹ˆMysqlæ˜¯å¦‚ä½•æŸ¥è¯¢çš„å‘¢?</p><ul><li><p>å•æ•°æ®é¡µæŸ¥è¯¢</p><p>å‡å¦‚æˆ‘ä»¬æŸ¥è¯¢çš„ä¸€å¼ è¡¨ä¸­, å‹æ ¹æ²¡å¤šå°‘æ•°æ®, ä¹Ÿå°±ä¸€ä¸ªæ•°æ®é¡µçš„å¤§å°. é‚£ä¹ˆMysqlå°±ä¼šç›´æ¥åˆ°æ•°æ®é¡µçš„é¡µç›®å½•ä¸­æ ¹æ®ä¸»é”®è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾. å¿«é€Ÿå®šä½åˆ°ä¸»é”®çš„æ§½ä½, ç„¶åéå†æ§½ä½çš„æ¯ä¸€è¡Œæ•°æ®, æ‰¾åˆ°ä¸»é”®å¯¹åº”çš„æ•°æ®ä¸ºæ­¢. å› ä¸ºä¸€ä¸ªæ§½ä½å¯èƒ½å­˜å‚¨äº†ä¸€ç»„æ•°æ®, æ‰€ä»¥éœ€è¦åœ¨æ§½ä½é‡Œéå†æŸ¥æ‰¾.</p></li><li><p>å¤šæ•°æ®é¡µæŸ¥è¯¢</p><p>å¦‚æœæ˜¯å¤šæ•°æ®é¡µçš„è¯ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–°çŸ¥è¯†æ¥å¸®æˆ‘ä»¬å¿«é€Ÿå®šä½åˆ°æŒ‡å®šçš„æ•°æ®é¡µä¸­ï¼Œç„¶åæ‰èƒ½ç”¨å•æ•°æ®é¡µçš„æ–¹å¼æ¥æŸ¥è¯¢ï¼Œç¨åæˆ‘å†æ¥è¯´ç´¢å¼•é¡µç›¸å…³å†…å®¹ã€‚</p></li></ul><h3 id="Page-directory"><a href="#Page-directory" class="headerlink" title="Page directory"></a>Page directory</h3><p><a href="https://blog.csdn.net/jy02268879/article/details/105652206">æ·±å…¥ç ”ç©¶Mysqlé¡µç»“æ„</a></p><p>ç°åœ¨æˆ‘ä»¬äº†è§£äº†è®°å½•åœ¨é¡µä¸­æŒ‰ç…§ä¸»é”®å€¼ç”±å°åˆ°å¤§é¡ºåºä¸²è”æˆä¸€ä¸ªå•é“¾è¡¨ï¼Œé‚£å¦‚æœæˆ‘ä»¬æƒ³æ ¹æ®ä¸»é”®å€¼æŸ¥æ‰¾é¡µä¸­çš„æŸæ¡è®°å½•è¯¥å’‹åŠå‘¢ï¼Ÿ</p><p>è®¾è®¡InnoDBçš„å¤§å”ä»¬ä¸ºæˆ‘ä»¬çš„è®°å½•ä¹Ÿåˆ¶ä½œäº†ä¸€ä¸ªç±»ä¼¼çš„ç›®å½•ï¼Œä»–ä»¬çš„åˆ¶ä½œè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><ul><li>å°†æ‰€æœ‰æ­£å¸¸çš„è®°å½•ï¼ˆåŒ…æ‹¬æœ€å¤§å’Œæœ€å°è®°å½•ï¼Œä¸åŒ…æ‹¬æ ‡è®°ä¸ºå·²åˆ é™¤çš„è®°å½•ï¼‰åˆ’åˆ†ä¸ºå‡ ä¸ªç»„ã€‚</li><li>æ¯ä¸ªç»„çš„æœ€åä¸€æ¡è®°å½•ï¼ˆä¹Ÿå°±æ˜¯ç»„å†…æœ€å¤§çš„é‚£æ¡è®°å½•ï¼‰çš„å¤´ä¿¡æ¯ä¸­çš„n_ownedå±æ€§è¡¨ç¤ºè¯¥è®°å½•æ‹¥æœ‰å¤šå°‘æ¡è®°å½•ï¼Œä¹Ÿå°±æ˜¯è¯¥ç»„å†…å…±æœ‰å‡ æ¡è®°å½•</li><li>å°†æ¯ä¸ªç»„çš„æœ€åä¸€æ¡è®°å½•çš„åœ°å€åç§»é‡å•ç‹¬æå–å‡ºæ¥ï¼Œç”¨ä½œæŸ¥æ‰¾ã€‚</li></ul><p>æ³¨æ„ï¼šè¿™ä¸ªé¡µç›®å½•æ˜¯ä¸ºä¸»é”®æœåŠ¡çš„ã€‚</p><p><img src="/image/Mysql/format,png.png" alt="img"></p><p>å¯¹äºæœ€å°è®°å½•æ‰€åœ¨çš„åˆ†ç»„åªèƒ½æœ‰ 1 æ¡è®°å½•ï¼Œæœ€å¤§è®°å½•æ‰€åœ¨çš„åˆ†ç»„æ‹¥æœ‰çš„è®°å½•æ¡æ•°åªèƒ½åœ¨ 1-8 æ¡ä¹‹é—´ï¼Œå‰©ä¸‹çš„åˆ†ç»„ä¸­è®°å½•çš„æ¡æ•°èŒƒå›´åªèƒ½åœ¨æ˜¯ 4-8 æ¡ä¹‹é—´ã€‚</p><p>åˆ†ç»„æ˜¯æŒ‰ç…§ä¸‹è¾¹çš„æ­¥éª¤è¿›è¡Œï¼š</p><ul><li>åˆå§‹æƒ…å†µä¸‹ä¸€ä¸ªæ•°æ®é¡µé‡Œåªæœ‰æœ€å°è®°å½•å’Œæœ€å¤§è®°å½•ä¸¤æ¡è®°å½•ï¼Œå®ƒä»¬åˆ†å±äºä¸¤ä¸ªåˆ†ç»„ã€‚</li><li>ä¹‹åæ¯æ’å…¥ä¸€æ¡è®°å½•ï¼Œéƒ½ä¼šä»é¡µç›®å½•ä¸­æ‰¾åˆ°ä¸»é”®å€¼æ¯”æœ¬è®°å½•çš„ä¸»é”®å€¼å¤§å¹¶ä¸”å·®å€¼æœ€å°çš„æ§½ï¼Œç„¶åæŠŠè¯¥æ§½å¯¹åº”çš„è®°å½•çš„n_ownedå€¼åŠ 1ï¼Œè¡¨ç¤ºæœ¬ç»„å†…åˆæ·»åŠ äº†ä¸€æ¡è®°å½•ï¼Œç›´åˆ°è¯¥ç»„ä¸­çš„è®°å½•æ•°ç­‰äº8ä¸ªã€‚</li><li>åœ¨ä¸€ä¸ªç»„ä¸­çš„è®°å½•æ•°ç­‰äº8ä¸ªåå†æ’å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œä¼šå°†ç»„ä¸­çš„è®°å½•æ‹†åˆ†æˆä¸¤ä¸ªç»„ï¼Œä¸€ä¸ªç»„ä¸­4æ¡è®°å½•ï¼Œå¦ä¸€ä¸ª5æ¡è®°å½•ã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šåœ¨é¡µç›®å½•ä¸­æ–°å¢ä¸€ä¸ªæ§½æ¥è®°å½•è¿™ä¸ªæ–°å¢åˆ†ç»„ä¸­æœ€å¤§çš„é‚£æ¡è®°å½•çš„åç§»é‡ã€‚</li></ul><p>æˆ‘ä»¬å†æ·»åŠ 12æ¡è®°å½•çœ‹çœ‹æ•ˆæœï¼š</p><p><img src="/image/Mysql/format,png-20220328150555793.png" alt="img"></p><p>å› ä¸ºæŠŠ16æ¡è®°å½•çš„å…¨éƒ¨ä¿¡æ¯éƒ½ç”»åœ¨ä¸€å¼ å›¾é‡Œå¤ªå åœ°æ–¹ï¼Œè®©äººçœ¼èŠ±ç¼­ä¹±çš„ï¼Œæ‰€ä»¥åªä¿ç•™äº†ç”¨æˆ·è®°å½•å¤´ä¿¡æ¯ä¸­çš„n_ownedå’Œnext_recordå±æ€§ã€‚</p><p>å› ä¸ºå„ä¸ªæ§½ä»£è¡¨çš„è®°å½•çš„ä¸»é”®å€¼éƒ½æ˜¯ä»å°åˆ°å¤§æ’åºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ‰€è°“çš„äºŒåˆ†æ³•æ¥è¿›è¡Œå¿«é€ŸæŸ¥æ‰¾ã€‚</p><p>æ‰€ä»¥åœ¨ä¸€ä¸ªæ•°æ®é¡µä¸­æŸ¥æ‰¾æŒ‡å®šä¸»é”®å€¼çš„è®°å½•çš„è¿‡ç¨‹åˆ†ä¸ºä¸¤æ­¥ï¼š</p><ul><li>é€šè¿‡äºŒåˆ†æ³•ç¡®å®šè¯¥è®°å½•æ‰€åœ¨çš„æ§½ï¼Œå¹¶æ‰¾åˆ°è¯¥æ§½æ‰€åœ¨åˆ†ç»„ä¸­ä¸»é”®å€¼æœ€å¤§çš„é‚£æ¡è®°å½•ã€‚</li><li>é€šè¿‡è®°å½•çš„next_recordå±æ€§éå†è¯¥æ§½æ‰€åœ¨çš„ç»„ä¸­çš„å„ä¸ªè®°å½•ã€‚</li></ul><p>æ¯”æ–¹è¯´æˆ‘ä»¬æƒ³æ‰¾ä¸»é”®å€¼ä¸º6çš„è®°å½•ï¼Œè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><p>è®¡ç®—ä¸­é—´æ§½çš„ä½ç½®ï¼š(0+4)&#x2F;2&#x3D;2ï¼Œæ‰€ä»¥æŸ¥çœ‹æ§½2å¯¹åº”è®°å½•çš„ä¸»é”®å€¼ä¸º8ï¼Œåˆå› ä¸º8 &gt; 6ï¼Œæ‰€ä»¥è®¾ç½®high&#x3D;2ï¼Œlowä¿æŒä¸å˜ã€‚</p><p>é‡æ–°è®¡ç®—ä¸­é—´æ§½çš„ä½ç½®ï¼š(0+2)&#x2F;2&#x3D;1ï¼Œæ‰€ä»¥æŸ¥çœ‹æ§½1å¯¹åº”çš„ä¸»é”®å€¼ä¸º4ï¼Œåˆå› ä¸º4 &lt; 6ï¼Œæ‰€ä»¥è®¾ç½®low&#x3D;1ï¼Œhighä¿æŒä¸å˜ã€‚</p><p>å› ä¸ºhigh - lowçš„å€¼ä¸º1ï¼Œæ‰€ä»¥ç¡®å®šä¸»é”®å€¼ä¸º6çš„è®°å½•åœ¨æ§½2å¯¹åº”çš„ç»„ä¸­ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å¾ˆè½»æ˜“çš„æ‹¿åˆ°æ§½1å¯¹åº”çš„è®°å½•ï¼ˆä¸»é”®å€¼ä¸º4ï¼‰ï¼Œè¯¥æ¡è®°å½•çš„ä¸‹ä¸€æ¡è®°å½•å°±æ˜¯æ§½2ä¸­ä¸»é”®å€¼æœ€å°çš„è®°å½•ï¼Œè¯¥è®°å½•çš„ä¸»é”®å€¼ä¸º5ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä»è¿™æ¡ä¸»é”®å€¼ä¸º5çš„è®°å½•å‡ºå‘ï¼Œéå†æ§½2ä¸­çš„å„æ¡è®°å½•</p><p>æ³¨æ„ï¼šè‹¥æŸ¥åˆ°æ•°æ®åœ¨æ§½2çš„åˆ†ç»„ä¸­ï¼Œç”±äºæ§½2æ˜¯æŒ‡å‘æœ€åä¸€ä¸ªè®°å½•ï¼Œæ‰€ä»¥éœ€è¦å‘ä¸Šæ‰¾ä¸€ä¸ªæ§½ä½ï¼Œå®šä½åˆ°ä¸Šä¸€ä¸ªæ§½ä½æœ€åä¸€è¡Œï¼Œç„¶åå†å‘ä¸‹æ‰¾ã€‚</p><h2 id="Index-Page"><a href="#Index-Page" class="headerlink" title="Index Page"></a>Index Page</h2><p>ç´¢å¼•é¡µä¹Ÿåˆç§°**[ä¸»é”®ç›®å½•]. <strong>ç®€å•æ¥è¯´å°±æ˜¯å¦‚æœä¸€å¼ è¡¨æ•°æ®å¾ˆå¤§çš„è¯, é‚£ä¹ˆè‡ªç„¶ä¼šæœ‰å¾ˆå¤šçš„æ•°æ®é¡µå‡ºç°. å› ä¸ºä½ çš„ç´¢å¼•ä¹Ÿæ˜¯å­˜å‚¨åœ¨é‡Œé¢çš„, æ‰€ä»¥ä¼šå‡ºç°</strong>ç´¢å¼•é¡µ**. è€Œç´¢å¼•é¡µä¸­å­˜å‚¨çš„å°±æ˜¯å¤šä¸ªæ•°æ®é¡µä¸­æœ€å°çš„ä¸»é”®idä¸æ•°æ®é¡µå·.</p><p><font color='red'>B+æ ‘ä¸­çš„éå¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯ç´¢å¼•é¡µï¼Œç´¢å¼•é¡µé‡Œé¢å­˜å‚¨çš„æ˜¯ä¸‹æ–¹éå¶å­èŠ‚ç‚¹çš„ç´¢å¼•é¡µæœ€å°IDï¼Œåœ¨æœ€åº•å±‚çš„éå¶å­èŠ‚ç‚¹çš„ç´¢å¼•é¡µé‡Œé¢å­˜å‚¨çš„æ˜¯æ•°æ®é¡µçš„æœ€å°ä¸»é”®idï¼Œè€Œå¶å­èŠ‚ç‚¹å­˜å‚¨çš„å°±æ˜¯æ•°æ®é¡µä¿¡æ¯ã€‚</font></p><p><img src="/image/Mysql/iShot2022-02-17%2015.14.10.png" alt="img"></p><p>ä½†æ˜¯å¦‚æœæ•°æ®çœŸçš„æ¯”è¾ƒåºå¤§, ç´¢å¼•é¡µå‡ºæ¥å¾ˆå¤šå‘¢? æˆ‘ä»¬æ€ä¹ˆå¿«é€Ÿå®šä½åˆ°æˆ‘ä»¬æƒ³è¦çš„ç´¢å¼•é¡µ? äºæ˜¯ä¸€ä¸ªå…¨æ–°çš„æ¦‚å¿µäº§ç”Ÿäº†ç´¢å¼•B+æ ‘</p><p>å¯¹äº InnoDB æ¥è¯´ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯ä»¥é”®å€¼å¯¹çš„æ–¹å¼å­˜å‚¨çš„ï¼Œä¸»é”®ç´¢å¼•å’Œè¾…åŠ©ç´¢å¼•åœ¨å­˜å‚¨æ•°æ®æ—¶ä¼šå°† id å’Œ index ä½œä¸ºé”®ï¼Œå°†æ‰€æœ‰åˆ—å’Œ id ä½œä¸ºé”®å¯¹åº”çš„å€¼. åœ¨ B+ æ ‘ä¸­, æ‰€æœ‰çš„éå¶å­èŠ‚ç‚¹éƒ½æ˜¯å­˜å‚¨çš„ç´¢å¼•å€¼, åªæœ‰å¶å­èŠ‚ç‚¹æ‰ä¼šå­˜å‚¨æ•°æ®.</p><ul><li>ä½†æ˜¯å› ä¸ºè¾…åŠ©ç´¢å¼•å­˜å‚¨çš„æ˜¯ id çš„åŸå› , æ‰€ä»¥éœ€è¦äºŒæ¬¡å›è¡¨æŸ¥è¯¢.</li></ul><p>ä¸€ä¸ª B+ æ ‘æ„å»ºå‡ºæ¥ä»¥å, æˆ‘ä»¬ä»¥ä¸»é”®ç´¢å¼•ä¸ºä¾‹. å½“æˆ‘ä»¬æŸ¥è¯¢æ•°æ®æ—¶, é¦–å…ˆå°±ä¼šä» B+ æ•°çš„é¡¶å±‚å¼€å§‹äºŒåˆ†æŸ¥æ‰¾, ä¸€ç›´æ‰¾åˆ°æˆ‘ä»¬éœ€è¦çš„å¶å­èŠ‚ç‚¹, å¶å­èŠ‚ç‚¹å­˜å‚¨çš„ä¸æ˜¯å®é™…çš„æ•°æ®, è€Œæ˜¯<strong>æ•°æ®é¡µ</strong>. æ‰€ä»¥æˆ‘ä»¬éœ€è¦å†é€šè¿‡æ•°æ®é¡µçŸ¥è¯†æ¥ç»“æŸæŸ¥è¯¢ã€‚</p><h3 id="Union-Index"><a href="#Union-Index" class="headerlink" title="Union Index"></a>Union Index</h3><p>åœ¨è¿™é‡Œæˆ‘ä»¬å•ç‹¬å°†ã€Œè”åˆç´¢å¼•ã€çš„ç»“æ„æ‹¿å‡ºæ¥è®°å½•ï¼Œç½‘ç»œä¸Šå¯¹äºè¯¥å­˜å‚¨ç»“æ„æœ‰ä¸¤ç§ä¸åŒçš„è§‚ç‚¹è®ºè¿°ã€‚</p><p>å…¶ä¸€æ˜¯ç´¢å¼•æ ‘çš„éå¶å­èŠ‚ç‚¹ä¸Šå­˜å‚¨çš„æ˜¯æœ€å·¦ä¾§åˆ—çš„å€¼ï¼Œé€šè¿‡è¯¥å€¼è¿›è¡Œåç»­çš„ä¾æ¬¡æŸ¥æ‰¾ã€‚</p><p><font color='red'>å…¶äºŒæ˜¯ç´¢å¼•æ ‘çš„éå¶å­èŠ‚ç‚¹ä¸Šå­˜å‚¨çš„æ˜¯æ‰€æœ‰åˆ—çš„å€¼ï¼Œç„¶åæ ¹æ®å„ä¸ªå€¼è¿›è¡Œä¾æ¬¡æŸ¥æ‰¾ã€‚</font></p><p>ç»è¿‡æŸ¥æ‰¾ä¸é˜…è¯»ä¹¦ç±ï¼Œæˆ‘æ›´å€¾å‘äºå¤šåˆ—ç»„åˆå­˜å‚¨çš„æ–¹å¼ã€‚å…¶å®ä¸ç®¡å¦‚ä½•å­˜å‚¨ï¼Œæœ¬è´¨ä¸ŠæŸ¥æ‰¾æ•°æ®éƒ½æ˜¯éœ€è¦ä¸€é¡¹é¡¹çš„æŸ¥æ‰¾ï¼Œè¿™ä¹Ÿå°±å‡ºç°äº†æˆ‘ä»¬ç†ŸçŸ¥çš„ã€Œæœ€å·¦åŒ¹é…ã€é—®é¢˜ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å°†è”åˆç´¢å¼•æƒ³åƒæˆç”µè¯ç°¿ï¼Œé€šè¿‡æœ€å·¦åŒ¹é…çš„ã€Œå§“ã€ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¿«é€Ÿçš„æ‰¾åˆ°åç»­çš„ã€Œä¸­é—´å­—+æœ«å°¾å­—ã€ã€‚ä½†æ˜¯å¦‚æœæ²¡æœ‰æœ€å·¦é¡¹ï¼Œæˆ‘ä»¬è‚¯å®šåªèƒ½æ‰«æå…¨éƒ¨é¡¹è¿›è¡Œå…¨è¡¨æŸ¥è¯¢ã€‚</p><p>è‹¥æˆ‘ä»¬çš„æ¡ä»¶åªæœ‰ã€Œå§“+æœ«å°¾å­—ã€ï¼Œç¼ºå°‘äº†ã€Œä¸­é—´å­—ã€ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ ¹æ®åŸåˆ™ï¼Œåªèƒ½ç”¨åˆ°å¤åˆç´¢å¼•ä¸­çš„ã€Œå§“ã€ç´¢å¼•ï¼Œæ— æ³•ç»§ç»­é‡‡ç”¨åç»­çš„ç´¢å¼•ã€‚</p><h2 id="Master-amp-Slave"><a href="#Master-amp-Slave" class="headerlink" title="Master &amp; Slave"></a>Master &amp; Slave</h2><p>å› ä¸ºä»¥æˆ‘ç›®å‰æ¥è§¦çš„é¡¹ç›®ä½“é‡, ä½¿ç”¨åˆ° Mysql é›†ç¾¤çš„å¯èƒ½æ€§å¾®ä¹å…¶å¾®, æ‰€ä»¥åœ¨è¿™é‡Œåªæ˜¯ç®€å•è®°å½•ä¸€ä¸‹. å½“æˆ‘ä»¬åˆ›å»ºäº†é›†ç¾¤æ—¶, Mysql é›†ç¾¤å¹¶ä¸ä¼šä¿è¯é«˜å¯ç”¨. è¿™éœ€è¦æˆ‘ä»¬è‡ªå·±é€šè¿‡ç¬¬ä¸‰æ–¹æ’ä»¶å®ç°. æ¯”å¦‚<strong>MHA</strong>. ä»–ä¼šéƒ¨ç½²ä¸€å° Manager èŠ‚ç‚¹, ç„¶ååœ¨æ¯ä¸€å° Mysql æœåŠ¡å™¨ä¸Šéƒ¨ç½² Node èŠ‚ç‚¹. å¦‚æœæŸä¸ª Master èŠ‚ç‚¹å®•æœº, é‚£ä¹ˆä»–å°±ä¼šå°† Slave æå‡ä¸Šå».</p><p>ä½†æ˜¯é«˜å¯ç”¨ä¹Ÿæœ‰ä¸ªç¼ºç‚¹. å¦‚æœä½ çš„æŸä¸ªæœåŠ¡å™¨å˜æˆäº†ä¸»èŠ‚ç‚¹, é‚£ä¹ˆ java é¡¹ç›®å¦‚æœåŠ¨æ€æ›´æ”¹ä¸»åº“åœ°å€å‘¢? éœ€è¦ç ”ç©¶ä¸€ä¸‹è¿™ä¸ªé—®é¢˜</p><h3 id="Mode"><a href="#Mode" class="headerlink" title="Mode"></a>Mode</h3><p><strong>æ™®é€šæ—¥å¿—å¤åˆ¶(5.6 before)ï¼š</strong>MySQLæœ€æ—©æ”¯æŒçš„å¤åˆ¶æŠ€æœ¯ï¼ŒBUGç›¸å¯¹è¾ƒå°‘ï¼Œå¯¹SQLæŸ¥è¯¢æ²¡ä»€ä¹ˆé™åˆ¶ï¼Œæ•…éšœå¤„ç†æ¯”è¾ƒå¼±å®¹æ˜“ï¼Œä½†æ˜¯åœ¨ä¸»èŠ‚ç‚¹æŒ‚æ‰ï¼Œç”±ä»èŠ‚ç‚¹é€‰ä¸¾åå¯èƒ½ä¼šé€ æˆä¿¡æ¯ä¸¢å¤±é—®é¢˜</p><p><strong>GTIDå…¨å±€äº‹åŠ¡IDå¤åˆ¶(5.6 after)ï¼š</strong>å¾ˆæ–¹ä¾¿çš„æ”¯æŒé«˜å¯ç”¨ï¼Œä½†æ˜¯ä¸æ”¯æŒéäº‹åŠ¡å¼•æ“ï¼Œä¸æ”¯æŒ <code>sql_slave_skip_counter</code> (ä¸€èˆ¬ç”¨è¿™ä¸ªæ¥è·³è¿‡åŸºäºbinlogä¸»ä»å¤åˆ¶å‡ºç°çš„é—®é¢˜)ã€‚ä¹Ÿä¸æ”¯æŒ<code>create table â€¦ select</code> ä»¥åŠ <code>create temporary table</code></p><h3 id="Principle"><a href="#Principle" class="headerlink" title="Principle"></a>Principle</h3><p>ä¸»åº“å°†å˜æ›´å†™å…¥ binlog æ—¥å¿—ï¼Œç„¶åä»åº“è¿æ¥åˆ°ä¸»åº“ä¹‹åï¼Œä»åº“æœ‰ä¸€ä¸ª IO çº¿ç¨‹ï¼Œå°†ä¸»åº“çš„ binlog æ—¥å¿—æ‹·è´åˆ°è‡ªå·±æœ¬åœ°ï¼Œå†™å…¥ä¸€ä¸ª relay ä¸­ç»§æ—¥å¿—ä¸­ã€‚æ¥ç€ä»åº“ä¸­æœ‰ä¸€ä¸ª SQL çº¿ç¨‹ä¼šä»ä¸­ç»§æ—¥å¿—è¯»å– binlogï¼Œç„¶åæ‰§è¡Œ binlog æ—¥å¿—ä¸­çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯åœ¨è‡ªå·±æœ¬åœ°å†æ¬¡æ‰§è¡Œä¸€é SQLï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯è‡ªå·±è·Ÿä¸»åº“çš„æ•°æ®æ˜¯ä¸€æ ·çš„.</p><p>è¿™é‡Œæœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„ä¸€ç‚¹ï¼Œå°±æ˜¯ä»åº“åŒæ­¥ä¸»åº“æ•°æ®çš„è¿‡ç¨‹æ˜¯ä¸²è¡ŒåŒ–çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸»åº“ä¸Šå¹¶è¡Œçš„æ“ä½œï¼Œåœ¨ä»åº“ä¸Šä¼šä¸²è¡Œæ‰§è¡Œã€‚æ‰€ä»¥è¿™å°±æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç‚¹äº†ï¼Œç”±äºä»åº“ä»ä¸»åº“æ‹·è´æ—¥å¿—ä»¥åŠä¸²è¡Œæ‰§è¡Œ SQL çš„ç‰¹ç‚¹ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä»åº“çš„æ•°æ®ä¸€å®šä¼šæ¯”ä¸»åº“æ…¢ä¸€äº›ï¼Œæ˜¯<strong>æœ‰å»¶æ—¶</strong>çš„. æ‰€ä»¥ç»å¸¸å‡ºç°ï¼Œåˆšå†™å…¥ä¸»åº“çš„æ•°æ®å¯èƒ½æ˜¯è¯»ä¸åˆ°çš„ï¼Œè¦è¿‡å‡ åæ¯«ç§’ï¼Œç”šè‡³å‡ ç™¾æ¯«ç§’æ‰èƒ½è¯»å–åˆ°</p><ul><li><p><strong>åŒæ­¥å¤åˆ¶ï¼š</strong>æœ€æ²¡ç”¨çš„å¤åˆ¶æ–¹å¼</p><p>æŒ‡å½“ä¸»åº“æ‰§è¡Œå®Œä¸€ä¸ªäº‹åŠ¡ï¼Œæ‰€æœ‰çš„ä»åº“éƒ½æ‰§è¡Œäº†è¯¥äº‹åŠ¡æ‰è¿”å›ç»™å®¢æˆ·ç«¯ã€‚å› ä¸ºéœ€è¦ç­‰å¾…æ‰€æœ‰ä»åº“æ‰§è¡Œå®Œè¯¥äº‹åŠ¡æ‰èƒ½è¿”å›ï¼Œæ‰€ä»¥å…¨åŒæ­¥å¤åˆ¶çš„æ€§èƒ½å¿…ç„¶ä¼šæ”¶åˆ°ä¸¥é‡çš„å½±å“ã€‚</p></li><li><p><strong>å¼‚æ­¥å¤åˆ¶(é»˜è®¤)ï¼š</strong>æä¾›äº†ä¸»ä»æ–¹æ¡ˆï¼Œé™ä½äº†å•èŠ‚ç‚¹è¿è¡Œæ•°æ®åº“çš„é£é™©</p><p>ä¸»åº“æ‰§è¡Œå®Œäº‹åŠ¡åç«‹å³å“åº”å®¢æˆ·ç«¯ï¼Œä¸ç†ä¼šä»åº“æ˜¯å¦æ¥æ”¶åˆ°è‡ªå·±çš„ä¿¡æ¯ã€‚è¿™ä¸ªæ–¹å¼å¯é æ€§å¾ˆå·®ï¼Œå®¹æ˜“ä¸¢å¤±æ•°æ®ï¼Œä½†æ˜¯å“åº”é€Ÿåº¦å¾ˆå¿«ã€‚å¦‚æœä¸»æœåŠ¡å™¨å´©æºƒï¼Œå®ƒå·²æäº¤çš„äº‹åŠ¡å¯èƒ½ä¸ä¼šä¼ è¾“åˆ°ä»»ä½•ä»æœåŠ¡å™¨ã€‚å› æ­¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»ä¸»æœåŠ¡å™¨æ•…éšœè½¬ç§»åˆ°ä»æœåŠ¡å™¨å¯èƒ½ä¼šå¯¼è‡´æ•…éšœè½¬ç§»åˆ°ç¼ºå°‘ä¸ä¸»æœåŠ¡å™¨ç›¸å…³çš„äº‹åŠ¡çš„æœåŠ¡å™¨ã€‚å¼‚æ­¥å¤åˆ¶æä¾›äº†è¾ƒä½çš„å†™å…¥å»¶è¿Ÿï¼Œå› ä¸ºå†™å…¥åœ¨å†™å…¥ä»å±ä¹‹å‰ç”±ä¸»æœºæœ¬åœ°ç¡®è®¤ã€‚å®ƒéå¸¸é€‚åˆè¯»å–æ‰©å±•ï¼Œå› ä¸ºæ·»åŠ æ›´å¤šå‰¯æœ¬ä¸ä¼šå½±å“å¤åˆ¶å»¶è¿Ÿã€‚å¼‚æ­¥å¤åˆ¶çš„è‰¯å¥½ç”¨ä¾‹åŒ…æ‹¬ä¸ºè¯»å–æ‰©å±•éƒ¨ç½²åªè¯»å‰¯æœ¬ã€ç”¨äºç¾éš¾æ¢å¤å’Œåˆ†æ&#x2F;æŠ¥å‘Šçš„å®æ—¶å¤‡ä»½å‰¯æœ¬ã€‚</p></li><li><p><strong>å¢å¼ºåŠåŒæ­¥å¤åˆ¶(ä¼˜åŒ–)ï¼š</strong>å¼‚æ­¥ä¸»ä»å¤åˆ¶çš„åŠ å¼ºï¼Œè§£å†³äº†æ•°æ®ä¸¢å¤±çš„é£é™©ï¼Œä½†æ˜¯ä¾ç„¶å­˜åœ¨ç½‘ç»œå»¶è¿Ÿï¼Œåˆ‡æ¢éº»çƒ¦çš„é—®é¢˜(ä¾‹å¦‚10ä¸ªèŠ‚ç‚¹ï¼Œ1ä¸»9ä»ï¼Œä¸»èŠ‚ç‚¹å®•æœºï¼Œå½“æŠŠä¸€ä¸ªä»èŠ‚ç‚¹æå‡ä¸ºä¸»èŠ‚ç‚¹åï¼Œå…¶å®ƒèŠ‚ç‚¹éœ€è¦æ‰‹åŠ¨ä¿®æ”¹master)</p><p>ä¹Ÿå« <code>semi-sync</code> å¤åˆ¶ï¼ŒæŒ‡çš„å°±æ˜¯ä¸»åº“å†™å…¥ binlog æ—¥å¿—ä¹‹åï¼Œå°±ä¼šå°†<strong>å¼ºåˆ¶</strong>æ­¤æ—¶ç«‹å³å°†æ•°æ®åŒæ­¥åˆ°ä»åº“ï¼Œä»åº“å°†æ—¥å¿—å†™å…¥è‡ªå·±æœ¬åœ°çš„ relay log ä¹‹åï¼Œæ¥ç€ä¼šè¿”å›ä¸€ä¸ª ack ç»™ä¸»åº“ï¼Œä¸»åº“æ¥æ”¶åˆ°<strong>è‡³å°‘ä¸€ä¸ªä»åº“</strong>çš„ ack ä¹‹åæ‰ä¼šè®¤ä¸ºå†™æ“ä½œå®Œæˆäº†ã€‚è¦å¯ç”¨åŠåŒæ­¥å¤åˆ¶ï¼Œéœ€è¦é¢å¤–çš„æ’ä»¶å®‰è£…æ­¥éª¤ï¼Œå¹¶ä¸”å¿…é¡»åœ¨æŒ‡å®šçš„ MySQL master å’Œ slave ä¸Šå¯ç”¨ã€‚</p></li><li><p><strong>ç»„å¤åˆ¶(MGR)ï¼š</strong>æ‹¥æœ‰äº†è‡ªåŠ¨æ•…éšœè½¬ç§»failoverçš„èƒ½åŠ›ï¼Œå½“ä¸»èŠ‚ç‚¹å‘ç”Ÿæ•…éšœ(å•ä¸»æ¨¡å¼æ‰éœ€è€ƒè™‘)æ—¶ï¼Œç»„å†…éƒ¨ä¼šè‡ªåŠ¨é€‰æ‹©ä¸»èŠ‚ç‚¹ã€‚</p><p>æ˜¯ä¸€ç§ä¸»ä»å¤åˆ¶çš„<strong>é«˜å¯ç”¨</strong>æŠ€æœ¯ï¼Œåˆ†ä¸º<strong>å•ä¸»æ¨¡å¼</strong>å’Œ<strong>å¤šä¸»æ¨¡å¼</strong>ã€‚ä¸ä¸Šè¿°å¤åˆ¶ä¸åŒçš„æ˜¯ï¼Œæ‰€æœ‰è¯»å†™äº‹åŠ¡ä»…åœ¨è·å¾—ç»„æ‰¹å‡†åæ‰æäº¤ã€‚</p></li></ul><h3 id="Parallel"><a href="#Parallel" class="headerlink" title="Parallel"></a>Parallel</h3><p>ä¸»å¤‡å»¶è¿Ÿçš„ä¸»è¦åŸå› åœ¨äºï¼Œmaster A ä¸Šäº§ç”Ÿ binlog çš„é€Ÿåº¦å¤§äºslave B å¤„ç† binlog çš„é€Ÿåº¦ã€‚æ•°æ®çš„ç§¯å‹å°±åœ¨äº <code>sql_thread</code> å¤„ç†çš„é€Ÿåº¦. ä¸ºäº†è¦å‡å°‘å»¶è¿Ÿ, æˆ‘æ‰¾åˆ°äº†ä»¥ä¸‹å‡ ç§æ–¹å¼</p><ol><li><p>å¹¶è¡Œå¤åˆ¶</p><p>Mysql 5.6ç‰ˆæœ¬åªæ”¯æŒ schema çº§åˆ«çš„å¹¶è¡Œå¤åˆ¶. ä¹Ÿå°±æ˜¯ä¸»åº“æœ‰ä¸¤ä¸ª schema åˆ†åˆ«æ˜¯ jiedu , wlry. ä»åº“ä¹Ÿæ˜¯è¿™ä¸¤ä¸ª, é‚£ä¹ˆè¿›è¡Œæ•°æ®åŒæ­¥æ—¶, æœ€å°çº§åˆ«ä¹Ÿæ˜¯ schema çº§åˆ«. ä¸ä¼šæå‡å•åº“å¤šè¡¨çš„é€Ÿåº¦</p><p>Mysql 5.7 ç‰ˆæœ¬æ”¯æŒäº†<strong>åŸºäºç»„æäº¤çš„å¹¶è¡Œå¤åˆ¶</strong>. è¯´èµ·æ¥æ¯”è¾ƒå¤æ‚, å°±æ˜¯è·Ÿå…¨å±€äº‹åŠ¡ ID æœ‰å…³. ä½†æ˜¯è¿™ç§å¤åˆ¶æ–¹å¼æ”¯æŒåˆ°äº†è¡¨çº§åˆ«.æ›´é€‚åˆå•åº“å¤šè¡¨!</p><p>Mysql 8.0 ç‰ˆæœ¬æ”¯æŒ WriteSet å¤åˆ¶æ–¹å¼.</p></li><li><p>ä¸»ä»åº“æ‹†åˆ†. å°†å†™å‹åŠ›è¿›è¡Œåˆ†æ•£. æé«˜ä»åº“çš„æ‰§è¡Œé€Ÿåº¦</p></li><li><p>é€šè¿‡ ShardingSphere æ¥æ§åˆ¶æ’å…¥æ•°æ®ä¹‹å, æŸ¥è¯¢ä¸»åº“æ•°æ®, è€Œä¸èµ°ä»åº“æŸ¥è¯¢. ç›´æ¥ä¸è®©ç”¨æˆ·æ„ŸçŸ¥åˆ°ä»»ä½•å»¶è¿Ÿ.</p></li></ol><h3 id="High-Availability"><a href="#High-Availability" class="headerlink" title="High Availability"></a>High Availability</h3><h4 id="MHA"><a href="#MHA" class="headerlink" title="MHA"></a>MHA</h4><p><strong>MHA</strong>ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š<strong>MHA Manager</strong>ï¼ˆç®¡ç†èŠ‚ç‚¹ï¼‰å’Œ<strong>MHA Node</strong>ï¼ˆæ•°æ®èŠ‚ç‚¹ï¼‰ã€‚MHA Managerå¯ä»¥å•ç‹¬éƒ¨ç½²åœ¨ä¸€å°ç‹¬ç«‹çš„æœºå™¨ä¸Šç®¡ç†å¤šä¸ªmaster-slaveé›†ç¾¤ï¼Œä¹Ÿå¯ä»¥éƒ¨ç½²åœ¨ä¸€å°slaveèŠ‚ç‚¹ä¸Šï¼Œç”Ÿäº§ç¯å¢ƒä¸­å¤šæ•°å•ç‹¬éƒ¨ç½²ã€‚ MHA Nodeè¿è¡Œåœ¨æ¯ä¸ªMySQLæœåŠ¡å™¨ä¸Šï¼ŒMHA Managerä¼šå®šæ—¶æ¢æµ‹é›†ç¾¤ä¸­çš„masterèŠ‚ç‚¹ï¼Œå½“masterå‡ºç°æ•…éšœæ—¶ï¼Œå®ƒå¯ä»¥è‡ªåŠ¨å°†åˆ¤æ–­æœ€æ–°æ•°æ®çš„slaveæå‡ä¸ºæ–°çš„masterï¼Œå¹¶å°†æ‰€æœ‰å…¶ä»–çš„slaveé‡æ–°æŒ‡å‘æ–°çš„masterã€‚ä½†æ˜¯éœ€è¦æ³¨æ„MHAæ˜¯ä¸ä¼šç®¡Slaveæ˜¯å¦å®•æœºçš„ï¼Œå¦‚æœSlaveå®•æœºï¼Œåº”ç”¨ç¨‹åºä¾ç„¶ä¼šé”™è¯¯çš„å‘å…¶å‘èµ·è¯·æ±‚ã€‚</p><p>åœ¨ä¸€ä¸ªMaster node CRASHæ—¶ï¼ŒMHA è´Ÿè´£Master-Slave Auto-failoverï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒMySQLå¤åˆ¶æ˜¯å¼‚æ­¥çš„ã€‚MHAè¯•å›¾ä»å®•æœºçš„ä¸»æœåŠ¡å™¨ä¸Šä¿å­˜äºŒè¿›åˆ¶æ—¥å¿—ï¼Œé€šè¿‡sshè¡¥é½æ—¥å¿—ï¼Œæ‰€ä»¥éœ€è¦rootç”¨æˆ·ï¼ŒåŒæ—¶è´Ÿè½½å¯åœVIP. å¦‚æœä¸»æœåŠ¡å™¨å´©æºƒï¼Œåˆ™å®ƒå·²æäº¤çš„äº‹åŠ¡å¯èƒ½å°šæœªä¼ è¾“åˆ°ä»»ä½•ä»æœåŠ¡å™¨ã€‚å› æ­¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ä»ä¸»æœåŠ¡å™¨åˆ°ä»æœåŠ¡å™¨çš„æ•…éšœè½¬ç§»å¯èƒ½å¯¼è‡´äº‹åŠ¡ä¸¢å¤±ï¼Œæ‰€ä»¥é€šå¸¸è¿˜éœ€è¦ä½¿ç”¨åŠåŒæ­¥æ›¿ä»£å¼‚æ­¥ï¼Œä¸åŠåŒæ­¥å¤åˆ¶ç›¸ç»“åˆï¼Œå¯ä»¥é™ä½ç”±äºä¸»ç¡¬ä»¶æ•…éšœå¯¼è‡´æ•°æ®ä¸¢å¤±çš„é£é™©ã€‚</p><p><a href="https://juejin.cn/post/6844904099075325960#heading-10https://juejin.cn/post/6844904099075325960#heading-10">ç®€å•æ­å»ºè¯·ç‚¹å‡»è¿™é‡Œ</a><a href="https://juejin.cn/post/6844904099075325960#heading-10https://juejin.cn/post/6844904099075325960#heading-10">ğŸ”—</a></p><p>ç”Ÿäº§ç¯å¢ƒä¸­æœ€å¸¸ç”¨çš„è¿˜æ˜¯é‡‡ç”¨MHAæ–¹æ¡ˆï¼Œå¹¶ä¸”ç½‘ç»œä¸Šæœ‰ä½¿ç”¨master_ip_failover_scriptè„šæœ¬åˆ›å»ºZookeeperèŠ‚ç‚¹çš„æ–¹å¼ï¼Œå†ç”±Javaç›‘å¬åè®©ShardingSphereåŠ¨æ€åˆ‡æ¢ä¸»åº“çš„é«˜å¯ç”¨æ–¹æ¡ˆï¼Œä½†æ˜¯æ²¡æ‰¾åˆ°å…·ä½“å®ç°ï¼Œè€Œä¸”è¿™å¥—æ¶æ„æ— æ³•å®ç°æ£€æµ‹ä»åº“æ˜¯å¦æ­£å¸¸ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å†å¼•å…¥HAProxyç»„ä»¶ï¼Œå¯¹æ‰€æœ‰slaveèŠ‚ç‚¹è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚</p><h4 id="MGR"><a href="#MGR" class="headerlink" title="MGR"></a>MGR</h4><p>MGRæ˜¯Mysqlå†…ç½®çš„é«˜å¯ç”¨ç»„ä»¶ï¼Œéœ€è¦Mysqlå¼€å¯GTIDæ–¹æ¡ˆæ‰èƒ½ä½¿ç”¨ã€‚è¿™ä¸ªæ–¹å¼æ˜¯Oracleå…¬å¸æ¨èçš„ï¼Œå¹¶ä¸”å¯ä»¥ä¸ShardingSphereç›¸ç»“åˆå®ç°åŠ¨æ€è½¬ç§» (ç›®å‰åªæ”¯æŒå•ä¸»æ¨¡å¼)ã€‚</p><h4 id="HAProxy"><a href="#HAProxy" class="headerlink" title="HAProxy"></a>HAProxy</h4><p>HAProxy ä»£è¡¨ High Availability Proxyï¼Œæ˜¯ä¸€æ¬¾å‡ºè‰²çš„åŸºäºè½¯ä»¶çš„ TCP&#x2F;HTTP è´Ÿè½½å‡è¡¡å™¨ã€‚ å®ƒåœ¨ä¸€ç»„æœåŠ¡å™¨ä¹‹é—´åˆ†é…å·¥ä½œè´Ÿè½½ï¼Œä»¥æœ€å¤§é™åº¦åœ°æé«˜æ€§èƒ½å¹¶ä¼˜åŒ–èµ„æºä½¿ç”¨ã€‚ HAProxy ä½¿ç”¨å¤æ‚ä¸”å¯å®šåˆ¶çš„å¥åº·æ£€æŸ¥æ–¹æ³•æ„å»ºï¼Œå…è®¸åœ¨å•ä¸ªè¿è¡Œå®ä¾‹ä¸­å®ç°å¤šä¸ªæœåŠ¡çš„è´Ÿè½½å¹³è¡¡ã€‚</p><p>HAProxyé€šè¿‡é…ç½®æ–‡ä»¶ä¸­å¯ä»¥é…ç½®Mysqlã€Tcpã€Httpä¸‰ç§æ£€æµ‹æ–¹å¼ï¼Œè‹¥æŸä¸ªèŠ‚ç‚¹å¼‚å¸¸ï¼ŒHAProxyå°†å¿½ç•¥è¯¥èŠ‚ç‚¹çš„è´Ÿè½½å‡è¡¡ã€‚</p><p>ä½†æ˜¯HAProxyæœ¬èº«æ˜¯å•ç‚¹çš„ï¼Œæˆ‘ä»¬ä¸ºäº†è§£å†³å•ç‚¹æ•…éšœçš„é—®é¢˜ï¼Œå¯ä»¥åŠ å…¥Keepalivedç­‰ç»„ä»¶è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p><a href="https://blog.csdn.net/qq_34556414/article/details/105143584">HAProxyçš„ç®€æ˜“å•ä¸»å¤šä»å®ç°</a></p><h4 id="Mycat"><a href="#Mycat" class="headerlink" title="Mycat"></a>Mycat</h4><p>çœ‹äº†ä¸€ä¸‹Mycatå®˜æ–¹æ–‡æ¡£ï¼Œå¯¹äºMGRã€MHAç­‰éƒ½æœ‰éå¸¸å¥½çš„å…¼å®¹æ¨¡å¼ï¼Œå¯ä»¥å®ç°åŠ¨æ€æ•°æ®æºæ›´æ”¹ï¼Œä½†æ˜¯ä½¿ç”¨ä¼¼ä¹ä¸å¤ªå¹¿æ³›ã€‚</p><hr><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span>Mysqlçš„æ•°æ®è™½ç„¶æ˜¯ä¸€è¡Œä¸€è¡Œçš„, ä½†æ˜¯è¿™äº›æ•°æ®ä¼šæœ€ç»ˆå­˜å‚¨åœ¨æ•°æ®é¡µé‡Œé¢. å½“ç”¨æˆ·æŸ¥è¯¢&#x2F;æ›´æ–°æŸä¸€æ¡æ•°æ®æ—¶, ä¼šå°†è¯¥æ•°æ®çš„å½“å‰é¡µä»¥åŠç›¸é‚»é¡µå…¨éƒ¨æ”¾å…¥åˆ°ç¼“å†²æ± é‡Œé¢.<a href="#fnref:1" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:2" class="footnote-text"><span>æè¿°ä¿¡æ¯æ˜¯æ•°æ®é¡µæ‰€å±çš„è¡¨ç©ºé—´, æ•°æ®é¡µçš„ç¼–å·, åœ¨ç¼“å†²æ± ä¸­çš„åœ°å€ä»¥åŠä¸€äº›é¢å¤–ä¿¡æ¯. æè¿°æ–‡ä»¶å¤§çº¦å æ®ç¼“å†²æ± çš„5%å®¹é‡. æ¯”å¦‚ä½ åˆ›å»ºçš„æ˜¯128Mbçš„ç¼“å†²æ± . é‚£ä¹ˆåŠ ä¸Šæè¿°ä¿¡æ¯, å®é™…ä¸Šåœ¨130+å·¦å³çš„å¤§å°.<a href="#fnref:2" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:3" class="footnote-text"><span>Mysqlçš„æ•°æ®å­˜å‚¨åœ¨äº†æ•°æ®é¡µé‡Œé¢, åŒæ ·çš„, RedoLogæ—¥å¿—ä¿¡æ¯ä¹Ÿå­˜å‚¨åœ¨äº†Blockä¸­. blockå¤§å°ä¸º512byte. åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†head body trailer<a href="#fnref:3" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:4" class="footnote-text"><span>å› ä¸ºå­˜åœ¨OS cacheçš„æƒ…å†µ, æ‰€ä»¥å®é™…ä¸Šå¹¶ä¸æ˜¯ç›´æ¥åˆ·å…¥åˆ°ç£ç›˜ä¸­, è€Œæ˜¯ä»å†…å­˜è¿›å…¥åˆ°OS cacheé‡Œ. ä¹‹åç”±æ“ä½œç³»ç»Ÿè¿›è¡Œæ–‡ä»¶å†™å…¥. Mysqlæœ‰å‚æ•°å¯ä»¥ç›´æ¥å°†æ—¥å¿—åˆ·å…¥ç£ç›˜, ä¸èµ°OS cache<a href="#fnref:4" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:5" class="footnote-text"><span>é¡µåˆ†è£‚çš„æ¦‚å¿µæ˜¯å½“å­˜åœ¨åä¸€ä¸ªæ•°æ®é¡µçš„éƒ¨åˆ†æ•°æ®ä¸»é”®æ¯”å‰ä¸€ä¸ªæ•°æ®é¡µä¸­çš„ä¸»é”®å°æ—¶, Mysqlä¼šè‡ªåŠ¨å¸®ä½ è°ƒæ•´ä¸»é”®å¤§å°, ä»–ä¼šä¿è¯è¿™ä¸¤ä¸ªæ•°æ®é¡µä¸­çš„ä¸»é”®å€¼ä¸€å®šæ˜¯æŒ‰ç…§ä»å°åˆ°å¤§çš„é¡ºåºæ’åˆ—<a href="#fnref:5" rev="footnote" class="footnote-backref"> â†©</a></span></span></li></ol></div></section>]]></content>
    
    
    <categories>
      
      <category>DataBase</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>SSOå•ç‚¹ç™»å½•</title>
    <link href="/2022/03/28/Distributed%20System/SSO%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/"/>
    <url>/2022/03/28/Distributed%20System/SSO%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<h2 id="åŒåŸŸåæ–¹å¼"><a href="#åŒåŸŸåæ–¹å¼" class="headerlink" title="åŒåŸŸåæ–¹å¼"></a>åŒåŸŸåæ–¹å¼</h2><ol><li><p><strong>ä½¿ç”¨å…±äº«Cookieæ¥è§£å†³Tokenå…±äº«é—®é¢˜ã€‚</strong></p><p>æ‰€è°“å…±äº«Cookieï¼Œå°±æ˜¯Cookieè®¾ç½®ä¸ºé¡¶åŸŸåï¼Œç„¶åå°±å¯ä»¥åœ¨äºŒçº§åŸŸåä¸‹çš„å…±äº«ï¼Œä¸¾ä¸ªä¾‹å­ï¼šå†™åœ¨çˆ¶åŸŸåstp.comä¸‹çš„Cookieï¼Œ<a href="http://åœ¨s1.stp.com/">åœ¨s1.stp.com</a>ã€s2.stp.comç­‰å­åŸŸåéƒ½æ˜¯å¯ä»¥å…±äº«è®¿é—®çš„ã€‚</p></li><li><p><strong>ä½¿ç”¨Redisæ¥è§£å†³Sessionå…±äº«é—®é¢˜ã€‚</strong></p><p>Cookieçš„é—®é¢˜è§£å†³äº†ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹sessionçš„é—®é¢˜ã€‚æˆ‘ä»¬åœ¨ssoç³»ç»Ÿç™»å½•äº†ï¼Œè¿™æ—¶å†è®¿é—®app1ï¼ŒCookieä¹Ÿå¸¦åˆ°äº†app1çš„æœåŠ¡ç«¯ï¼ˆServerï¼‰ï¼Œapp1çš„æœåŠ¡ç«¯æ€ä¹ˆæ‰¾åˆ°è¿™ä¸ªCookieå¯¹åº”çš„Sessionå‘¢ï¼Ÿè¿™é‡Œå°±è¦æŠŠ 3 ä¸ªç³»ç»Ÿçš„Sessionå…±äº«ï¼Œé‡‡ç”¨Redisæ¥å®ç°ã€‚</p></li></ol><h3 id="Shiro-Sessionæ¨¡å¼"><a href="#Shiro-Sessionæ¨¡å¼" class="headerlink" title="Shiro Sessionæ¨¡å¼"></a>Shiro Sessionæ¨¡å¼</h3><p>Shiroæ ‡å‡†æ¨¡å¼æ˜¯åŸºäºSessionæ¥åšçš„ï¼ŒSessionIDå­˜å‚¨åœ¨Cookieé‡Œã€‚ä¹Ÿå°±æ„å‘³ç€å¦‚æœæˆ‘ä»¬å¤šä¸ªç³»ç»Ÿéƒ½é‡‡ç”¨Shiroæ¡†æ¶è®¤è¯ã€‚</p><p>é‚£ä¹ˆå½“æˆ‘ä»¬åˆ é™¤äº†Redisçš„Sessionåï¼Œæ‰€æœ‰ç³»ç»Ÿéƒ½ä¼šå…¨éƒ¨æ³¨é”€ã€‚</p><h3 id="Sa-Token"><a href="#Sa-Token" class="headerlink" title="Sa-Token"></a>Sa-Token</h3><p>ç”¨æˆ·ç™»å½•æˆåŠŸï¼Œä¼šåˆ›å»ºå¤šä¸ªSessionå¯¹è±¡ï¼ˆå…¶å®å°±æ˜¯Mapé›†åˆä¹‹ç±»çš„ï¼‰å­˜å‚¨åˆ°Redisé‡Œé¢ï¼Œå†è¿”å›æµè§ˆå™¨ä¸€ä¸ªTokenæ ‡è¯†ï¼Œåç»­è¯·æ±‚æœåŠ¡å™¨æ£€éªŒè¯¥Cookieä¸­çš„Tokenã€‚</p><p>è¯¥Tokené‡Œé¢å­˜å‚¨äº†ç”¨æˆ·ä¿¡æ¯ï¼Œæ˜¯å¦ç™»å½•ç­‰ã€‚</p><p>ç”¨æˆ·è®¿é—®å…¶ä»–ç³»ç»Ÿæ—¶ï¼Œç½‘å…³æ‹¦æˆªæ ¡éªŒCookieä¸­çš„Tokenæ˜¯å¦æ­£ç¡®ï¼Œæ˜¯å¦ç™»å½•ï¼Œç„¶åå†äº¤ç”±åç»­ç™»å½•æ–¹æ³•ç»™ç”¨æˆ·åŠ æƒé™ä¿¡æ¯ã€‚</p><p>å½“ç”¨æˆ·ç‚¹å‡»æŸç³»ç»Ÿçš„æ³¨é”€åï¼Œå…ˆåˆ é™¤Cookieï¼Œå†åˆ é™¤Redisé‡Œçš„Sessionä¿¡æ¯ã€‚</p><h3 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h3><p>JWTå­˜å…¥åˆ°Cookieé‡Œé¢ï¼ŒAç³»ç»Ÿé¦–å…ˆç™»å½•ï¼Œç„¶åJWTå­˜å…¥åˆ°é¡¶çº§åŸŸåçš„Cookieé‡Œé¢ï¼ŒBç³»ç»Ÿç½‘å…³æ‹¦æˆªåï¼Œé‡å®šå‘åˆ°SSOæœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨è·å–Cookieæ˜¯å¦å­˜åœ¨å¹¶éªŒè¯ï¼ŒæˆåŠŸåè¿”å›ç»™Bç³»ç»Ÿã€‚</p><h2 id="ä¸åŒåŸŸçš„CASæ–¹å¼"><a href="#ä¸åŒåŸŸçš„CASæ–¹å¼" class="headerlink" title="ä¸åŒåŸŸçš„CASæ–¹å¼"></a>ä¸åŒåŸŸçš„CASæ–¹å¼</h2><blockquote><p>Spring Securityæœ‰ä¸<a href="https://github.com/apereo/cas">CAS</a>é›†æˆçš„ä¾¿æ·å†™æ³•, ç ”å‘è€…åªéœ€è¦é…ç½®åœ°å€, ä¸éœ€è¦å…³å¿ƒå¦‚ä½•ç»Ÿä¸€è®¤è¯.</p></blockquote><p>CAS ï¼ˆCentral Authentication Serviceï¼‰ä¸­å¤®è®¤è¯æœåŠ¡</p><ol><li><p>Aç³»ç»Ÿç™»å½•å¹¶é‡å®šå‘SSO é¦–å…ˆï¼Œç”¨æˆ·æƒ³è¦è®¿é—®ç³»ç»ŸA <a href="http://www.java3y.comå—é™çš„èµ„æº(æ¯”å¦‚è¯´è´­ç‰©è½¦åŠŸèƒ½ï¼Œè´­ç‰©è½¦åŠŸèƒ½éœ€è¦ç™»å½•åæ‰èƒ½è®¿é—®)ï¼Œç³»ç»ŸAwww.java3y.comå‘ç°ç”¨æˆ·å¹¶æ²¡æœ‰ç™»å½•ï¼Œäºæ˜¯é‡å®šå‘åˆ°ssoè®¤è¯ä¸­å¿ƒï¼Œå¹¶å°†è‡ªå·±çš„åœ°å€ä½œä¸ºå‚æ•°ã€‚è¯·æ±‚çš„åœ°å€å¦‚ä¸‹ï¼š">www.java3y.comå—é™çš„èµ„æº(æ¯”å¦‚è¯´è´­ç‰©è½¦åŠŸèƒ½ï¼Œè´­ç‰©è½¦åŠŸèƒ½éœ€è¦ç™»å½•åæ‰èƒ½è®¿é—®)ï¼Œç³»ç»ŸAwww.java3y.comå‘ç°ç”¨æˆ·å¹¶æ²¡æœ‰ç™»å½•ï¼Œäºæ˜¯é‡å®šå‘åˆ°ssoè®¤è¯ä¸­å¿ƒï¼Œå¹¶å°†è‡ªå·±çš„åœ°å€ä½œä¸ºå‚æ•°ã€‚è¯·æ±‚çš„åœ°å€å¦‚ä¸‹ï¼š</a></p><p><a href="http://www.sso.com/?service=www.java3y.com">http://www.sso.com?service=www.java3y.com</a></p></li><li><p>SSOè¿›è¡Œè®¤è¯å¹¶è®¾ç½®SSOåŸŸçš„Tokenï¼Œå¹¶é‡å®šå‘ç»™Aç³»ç»Ÿ ssoè®¤è¯ä¸­å¿ƒå‘ç°ç”¨æˆ·æœªç™»å½•ï¼Œå°†ç”¨æˆ·å¼•å¯¼è‡³ç™»å½•é¡µé¢ï¼Œç”¨æˆ·è¿›è¡Œè¾“å…¥ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œç™»å½•ï¼Œç”¨æˆ·ä¸è®¤è¯ä¸­å¿ƒå»ºç«‹å…¨å±€ä¼šè¯ï¼ˆç”Ÿæˆä¸€ä»½Tokenï¼Œå†™åˆ°Cookieä¸­ï¼Œä¿å­˜åœ¨æµè§ˆå™¨ä¸Šï¼‰</p><p>éšåï¼Œè®¤è¯ä¸­å¿ƒé‡å®šå‘å›ç³»ç»ŸAï¼Œå¹¶æŠŠTokenæºå¸¦è¿‡å»ç»™ç³»ç»ŸAï¼Œé‡å®šå‘çš„åœ°å€å¦‚ä¸‹ï¼š</p><p><a href="http://www.java3y.com/?token=xxxxxxx">http://www.java3y.com?token=xxxxxxx</a></p></li><li><p>Aç³»ç»Ÿæºå¸¦Tokenå»SSOéªŒè¯ï¼Œå¹¶ç¡®è®¤ç™»å½• æ¥ç€ï¼Œç³»ç»ŸAå»ssoè®¤è¯ä¸­å¿ƒéªŒè¯è¿™ä¸ªTokenæ˜¯å¦æ­£ç¡®ï¼Œå¦‚æœæ­£ç¡®ï¼Œåˆ™ç³»ç»ŸAå’Œç”¨æˆ·å»ºç«‹å±€éƒ¨ä¼šè¯ï¼ˆåˆ›å»ºSessionï¼‰ã€‚åˆ°æ­¤ï¼Œç³»ç»ŸAå’Œç”¨æˆ·å·²ç»æ˜¯ç™»å½•çŠ¶æ€äº†ã€‚</p></li><li><p>ç”¨æˆ·ç™»å½•Bç³»ç»Ÿï¼Œé‡å®šå‘åˆ°SSOï¼ŒSSOæ£€æµ‹Cookieé‡Œæ˜¯å¦å­˜åœ¨Tokenå¹¶éªŒè¯ æ­¤æ—¶ï¼Œç”¨æˆ·æƒ³è¦è®¿é—®ç³»ç»ŸB<a href="http://www.java4y.comå—é™çš„èµ„æº(æ¯”å¦‚è¯´è®¢å•åŠŸèƒ½,è®¢å•åŠŸèƒ½éœ€è¦ç™»å½•åæ‰èƒ½è®¿é—®),ç³»ç»Ÿb/">www.java4y.comå—é™çš„èµ„æº(æ¯”å¦‚è¯´è®¢å•åŠŸèƒ½ï¼Œè®¢å•åŠŸèƒ½éœ€è¦ç™»å½•åæ‰èƒ½è®¿é—®)ï¼Œç³»ç»ŸB</a> <a href="http://www.java4y.comå‘ç°ç”¨æˆ·å¹¶æ²¡æœ‰ç™»å½•ï¼Œäºæ˜¯é‡å®šå‘åˆ°ssoè®¤è¯ä¸­å¿ƒï¼Œå¹¶å°†è‡ªå·±çš„åœ°å€ä½œä¸ºå‚æ•°ã€‚è¯·æ±‚çš„åœ°å€å¦‚ä¸‹ï¼š">www.java4y.comå‘ç°ç”¨æˆ·å¹¶æ²¡æœ‰ç™»å½•ï¼Œäºæ˜¯é‡å®šå‘åˆ°ssoè®¤è¯ä¸­å¿ƒï¼Œå¹¶å°†è‡ªå·±çš„åœ°å€ä½œä¸ºå‚æ•°ã€‚è¯·æ±‚çš„åœ°å€å¦‚ä¸‹ï¼š</a></p><p><a href="http://www.sso.com/?service=www.java4y.com">http://www.sso.com?service=www.java4y.com</a></p></li><li><p>SSOå‘ç°ç”¨æˆ·å·²ç™»å½•ï¼Œå°†Tokené‡å®šå‘Bç³»ç»Ÿ æ³¨æ„ï¼Œå› ä¸ºä¹‹å‰ç”¨æˆ·ä¸è®¤è¯ä¸­å¿ƒ<a href="http://www.sso.comå·²ç»å»ºç«‹äº†å…¨å±€ä¼šè¯(å½“æ—¶å·²ç»æŠŠcookieä¿å­˜åˆ°æµè§ˆå™¨ä¸Šäº†),æ‰€ä»¥è¿™æ¬¡ç³»ç»Ÿbé‡å®šå‘åˆ°è®¤è¯ä¸­å¿ƒwww.sso.comæ˜¯å¯ä»¥å¸¦ä¸Šcookieçš„./">www.sso.comå·²ç»å»ºç«‹äº†å…¨å±€ä¼šè¯ï¼ˆå½“æ—¶å·²ç»æŠŠCookieä¿å­˜åˆ°æµè§ˆå™¨ä¸Šäº†ï¼‰ï¼Œæ‰€ä»¥è¿™æ¬¡ç³»ç»ŸBé‡å®šå‘åˆ°è®¤è¯ä¸­å¿ƒwww.sso.comæ˜¯å¯ä»¥å¸¦ä¸ŠCookieçš„ã€‚</a> è®¤è¯ä¸­å¿ƒæ ¹æ®å¸¦è¿‡æ¥çš„Cookieå‘ç°å·²ç»ä¸ç”¨æˆ·å»ºç«‹äº†å…¨å±€ä¼šè¯äº†ï¼Œè®¤è¯ä¸­å¿ƒé‡å®šå‘å›ç³»ç»ŸBï¼Œå¹¶æŠŠTokenæºå¸¦è¿‡å»ç»™ç³»ç»ŸBï¼Œé‡å®šå‘çš„åœ°å€å¦‚ä¸‹ï¼š</p><p><a href="http://www.java4y.com/?token=xxxxxxx">http://www.java4y.com?token=xxxxxxx</a></p></li><li><p>Bç³»ç»Ÿæºå¸¦Tokenå»SSOéªŒè¯ï¼Œå¹¶ç¡®è®¤ç™»å½• æ¥ç€ï¼Œç³»ç»ŸBå»ssoè®¤è¯ä¸­å¿ƒéªŒè¯è¿™ä¸ªTokenæ˜¯å¦æ­£ç¡®ï¼Œå¦‚æœæ­£ç¡®ï¼Œåˆ™ç³»ç»ŸBå’Œç”¨æˆ·å»ºç«‹å±€éƒ¨ä¼šè¯ï¼ˆåˆ›å»ºSessionï¼‰ã€‚åˆ°æ­¤ï¼Œç³»ç»ŸBå’Œç”¨æˆ·å·²ç»æ˜¯ç™»å½•çŠ¶æ€äº†ã€‚</p></li></ol><h3 id="ç¥¨æ®æ¨¡å¼"><a href="#ç¥¨æ®æ¨¡å¼" class="headerlink" title="ç¥¨æ®æ¨¡å¼"></a>ç¥¨æ®æ¨¡å¼</h3><p>åœ¨CASæ ‡å‡†ä¸­ï¼Œç”¨æˆ·ç™»å½•è®¤è¯çš„æ“ä½œå¦‚ä¸‹ã€‚</p><ol><li>ç”¨æˆ·è®¿é—®Aç³»ç»Ÿï¼Œé‡å®šå‘SSOï¼Œå¹¶æºå¸¦å½“å‰ç³»ç»Ÿåœ°å€ã€‚</li><li>SSOè¿›è¡Œç™»å½•ï¼Œå¹¶ç”Ÿæˆ key &#x3D; CASTGC, value &#x3D; ${TGC}çš„Cookieï¼Œä»¥åŠkey &#x3D; ${TGC}, value &#x3D; ${TGT}çš„Sessionã€‚</li><li>SSOåˆ†å‘STç»™Aç³»ç»Ÿï¼ŒAç³»ç»Ÿæºå¸¦STå»SSOéªŒè¯ï¼ŒéªŒè¯é€šè¿‡ï¼ŒAç³»ç»Ÿæ­£å¸¸ç™»å½•ã€‚</li><li>ç”¨æˆ·è®¿é—®Bç³»ç»Ÿï¼Œé‡å®šå‘SSO</li><li>SSOå‘ç°Cookieä¸­æœ‰CASTGCçš„Cookieï¼Œè·å–åˆ°TGCçš„å€¼å»SessionæŸ¥æ‰¾TGTæ˜¯å¦å­˜åœ¨ï¼Œæ‰¾åˆ°çš„è¯å°±è¯´æ˜ç™»å½•è¿‡äº†ã€‚</li><li>SSOåˆ†å‘STç»™Bç³»ç»Ÿï¼ŒBç³»ç»Ÿæºå¸¦STå»SSOéªŒè¯ï¼ŒéªŒè¯é€šè¿‡ï¼ŒBç³»ç»Ÿæ­£å¸¸ç™»å½•ã€‚</li></ol><h3 id="ä¸€æ¬¡æ³¨é”€ï¼Œå…¨ç«¯ä¸‹çº¿"><a href="#ä¸€æ¬¡æ³¨é”€ï¼Œå…¨ç«¯ä¸‹çº¿" class="headerlink" title="ä¸€æ¬¡æ³¨é”€ï¼Œå…¨ç«¯ä¸‹çº¿"></a>ä¸€æ¬¡æ³¨é”€ï¼Œå…¨ç«¯ä¸‹çº¿</h3><p>SSOåœ¨è¢«é‡å®šå‘è¿‡æ¥æ—¶ï¼Œå°†ä¸šåŠ¡ç³»ç»Ÿçš„é¡¹ç›®åœ°å€å­˜å…¥åˆ°ç”¨æˆ·ç›¸å…³çš„Seté›†åˆé‡Œã€‚</p><p>å½“æŸä¸ªç³»ç»Ÿç‚¹å‡»æ³¨é”€æŒ‰é’®ï¼Œå°†è¯¥è¯·æ±‚å‘é€è‡³SSOä¸­ï¼Œè®©SSOéå†Seté›†åˆå¯¹åœ°å€åè¿½åŠ æ³¨é”€å­—ç¬¦ä¸²ï¼Œè¿›è¡Œé€ä¸€ä¸‹çº¿æ“ä½œï¼Œç„¶åå†æ³¨é”€SSOã€‚</p><h3 id="æœ¬åœ°æœåŠ¡"><a href="#æœ¬åœ°æœåŠ¡" class="headerlink" title="æœ¬åœ°æœåŠ¡"></a>æœ¬åœ°æœåŠ¡</h3><h4 id="è®¤è¯"><a href="#è®¤è¯" class="headerlink" title="è®¤è¯"></a>è®¤è¯</h4><ol><li>ç”¨æˆ·è®¿é—®&#x2F;business&#x2F;index , å› ä¸ºæ²¡ç™»å½•, è¢«é…ç½®çš„<code>authenticationEntryPoint</code>å‘é€SSOç™»å½•è¯·æ±‚é‡å®šå‘è‡³&#x2F;sso&#x2F;code?redirectUrl</li><li>SSOæœåŠ¡çš„é»˜è®¤æœªè®¤è¯æ‹¦æˆªå™¨æ‹¦æˆªåˆ°è¯¥è¯·æ±‚, é‡å®šå‘è‡³SSOç™»å½•é¡µé¢.</li><li>ç”¨æˆ·ç™»å½•æˆåŠŸå, äº¤ç”±ç ”å‘äººå‘˜å®ç°SSOæœåŠ¡ä¸­çš„successHandlerç±»è¿›è¡Œå¤„ç†, <code>authenticationDetailsSource.buildDetails(request)</code>è®¾ç½®detailsä¿¡æ¯åˆ°Authenticationé‡Œé¢, è®°å½•æ—¥å¿—ç­‰, å¹¶æ ¹æ®savedRequesté‡å®šå‘åˆ°ä¸šåŠ¡çš„index æˆ–è€… SSOçš„index</li><li>å†æ¬¡è®¿é—®&#x2F;business&#x2F;index , è¿˜æ˜¯å› ä¸ºæ²¡ç™»å½•, è¢«é…ç½®çš„<code>authenticationEntryPoint</code>å‘é€SSOç™»å½•è¯·æ±‚é‡å®šå‘è‡³&#x2F;sso&#x2F;code?redirectUrl</li><li>è¿™ä¸€æ¬¡SSOé€šè¿‡å·²ç»å­˜åœ¨çš„sessionå‘ç°è®¤è¯äº†, ä¸å†æ‹¦æˆª, è¿›å…¥codeæ–¹æ³•, æŸ¥è¯¢å…·ä½“çš„å®¢æˆ·ç«¯ä¿¡æ¯, æ ¹æ®sessionä¸­çš„ç”¨æˆ·ä¿¡æ¯ä¸æŸ¥è¯¢çš„å®¢æˆ·ç«¯ä¿¡æ¯å­˜å…¥map, key&#x3D;code, value&#x3D;authentication, å†æ ¹æ®redirectUrlè¿”å›é‡å®šå‘è‡³ä¸šåŠ¡çš„postç™»å½•è¯·æ±‚(&#x2F;ssoLogin)</li><li>è¿™ä¸€æ¬¡è¯·æ±‚åœ°å€æ˜¯&#x2F;ssoLogin, è¯¥åœ°å€æ˜¯å­ç±»æ„é€ å™¨ä¸­å®šä¹‰çš„, æ‰€ä»¥è¢«<code>AbstractAuthenticationProcessingFilter</code>è¿‡æ»¤å™¨åŒ¹é…åˆ°. æ ¹æ®codeå‚æ•°, newä¸€ä¸ªAuthentication, å¹¶authenticationDetailsSource.buildDetails(request)è®¾ç½®detailsä¿¡æ¯åˆ°Authenticationé‡Œé¢, å¹¶åˆ›å»ºä¸€ä¸ªå½“å‰sessionå¹¶ä¼ å…¥. æ£€æŸ¥codeå‚æ•°æ˜¯å¦å­˜åœ¨, ä¸å­˜åœ¨å°±é‡æ–°å»è·å–code, å­˜åœ¨å°±è¿›å…¥è‡ªå®šä¹‰è®¤è¯é€»è¾‘<code>SsoAuthenticationProvider</code></li><li>è¯¥è®¤è¯æ–¹æ³•ä¸­è¿›è¡Œè¿œç¨‹è°ƒç”¨&#x2F;sso&#x2F;verifyæ–¹æ³•, é€šè¿‡codeå‚æ•°ä»mapä¸­åˆ é™¤è¯¥keyå¹¶è·å–authenticationå¯¹è±¡, ç„¶åè¿”å›userä¿¡æ¯å¯¹è±¡, é‡Œé¢åŒ…å«SSOçš„sessionid, å°†ä»–ä¹Ÿæ”¾å…¥authenticationå¯¹è±¡é‡Œé¢, ç„¶åè¿”å›authentication <strong>åœ¨è¿™ä¸€æ­¥ä¸­, å¦‚æœé¡¹ç›®ä¹‹é—´å…è®¸å…±äº«Redis, åˆ™ä¸éœ€è¦å°†ç”¨æˆ·ä¿¡æ¯é€šè¿‡httpçš„æ–¹å¼åŒæ­¥</strong></li><li>è¿›å…¥ä¸šåŠ¡çš„ç™»å½•æˆåŠŸsuccessHandlerç±»è¿›è¡Œå¤„ç†,å°†SSOçš„sessionidä¸å½“å‰ä¸šåŠ¡çš„sessionidç»‘å®šæ”¾å…¥åŸŸä¸­, è·å–savedRequestå¹¶é‡å®šå‘</li></ol><h4 id="ç™»å‡º"><a href="#ç™»å‡º" class="headerlink" title="ç™»å‡º"></a>ç™»å‡º</h4><ol><li>ç”¨æˆ·è°ƒç”¨å½“å‰ä¸šåŠ¡çš„ç™»å‡ºæ–¹æ³•, è¯¥æ–¹æ³•é‡å®šå‘åˆ°SSOç™»å‡ºæ–¹æ³•</li><li>SSOç™»å‡ºæ–¹æ³•æ ¹æ®é…ç½®å¥½çš„æ‰€æœ‰ä¸šåŠ¡æ¨¡å—ä¿¡æ¯, å¾ªç¯è·å–æ‰€æœ‰çš„ç™»å‡ºåœ°å€, ä¼ å…¥SSOçš„sessionIdå¹¶è¿›è¡Œè°ƒç”¨</li><li>æ¯ä¸€ä¸ªä¸šåŠ¡ç™»å‡ºæ–¹æ³•å¤„ç†éƒ½éœ€è¦æ ¹æ®SSOçš„sessionidæ‰¾åˆ°å½“å‰ä¸šåŠ¡çš„sessionId, ç„¶åæ³¨é”€.</li></ol>]]></content>
    
    
    <categories>
      
      <category>Distributed System</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Oauth2</title>
    <link href="/2022/03/28/Distributed%20System/Oauth2/"/>
    <url>/2022/03/28/Distributed%20System/Oauth2/</url>
    
    <content type="html"><![CDATA[<h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><hr><p>ç®€å•è¯´ï¼ŒOAuth å°±æ˜¯ä¸€ç§æˆæƒæœºåˆ¶ã€‚æ•°æ®çš„æ‰€æœ‰è€…å‘Šè¯‰ç³»ç»Ÿï¼ŒåŒæ„æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨è¿›å…¥ç³»ç»Ÿï¼Œè·å–è¿™äº›æ•°æ®ã€‚ç³»ç»Ÿä»è€Œäº§ç”Ÿä¸€ä¸ªçŸ­æœŸçš„è¿›å…¥ä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œç”¨æ¥ä»£æ›¿å¯†ç ï¼Œä¾›ç¬¬ä¸‰æ–¹åº”ç”¨ä½¿ç”¨ã€‚</p><p>ä»¤ç‰Œï¼ˆtokenï¼‰ä¸å¯†ç ï¼ˆpasswordï¼‰çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼Œéƒ½å¯ä»¥è¿›å…¥ç³»ç»Ÿï¼Œä½†æ˜¯æœ‰ä¸‰ç‚¹å·®å¼‚ã€‚</p><ol><li>ä»¤ç‰Œæ˜¯çŸ­æœŸçš„ï¼Œåˆ°æœŸä¼šè‡ªåŠ¨å¤±æ•ˆï¼Œç”¨æˆ·è‡ªå·±æ— æ³•ä¿®æ”¹ã€‚å¯†ç ä¸€èˆ¬é•¿æœŸæœ‰æ•ˆï¼Œç”¨æˆ·ä¸ä¿®æ”¹ï¼Œå°±ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚</li><li>ä»¤ç‰Œå¯ä»¥è¢«æ•°æ®æ‰€æœ‰è€…æ’¤é”€ï¼Œä¼šç«‹å³å¤±æ•ˆã€‚</li><li>ä»¤ç‰Œæœ‰æƒé™èŒƒå›´ï¼ˆscopeï¼‰ï¼Œå¯¹äºç½‘ç»œæœåŠ¡æ¥è¯´ï¼Œåªè¯»ä»¤ç‰Œå°±æ¯”è¯»å†™ä»¤ç‰Œæ›´å®‰å…¨ã€‚å¯†ç ä¸€èˆ¬æ˜¯å®Œæ•´æƒé™ã€‚</li></ol><h2 id="è§’è‰²"><a href="#è§’è‰²" class="headerlink" title="è§’è‰²"></a>è§’è‰²</h2><hr><ul><li>Resource owner (èµ„æºæ‹¥æœ‰è€…) ï¼šæ‹¥æœ‰è¯¥èµ„æºçš„æœ€ç»ˆç”¨æˆ·ï¼Œä»–æœ‰è®¿é—®èµ„æºçš„è´¦å·å¯†ç ï¼ˆå¾®ä¿¡ç”¨æˆ·ï¼‰</li><li>Resource server (èµ„æºæœåŠ¡å™¨) ï¼šæ‹¥æœ‰å—ä¿æŠ¤èµ„æºçš„æœåŠ¡å™¨ï¼Œå¦‚æœè¯·æ±‚åŒ…å«æ­£ç¡®çš„è®¿é—®ä»¤ç‰Œï¼Œå¯ä»¥è®¿é—®èµ„æºï¼ˆå¾®ä¿¡æœåŠ¡å™¨ï¼‰</li><li>Client (å®¢æˆ·ç«¯) ï¼šè®¿é—®èµ„æºçš„å®¢æˆ·ç«¯ï¼Œä¼šä½¿ç”¨è®¿é—®ä»¤ç‰Œå»è·å–èµ„æºæœåŠ¡å™¨çš„èµ„æºï¼Œå¯ä»¥æ˜¯æµè§ˆå™¨ã€ç§»åŠ¨è®¾å¤‡æˆ–è€…æœåŠ¡å™¨ï¼ˆæˆ’æ¯’ç½‘ç«™ï¼‰</li><li>Authentication server (è®¤è¯æœåŠ¡å™¨) ï¼šç”¨äºè®¤è¯ç”¨æˆ·çš„æœåŠ¡å™¨ï¼Œå¦‚æœå®¢æˆ·ç«¯è®¤è¯é€šè¿‡ï¼Œå‘æ”¾è®¿é—®èµ„æºæœåŠ¡å™¨çš„ä»¤ç‰Œï¼ˆå¾®ä¿¡è®¤è¯æœåŠ¡ï¼‰</li></ul><h2 id="æˆæƒæ¨¡å¼"><a href="#æˆæƒæ¨¡å¼" class="headerlink" title="æˆæƒæ¨¡å¼"></a>æˆæƒæ¨¡å¼</h2><h3 id="æˆæƒç "><a href="#æˆæƒç " class="headerlink" title="æˆæƒç "></a>æˆæƒç </h3><p>æˆæƒç ï¼ˆauthorization codeï¼‰æ–¹å¼ï¼ŒæŒ‡çš„æ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨å…ˆç”³è¯·ä¸€ä¸ªæˆæƒç ï¼Œç„¶åå†ç”¨è¯¥ç è·å–ä»¤ç‰Œã€‚è¿™ç§æ–¹å¼æ˜¯æœ€å¸¸ç”¨çš„æµç¨‹ï¼Œå®‰å…¨æ€§ä¹Ÿæœ€é«˜ï¼Œå®ƒé€‚ç”¨äºé‚£äº›æœ‰åç«¯çš„ Web åº”ç”¨ã€‚</p><ol><li>A ç½‘ç«™æä¾›ä¸€ä¸ªé“¾æ¥ï¼Œç”¨æˆ·ç‚¹å‡»åå°±ä¼šè·³è½¬åˆ° B ç½‘ç«™ï¼Œæˆæƒç”¨æˆ·æ•°æ®ç»™ A ç½‘ç«™ä½¿ç”¨ã€‚ä¸‹é¢å°±æ˜¯ A ç½‘ç«™è·³è½¬ B ç½‘ç«™çš„ä¸€ä¸ªç¤ºæ„é“¾æ¥ã€‚ <em><strong>åœ¨è¿™ä¸€æ­¥è¯·æ±‚æ—¶, å¦‚æœæ£€æµ‹åˆ°scopeå‚æ•°, ä¸€èˆ¬ä¼šå¼¹å‡ºå…·ä½“çš„æˆæƒé¡µé¢, ç”¨æˆ·ç¡®å®šæˆæƒæ‰ä¼šå¾€ä¸‹èµ°, è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆéœ€è¦authorize, è€Œä¸æ˜¯ç›´æ¥è¯·æ±‚tokençš„åŸå› </strong></em></li></ol><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// response_typeå‚æ•°è¡¨ç¤ºè¦æ±‚è¿”å›æˆæƒç ï¼ˆcodeï¼‰</span><br><span class="hljs-comment">// client_idå‚æ•°è®© B çŸ¥é“æ˜¯è°åœ¨è¯·æ±‚, ä¸€ä¸ªåº”ç”¨ä¸€ä¸ªid</span><br><span class="hljs-comment">// redirect_uriå‚æ•°æ˜¯ B æ¥å—æˆ–æ‹’ç»è¯·æ±‚åçš„è·³è½¬ç½‘å€</span><br><br>**<span class="hljs-comment">// scopeï¼šå‚æ•°è¡¨ç¤ºè¦æ±‚çš„æˆæƒèŒƒå›´ï¼ˆè¿™é‡Œæ˜¯åªè¯»ï¼‰, ä¹Ÿå¯ä»¥ä¸ä¼ </span><br><span class="hljs-comment">// scopeï¼šå¦‚æœä¼ äº†, æœåŠ¡ç«¯éœ€è¦æ£€æŸ¥å»æ•°æ®åº“è¯¥åº”ç”¨çš„scopeæ˜¯å¦ä¸ä¹‹å»åˆ, ä¸ç¬¦åˆç›´æ¥è¿”å›é”™è¯¯ä¿¡æ¯</span><br><span class="hljs-comment">// scopeï¼šå¦‚æœä¸ä¼ , åˆ™è¡¨ç¤ºé™é»˜æˆæƒ, ä¸è¿”å›ä»»ä½•æƒé™scope, åªè¡¨æ˜ç™»å½•äº†, æ‰€ä»¥ä¹Ÿä¸èƒ½è·å–ä»»ä½•ä¿¡æ¯, å½“ç„¶ä½ ä¹Ÿå¯ä»¥å»æŸ¥è¯¢è¯¥ç”¨æˆ·çš„æ‰€æœ‰scope, åç»­è¿”å›ç»™ä»–**</span><br>**<span class="hljs-comment">// secretï¼šä¸€å¼€å§‹ä¸ä¼ æ˜¯å› ä¸ºåé¢æœ‰é‡å®šå‘ï¼Œé‡å®šå‘æ˜¯å¯æ„ŸçŸ¥çš„ï¼Œæœ‰å¯èƒ½è¢«å…¶ä»–ç½‘ç«™æ‹¿åˆ°**</span><br>https:<span class="hljs-comment">//b.com/oauth/authorize?</span><br>  response_type=code&amp;<br>  client_id=CLIENT_ID&amp;<br>  redirect_uri=CALLBACK_URL&amp;<br>  scope=read<br></code></pre></td></tr></table></figure><ol><li>ç”¨æˆ·è·³è½¬åï¼ŒB ç½‘ç«™ä¼šè¦æ±‚ç”¨æˆ·ç™»å½•ï¼Œç„¶åè¯¢é—®æ˜¯å¦åŒæ„ç»™äºˆ A ç½‘ç«™æˆæƒã€‚ç”¨æˆ·è¡¨ç¤ºåŒæ„ï¼Œè¿™æ—¶ B ç½‘ç«™å°±ä¼šè·³å›redirect_uriå‚æ•°æŒ‡å®šçš„ç½‘å€ã€‚è·³è½¬æ—¶ï¼Œä¼šä¼ å›ä¸€ä¸ªæˆæƒç ï¼Œå°±åƒä¸‹é¢è¿™æ ·ã€‚</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// codeå‚æ•°å°±æ˜¯æˆæƒç , éœ€è¦è®¾ç½®è¿‡æœŸæ—¶é—´, å¯ä»¥æ”¾åœ¨redisé‡Œé¢</span><br><span class="hljs-comment">// æ­£å¸¸ä½¿ç”¨ä¸€æ¬¡ä»¥å, å°±è¦è¢«é”€æ¯, ä¸å…è®¸ç¬¬äºŒæ¬¡ä½¿ç”¨</span><br>https:<span class="hljs-comment">//a.com/callback?code=AUTHORIZATION_CODE</span><br></code></pre></td></tr></table></figure><ol><li>A ç½‘ç«™æ‹¿åˆ°æˆæƒç ä»¥åï¼Œå°±å¯ä»¥åœ¨åç«¯ï¼Œå‘ B ç½‘ç«™è¯·æ±‚ä»¤ç‰Œã€‚</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs Java">**<span class="hljs-comment">// client_idå‚æ•°è®© B çŸ¥é“æ˜¯è°åœ¨è¯·æ±‚, ä¸€ä¸ªåº”ç”¨ä¸€ä¸ªid</span><br><span class="hljs-comment">// client_secretå‚æ•°ç”¨æ¥è®©Bç¡®è®¤Açš„èº«ä»½, æ˜¯åº”ç”¨çš„ä¿å¯†ç§˜é’¥, å¯ä»¥è®©æœåŠ¡å™¨åˆ†å‘ä¸€ä¸ªåŠ å¯†ç§˜é’¥, ç„¶åæœåŠ¡å™¨æœ‰è§£å¯†çš„ç®—æ³•**</span><br><br>**<span class="hljs-comment">// æœ‰äº›åº”ç”¨åœ¨è®©ç¬¬ä¸‰æ–¹è¯·æ±‚æ—¶, ä¼šæœ‰ä¸€ä¸ªå‰ç½®æ¥å£, è®©ç¬¬ä¸‰æ–¹å…¬å¸è¾“å…¥åº”ç”¨åç§°ç­‰ä¿¡æ¯, ç„¶åè¿”å›ç»™client_idå’Œclient_secret**</span><br>**<span class="hljs-comment">// å¦‚æœæ˜¯è‡ªå·±çš„åº”ç”¨, é‚£ä¹ˆè‡ªå·±çº¦å®šå¥½è¿™ä¸¤ä¸ªä¿¡æ¯, è®©å®¢æˆ·ç«¯åŠæœåŠ¡ç«¯éƒ½èƒ½çŸ¥æ™“å°±å¯ä»¥äº†**</span><br><br><span class="hljs-comment">// grant_typeå‚æ•°çš„å€¼æ˜¯AUTHORIZATION_CODE, è¡¨ç¤ºé‡‡ç”¨çš„æˆæƒæ–¹å¼æ˜¯æˆæƒç </span><br><span class="hljs-comment">// codeå‚æ•°æ˜¯ä¸Šä¸€æ­¥æ‹¿åˆ°çš„æˆæƒç </span><br><span class="hljs-comment">// redirect_uriå‚æ•°æ˜¯ä»¤ç‰Œé¢å‘åçš„å›è°ƒç½‘å€</span><br>https:<span class="hljs-comment">//b.com/oauth/token?</span><br> client_id=CLIENT_ID&amp;<br> client_secret=CLIENT_SECRET&amp;<br> grant_type=authorization_code&amp;<br> code=AUTHORIZATION_CODE&amp;<br> redirect_uri=CALLBACK_URL<br></code></pre></td></tr></table></figure><ol><li>B ç½‘ç«™æ”¶åˆ°è¯·æ±‚ä»¥åï¼Œå°±ä¼šé¢å‘ä»¤ç‰Œã€‚å…·ä½“åšæ³•æ˜¯å‘redirect_uriæŒ‡å®šçš„ç½‘å€ï¼Œå‘é€ä¸€æ®µ JSON æ•°æ®ã€‚</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JSON"><span class="hljs-punctuation">&#123;</span>    <br>  <span class="hljs-attr">&quot;access_token&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;ONWVJzfOv1XidEdeBAdqPxYGL60toIzhzHRwp1ySPHMEKWFbp5FIp3FuaQ3g&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;token_type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bearer&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;expires_in&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">2592000</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;refresh_token&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;REFRESH_TOKEN&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;scope&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;read&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// Seté›†åˆ</span><br>  <span class="hljs-attr">&quot;uid&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">100101</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;info&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span>...<span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-comment">// æˆ–è€…</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;access_token&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;ONWVJzfOv1XidEdeBAdqPxYGL60toIzhzHRwp1ySPHMEKWFbp5FIp3FuaQ3g&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;refresh_token&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;SshGOiUl4w9UIePixwQzvXjlnddMi52xgviM8S4RPm26m1bBgJInpSXC4AND&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;expires_in&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">7199</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;refresh_expires_in&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">2591999</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// åˆ·æ–°ä»¤ç‰Œçš„å¤±æ•ˆæ—¶é—´</span><br>  <span class="hljs-attr">&quot;client_id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1001</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;uid&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">10001</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;scope&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// Seté›†åˆ</span><br>  <span class="hljs-attr">&quot;openid&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;gr_SwoIN0MC1ewxHX_vfCW3BothWDZMMtx__&quot;</span> <span class="hljs-comment">// JWT</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h4 id="ç­”ç–‘"><a href="#ç­”ç–‘" class="headerlink" title="ç­”ç–‘"></a>ç­”ç–‘</h4><ul><li><strong>ä¼šä¸ä¼šæœ‰å…¶ä»–åº”ç”¨å†’å……ç¬¬ä¸‰æ–¹åº”ç”¨éª—å–æˆæƒï¼Ÿ</strong> ClientID ä»£è¡¨ä¸€ä¸ªç¬¬ä¸‰æ–¹åº”ç”¨çš„â€œç”¨æˆ·åâ€ï¼Œè¿™é¡¹ä¿¡æ¯æ˜¯å¯ä»¥å®Œå…¨å…¬å¼€çš„ã€‚ä½† ClientSecret åº”å½“åªæœ‰åº”ç”¨è‡ªå·±æ‰çŸ¥é“ï¼Œè¿™ä¸ªä»£è¡¨äº†ç¬¬ä¸‰æ–¹åº”ç”¨çš„â€œå¯†ç â€ã€‚åœ¨ç¬¬ 5 æ­¥å‘æ”¾ä»¤ç‰Œæ—¶ï¼Œè°ƒç”¨è€…å¿…é¡»èƒ½å¤Ÿæä¾› ClientSecret æ‰èƒ½æˆåŠŸå®Œæˆã€‚åªè¦ç¬¬ä¸‰æ–¹åº”ç”¨å¦¥å–„ä¿ç®¡å¥½ ClientSecretï¼Œå°±æ²¡æœ‰äººèƒ½å¤Ÿå†’å……å®ƒã€‚</li><li><strong>ä¸ºä»€ä¹ˆè¦å…ˆå‘æ”¾æˆæƒç ï¼Œå†ç”¨æˆæƒç æ¢ä»¤ç‰Œï¼Ÿ</strong> è¿™æ˜¯å› ä¸ºå®¢æˆ·ç«¯è½¬å‘ï¼ˆé€šå¸¸å°±æ˜¯ä¸€æ¬¡ HTTP 302 é‡å®šå‘ï¼‰å¯¹äºç”¨æˆ·æ˜¯å¯è§çš„ï¼Œæ¢è€Œè¨€ä¹‹ï¼Œæˆæƒç å¯èƒ½ä¼šæš´éœ²ç»™ç”¨æˆ·ä»¥åŠç”¨æˆ·æœºå™¨ä¸Šçš„å…¶ä»–ç¨‹åºï¼Œä½†ç”±äºç”¨æˆ·å¹¶æ²¡æœ‰ ClientSecretï¼Œå…‰æœ‰æˆæƒç ä¹Ÿæ˜¯æ— æ³•æ¢å–åˆ°ä»¤ç‰Œçš„ï¼Œæ‰€ä»¥é¿å…äº†ä»¤ç‰Œåœ¨ä¼ è¾“è½¬å‘è¿‡ç¨‹ä¸­è¢«æ³„æ¼çš„é£é™©ã€‚</li><li><strong>ä¸ºä»€ä¹ˆè¦è®¾è®¡ä¸€ä¸ªæ—¶é™è¾ƒé•¿çš„åˆ·æ–°ä»¤ç‰Œå’Œæ—¶é™è¾ƒçŸ­çš„è®¿é—®ä»¤ç‰Œï¼Ÿä¸èƒ½ç›´æ¥æŠŠè®¿é—®ä»¤ç‰Œçš„æ—¶é—´è°ƒé•¿å—ï¼Ÿ</strong> è¿™æ˜¯ä¸ºäº†ç¼“è§£ OAuth2 åœ¨å®é™…åº”ç”¨ä¸­çš„ä¸€ä¸ªä¸»è¦ç¼ºé™·ï¼Œé€šå¸¸è®¿é—®ä»¤ç‰Œä¸€æ—¦å‘æ”¾ï¼Œé™¤éè¶…è¿‡äº†ä»¤ç‰Œä¸­çš„æœ‰æ•ˆæœŸï¼Œå¦åˆ™å¾ˆéš¾ï¼ˆéœ€è¦ä»˜å‡ºè¾ƒå¤§ä»£ä»·ï¼‰æœ‰å…¶ä»–æ–¹å¼è®©å®ƒå¤±æ•ˆï¼Œæ‰€ä»¥è®¿é—®ä»¤ç‰Œçš„æ—¶æ•ˆæ€§ä¸€èˆ¬è®¾è®¡çš„æ¯”è¾ƒçŸ­ï¼Œè­¬å¦‚å‡ ä¸ªå°æ—¶ï¼Œå¦‚æœè¿˜éœ€è¦ç»§ç»­ç”¨ï¼Œé‚£å°±å®šæœŸç”¨åˆ·æ–°ä»¤ç‰Œå»æ›´æ–°ï¼ŒæˆæƒæœåŠ¡å™¨å°±å¯ä»¥åœ¨æ›´æ–°è¿‡ç¨‹ä¸­å†³å®šæ˜¯å¦è¿˜è¦ç»§ç»­ç»™äºˆæˆæƒã€‚</li></ul><h3 id="å¯†ç å¼"><a href="#å¯†ç å¼" class="headerlink" title="å¯†ç å¼"></a>å¯†ç å¼</h3><p>å¦‚æœä½ é«˜åº¦ä¿¡ä»»æŸä¸ªåº”ç”¨ï¼Œ<strong>RFC 6749</strong> ä¹Ÿå…è®¸ç”¨æˆ·æŠŠç”¨æˆ·åå’Œå¯†ç ï¼Œç›´æ¥å‘Šè¯‰è¯¥åº”ç”¨ã€‚è¯¥åº”ç”¨å°±ä½¿ç”¨ä½ çš„å¯†ç ï¼Œç”³è¯·ä»¤ç‰Œï¼Œè¿™ç§æ–¹å¼ç§°ä¸ºâ€å¯†ç å¼â€ï¼ˆpasswordï¼‰ã€‚</p><ol><li>A ç½‘ç«™è¦æ±‚ç”¨æˆ·æä¾› B ç½‘ç«™çš„ç”¨æˆ·åå’Œå¯†ç ã€‚æ‹¿åˆ°ä»¥åï¼ŒA å°±ç›´æ¥å‘ B è¯·æ±‚ä»¤ç‰Œã€‚</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// client_idå‚æ•°è®© B çŸ¥é“æ˜¯è°åœ¨è¯·æ±‚, ä¸€ä¸ªåº”ç”¨ä¸€ä¸ªid</span><br><span class="hljs-comment">// client_secretå‚æ•°ç”¨æ¥è®©Bç¡®è®¤Açš„èº«ä»½, æ˜¯åº”ç”¨çš„ä¿å¯†ç§˜é’¥, è‡ªå·±é…ä¸€ä¸ª</span><br><span class="hljs-comment">// grant_typeå‚æ•°çš„å€¼æ˜¯password, è¡¨ç¤ºé‡‡ç”¨çš„æˆæƒæ–¹å¼æ˜¯å¯†ç å¼</span><br><span class="hljs-comment">// usernameå’Œpasswordæ˜¯ B çš„ç”¨æˆ·åå’Œå¯†ç ã€‚</span><br>https:<span class="hljs-comment">//oauth.b.com/oauth/token?</span><br>  grant_type=password&amp;<br>  username=USERNAME&amp;<br>  password=PASSWORD&amp;<br>  client_secret=CLIENT_SECRET&amp;<br>  client_id=CLIENT_ID&amp;<br>  scope=scope<br></code></pre></td></tr></table></figure><ol><li>B ç½‘ç«™éªŒè¯èº«ä»½é€šè¿‡åï¼Œç›´æ¥ç»™å‡ºä»¤ç‰Œã€‚æ³¨æ„ï¼Œè¿™æ—¶ä¸éœ€è¦è·³è½¬ï¼Œè€Œæ˜¯æŠŠä»¤ç‰Œæ”¾åœ¨ JSON æ•°æ®é‡Œé¢ï¼Œä½œä¸º HTTP å›åº”ï¼ŒA å› æ­¤æ‹¿åˆ°ä»¤ç‰Œã€‚</li></ol><p>è¿™ç§æ–¹å¼éœ€è¦ç”¨æˆ·ç»™å‡ºè‡ªå·±çš„ç”¨æˆ·å&#x2F;å¯†ç ï¼Œæ˜¾ç„¶é£é™©å¾ˆå¤§ï¼Œå› æ­¤åªé€‚ç”¨äºå…¶ä»–æˆæƒæ–¹å¼éƒ½æ— æ³•é‡‡ç”¨çš„æƒ…å†µï¼Œè€Œä¸”å¿…é¡»æ˜¯ç”¨æˆ·é«˜åº¦ä¿¡ä»»çš„åº”ç”¨ã€‚</p><h3 id="éšè—å¼"><a href="#éšè—å¼" class="headerlink" title="éšè—å¼"></a><strong>éšè—å¼</strong></h3><p>æœ‰äº› Web åº”ç”¨æ˜¯çº¯å‰ç«¯åº”ç”¨ï¼Œæ²¡æœ‰åç«¯ã€‚è¿™æ—¶å°±ä¸èƒ½ç”¨ä¸Šé¢çš„æ–¹å¼äº†ï¼Œå¿…é¡»å°†ä»¤ç‰Œå‚¨å­˜åœ¨å‰ç«¯ã€‚**RFC 6749 **å°±è§„å®šäº†ç¬¬äºŒç§æ–¹å¼ï¼Œå…è®¸ç›´æ¥å‘å‰ç«¯é¢å‘ä»¤ç‰Œã€‚è¿™ç§æ–¹å¼æ²¡æœ‰æˆæƒç è¿™ä¸ªä¸­é—´æ­¥éª¤ï¼Œæ‰€ä»¥ç§°ä¸ºï¼ˆæˆæƒç ï¼‰â€éšè—å¼â€ï¼ˆimplicitï¼‰ã€‚</p><ol><li>A ç½‘ç«™æä¾›ä¸€ä¸ªé“¾æ¥ï¼Œè¦æ±‚ç”¨æˆ·è·³è½¬åˆ° B ç½‘ç«™ï¼Œæˆæƒç”¨æˆ·æ•°æ®ç»™ A ç½‘ç«™ä½¿ç”¨ã€‚</li></ol><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Http">https://b.com/oauth/authorize?<br>  response_type=token&amp;<br>  client_id=CLIENT_ID&amp;<br>  redirect_uri=CALLBACK_URL&amp;<br>  scope=read<br>ä¸Šé¢ URL ä¸­ï¼Œ`response_type`å‚æ•°ä¸º`token`ï¼Œè¡¨ç¤ºè¦æ±‚ç›´æ¥è¿”å›ä»¤ç‰Œã€‚<br></code></pre></td></tr></table></figure><ol><li>ç”¨æˆ·è·³è½¬åˆ° B ç½‘ç«™ï¼Œç™»å½•ååŒæ„ç»™äºˆ A ç½‘ç«™æˆæƒã€‚è¿™æ—¶ï¼ŒB ç½‘ç«™å°±ä¼šè·³å›redirect_uriå‚æ•°æŒ‡å®šçš„è·³è½¬ç½‘å€ï¼Œå¹¶ä¸”æŠŠä»¤ç‰Œä½œä¸º URL å‚æ•°ï¼Œä¼ ç»™ A ç½‘ç«™ã€‚</li></ol><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Http">https://a.com/callback#token=ACCESS_TOKEN<br>ä¸Šé¢ URL ä¸­ï¼Œ`token`å‚æ•°å°±æ˜¯ä»¤ç‰Œï¼ŒA ç½‘ç«™å› æ­¤ç›´æ¥åœ¨å‰ç«¯æ‹¿åˆ°ä»¤ç‰Œã€‚<br></code></pre></td></tr></table></figure><h3 id="å‡­è¯å¼"><a href="#å‡­è¯å¼" class="headerlink" title="å‡­è¯å¼"></a><strong>å‡­è¯å¼</strong></h3><p>æœ€åä¸€ç§æ–¹å¼æ˜¯å‡­è¯å¼ï¼ˆclient credentialsï¼‰ï¼Œé€‚ç”¨äºæ²¡æœ‰å‰ç«¯çš„å‘½ä»¤è¡Œåº”ç”¨ï¼Œå³åœ¨å‘½ä»¤è¡Œä¸‹è¯·æ±‚ä»¤ç‰Œã€‚</p><ol><li>A åº”ç”¨åœ¨å‘½ä»¤è¡Œå‘ B å‘å‡ºè¯·æ±‚ã€‚</li></ol><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Http">https://oauth.b.com/token?<br>  grant_type=client_credentials&amp;<br>  client_id=CLIENT_ID&amp;<br>  client_secret=CLIENT_SECRET<br>ä¸Šé¢ URL ä¸­ï¼Œ`grant_type`å‚æ•°ç­‰äº`client_credentials`è¡¨ç¤ºé‡‡ç”¨å‡­è¯å¼ï¼Œ`client_id`å’Œ`client_secret`ç”¨æ¥è®© B ç¡®è®¤ A çš„èº«ä»½ã€‚<br></code></pre></td></tr></table></figure><ol><li><p>B ç½‘ç«™éªŒè¯é€šè¿‡ä»¥åï¼Œç›´æ¥è¿”å›ä»¤ç‰Œã€‚</p><p>è¿™ç§æ–¹å¼ç»™å‡ºçš„ä»¤ç‰Œï¼Œæ˜¯é’ˆå¯¹ç¬¬ä¸‰æ–¹åº”ç”¨çš„ï¼Œè€Œä¸æ˜¯é’ˆå¯¹ç”¨æˆ·çš„ï¼Œå³æœ‰å¯èƒ½å¤šä¸ªç”¨æˆ·å…±äº«åŒä¸€ä¸ªä»¤ç‰Œã€‚</p></li></ol><h2 id="ä»¤ç‰Œçš„ä½¿ç”¨"><a href="#ä»¤ç‰Œçš„ä½¿ç”¨" class="headerlink" title="ä»¤ç‰Œçš„ä½¿ç”¨"></a>ä»¤ç‰Œçš„ä½¿ç”¨</h2><hr><p>A ç½‘ç«™æ‹¿åˆ°ä»¤ç‰Œä»¥åï¼Œå°±å¯ä»¥å‘ B ç½‘ç«™çš„ API è¯·æ±‚æ•°æ®äº†ã€‚</p><p>æ­¤æ—¶ï¼Œæ¯ä¸ªå‘åˆ° API çš„è¯·æ±‚ï¼Œéƒ½å¿…é¡»å¸¦æœ‰ä»¤ç‰Œã€‚å…·ä½“åšæ³•æ˜¯åœ¨è¯·æ±‚çš„å¤´ä¿¡æ¯ï¼ŒåŠ ä¸Šä¸€ä¸ªAuthorizationå­—æ®µï¼Œä»¤ç‰Œå°±æ”¾åœ¨è¿™ä¸ªå­—æ®µé‡Œé¢ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Bash">curl -H <span class="hljs-string">&quot;Authorization: Bearer ACCESS_TOKEN&quot;</span> \<br><span class="hljs-string">&quot;https://api.b.com&quot;</span><br></code></pre></td></tr></table></figure><p>ä¸Šé¢å‘½ä»¤ä¸­ï¼ŒACCESS_TOKENå°±æ˜¯æ‹¿åˆ°çš„ä»¤ç‰Œã€‚</p><h2 id="æ›´æ–°ä»¤ç‰Œ"><a href="#æ›´æ–°ä»¤ç‰Œ" class="headerlink" title="æ›´æ–°ä»¤ç‰Œ"></a>æ›´æ–°ä»¤ç‰Œ</h2><hr><p>ä»¤ç‰Œçš„æœ‰æ•ˆæœŸåˆ°äº†ï¼Œå¦‚æœè®©ç”¨æˆ·é‡æ–°èµ°ä¸€éä¸Šé¢çš„æµç¨‹ï¼Œå†ç”³è¯·ä¸€ä¸ªæ–°çš„ä»¤ç‰Œï¼Œå¾ˆå¯èƒ½ä½“éªŒä¸å¥½ï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰å¿…è¦ã€‚OAuth 2.0 å…è®¸ç”¨æˆ·è‡ªåŠ¨æ›´æ–°ä»¤ç‰Œã€‚</p><p>å…·ä½“æ–¹æ³•æ˜¯ï¼ŒB ç½‘ç«™é¢å‘ä»¤ç‰Œçš„æ—¶å€™ï¼Œä¸€æ¬¡æ€§é¢å‘ä¸¤ä¸ªä»¤ç‰Œï¼Œä¸€ä¸ªç”¨äºè·å–æ•°æ®ï¼Œå¦ä¸€ä¸ªç”¨äºè·å–æ–°çš„ä»¤ç‰Œï¼ˆrefresh token å­—æ®µï¼‰ã€‚ä»¤ç‰Œåˆ°æœŸå‰ï¼Œç”¨æˆ·ä½¿ç”¨ refresh token å‘ä¸€ä¸ªè¯·æ±‚ï¼Œå»æ›´æ–°ä»¤ç‰Œã€‚</p><p>B ç½‘ç«™éªŒè¯é€šè¿‡ä»¥åï¼Œå°±ä¼šé¢å‘æ–°çš„ä»¤ç‰Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// grant_typeå‚æ•°ä¸ºrefresh_tokenè¡¨ç¤ºè¦æ±‚æ›´æ–°ä»¤ç‰Œ</span><br><span class="hljs-comment">// client_idå‚æ•°å’Œclient_secretå‚æ•°ç”¨äºç¡®è®¤èº«ä»½</span><br><span class="hljs-comment">// refresh_tokenå‚æ•°å°±æ˜¯ç”¨äºæ›´æ–°ä»¤ç‰Œçš„ä»¤ç‰Œã€‚</span><br>https:<span class="hljs-comment">//b.com/oauth/token?</span><br>  grant_type=refresh_token&amp;<br>  client_id=CLIENT_ID&amp;<br>  client_secret=CLIENT_SECRET&amp;<br>  refresh_token=REFRESH_TOKEN<br></code></pre></td></tr></table></figure><h2 id="ç¬¬ä¸‰æ–¹ç™»å½•åŸç†"><a href="#ç¬¬ä¸‰æ–¹ç™»å½•åŸç†" class="headerlink" title="ç¬¬ä¸‰æ–¹ç™»å½•åŸç†"></a>ç¬¬ä¸‰æ–¹ç™»å½•åŸç†</h2><hr><p>æ‰€è°“ç¬¬ä¸‰æ–¹ç™»å½•ï¼Œå®è´¨å°±æ˜¯ OAuth æˆæƒã€‚ç”¨æˆ·æƒ³è¦ç™»å½• A ç½‘ç«™ï¼ŒA ç½‘ç«™è®©ç”¨æˆ·æä¾›ç¬¬ä¸‰æ–¹ç½‘ç«™çš„æ•°æ®ï¼Œè¯æ˜è‡ªå·±çš„èº«ä»½ã€‚è·å–ç¬¬ä¸‰æ–¹ç½‘ç«™çš„èº«ä»½æ•°æ®ï¼Œå°±éœ€è¦ OAuth æˆæƒã€‚</p><p>ä¸¾ä¾‹æ¥è¯´ï¼ŒA ç½‘ç«™å…è®¸ GitHub ç™»å½•ï¼ŒèƒŒåå°±æ˜¯ä¸‹é¢çš„æµç¨‹ã€‚</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs text">**Authorize**<br>1. A ç½‘ç«™è®©ç”¨æˆ·è·³è½¬åˆ° GitHubã€‚<br><br>2. GitHub è¦æ±‚ç”¨æˆ·ç™»å½•ï¼Œç„¶åè¯¢é—®&quot;A ç½‘ç«™è¦æ±‚è·å¾— xx æƒé™ï¼Œä½ æ˜¯å¦åŒæ„ï¼Ÿ&quot;<br><br>3. ç”¨æˆ·åŒæ„ï¼ŒGitHub å°±ä¼šé‡å®šå‘å› A ç½‘ç«™ï¼ŒåŒæ—¶å‘å›ä¸€ä¸ªæˆæƒç ã€‚<br><br>**Token**<br>4. A ç½‘ç«™ä½¿ç”¨æˆæƒç ï¼Œå‘ GitHub è¯·æ±‚ä»¤ç‰Œã€‚<br><br>5. GitHub è¿”å›ä»¤ç‰Œ.<br><br>6. A ç½‘ç«™ä½¿ç”¨ä»¤ç‰Œï¼Œå‘ GitHub è¯·æ±‚ç”¨æˆ·æ•°æ®ã€‚<br></code></pre></td></tr></table></figure><h3 id="åº”ç”¨ç™»è®°"><a href="#åº”ç”¨ç™»è®°" class="headerlink" title="åº”ç”¨ç™»è®°"></a>åº”ç”¨ç™»è®°</h3><p>ä¸€ä¸ªåº”ç”¨è¦æ±‚ OAuth æˆæƒï¼Œå¿…é¡»å…ˆåˆ°å¯¹æ–¹ç½‘ç«™ç™»è®°ï¼Œè®©å¯¹æ–¹çŸ¥é“æ˜¯è°åœ¨è¯·æ±‚ã€‚</p><p>æ‰€ä»¥ï¼Œä½ è¦å…ˆå» GitHub ç™»è®°ä¸€ä¸‹ã€‚å½“ç„¶ï¼Œæˆ‘å·²ç»ç™»è®°è¿‡äº†ï¼Œä½ ä½¿ç”¨æˆ‘çš„ç™»è®°ä¿¡æ¯ä¹Ÿå¯ä»¥ï¼Œä½†ä¸ºäº†å®Œæ•´èµ°ä¸€éæµç¨‹ï¼Œè¿˜æ˜¯å»ºè®®å¤§å®¶è‡ªå·±ç™»è®°ã€‚è¿™æ˜¯å…è´¹çš„ã€‚</p><p>è®¿é—®è¿™ä¸ªç½‘å€ï¼Œå¡«å†™ç™»è®°è¡¨ã€‚</p><p><img src="/image/Oauth2/WX20220328-114828@2x.png" alt="img"></p><p>åº”ç”¨çš„åç§°éšä¾¿å¡«ï¼Œä¸»é¡µ URL å¡«å†™<code>http://localhost:8080</code>ã€‚</p><p>è·³è½¬ç½‘å€å¡«å†™ <code>http://localhost:8080/oauth/redirect</code>ã€‚</p><p>æäº¤è¡¨å•ä»¥åï¼ŒGitHub åº”è¯¥ä¼šè¿”å›å®¢æˆ·ç«¯ IDï¼ˆclient IDï¼‰å’Œå®¢æˆ·ç«¯å¯†é’¥ï¼ˆclient secretï¼‰ï¼Œè¿™å°±æ˜¯åº”ç”¨çš„èº«ä»½è¯†åˆ«ç ã€‚</p><h3 id="è·³è½¬æˆæƒ"><a href="#è·³è½¬æˆæƒ" class="headerlink" title="è·³è½¬æˆæƒ"></a>è·³è½¬æˆæƒ</h3><p>åœ¨ä½ è‡ªå·±æ­å»ºçš„Webç½‘ç«™ä¸­ï¼Œå¯¹Githubè¿›è¡Œæˆæƒè®¿é—®ã€‚</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Http">https://github.com/login/oauth/authorize?<br>  client_id=7e015d8ce32370079895&amp;<br>  redirect_uri=http://localhost:8080/oauth/redirect<br></code></pre></td></tr></table></figure><p>è¿™ä¸ª URL æŒ‡å‘ GitHub çš„ OAuth æˆæƒç½‘å€ï¼Œå¸¦æœ‰ä¸¤ä¸ªå‚æ•°ï¼š<code>client_id</code>å‘Šè¯‰ GitHub è°åœ¨è¯·æ±‚ï¼Œ<code>redirect_uri</code>æ˜¯ç¨åè·³è½¬å›æ¥çš„ç½‘å€ã€‚</p><p>ç”¨æˆ·ç‚¹å‡»åˆ°äº† GitHubï¼ŒGitHub ä¼šè¦æ±‚ç”¨æˆ·ç™»å½•ï¼Œç¡®ä¿æ˜¯æœ¬äººåœ¨æ“ä½œã€‚</p><h3 id="è·å–æˆæƒç "><a href="#è·å–æˆæƒç " class="headerlink" title="è·å–æˆæƒç "></a>è·å–æˆæƒç </h3><p>ç™»å½•åï¼ŒGitHub è¯¢é—®ç”¨æˆ·ï¼Œè¯¥åº”ç”¨æ­£åœ¨è¯·æ±‚æ•°æ®ï¼Œä½ æ˜¯å¦åŒæ„æˆæƒã€‚</p><p><img src="/image/Oauth2/WX20220328-114914@2x.png" alt="img"></p><p>ç”¨æˆ·åŒæ„æˆæƒï¼Œ GitHub å°±ä¼šè·³è½¬åˆ°<code>redirect_uri</code>æŒ‡å®šçš„è·³è½¬ç½‘å€ï¼Œå¹¶ä¸”å¸¦ä¸Šæˆæƒç ï¼Œè·³è½¬å›æ¥çš„ URL å°±æ˜¯ä¸‹é¢çš„æ ·å­ã€‚</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Http">http://localhost:8080/oauth/redirect?<br>  code=859310e7cecc9196f4af<br></code></pre></td></tr></table></figure><p>åç«¯æ”¶åˆ°è¿™ä¸ªè¯·æ±‚ä»¥åï¼Œå°±æ‹¿åˆ°äº†æˆæƒç ï¼ˆcodeå‚æ•°ï¼‰ã€‚</p><h3 id="è·å–ä»¤ç‰Œ"><a href="#è·å–ä»¤ç‰Œ" class="headerlink" title="è·å–ä»¤ç‰Œ"></a>è·å–ä»¤ç‰Œ</h3><p>åç«¯ä½¿ç”¨è¿™ä¸ªæˆæƒç ï¼Œå‘ GitHub è¯·æ±‚ä»¤ç‰Œã€‚</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Http">https://github.com/login/oauth/access_token?<br>    client_id=$&#123;clientID&#125;&amp;<br>    client_secret=$&#123;clientSecret&#125;&amp;<br>    code=$&#123;requestToken&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç ä¸­ï¼ŒGitHub çš„ä»¤ç‰Œæ¥å£<code>https://github.com/login/oauth/access_token</code>éœ€è¦æä¾›ä¸‰ä¸ªå‚æ•°ã€‚</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Http">client_idï¼šå®¢æˆ·ç«¯çš„ ID<br><br>client_secretï¼šå®¢æˆ·ç«¯çš„å¯†é’¥<br><br>codeï¼šæˆæƒç <br></code></pre></td></tr></table></figure><p>ä½œä¸ºå›åº”ï¼ŒGitHub ä¼šè¿”å›ä¸€æ®µ JSON æ•°æ®ï¼Œé‡Œé¢åŒ…å«äº†ä»¤ç‰ŒaccessTokenã€‚</p><h3 id="APIæ•°æ®"><a href="#APIæ•°æ®" class="headerlink" title="APIæ•°æ®"></a>APIæ•°æ®</h3><p>æœ‰äº†ä»¤ç‰Œä»¥åï¼Œå°±å¯ä»¥å‘ API è¯·æ±‚æ•°æ®äº†ã€‚</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Http">https://api.github.com/user,<br>  headers: &#123;<br>    accept: &#x27;application/json&#x27;,<br>    Authorization: &#x27;Bearer $&#123;accessToken&#125;&#x27;<br>  &#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç ä¸­ï¼ŒGitHub API çš„åœ°å€æ˜¯<code>https://api.github.com/user</code>ï¼Œè¯·æ±‚çš„æ—¶å€™å¿…é¡»åœ¨ HTTP å¤´ä¿¡æ¯é‡Œé¢å¸¦ä¸Šä»¤ç‰Œ<code>Authorization: token 361507da</code>ã€‚</p><p>ç„¶åï¼Œå°±å¯ä»¥æ‹¿åˆ°ç”¨æˆ·æ•°æ®ï¼Œå¾—åˆ°ç”¨æˆ·çš„èº«ä»½ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Distributed System</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Feign</title>
    <link href="/2022/03/28/Spring/Feign/"/>
    <url>/2022/03/28/Spring/Feign/</url>
    
    <content type="html"><![CDATA[<p>SpringCloud feign å¯¹Netflix feignè¿›è¡Œäº†åŒ…è£…å’Œå¢å¼ºï¼Œæœ¬æ–‡ä»æºç è§’åº¦æ¢³ç†ä¸€ä¸ªè¯·æ±‚é“¾è·¯ä¸­å‚ä¸çš„å„ä¸ªç»„ä»¶åŠå…¶å®ƒä»¬å¦‚ä½•é…åˆäº¤äº’å®Œæˆè¯·æ±‚ã€‚ç»„ä»¶åŒ…æ‹¬feignã€ribbonã€hystrixã€sleuthç­‰</p><h2 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h2><h3 id="EnableFeignClients"><a href="#EnableFeignClients" class="headerlink" title="@EnableFeignClients"></a>@EnableFeignClients</h3><p>è¯¥æ³¨è§£é€šè¿‡importæ–¹å¼ï¼Œå¼•å…¥FeignClientsRegistrarã€‚å…ˆæ³¨å†Œé»˜è®¤é…ç½®ï¼Œå†æ³¨å†Œæ‰€æœ‰çš„feignClient BeanDefinitionã€‚</p><p>æ‰«æåˆ°æ‰€æœ‰@FeignClientçš„BeanDefinitionåï¼ŒåŒ…è£…æˆFeignClientFactoryBeanï¼Œç„¶åæ³¨å†Œåˆ°springä¸Šä¸‹æ–‡ä¸­ã€‚</p><h3 id="FeignClientFactoryBean"><a href="#FeignClientFactoryBean" class="headerlink" title="FeignClientFactoryBean"></a>FeignClientFactoryBean</h3><p>å®Œæˆäº†è°ƒç”¨å‰çš„æ‰€æœ‰å‡†å¤‡å·¥ä½œï¼Œå¦‚FeignContextï¼ŒFeign.builderçš„åˆ›å»ºã€åˆ¤æ–­æ˜¯å¦éœ€è¦è´Ÿè½½å‡è¡¡åŠè®¾ç½®åŠFeignçš„ä»£ç†ç±»çš„åˆ›å»ºç­‰ã€‚</p><p>Feign çš„åŠ¨æ€ä»£ç†åˆ›å»ºå®Œæˆï¼Œå¹¶äº¤ç”±Springå®¹å™¨ç®¡ç†ã€‚ç¬¬äºŒé˜¶æ®µçš„åˆå§‹åŒ–é˜¶æ®µè‡³æ­¤ç»“æŸã€‚httpè¯·æ±‚å‘ç”Ÿæ—¶ï¼Œåˆ›å»ºçš„ä»£ç†å¯¹è±¡æœ€ç»ˆèšåˆribbonã€hystrixã€sleuthçš„åŠŸèƒ½å®Œæˆæ•´ä¸ªè°ƒç”¨é“¾è·¯çš„å¢å¼ºæˆ–è·Ÿè¸ªã€‚</p><h2 id="Log"><a href="#Log" class="headerlink" title="Log"></a>Log</h2><ul><li>NONEï¼šé»˜è®¤çš„ï¼Œä¸æ˜¾ç¤ºä»»ä½•æ—¥å¿—ï¼›</li><li>BASICï¼šä»…è®°å½•è¯·æ±‚æ–¹æ³•ã€URLã€å“åº”çŠ¶æ€ç åŠæ‰§è¡Œæ—¶é—´ï¼›</li><li>HEADERSï¼šé™¤äº†BASICä¸­å®šä¹‰çš„ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜æœ‰è¯·æ±‚å’Œå“åº”çš„å¤´ä¿¡æ¯ï¼›</li><li>FULLï¼šé™¤äº†HEADERSä¸­å®šä¹‰çš„ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜æœ‰è¯·æ±‚å’Œå“åº”çš„æ­£æ–‡åŠå…ƒæ•°æ®ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by macro on 2019/9/5.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeignConfig</span> &#123;<br>  <span class="hljs-meta">@Bean</span><br>  Logger.Level <span class="hljs-title function_">feignLoggerLevel</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> Logger.Level.FULL;<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">level:</span><br>  <span class="hljs-attr">com.macro.cloud.service.UserService:</span> <span class="hljs-string">debug</span><br><br></code></pre></td></tr></table></figure><h2 id="Used-Config"><a href="#Used-Config" class="headerlink" title="Used Config"></a>Used Config</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">hystrix:</span><br>  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#åœ¨Feignä¸­å¼€å¯Hystrix</span><br>  <span class="hljs-attr">compression:</span><br>  <span class="hljs-attr">request:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#æ˜¯å¦å¯¹è¯·æ±‚è¿›è¡ŒGZIPå‹ç¼©</span><br>    <span class="hljs-attr">mime-types:</span> <span class="hljs-string">text/xml,application/xml,application/json</span> <span class="hljs-comment">#æŒ‡å®šå‹ç¼©çš„è¯·æ±‚æ•°æ®ç±»å‹</span><br>    <span class="hljs-attr">min-request-size:</span> <span class="hljs-number">2048</span> <span class="hljs-comment">#è¶…è¿‡è¯¥å¤§å°çš„è¯·æ±‚ä¼šè¢«å‹ç¼©</span><br>  <span class="hljs-attr">response:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#æ˜¯å¦å¯¹å“åº”è¿›è¡ŒGZIPå‹ç¼©</span><br><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">level:</span> <span class="hljs-comment">#ä¿®æ”¹æ—¥å¿—çº§åˆ«</span><br>  <span class="hljs-attr">com.macro.cloud.service.UserService:</span> <span class="hljs-string">debug</span><br><br></code></pre></td></tr></table></figure><h2 id="è°ƒç”¨"><a href="#è°ƒç”¨" class="headerlink" title="è°ƒç”¨"></a>è°ƒç”¨</h2><p>åœ¨åˆå§‹åŒ–çš„æœ€åï¼Œåˆ›å»ºäº†InvocationHandlerï¼Œåœ¨è¯·æ±‚å‘ç”Ÿæ—¶invoke()æ–¹æ³•å°†è¢«è°ƒç”¨ã€‚å¦‚æœå¼•å…¥äº†hystrixï¼Œé‚£ä¹ˆå°±æ˜¯è°ƒç”¨HystrixInvocationHandlerï¼Œè¯¥æ–¹æ³•å†…éƒ¨è°ƒç”¨äº†HystrixCommandã€‚</p><p>åœ¨run()æ–¹æ³•ä¸­ï¼Œè°ƒç”¨å¯¹åº”çš„methodHandlerçš„invoke()æ–¹æ³•ã€‚åœ¨è¿™é‡Œæœ‰è·å–URLï¼Œå°è£…ribbonè¯·æ±‚ï¼Œè´Ÿè½½å‡è¡¡ï¼Œå¹¶æœ€ç»ˆæ‰§è¡Œhttpclientè°ƒç”¨ã€‚</p><h2 id="æºç è§£è¯»"><a href="#æºç è§£è¯»" class="headerlink" title="æºç è§£è¯»"></a>æºç è§£è¯»</h2><p><a href="https://www.jianshu.com/p/769081fe8d95">Feign è°ƒç”¨è¿‡ç¨‹åˆ†æ</a></p>]]></content>
    
    
    <categories>
      
      <category>Spring Cloud</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>GateWay</title>
    <link href="/2022/03/28/Spring/GateWay/"/>
    <url>/2022/03/28/Spring/GateWay/</url>
    
    <content type="html"><![CDATA[<h3 id="è¿‡æ»¤å™¨"><a href="#è¿‡æ»¤å™¨" class="headerlink" title="è¿‡æ»¤å™¨"></a>è¿‡æ»¤å™¨</h3><h4 id="GlobalFilter"><a href="#GlobalFilter" class="headerlink" title="GlobalFilter"></a>GlobalFilter</h4><p>å…¨å±€è¿‡æ»¤å™¨ï¼Œä¸éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œä½œç”¨åœ¨æ‰€æœ‰çš„è·¯ç”±ä¸Šï¼Œæœ€ç»ˆé€šè¿‡GatewayFilterAdapteråŒ…è£…æˆGatewayFilterChainå¯è¯†åˆ«çš„è¿‡æ»¤å™¨ï¼Œå®ƒä¸ºè¯·æ±‚ä¸šåŠ¡ä»¥åŠè·¯ç”±çš„URIè½¬æ¢ä¸ºçœŸå®ä¸šåŠ¡æœåŠ¡çš„è¯·æ±‚åœ°å€çš„æ ¸å¿ƒè¿‡æ»¤å™¨ï¼Œä¸éœ€è¦é…ç½®ï¼Œç³»ç»Ÿåˆå§‹åŒ–æ—¶åŠ è½½ï¼Œå¹¶ä½œç”¨åœ¨æ¯ä¸ªè·¯ç”±ä¸Šã€‚</p><ul><li><strong>å¯ä»¥å®ç°æ­¤è¿‡æ»¤å™¨æ¥å®Œæˆé‰´æƒåŠŸèƒ½, æ¯”å¦‚ruoyi-cloudé¡¹ç›®çš„AuthFilter</strong>  <figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></div></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ç½‘å…³é‰´æƒ</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> ruoyi</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GlobalFilter</span>, Ordered<br>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(AuthFilter.class);<br><br>    <span class="hljs-comment">// æ’é™¤è¿‡æ»¤çš„ uri åœ°å€ï¼Œnacosè‡ªè¡Œæ·»åŠ </span><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IgnoreWhiteProperties ignoreWhite;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisService redisService;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span><br>    &#123;<br>        <span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> exchange.getRequest();<br>        ServerHttpRequest.<span class="hljs-type">Builder</span> <span class="hljs-variable">mutate</span> <span class="hljs-operator">=</span> request.mutate();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> request.getURI().getPath();<br>        <span class="hljs-comment">// è·³è¿‡ä¸éœ€è¦éªŒè¯çš„è·¯å¾„</span><br>        <span class="hljs-keyword">if</span> (StringUtils.matches(url, ignoreWhite.getWhites()))<br>        &#123;<br>            <span class="hljs-keyword">return</span> chain.filter(exchange);<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> getToken(request);<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(token))<br>        &#123;<br>            <span class="hljs-keyword">return</span> unauthorizedResponse(exchange, <span class="hljs-string">&quot;ä»¤ç‰Œä¸èƒ½ä¸ºç©º&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> JwtUtils.parseToken(token);<br>        <span class="hljs-keyword">if</span> (claims == <span class="hljs-literal">null</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> unauthorizedResponse(exchange, <span class="hljs-string">&quot;ä»¤ç‰Œå·²è¿‡æœŸæˆ–éªŒè¯ä¸æ­£ç¡®ï¼&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">userkey</span> <span class="hljs-operator">=</span> JwtUtils.getUserKey(claims);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">islogin</span> <span class="hljs-operator">=</span> redisService.hasKey(getTokenKey(userkey));<br>        <span class="hljs-keyword">if</span> (!islogin)<br>        &#123;<br>            <span class="hljs-keyword">return</span> unauthorizedResponse(exchange, <span class="hljs-string">&quot;ç™»å½•çŠ¶æ€å·²è¿‡æœŸ&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">userid</span> <span class="hljs-operator">=</span> JwtUtils.getUserId(claims);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> JwtUtils.getUserName(claims);<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(userid) || StringUtils.isEmpty(username))<br>        &#123;<br>            <span class="hljs-keyword">return</span> unauthorizedResponse(exchange, <span class="hljs-string">&quot;ä»¤ç‰ŒéªŒè¯å¤±è´¥&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// è®¾ç½®ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚</span><br>        addHeader(mutate, SecurityConstants.USER_KEY, userkey);<br>        addHeader(mutate, SecurityConstants.DETAILS_USER_ID, userid);<br>        addHeader(mutate, SecurityConstants.DETAILS_USERNAME, username);<br>        <span class="hljs-comment">// å†…éƒ¨è¯·æ±‚æ¥æºå‚æ•°æ¸…é™¤</span><br>        removeHeader(mutate, SecurityConstants.FROM_SOURCE);<br>        <span class="hljs-keyword">return</span> chain.filter(exchange.mutate().request(mutate.build()).build());<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addHeader</span><span class="hljs-params">(ServerHttpRequest.Builder mutate, String name, Object value)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">valueStr</span> <span class="hljs-operator">=</span> value.toString();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">valueEncode</span> <span class="hljs-operator">=</span> ServletUtils.urlEncode(valueStr);<br>        mutate.header(name, valueEncode);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeHeader</span><span class="hljs-params">(ServerHttpRequest.Builder mutate, String name)</span><br>    &#123;<br>        mutate.headers(httpHeaders -&gt; httpHeaders.remove(name)).build();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Mono&lt;Void&gt; <span class="hljs-title function_">unauthorizedResponse</span><span class="hljs-params">(ServerWebExchange exchange, String msg)</span><br>    &#123;<br>        log.error(<span class="hljs-string">&quot;[é‰´æƒå¼‚å¸¸å¤„ç†]è¯·æ±‚è·¯å¾„:&#123;&#125;&quot;</span>, exchange.getRequest().getPath());<br>        <span class="hljs-keyword">return</span> ServletUtils.webFluxResponseWriter(exchange.getResponse(), msg, HttpStatus.UNAUTHORIZED);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è·å–ç¼“å­˜key</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getTokenKey</span><span class="hljs-params">(String token)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> CacheConstants.LOGIN_TOKEN_KEY + token;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è·å–è¯·æ±‚token</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getToken</span><span class="hljs-params">(ServerHttpRequest request)</span><br>    &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeaders().getFirst(TokenConstants.AUTHENTICATION);<br>        <span class="hljs-comment">// å¦‚æœå‰ç«¯è®¾ç½®äº†ä»¤ç‰Œå‰ç¼€ï¼Œåˆ™è£å‰ªæ‰å‰ç¼€</span><br>        <span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(token) &amp;&amp; token.startsWith(TokenConstants.PREFIX))<br>        &#123;<br>            token = token.replaceFirst(TokenConstants.PREFIX, StringUtils.EMPTY);<br>        &#125;<br>        <span class="hljs-keyword">return</span> token;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> -<span class="hljs-number">200</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="GatewayFilter"><a href="#GatewayFilter" class="headerlink" title="GatewayFilter"></a>GatewayFilter</h4><p>éœ€è¦é€šè¿‡ <code>spring.cloud.routes.filters</code> é…ç½®åœ¨<strong>å…·ä½“è·¯ç”±</strong>ä¸‹ï¼Œåªä½œç”¨åœ¨å½“å‰è·¯ç”±ä¸Šæˆ–é€šè¿‡spring.cloud.default-filtersé…ç½®åœ¨å…¨å±€ï¼Œä½œç”¨åœ¨æ‰€æœ‰è·¯ç”±ä¸Šã€‚</p><h4 id="Hystrix-GatewayFilter"><a href="#Hystrix-GatewayFilter" class="headerlink" title="Hystrix GatewayFilter"></a>Hystrix GatewayFilter</h4><p>Hystrix è¿‡æ»¤å™¨å…è®¸ä½ å°†æ–­è·¯å™¨åŠŸèƒ½æ·»åŠ åˆ°<strong>å…·ä½“çš„ç½‘å…³è·¯ç”±</strong>ä¸­ï¼Œä½¿ä½ çš„æœåŠ¡å…å—çº§è”æ•…éšœçš„å½±å“ï¼Œå¹¶æä¾›æœåŠ¡é™çº§å¤„ç†ã€‚</p><ul><li><p>è¦å¼€å¯æ–­è·¯å™¨åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦åœ¨pom.xmlä¸­æ·»åŠ Hystrixçš„ç›¸å…³ä¾èµ–ï¼š</p>  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>ç„¶åæ·»åŠ ç›¸å…³æœåŠ¡é™çº§çš„å¤„ç†ç±»ï¼š</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by macro on 2019/9/25.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FallbackController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/fallback&quot;)</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">fallback</span><span class="hljs-params">()</span> &#123;<br>        Map&lt;String,Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        result.put(<span class="hljs-string">&quot;data&quot;</span>,<span class="hljs-literal">null</span>);<br>        result.put(<span class="hljs-string">&quot;message&quot;</span>,<span class="hljs-string">&quot;Get request fallback!&quot;</span>);<br>        result.put(<span class="hljs-string">&quot;code&quot;</span>,<span class="hljs-number">500</span>);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>åœ¨application-filter.ymlä¸­æ·»åŠ ç›¸å…³é…ç½®ï¼Œå½“è·¯ç”±å‡ºé”™æ—¶ä¼šè½¬å‘åˆ°æœåŠ¡é™çº§å¤„ç†çš„æ§åˆ¶å™¨ä¸Šï¼š</p>  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">hystrix_route</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:8201</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Method=GET</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Hystrix</span><br>              <span class="hljs-attr">args:</span><br>                <span class="hljs-attr">name:</span> <span class="hljs-string">fallbackcmd</span><br>                <span class="hljs-attr">fallbackUri:</span> <span class="hljs-string">forward:/fallback</span><br></code></pre></td></tr></table></figure></li><li><p>å…³é—­user-serviceï¼Œè°ƒç”¨è¯¥åœ°å€è¿›è¡Œæµ‹è¯•ï¼š<a href="http://localhost:9201/user/1">http://localhost:9201/user/1</a> ï¼Œå‘ç°å·²ç»è¿”å›äº†æœåŠ¡é™çº§çš„å¤„ç†ä¿¡æ¯ã€‚</p></li></ul><p><img src="http://www.macrozheng.com/images/springcloud_gateway_03.png" title="image"></p><h3 id="å¼‚å¸¸æ‹¦æˆªå™¨"><a href="#å¼‚å¸¸æ‹¦æˆªå™¨" class="headerlink" title="å¼‚å¸¸æ‹¦æˆªå™¨"></a>å¼‚å¸¸æ‹¦æˆªå™¨</h3><h4 id="WebExceptionHandler"><a href="#WebExceptionHandler" class="headerlink" title="WebExceptionHandler"></a>WebExceptionHandler</h4><p>åœ¨è¯¥å¼‚å¸¸å¤„ç†ä¸­, å¯ä»¥å¯¹ <code>æœåŠ¡æœªæ‰¾åˆ°</code> æˆ–è€…<code>sentinel</code>çš„ç›¸å…³å¼‚å¸¸ (BlockException) è¿›è¡Œåˆ¤æ–­æ‹¦æˆª, å¹¶è¿”å›å¯¹åº”é”™è¯¯ä¿¡æ¯, å‘ŠçŸ¥ç”¨æˆ·</p><p>å…·ä½“å¯æŸ¥çœ‹<strong>ruoyi</strong>é¡¹ç›®çš„ç›¸å…³ä»£ç , å†™çš„æ¯”è¾ƒå®Œå…¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ç½‘å…³ç»Ÿä¸€å¼‚å¸¸å¤„ç†</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> ruoyi</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Order(-1)</span> <span class="hljs-comment">//ä¼˜å…ˆçº§ä¸€å®šè¦å°äºå†…ç½®ResponseStatusExceptionHandler, ç»è¿‡å®ƒå¤„ç†çš„è·å–å¯¹åº”é”™è¯¯ç±»çš„ å“åº”ç </span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GatewayExceptionHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ErrorWebExceptionHandler</span><br>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(GatewayExceptionHandler.class);<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">handle</span><span class="hljs-params">(ServerWebExchange exchange, Throwable ex)</span><br>    &#123;<br>        <span class="hljs-type">ServerHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> exchange.getResponse();<br><br>        <span class="hljs-keyword">if</span> (exchange.getResponse().isCommitted())<br>        &#123;<br>            <span class="hljs-keyword">return</span> Mono.error(ex);<br>        &#125;<br><br>        String msg;<br><br>        <span class="hljs-keyword">if</span> (ex <span class="hljs-keyword">instanceof</span> NotFoundException)<br>        &#123;<br>            msg = <span class="hljs-string">&quot;æœåŠ¡æœªæ‰¾åˆ°&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ex <span class="hljs-keyword">instanceof</span> ResponseStatusException)<br>        &#123;<br>            <span class="hljs-type">ResponseStatusException</span> <span class="hljs-variable">responseStatusException</span> <span class="hljs-operator">=</span> (ResponseStatusException) ex;<br>            msg = responseStatusException.getMessage();<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            msg = <span class="hljs-string">&quot;å†…éƒ¨æœåŠ¡å™¨é”™è¯¯&quot;</span>;<br>        &#125;<br><br>        log.error(<span class="hljs-string">&quot;[ç½‘å…³å¼‚å¸¸å¤„ç†]è¯·æ±‚è·¯å¾„:&#123;&#125;,å¼‚å¸¸ä¿¡æ¯:&#123;&#125;&quot;</span>, exchange.getRequest().getPath(), ex.getMessage());<br><br>        <span class="hljs-keyword">return</span> ServletUtils.webFluxResponseWriter(response, msg);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * è‡ªå®šä¹‰é™æµå¼‚å¸¸å¤„ç†</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> ruoyi</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SentinelFallbackHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebExceptionHandler</span><br>&#123;<br>    <span class="hljs-keyword">private</span> Mono&lt;Void&gt; <span class="hljs-title function_">writeResponse</span><span class="hljs-params">(ServerResponse response, ServerWebExchange exchange)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> ServletUtils.webFluxResponseWriter(exchange.getResponse(), <span class="hljs-string">&quot;è¯·æ±‚è¶…è¿‡æœ€å¤§æ•°ï¼Œè¯·ç¨å€™å†è¯•&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">handle</span><span class="hljs-params">(ServerWebExchange exchange, Throwable ex)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (exchange.getResponse().isCommitted())<br>        &#123;<br>            <span class="hljs-keyword">return</span> Mono.error(ex);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!BlockException.isBlockException(ex))<br>        &#123;<br>            <span class="hljs-keyword">return</span> Mono.error(ex);<br>        &#125;<br>        <span class="hljs-keyword">return</span> handleBlockedRequest(exchange, ex).flatMap(response -&gt; writeResponse(response, exchange));<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Mono&lt;ServerResponse&gt; <span class="hljs-title function_">handleBlockedRequest</span><span class="hljs-params">(ServerWebExchange exchange, Throwable throwable)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> GatewayCallbackManager.getBlockHandler().handleRequest(exchange, throwable);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Spring Cloud</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Canal</title>
    <link href="/2022/03/28/Spring/Canal/"/>
    <url>/2022/03/28/Spring/Canal/</url>
    
    <content type="html"><![CDATA[<h2 id="What-is-Canal"><a href="#What-is-Canal" class="headerlink" title="What is Canal?"></a>What is Canal?</h2><p>Canal is a high performance data synchronization system based on MySQL binary log. Canal is widely used in Alibaba group (including <a href="https://www.taobao.com/">https://www.taobao.com</a>) to provide reliable low latency incremental data pipeline.</p><p>Canalæ˜¯ä¸€ä¸ªåŸºäº MySQL äºŒè¿›åˆ¶æ—¥å¿—çš„é«˜æ€§èƒ½æ•°æ®åŒæ­¥ç³»ç»Ÿã€‚Canal åœ¨é˜¿é‡Œå·´å·´é›†å›¢(åŒ…æ‹¬ <a href="https://www.taobao.com/">https://www.taobao.com</a> )ä¸­è¢«å¹¿æ³›åº”ç”¨ï¼Œä»¥æä¾›å¯é çš„ä½å»¶è¿Ÿå¢é‡æ•°æ®æµæ°´çº¿ã€‚</p><p>Canal Server is capable of parsing MySQL binlog and subscribe to the data change, while Canal Client can be implemented to broadcast the change to anywhere, e.g. database and Apache Kafka.</p><p>Canal Serverèƒ½å¤Ÿè§£æ MySQL binlog å¹¶è®¢é˜…æ•°æ®æ›´æ”¹ï¼Œè€Œ Canal Client å¯ä»¥å®ç°å°†æ›´æ”¹å¹¿æ’­åˆ°ä»»ä½•åœ°æ–¹ï¼Œä¾‹å¦‚æ•°æ®åº“å’Œ Apache Kafkaã€‚</p><h2 id="Component"><a href="#Component" class="headerlink" title="Component"></a>Component</h2><h3 id="Admin"><a href="#Admin" class="headerlink" title="Admin"></a>Admin</h3><p>canal-adminè®¾è®¡ä¸Šæ˜¯ä¸ºcanalæä¾›æ•´ä½“é…ç½®ç®¡ç†ã€èŠ‚ç‚¹è¿ç»´ç­‰é¢å‘è¿ç»´çš„åŠŸèƒ½ï¼Œæä¾›ç›¸å¯¹å‹å¥½çš„WebUIæ“ä½œç•Œé¢ï¼Œæ–¹ä¾¿æ›´å¤šç”¨æˆ·å¿«é€Ÿå’Œå®‰å…¨çš„æ“ä½œã€‚</p><h3 id="Adapter"><a href="#Adapter" class="headerlink" title="Adapter"></a>Adapter</h3><p>canal-adapteræ˜¯ä¸ºäº†è®©ç ”å‘äººå‘˜æ–¹ä¾¿å¿«é€Ÿçš„å°†å¢é‡æ•°æ®å‘é€åˆ°ElasticSearchç­‰Nosqlä¸­ï¼Œå‡å°‘Javaä»£ç çš„ç¼–å†™ã€‚</p><h3 id="Deployer"><a href="#Deployer" class="headerlink" title="Deployer"></a>Deployer</h3><p>canal-deployeræ˜¯ä¸€ä¸ªæ¨¡ä»¿Mysqlå¤‡æœºçš„å°å‹æœåŠ¡ï¼Œç”¨äºè·å–æ•°æ®åº“æ—¥å¿—æŠ“å–æ•°æ®ã€‚</p><h2 id="Use"><a href="#Use" class="headerlink" title="Use"></a>Use</h2><h3 id="1-Schedule"><a href="#1-Schedule" class="headerlink" title="1. Schedule"></a>1. Schedule</h3><p>ä½¿ç”¨Springbootå®šæ—¶å™¨ï¼Œå®šæ—¶æŠ“å–Canalä¸­çš„å¢é‡æ•°æ®ï¼Œå¹¶è§£æï¼Œç„¶åå‘é€åˆ°è‡ªå·±æƒ³å»çš„åœ°æ–¹ã€‚å®˜æ–¹ä¸­ä¹Ÿæ˜¯ä½¿ç”¨æ­¤åšæ³•ã€‚</p><figure class="highlight awk"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><pre><code class="hljs awk">Get <span class="hljs-regexp">/knowledge/</span>_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>:&#123;<br>    <span class="hljs-string">&quot;term&quot;</span>:&#123;<br>      <span class="hljs-string">&quot;searchTypeId.keyword&quot;</span>:<span class="hljs-string">&quot;3&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Spring Cloud</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CDC</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hikari</title>
    <link href="/2022/03/28/Spring/Hikari/"/>
    <url>/2022/03/28/Spring/Hikari/</url>
    
    <content type="html"><![CDATA[<p>Hikariæ˜¯Springåœ¨2.0ä¹‹åçš„é»˜è®¤jdbcè¿æ¥å·¥å…·, ç›¸æ¯”äºå¸¸ç”¨çš„Druid, ä»–çš„è¿æ¥é€Ÿåº¦åŠ å¿«, å­—èŠ‚ç ç²¾ç®€, å¹¶å‘è¯»å†™æ•ˆç‡æé«˜</p><p>ä½†æ˜¯Druidæœ‰å¼ºå¤§çš„Sqlç›‘æ§ç‰¹æ€§ä»¥åŠé¢å¤–çš„æ‰©å±•åŠŸèƒ½</p><h2 id="ä¸»è¦æ„ä»¶"><a href="#ä¸»è¦æ„ä»¶" class="headerlink" title="ä¸»è¦æ„ä»¶"></a>ä¸»è¦æ„ä»¶</h2><ul><li>HikariDataSource<br>æ˜¯ä¸€åˆ‡çš„å…¥å£, ç”¨äºè·å–è¿æ¥çš„ä¸»è¦ç±»</li><li>HikariConfig<br>é…ç½®ç±»</li><li>HikariPool<br>æŒæœ‰è¿æ¥æ± , å»¶æ—¶maxlifetimeä»»åŠ¡, å®šæ—¶keepaliveæ¸…ç†ä»»åŠ¡çš„æ§åˆ¶ç±»</li><li>ConcurrentBag<br>è¿æ¥æ± , å†…éƒ¨æŒæœ‰äº†è¿æ¥å¯¹è±¡çš„é›†åˆ, ç”¨äºè·å– , åˆ é™¤, å¢åŠ è¿æ¥</li><li>PoolEntry<br>å…·ä½“çš„è¿æ¥å¯¹è±¡, æŒæœ‰å®é™…çš„ç‰©ç†è¿æ¥Connection</li><li>PoolBase<br>ä¸»è¦ç”¨äºç”Ÿäº§ä¸€ä¸ªDriverDataSourceç±», ç»™new PoolEntry()æ—¶ä½¿ç”¨</li></ul><h2 id="æºç è§£è¯»"><a href="#æºç è§£è¯»" class="headerlink" title="æºç è§£è¯»"></a>æºç è§£è¯»</h2><p><a href="https://juejin.cn/post/6986812265357901860">HikariCPæºç æµç¨‹</a></p>]]></content>
    
    
    <categories>
      
      <category>Spring Cloud</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Database</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Ribbon</title>
    <link href="/2022/03/28/Spring/Ribbon/"/>
    <url>/2022/03/28/Spring/Ribbon/</url>
    
    <content type="html"><![CDATA[<blockquote><p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå¾ˆå¤šæœåŠ¡éƒ½ä¼šéƒ¨ç½²å¤šä¸ªï¼Œå…¶ä»–æœåŠ¡å»è°ƒç”¨è¯¥æœåŠ¡çš„æ—¶å€™ï¼Œå¦‚ä½•ä¿è¯è´Ÿè½½å‡è¡¡æ˜¯ä¸ªä¸å¾—ä¸å»è€ƒè™‘çš„é—®é¢˜ã€‚è´Ÿè½½å‡è¡¡å¯ä»¥å¢åŠ ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œæ‰©å±•æ€§ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨RestTemplateæ¥è°ƒç”¨å…¶ä»–æœåŠ¡æ—¶ï¼ŒRibbonå¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚</p></blockquote><h3 id="RestTemplate"><a href="#RestTemplate" class="headerlink" title="RestTemplate"></a>RestTemplate</h3><p>RestTemplateæ˜¯ä¸€ä¸ªHTTPå®¢æˆ·ç«¯ï¼Œä½¿ç”¨å®ƒæˆ‘ä»¬å¯ä»¥æ–¹ä¾¿çš„è°ƒç”¨HTTPæ¥å£ï¼Œæ”¯æŒGETã€POSTã€PUTã€DELETEç­‰æ–¹æ³•ã€‚</p><h3 id="LoadBalanced"><a href="#LoadBalanced" class="headerlink" title="LoadBalanced"></a>LoadBalanced</h3><p>ä½¿ç”¨Ribbonçš„è´Ÿè½½å‡è¡¡åŠŸèƒ½éå¸¸ç®€å•ï¼Œå’Œç›´æ¥ä½¿ç”¨RestTemplateæ²¡ä»€ä¹ˆä¸¤æ ·ï¼Œåªéœ€ç»™RestTemplateæ·»åŠ ä¸€ä¸ª@LoadBalancedå³å¯ã€‚</p><ul><li>com.netflix.loadbalancer.RandomRuleï¼šä»æä¾›æœåŠ¡çš„å®ä¾‹ä¸­ä»¥éšæœºçš„æ–¹å¼ï¼›</li><li>com.netflix.loadbalancer.RoundRobinRuleï¼šä»¥çº¿æ€§è½®è¯¢çš„æ–¹å¼ï¼Œå°±æ˜¯ç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨ï¼Œä»æä¾›æœåŠ¡çš„å®ä¾‹ä¸­æŒ‰é¡ºåºé€‰å–ï¼Œç¬¬ä¸€æ¬¡é€‰ç¬¬ä¸€ä¸ªï¼Œç¬¬äºŒæ¬¡é€‰ç¬¬äºŒä¸ªï¼Œä»¥æ­¤ç±»æ¨ï¼Œåˆ°æœ€åä¸€ä¸ªä»¥åå†ä»å¤´æ¥è¿‡ï¼›</li><li>com.netflix.loadbalancer.RetryRuleï¼šåœ¨RoundRobinRuleçš„åŸºç¡€ä¸Šæ·»åŠ é‡è¯•æœºåˆ¶ï¼Œå³åœ¨æŒ‡å®šçš„é‡è¯•æ—¶é—´å†…ï¼Œåå¤ä½¿ç”¨çº¿æ€§è½®è¯¢ç­–ç•¥æ¥é€‰æ‹©å¯ç”¨å®ä¾‹ï¼›</li><li>com.netflix.loadbalancer.WeightedResponseTimeRuleï¼šå¯¹RoundRobinRuleçš„æ‰©å±•ï¼Œå“åº”é€Ÿåº¦è¶Šå¿«çš„å®ä¾‹é€‰æ‹©æƒé‡è¶Šå¤§ï¼Œè¶Šå®¹æ˜“è¢«é€‰æ‹©ï¼›</li><li>com.netflix.loadbalancer.BestAvailableRuleï¼šé€‰æ‹©å¹¶å‘è¾ƒå°çš„å®ä¾‹ï¼›</li><li>com.netflix.loadbalancer.AvailabilityFilteringRuleï¼šå…ˆè¿‡æ»¤æ‰æ•…éšœå®ä¾‹ï¼Œå†é€‰æ‹©å¹¶å‘è¾ƒå°çš„å®ä¾‹ï¼›</li><li>com.netflix.loadbalancer.ZoneAwareLoadBalancerï¼šé‡‡ç”¨åŒé‡è¿‡æ»¤ï¼ŒåŒæ—¶è¿‡æ»¤ä¸æ˜¯åŒä¸€åŒºåŸŸçš„å®ä¾‹å’Œæ•…éšœå®ä¾‹ï¼Œé€‰æ‹©å¹¶å‘è¾ƒå°çš„å®ä¾‹ã€‚</li></ul><h3 id="Used-Config"><a href="#Used-Config" class="headerlink" title="Used Config"></a>Used Config</h3><figure class="highlight yaml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">user-service:</span><br>  <span class="hljs-attr">ribbon:</span><br>  <span class="hljs-attr">ConnectTimeout:</span> <span class="hljs-number">1000</span> <span class="hljs-comment">#æœåŠ¡è¯·æ±‚è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span><br>  <span class="hljs-attr">ReadTimeout:</span> <span class="hljs-number">3000</span> <span class="hljs-comment">#æœåŠ¡è¯·æ±‚å¤„ç†è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span><br>  <span class="hljs-attr">OkToRetryOnAllOperations:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#å¯¹è¶…æ—¶è¯·æ±‚å¯ç”¨é‡è¯•æœºåˆ¶</span><br>  <span class="hljs-attr">MaxAutoRetriesNextServer:</span> <span class="hljs-number">1</span> <span class="hljs-comment">#åˆ‡æ¢é‡è¯•å®ä¾‹çš„æœ€å¤§ä¸ªæ•°</span><br>  <span class="hljs-attr">MaxAutoRetries:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># åˆ‡æ¢å®ä¾‹åé‡è¯•æœ€å¤§æ¬¡æ•°</span><br>  <span class="hljs-attr">NFLoadBalancerRuleClassName:</span> <span class="hljs-string">com.netflix.loadbalancer.RandomRule</span> <span class="hljs-comment">#ä¿®æ”¹è´Ÿè½½å‡è¡¡ç®—æ³•</span><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Spring Cloud</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Mycat</title>
    <link href="/2022/03/28/Spring/Mycat/"/>
    <url>/2022/03/28/Spring/Mycat/</url>
    
    <content type="html"><![CDATA[<p>çœ‹äº†ä¸€ä¸‹Mycat<a href="https://www.yuque.com/books/share/6606b3b6-3365-4187-94c4-e51116894695/bef923fb8acc57e0f805d45ef7782670">å®˜æ–¹æ–‡æ¡£</a>ï¼Œå¯¹äºMGRã€MHAç­‰éƒ½æœ‰éå¸¸å¥½çš„å…¼å®¹æ¨¡å¼ï¼Œå¯ä»¥å®ç°åŠ¨æ€æ•°æ®æºæ›´æ”¹ï¼Œä½†æ˜¯ä½¿ç”¨ä¼¼ä¹ä¸å¤ªå¹¿æ³›ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>DataBase</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Hystrix</title>
    <link href="/2022/03/28/Spring/Hystrix/"/>
    <url>/2022/03/28/Spring/Hystrix/</url>
    
    <content type="html"><![CDATA[<blockquote><p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒæœåŠ¡ä¸æœåŠ¡ä¹‹é—´é€šè¿‡è¿œç¨‹è°ƒç”¨çš„æ–¹å¼è¿›è¡Œé€šä¿¡ï¼Œä¸€æ—¦æŸä¸ªè¢«è°ƒç”¨çš„æœåŠ¡å‘ç”Ÿäº†æ•…éšœï¼Œå…¶ä¾èµ–æœåŠ¡ä¹Ÿä¼šå‘ç”Ÿæ•…éšœï¼Œæ­¤æ—¶å°±ä¼šå‘ç”Ÿæ•…éšœçš„è”“å»¶ï¼Œæœ€ç»ˆå¯¼è‡´ç³»ç»Ÿç˜«ç—ªã€‚Hystrixå®ç°äº†æ–­è·¯å™¨æ¨¡å¼ï¼Œå½“æŸä¸ªæœåŠ¡å‘ç”Ÿæ•…éšœæ—¶ï¼Œé€šè¿‡æ–­è·¯å™¨çš„ç›‘æ§ï¼Œç»™è°ƒç”¨æ–¹è¿”å›ä¸€ä¸ªé”™è¯¯å“åº”ï¼Œè€Œä¸æ˜¯é•¿æ—¶é—´çš„ç­‰å¾…ï¼Œè¿™æ ·å°±ä¸ä¼šä½¿å¾—è°ƒç”¨æ–¹ç”±äºé•¿æ—¶é—´å¾—ä¸åˆ°å“åº”è€Œå ç”¨çº¿ç¨‹ï¼Œä»è€Œé˜²æ­¢æ•…éšœçš„è”“å»¶ã€‚Hystrixå…·å¤‡æœåŠ¡é™çº§ã€æœåŠ¡ç†”æ–­ã€çº¿ç¨‹éš”ç¦»ã€è¯·æ±‚ç¼“å­˜ã€è¯·æ±‚åˆå¹¶åŠæœåŠ¡ç›‘æ§ç­‰å¼ºå¤§åŠŸèƒ½ã€‚</p></blockquote><h4 id="Used-Parameters"><a href="#Used-Parameters" class="headerlink" title="Used Parameters"></a>Used Parameters</h4><ul><li>fallbackMethodï¼šæŒ‡å®šæœåŠ¡é™çº§å¤„ç†æ–¹æ³•ï¼›</li><li>ignoreExceptionsï¼šå¿½ç•¥æŸäº›å¼‚å¸¸ï¼Œä¸å‘ç”ŸæœåŠ¡é™çº§ï¼›</li><li>commandKeyï¼šå‘½ä»¤åç§°ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„å‘½ä»¤ï¼›</li><li>groupKeyï¼šåˆ†ç»„åç§°ï¼ŒHystrixä¼šæ ¹æ®ä¸åŒçš„åˆ†ç»„æ¥ç»Ÿè®¡å‘½ä»¤çš„å‘Šè­¦åŠä»ªè¡¨ç›˜ä¿¡æ¯ï¼›</li><li>threadPoolKeyï¼šçº¿ç¨‹æ± åç§°ï¼Œç”¨äºåˆ’åˆ†çº¿ç¨‹æ± ã€‚</li></ul><h3 id="èµ„æºéš”ç¦»"><a href="#èµ„æºéš”ç¦»" class="headerlink" title="èµ„æºéš”ç¦»"></a>èµ„æºéš”ç¦»</h3><p><img src="https://res.craft.do/user/full/2c016c68-2ea0-5513-42ea-5813d216a654/doc/64F8465D-ECA0-4FC5-8B4D-195A84183BDB/AE24F0F6-D141-4924-8387-28C3C3D9AF70_2" title="image"></p><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p><ul><li><strong>çº¿ç¨‹æ± æŠ€æœ¯</strong>ï¼Œé€‚åˆç»å¤§å¤šæ•°åœºæ™¯ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬å¯¹ä¾èµ–æœåŠ¡çš„ç½‘ç»œè¯·æ±‚çš„è°ƒç”¨å’Œè®¿é—®ã€éœ€è¦å¯¹è°ƒç”¨çš„ timeout è¿›è¡Œæ§åˆ¶ï¼ˆæ•æ‰ timeout è¶…æ—¶å¼‚å¸¸ï¼‰ã€‚</li><li><strong>ä¿¡å·é‡æŠ€æœ¯</strong>ï¼Œé€‚åˆè¯´ä½ çš„è®¿é—®ä¸æ˜¯å¯¹å¤–éƒ¨ä¾èµ–çš„è®¿é—®ï¼Œè€Œæ˜¯å¯¹å†…éƒ¨çš„ä¸€äº›æ¯”è¾ƒå¤æ‚çš„ä¸šåŠ¡é€»è¾‘çš„è®¿é—®ï¼Œå¹¶ä¸”ç³»ç»Ÿå†…éƒ¨çš„ä»£ç ï¼Œå…¶å®ä¸æ¶‰åŠä»»ä½•çš„ç½‘ç»œè¯·æ±‚ï¼Œé‚£ä¹ˆåªè¦åšä¿¡å·é‡çš„æ™®é€šé™æµå°±å¯ä»¥äº†ï¼Œå› ä¸ºä¸éœ€è¦å»æ•è· timeout ç±»ä¼¼çš„é—®é¢˜ã€‚</li></ul><h3 id="Request-Cache"><a href="#Request-Cache" class="headerlink" title="Request Cache"></a>Request Cache</h3><p>åœ¨ä¸€æ¬¡è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­ï¼Œå¦‚æœæœ‰å¤šä¸ª commandï¼Œå‚æ•°éƒ½æ˜¯ä¸€æ ·çš„ï¼Œè°ƒç”¨çš„æ¥å£ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œè€Œç»“æœå¯ä»¥è®¤ä¸ºä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚é‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥è®©ç¬¬ä¸€ä¸ª command æ‰§è¡Œè¿”å›çš„ç»“æœç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œç„¶åè¿™ä¸ªè¯·æ±‚ä¸Šä¸‹æ–‡åç»­çš„å…¶å®ƒå¯¹è¿™ä¸ªä¾èµ–çš„è°ƒç”¨å…¨éƒ¨ä»å†…å­˜ä¸­å–å‡ºç¼“å­˜ç»“æœå°±å¯ä»¥äº†ã€‚</p><p>è¿™æ ·çš„è¯ï¼Œå¥½å¤„åœ¨äºä¸ç”¨åœ¨ä¸€æ¬¡è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­åå¤å¤šæ¬¡æ‰§è¡Œä¸€æ ·çš„ commandï¼Œ<strong>é¿å…é‡å¤æ‰§è¡Œç½‘ç»œè¯·æ±‚ï¼Œæå‡æ•´ä¸ªè¯·æ±‚çš„æ€§èƒ½</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@CacheResult(cacheKeyMethod = &quot;getCacheKey&quot;)</span><br><span class="hljs-meta">@HystrixCommand(fallbackMethod = &quot;getDefaultUser&quot;, commandKey = &quot;getUserCache&quot;)</span><br>    <span class="hljs-keyword">public</span> CommonResult <span class="hljs-title function_">getUserCache</span><span class="hljs-params">(Long id)</span> &#123;<br>    LOGGER.info(<span class="hljs-string">&quot;getUserCache id:&#123;&#125;&quot;</span>, id);<br>    <span class="hljs-keyword">return</span> restTemplate.getForObject(userServiceUrl + <span class="hljs-string">&quot;/user/&#123;1&#125;&quot;</span>, CommonResult.class, id);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ä¸ºç¼“å­˜ç”Ÿæˆkeyçš„æ–¹æ³•</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCacheKey</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-keyword">return</span> String.valueOf(id);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="HystrixCollapser-è¯·æ±‚åˆå¹¶"><a href="#HystrixCollapser-è¯·æ±‚åˆå¹¶" class="headerlink" title="HystrixCollapser è¯·æ±‚åˆå¹¶"></a>HystrixCollapser è¯·æ±‚åˆå¹¶</h3><ul><li>batchMethodï¼šç”¨äºè®¾ç½®è¯·æ±‚åˆå¹¶çš„æ–¹æ³•ï¼›</li><li>collapserPropertiesï¼šè¯·æ±‚åˆå¹¶å±æ€§ï¼Œç”¨äºæ§åˆ¶å®ä¾‹å±æ€§ï¼Œæœ‰å¾ˆå¤šï¼›</li><li>timerDelayInMillisecondsï¼šcollapserPropertiesä¸­çš„å±æ€§ï¼Œç”¨äºæ§åˆ¶æ¯éš”å¤šå°‘æ—¶é—´åˆå¹¶ä¸€æ¬¡è¯·æ±‚ï¼›</li></ul><ol><li>åœ¨UserHystrixControllerä¸­æ·»åŠ testCollapseræ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆè¿›è¡Œä¸¤æ¬¡æœåŠ¡è°ƒç”¨ï¼Œå†é—´éš”200msä»¥åè¿›è¡Œç¬¬ä¸‰æ¬¡æœåŠ¡è°ƒç”¨ï¼š</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/testCollapser&quot;)</span><br><span class="hljs-keyword">public</span> CommonResult <span class="hljs-title function_">testCollapser</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>  Future&lt;User&gt; future1 = userService.getUserFuture(<span class="hljs-number">1L</span>);<br>  Future&lt;User&gt; future2 = userService.getUserFuture(<span class="hljs-number">2L</span>);<br>  future1.get();<br>  future2.get();<br>  ThreadUtil.safeSleep(<span class="hljs-number">200</span>);<br>  Future&lt;User&gt; future3 = userService.getUserFuture(<span class="hljs-number">3L</span>);<br>  future3.get();<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonResult</span>(<span class="hljs-string">&quot;æ“ä½œæˆåŠŸ&quot;</span>, <span class="hljs-number">200</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure><ol><li>ä½¿ç”¨@HystrixCollapserå®ç°è¯·æ±‚åˆå¹¶ï¼Œæ‰€æœ‰å¯¹getUserFutureçš„çš„å¤šæ¬¡è°ƒç”¨éƒ½ä¼šè½¬åŒ–ä¸ºå¯¹getUserByIdsçš„å•æ¬¡è°ƒç”¨ï¼š</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@HystrixCollapser(batchMethod = &quot;getUserByIds&quot;,collapserProperties = &#123;</span><br><span class="hljs-meta">  @HystrixProperty(name = &quot;timerDelayInMilliseconds&quot;, value = &quot;100&quot;)</span><br><span class="hljs-meta">&#125;)</span><br><span class="hljs-keyword">public</span> Future&lt;User&gt; <span class="hljs-title function_">getUserFuture</span><span class="hljs-params">(Long id)</span> &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncResult</span>&lt;User&gt;()&#123;<br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> User <span class="hljs-title function_">invoke</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">CommonResult</span> <span class="hljs-variable">commonResult</span> <span class="hljs-operator">=</span> restTemplate.getForObject(userServiceUrl + <span class="hljs-string">&quot;/user/&#123;1&#125;&quot;</span>, CommonResult.class, id);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> (Map) commonResult.getData();<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> BeanUtil.mapToBean(data,User.class,<span class="hljs-literal">true</span>);<br>    LOGGER.info(<span class="hljs-string">&quot;getUserById username:&#123;&#125;&quot;</span>, user.getUsername());<br>    <span class="hljs-keyword">return</span> user;<br>    &#125;<br>  &#125;;<br>&#125;<br><br><span class="hljs-meta">@HystrixCommand</span><br><span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getUserByIds</span><span class="hljs-params">(List&lt;Long&gt; ids)</span> &#123;<br>  LOGGER.info(<span class="hljs-string">&quot;getUserByIds:&#123;&#125;&quot;</span>, ids);<br>  <span class="hljs-type">CommonResult</span> <span class="hljs-variable">commonResult</span> <span class="hljs-operator">=</span> restTemplate.getForObject(userServiceUrl + <span class="hljs-string">&quot;/user/getUserByIds?ids=&#123;1&#125;&quot;</span>, CommonResult.class, CollUtil.join(ids,<span class="hljs-string">&quot;,&quot;</span>));<br>  <span class="hljs-keyword">return</span> (List&lt;User&gt;) commonResult.getData();<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="Used-Config"><a href="#Used-Config" class="headerlink" title="Used Config"></a>Used Config</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">hystrix:</span><br>  <span class="hljs-attr">command:</span> <span class="hljs-comment">#ç”¨äºæ§åˆ¶HystrixCommandçš„è¡Œä¸º</span><br>  <span class="hljs-attr">default:</span><br>    <span class="hljs-attr">execution:</span><br>    <span class="hljs-attr">isolation:</span><br>      <span class="hljs-attr">strategy:</span> <span class="hljs-string">THREAD</span> <span class="hljs-comment">#æ§åˆ¶HystrixCommandçš„éš”ç¦»ç­–ç•¥ï¼ŒTHREAD-&gt;çº¿ç¨‹æ± éš”ç¦»ç­–ç•¥(é»˜è®¤)ï¼ŒSEMAPHORE-&gt;ä¿¡å·é‡éš”ç¦»ç­–ç•¥</span><br>      <span class="hljs-attr">thread:</span><br>      <span class="hljs-attr">timeoutInMilliseconds:</span> <span class="hljs-number">1000</span> <span class="hljs-comment">#é…ç½®HystrixCommandæ‰§è¡Œçš„è¶…æ—¶æ—¶é—´ï¼Œæ‰§è¡Œè¶…è¿‡è¯¥æ—¶é—´ä¼šè¿›è¡ŒæœåŠ¡é™çº§å¤„ç†</span><br>      <span class="hljs-attr">interruptOnTimeout:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#é…ç½®HystrixCommandæ‰§è¡Œè¶…æ—¶çš„æ—¶å€™æ˜¯å¦è¦ä¸­æ–­</span><br>      <span class="hljs-attr">interruptOnCancel:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#é…ç½®HystrixCommandæ‰§è¡Œè¢«å–æ¶ˆçš„æ—¶å€™æ˜¯å¦è¦ä¸­æ–­</span><br>      <span class="hljs-attr">timeout:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#é…ç½®HystrixCommandçš„æ‰§è¡Œæ˜¯å¦å¯ç”¨è¶…æ—¶æ—¶é—´</span><br>      <span class="hljs-attr">semaphore:</span><br>      <span class="hljs-attr">maxConcurrentRequests:</span> <span class="hljs-number">10</span> <span class="hljs-comment">#å½“ä½¿ç”¨ä¿¡å·é‡éš”ç¦»ç­–ç•¥æ—¶ï¼Œç”¨æ¥æ§åˆ¶å¹¶å‘é‡çš„å¤§å°ï¼Œè¶…è¿‡è¯¥å¹¶å‘é‡çš„è¯·æ±‚ä¼šè¢«æ‹’ç»</span><br>    <span class="hljs-attr">fallback:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#ç”¨äºæ§åˆ¶æ˜¯å¦å¯ç”¨æœåŠ¡é™çº§</span><br>    <span class="hljs-attr">circuitBreaker:</span> <span class="hljs-comment">#ç”¨äºæ§åˆ¶HystrixCircuitBreakerçš„è¡Œä¸º</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#ç”¨äºæ§åˆ¶æ–­è·¯å™¨æ˜¯å¦è·Ÿè¸ªå¥åº·çŠ¶å†µä»¥åŠç†”æ–­è¯·æ±‚</span><br>    <span class="hljs-attr">requestVolumeThreshold:</span> <span class="hljs-number">20</span> <span class="hljs-comment">#è¶…è¿‡è¯¥è¯·æ±‚æ•°çš„è¯·æ±‚ä¼šè¢«æ‹’ç»</span><br>    <span class="hljs-attr">forceOpen:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#å¼ºåˆ¶æ‰“å¼€æ–­è·¯å™¨ï¼Œæ‹’ç»æ‰€æœ‰è¯·æ±‚</span><br>    <span class="hljs-attr">forceClosed:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#å¼ºåˆ¶å…³é—­æ–­è·¯å™¨ï¼Œæ¥æ”¶æ‰€æœ‰è¯·æ±‚</span><br>    <span class="hljs-attr">requestCache:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#ç”¨äºæ§åˆ¶æ˜¯å¦å¼€å¯è¯·æ±‚ç¼“å­˜</span><br>  <span class="hljs-attr">collapser:</span> <span class="hljs-comment">#ç”¨äºæ§åˆ¶HystrixCollapserçš„æ‰§è¡Œè¡Œä¸º</span><br>  <span class="hljs-attr">default:</span><br>    <span class="hljs-attr">maxRequestsInBatch:</span> <span class="hljs-number">100</span> <span class="hljs-comment">#æ§åˆ¶ä¸€æ¬¡åˆå¹¶è¯·æ±‚åˆå¹¶çš„æœ€å¤§è¯·æ±‚æ•°</span><br>    <span class="hljs-attr">timerDelayinMilliseconds:</span> <span class="hljs-number">10</span> <span class="hljs-comment">#æ§åˆ¶å¤šå°‘æ¯«ç§’å†…çš„è¯·æ±‚ä¼šè¢«åˆå¹¶æˆä¸€ä¸ª</span><br>    <span class="hljs-attr">requestCache:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#æ§åˆ¶åˆå¹¶è¯·æ±‚æ˜¯å¦å¼€å¯ç¼“å­˜</span><br>  <span class="hljs-attr">threadpool:</span> <span class="hljs-comment">#ç”¨äºæ§åˆ¶HystrixCommandæ‰§è¡Œæ‰€åœ¨çº¿ç¨‹æ± çš„è¡Œä¸º</span><br>  <span class="hljs-attr">default:</span><br>    <span class="hljs-attr">coreSize:</span> <span class="hljs-number">10</span> <span class="hljs-comment">#çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°</span><br>    <span class="hljs-attr">maximumSize:</span> <span class="hljs-number">10</span> <span class="hljs-comment">#çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œè¶…è¿‡è¯¥çº¿ç¨‹æ•°çš„è¯·æ±‚ä¼šè¢«æ‹’ç»</span><br>    <span class="hljs-attr">maxQueueSize:</span> <span class="hljs-number">-1</span> <span class="hljs-comment">#ç”¨äºè®¾ç½®çº¿ç¨‹æ± çš„æœ€å¤§é˜Ÿåˆ—å¤§å°ï¼Œ-1é‡‡ç”¨SynchronousQueueï¼Œå…¶ä»–æ­£æ•°é‡‡ç”¨LinkedBlockingQueue</span><br>    <span class="hljs-attr">queueSizeRejectionThreshold:</span> <span class="hljs-number">5</span> <span class="hljs-comment">#ç”¨äºè®¾ç½®çº¿ç¨‹æ± é˜Ÿåˆ—çš„æ‹’ç»é˜€å€¼ï¼Œç”±äºLinkedBlockingQueueä¸èƒ½åŠ¨æ€æ”¹ç‰ˆå¤§å°ï¼Œä½¿ç”¨æ—¶éœ€è¦ç”¨è¯¥å‚æ•°æ¥æ§åˆ¶çº¿ç¨‹æ•°</span><br><br></code></pre></td></tr></table></figure><h3 id="DashBoard"><a href="#DashBoard" class="headerlink" title="DashBoard"></a>DashBoard</h3><p>Hystrixæä¾›äº†Hystrix Dashboardæ¥å®æ—¶ç›‘æ§HystrixCommandæ–¹æ³•çš„æ‰§è¡Œæƒ…å†µã€‚ Hystrix Dashboardå¯ä»¥æœ‰æ•ˆåœ°åæ˜ å‡ºæ¯ä¸ªHystrixå®ä¾‹çš„è¿è¡Œæƒ…å†µï¼Œå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå‘ç°ç³»ç»Ÿä¸­çš„é—®é¢˜ï¼Œä»è€Œé‡‡å–å¯¹åº”æªæ–½ã€‚</p><p><img src="https://res.craft.do/user/full/2c016c68-2ea0-5513-42ea-5813d216a654/doc/64F8465D-ECA0-4FC5-8B4D-195A84183BDB/7ED0A8F2-1BE6-4284-B09D-A44390CCE9F6_2" title="image"></p>]]></content>
    
    
    <categories>
      
      <category>Spring Cloud</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Mybatis</title>
    <link href="/2022/03/28/Spring/Mybatis/"/>
    <url>/2022/03/28/Spring/Mybatis/</url>
    
    <content type="html"><![CDATA[<h2 id="Primary-components"><a href="#Primary-components" class="headerlink" title="Primary components"></a>Primary components</h2><ul><li>Configuration<br>  MyBatisæ‰€æœ‰çš„é…ç½®ä¿¡æ¯éƒ½ç»´æŒåœ¨Configurationå¯¹è±¡ä¹‹ä¸­ã€‚<strong>åŒ…å«æ‹¦æˆªå™¨çš„åŠ¨æ€ä»£ç†åŠŸèƒ½</strong><ul><li><code>SqlSessionFactoryBuilder</code>å¯¹è±¡é€šè¿‡è¯¥é…ç½®ç”Ÿæˆ<code>SqlSessionFactory</code>, <code>SqlSessionFactory.openSession()</code>å¾—åˆ°<code>SqlSession</code>å¯¹è±¡</li><li>Springé›†æˆç‰ˆæœ¬ä¸­, ä¸å†é‡‡ç”¨Builderç”Ÿæˆ, è€Œæ˜¯SqlSessionFactoryBeançš„å·¥å‚beanæ–¹å¼æ³¨å…¥åˆ°Springä¸­</li></ul></li><li>SqlSession<br>ä½œä¸ºMyBatiså·¥ä½œçš„ä¸»è¦é¡¶å±‚APIï¼Œè¡¨ç¤ºå’Œæ•°æ®åº“äº¤äº’çš„ä¼šè¯ï¼Œå®Œæˆå¿…è¦æ•°æ®åº“å¢åˆ æ”¹æŸ¥åŠŸèƒ½ã€‚</li><li>MappedStatement<br>MappedStatementæ˜¯ç»´æŠ¤äº†æŸä¸€æ¡&lt;select|update|delete|insert&gt;èŠ‚ç‚¹çš„å°è£…å¯¹è±¡ã€‚</li><li>Executor<br>MyBatisæ‰§è¡Œå™¨ï¼Œæ˜¯MyBatis è°ƒåº¦çš„æ ¸å¿ƒï¼Œè´Ÿè´£SQLè¯­å¥çš„ç”Ÿæˆå’ŒæŸ¥è¯¢ç¼“å­˜çš„ç»´æŠ¤ã€‚</li><li>SqlSourceÂ Â Â Â Â Â Â Â Â Â Â <br>è´Ÿè´£æ ¹æ®ç”¨æˆ·ä¼ é€’çš„parameterObjectï¼ŒåŠ¨æ€åœ°ç”ŸæˆSQLè¯­å¥ï¼Œå°†ä¿¡æ¯å°è£…åˆ°BoundSqlå¯¹è±¡ä¸­ï¼Œå¹¶è¿”å›ã€‚</li></ul><p><img src="/image/Mybatis/mybatis-y-arch-1.png"></p><ul><li>BoundSqlÂ Â Â Â Â Â Â Â Â Â Â Â <br>è¡¨ç¤ºåŠ¨æ€ç”Ÿæˆçš„SQLè¯­å¥ä»¥åŠç›¸åº”çš„å‚æ•°ä¿¡æ¯ã€‚</li><li>StatementHandler<br>å°è£…äº†JDBC Statementæ“ä½œï¼Œè´Ÿè´£å¯¹JDBC statement çš„æ“ä½œï¼Œå¦‚è®¾ç½®å‚æ•°ã€å°†Statementç»“æœé›†è½¬æ¢æˆListé›†åˆã€‚</li><li>ParameterHandler<br>è´Ÿè´£å¯¹ç”¨æˆ·ä¼ é€’çš„å‚æ•°è½¬æ¢æˆJDBC Statement æ‰€éœ€è¦çš„å‚æ•°ã€‚</li><li>ResultSetHandlerÂ <br>è´Ÿè´£å°†JDBCè¿”å›çš„ResultSetç»“æœé›†å¯¹è±¡è½¬æ¢æˆListç±»å‹çš„é›†åˆã€‚</li><li>TypeHandlerÂ Â Â Â Â Â Â <br>è´Ÿè´£javaæ•°æ®ç±»å‹å’Œjdbcæ•°æ®ç±»å‹ä¹‹é—´çš„æ˜ å°„å’Œè½¬æ¢ã€‚</li><li>DefaultObjectFactory<br>åœ¨è¿”å›æŸ¥è¯¢ç»“æœæ—¶, ä¼šè°ƒç”¨è¯¥ç±»çš„createæ–¹æ³•åˆ›å»ºjavaå¯¹è±¡å‡ºæ¥, å¯ä»¥å®ç°è¯¥æ–¹æ³•è‡ªå®šä¹‰æ–°çš„createæ–¹æ³•æ„é€ å‡ºæŒ‡å®šå€¼çš„å¯¹è±¡å‡ºæ¥</li></ul><h2 id="æºç è§£è¯»"><a href="#æºç è§£è¯»" class="headerlink" title="æºç è§£è¯»"></a>æºç è§£è¯»</h2><p><a href="https://pdai.tech/md/framework/orm-mybatis/mybatis-overview.html">Java å…¨æ ˆçŸ¥è¯†ä½“ç³»-Mybatisè¯¦è§£</a></p>]]></content>
    
    
    <categories>
      
      <category>Spring Cloud</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Database</tag>
      
      <tag>ORM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Seata</title>
    <link href="/2022/03/28/Spring/Seata/"/>
    <url>/2022/03/28/Spring/Seata/</url>
    
    <content type="html"><![CDATA[<blockquote><p>Seata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºæä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ã€‚Seata å°†ä¸ºç”¨æˆ·æä¾›äº† ATã€TCCã€SAGA å’Œ XA äº‹åŠ¡æ¨¡å¼ï¼Œä¸ºç”¨æˆ·æ‰“é€ ä¸€ç«™å¼çš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆã€‚</p></blockquote><h3 id="Component"><a href="#Component" class="headerlink" title="Component"></a>Component</h3><ul><li>Transaction Coordinator (TC)ï¼š äº‹åŠ¡åè°ƒå™¨ï¼Œç»´æŠ¤å…¨å±€äº‹åŠ¡çš„è¿è¡ŒçŠ¶æ€ï¼Œè´Ÿè´£åè°ƒå¹¶é©±åŠ¨å…¨å±€äº‹åŠ¡çš„æäº¤æˆ–å›æ»šï¼›</li><li>Transaction Manager (TM)ï¼š æ§åˆ¶å…¨å±€äº‹åŠ¡çš„è¾¹ç•Œï¼Œè´Ÿè´£å¼€å¯ä¸€ä¸ªå…¨å±€äº‹åŠ¡ï¼Œå¹¶æœ€ç»ˆå‘èµ·å…¨å±€æäº¤æˆ–å…¨å±€å›æ»šçš„å†³è®®ï¼›</li><li>Resource Manager (RM)ï¼š æ§åˆ¶åˆ†æ”¯äº‹åŠ¡ï¼Œè´Ÿè´£åˆ†æ”¯æ³¨å†Œã€çŠ¶æ€æ±‡æŠ¥ï¼Œå¹¶æ¥æ”¶äº‹åŠ¡åè°ƒå™¨çš„æŒ‡ä»¤ï¼Œé©±åŠ¨åˆ†æ”¯ï¼ˆæœ¬åœ°ï¼‰äº‹åŠ¡çš„æäº¤å’Œå›æ»šã€‚</li></ul><h3 id="ä¸€ä¸ªå…¸å‹çš„åˆ†å¸ƒå¼äº‹åŠ¡è¿‡ç¨‹"><a href="#ä¸€ä¸ªå…¸å‹çš„åˆ†å¸ƒå¼äº‹åŠ¡è¿‡ç¨‹" class="headerlink" title="ä¸€ä¸ªå…¸å‹çš„åˆ†å¸ƒå¼äº‹åŠ¡è¿‡ç¨‹"></a>ä¸€ä¸ªå…¸å‹çš„åˆ†å¸ƒå¼äº‹åŠ¡è¿‡ç¨‹</h3><ul><li>TM å‘ TC ç”³è¯·å¼€å¯ä¸€ä¸ªå…¨å±€äº‹åŠ¡ï¼Œå…¨å±€äº‹åŠ¡åˆ›å»ºæˆåŠŸå¹¶ç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ XIDï¼›</li><li>XID åœ¨å¾®æœåŠ¡è°ƒç”¨é“¾è·¯çš„ä¸Šä¸‹æ–‡ä¸­ä¼ æ’­ï¼›</li><li>RM å‘ TC æ³¨å†Œåˆ†æ”¯äº‹åŠ¡ï¼Œå°†å…¶çº³å…¥ XID å¯¹åº”å…¨å±€äº‹åŠ¡çš„ç®¡è¾–ï¼›</li><li>TM å‘ TC å‘èµ·é’ˆå¯¹ XID çš„å…¨å±€æäº¤æˆ–å›æ»šå†³è®®ï¼›</li><li>TC è°ƒåº¦ XID ä¸‹ç®¡è¾–çš„å…¨éƒ¨åˆ†æ”¯äº‹åŠ¡å®Œæˆæäº¤æˆ–å›æ»šè¯·æ±‚ã€‚</li></ul><p><img src="/image/Seata/seata.png"></p><h3 id="Installation-amp-Use"><a href="#Installation-amp-Use" class="headerlink" title="Installation &amp; Use"></a>Installation &amp; Use</h3><h4 id="1-Seataçš„é…ç½®"><a href="#1-Seataçš„é…ç½®" class="headerlink" title="1. Seataçš„é…ç½®"></a>1. Seataçš„é…ç½®</h4><p>è§£å‹seata-serverå®‰è£…åŒ…åˆ°æŒ‡å®šç›®å½•ï¼Œä¿®æ”¹<code>conf</code>ç›®å½•ä¸‹çš„<code>file.conf</code>é…ç½®æ–‡ä»¶ï¼Œä¸»è¦ä¿®æ”¹è‡ªå®šä¹‰äº‹åŠ¡ç»„åç§°ï¼Œäº‹åŠ¡æ—¥å¿—å­˜å‚¨æ¨¡å¼ä¸º<code>db</code>åŠæ•°æ®åº“è¿æ¥ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></div></td><td class="code"><pre><code class="hljs Objective-C">service &#123;<br>  #vgroup-&gt;rgroup<br>  vgroup_mapping.fsp_tx_group = &quot;default&quot; #ä¿®æ”¹äº‹åŠ¡ç»„åç§°ä¸ºï¼šfsp_tx_groupï¼Œå’Œå®¢æˆ·ç«¯è‡ªå®šä¹‰çš„åç§°å¯¹åº”<br>  #only support single node<br>  default.grouplist = &quot;127.0.0.1:8091&quot;<br>  #degrade current not support<br>  enableDegrade = false<br>  #disable<br>  disable = false<br>  #unit ms,s,m,h,d represents milliseconds, seconds, minutes, hours, days, default permanent<br>  max.commit.retry.timeout = &quot;-1&quot;<br>  max.rollback.retry.timeout = &quot;-1&quot;<br>&#125;<br><br>## transaction log store<br>store &#123;<br>  ## store mode: fileã€db<br>  mode = &quot;db&quot; #ä¿®æ”¹æ­¤å¤„å°†äº‹åŠ¡ä¿¡æ¯å­˜å‚¨åˆ°æ•°æ®åº“ä¸­<br><br>  ## database store<br>  db &#123;<br>  ## the implement of javax.sql.DataSource, such as DruidDataSource(druid)/BasicDataSource(dbcp) etc.<br>  datasource = &quot;dbcp&quot;<br>  ## mysql/oracle/h2/oceanbase etc.<br>  db-type = &quot;mysql&quot;<br>  driver-class-name = &quot;com.mysql.jdbc.Driver&quot;<br>  url = &quot;jdbc:mysql://localhost:3306/seat-server&quot; #ä¿®æ”¹æ•°æ®åº“è¿æ¥åœ°å€<br>  user = &quot;root&quot; #ä¿®æ”¹æ•°æ®åº“ç”¨æˆ·å<br>  password = &quot;root&quot; #ä¿®æ”¹æ•°æ®åº“å¯†ç <br>  min-conn = 1<br>  max-conn = 3<br>  global.table = &quot;global_table&quot;<br>  branch.table = &quot;branch_table&quot;<br>  lock-table = &quot;lock_table&quot;<br>  query-limit = 100<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>ä¿®æ”¹<code>conf</code>ç›®å½•ä¸‹çš„<code>registry.conf</code>é…ç½®æ–‡ä»¶ï¼ŒæŒ‡æ˜æ³¨å†Œä¸­å¿ƒä¸º<code>nacos</code>ï¼ŒåŠä¿®æ”¹<code>nacos</code>è¿æ¥ä¿¡æ¯å³å¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Objective-C">registry &#123;<br>  # file ã€nacos ã€eurekaã€redisã€zkã€consulã€etcd3ã€sofa<br>  type = &quot;nacos&quot; #æ”¹ä¸ºnacos<br><br>  nacos &#123;<br>  serverAddr = &quot;localhost:8848&quot; #æ”¹ä¸ºnacosçš„è¿æ¥åœ°å€<br>  namespace = &quot;&quot;<br>  cluster = &quot;default&quot;<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>å…ˆå¯åŠ¨Nacosï¼Œå†ä½¿ç”¨seata-serverä¸­<code>/bin/seata-server.bat</code>æ–‡ä»¶å¯åŠ¨seata-serverã€‚</p><h4 id="2-Javaå¦‚ä½•é›†æˆ"><a href="#2-Javaå¦‚ä½•é›†æˆ" class="headerlink" title="2. Javaå¦‚ä½•é›†æˆ"></a>2. Javaå¦‚ä½•é›†æˆ</h4><p>ä¸ºæœåŠ¡åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰äº‹åŠ¡ç»„</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>  <span class="hljs-attr">alibaba:</span><br>    <span class="hljs-attr">seata:</span><br>    <span class="hljs-attr">tx-service-group:</span> <span class="hljs-string">fsp_tx_group</span> <span class="hljs-comment">#è‡ªå®šä¹‰äº‹åŠ¡ç»„åç§°éœ€è¦ä¸seata-serverä¸­çš„å¯¹åº”</span><br><br></code></pre></td></tr></table></figure><p>å–æ¶ˆæ•°æ®æºçš„è‡ªåŠ¨åˆ›å»º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication(exclude = DataSourceAutoConfiguration.class)</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-meta">@EnableFeignClients</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeataOrderServiceApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(SeataOrderServiceApplication.class, args);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ›å»ºé…ç½®ä½¿ç”¨Seataå¯¹æ•°æ®æºåšä»£ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ä½¿ç”¨Seataå¯¹æ•°æ®æºè¿›è¡Œä»£ç†</span><br><span class="hljs-comment"> * Created by macro on 2019/11/11.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceProxyConfig</span> &#123;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;mybatis.mapperLocations&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String mapperLocations;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</span><br>    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">druidDataSource</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DruidDataSource</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DataSourceProxy <span class="hljs-title function_">dataSourceProxy</span><span class="hljs-params">(DataSource dataSource)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceProxy</span>(dataSource);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">sqlSessionFactoryBean</span><span class="hljs-params">(DataSourceProxy dataSourceProxy)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">SqlSessionFactoryBean</span> <span class="hljs-variable">sqlSessionFactoryBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBean</span>();<br>        sqlSessionFactoryBean.setDataSource(dataSourceProxy);<br>        sqlSessionFactoryBean.setMapperLocations(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PathMatchingResourcePatternResolver</span>()<br>                .getResources(mapperLocations));<br>        sqlSessionFactoryBean.setTransactionFactory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SpringManagedTransactionFactory</span>());<br>        <span class="hljs-keyword">return</span> sqlSessionFactoryBean.getObject();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Spring Cloud</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Database</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Sentinel</title>
    <link href="/2022/03/28/Spring/Sentinel/"/>
    <url>/2022/03/28/Spring/Sentinel/</url>
    
    <content type="html"><![CDATA[<blockquote><p>éšç€å¾®æœåŠ¡çš„æµè¡Œï¼ŒæœåŠ¡å’ŒæœåŠ¡ä¹‹é—´çš„ç¨³å®šæ€§å˜å¾—è¶Šæ¥è¶Šé‡è¦ã€‚ Sentinel ä»¥æµé‡ä¸ºåˆ‡å…¥ç‚¹ï¼Œä»æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤ç­‰å¤šä¸ªç»´åº¦ä¿æŠ¤æœåŠ¡çš„ç¨³å®šæ€§ã€‚</p></blockquote><h3 id="Caption"><a href="#Caption" class="headerlink" title="Caption"></a>Caption</h3><ul><li>resourceï¼šèµ„æºåç§°ï¼›</li><li>limitAppï¼šæ¥æºåº”ç”¨ï¼›</li><li>gradeï¼šé˜ˆå€¼ç±»å‹ï¼Œ0è¡¨ç¤ºçº¿ç¨‹æ•°ï¼Œ1è¡¨ç¤ºQPSï¼›</li><li>countï¼šå•æœºé˜ˆå€¼ï¼›</li><li>strategyï¼šæµæ§æ¨¡å¼ï¼Œ0è¡¨ç¤ºç›´æ¥ï¼Œ1è¡¨ç¤ºå…³è”ï¼Œ2è¡¨ç¤ºé“¾è·¯ï¼›</li><li>controlBehaviorï¼šæµæ§æ•ˆæœï¼Œ0è¡¨ç¤ºå¿«é€Ÿå¤±è´¥ï¼Œ1è¡¨ç¤ºWarm Upï¼Œ2è¡¨ç¤ºæ’é˜Ÿç­‰å¾…ï¼›</li><li>clusterModeï¼šæ˜¯å¦é›†ç¾¤ã€‚</li></ul><p>Sentinelå…·æœ‰å¦‚ä¸‹ç‰¹æ€§:</p><ul><li>ä¸°å¯Œçš„åº”ç”¨åœºæ™¯ï¼šæ‰¿æ¥äº†é˜¿é‡Œå·´å·´è¿‘ 10 å¹´çš„åŒåä¸€å¤§ä¿ƒæµé‡çš„æ ¸å¿ƒåœºæ™¯ï¼Œä¾‹å¦‚ç§’æ€ï¼Œå¯ä»¥å®æ—¶ç†”æ–­ä¸‹æ¸¸ä¸å¯ç”¨åº”ç”¨ï¼›</li><li>å®Œå¤‡çš„å®æ—¶ç›‘æ§ï¼šåŒæ—¶æä¾›å®æ—¶çš„ç›‘æ§åŠŸèƒ½ã€‚å¯ä»¥åœ¨æ§åˆ¶å°ä¸­çœ‹åˆ°æ¥å…¥åº”ç”¨çš„å•å°æœºå™¨ç§’çº§æ•°æ®ï¼Œç”šè‡³ 500 å°ä»¥ä¸‹è§„æ¨¡çš„é›†ç¾¤çš„æ±‡æ€»è¿è¡Œæƒ…å†µï¼›</li><li>å¹¿æ³›çš„å¼€æºç”Ÿæ€ï¼šæä¾›å¼€ç®±å³ç”¨çš„ä¸å…¶å®ƒå¼€æºæ¡†æ¶&#x2F;åº“çš„æ•´åˆæ¨¡å—ï¼Œä¾‹å¦‚ä¸ Spring Cloudã€Dubboã€gRPC çš„æ•´åˆï¼›</li><li>å®Œå–„çš„ SPI æ‰©å±•ç‚¹ï¼šæä¾›ç®€å•æ˜“ç”¨ã€å®Œå–„çš„ SPI æ‰©å±•ç‚¹ã€‚æ‚¨å¯ä»¥é€šè¿‡å®ç°æ‰©å±•ç‚¹ï¼Œå¿«é€Ÿçš„å®šåˆ¶é€»è¾‘ã€‚</li></ul><h3 id="å®é™…ä½¿ç”¨"><a href="#å®é™…ä½¿ç”¨" class="headerlink" title="å®é™…ä½¿ç”¨"></a>å®é™…ä½¿ç”¨</h3><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * é™æµåŠŸèƒ½</span><br><span class="hljs-comment"> * Created by macro on 2019/11/7.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/rateLimit&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RateLimitController</span> &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * æŒ‰èµ„æºåç§°é™æµï¼Œéœ€è¦æŒ‡å®šé™æµå¤„ç†é€»è¾‘</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@GetMapping(&quot;/byResource&quot;)</span><br>  <span class="hljs-meta">@SentinelResource(value = &quot;byResource&quot;,blockHandler = &quot;handleException&quot;)</span><br>  <span class="hljs-keyword">public</span> CommonResult <span class="hljs-title function_">byResource</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonResult</span>(<span class="hljs-string">&quot;æŒ‰èµ„æºåç§°é™æµ&quot;</span>, <span class="hljs-number">200</span>);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * æŒ‰URLé™æµï¼Œæœ‰é»˜è®¤çš„é™æµå¤„ç†é€»è¾‘</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@GetMapping(&quot;/byUrl&quot;)</span><br>  <span class="hljs-meta">@SentinelResource(value = &quot;byUrl&quot;,blockHandler = &quot;handleException&quot;)</span><br>  <span class="hljs-keyword">public</span> CommonResult <span class="hljs-title function_">byUrl</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonResult</span>(<span class="hljs-string">&quot;æŒ‰urlé™æµ&quot;</span>, <span class="hljs-number">200</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> CommonResult <span class="hljs-title function_">handleException</span><span class="hljs-params">(BlockException exception)</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonResult</span>(exception.getClass().getCanonicalName(),<span class="hljs-number">200</span>);<br>  &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="Nacos-å­˜å‚¨è§„åˆ™"><a href="#Nacos-å­˜å‚¨è§„åˆ™" class="headerlink" title="Nacos å­˜å‚¨è§„åˆ™"></a>Nacos å­˜å‚¨è§„åˆ™</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>  <span class="hljs-attr">sentinel:</span><br>    <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">ds1:</span><br>      <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span><br>      <span class="hljs-attr">dataId:</span> <span class="hljs-string">$&#123;spring.application.name&#125;-sentinel</span><br>      <span class="hljs-attr">groupId:</span> <span class="hljs-string">DEFAULT_GROUP</span><br>      <span class="hljs-attr">data-type:</span> <span class="hljs-string">json</span><br>      <span class="hljs-attr">rule-type:</span> <span class="hljs-string">flow</span><br><br><br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">[</span><br>  <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;resource&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/rateLimit/byUrl&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;limitApp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;default&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;grade&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;count&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;strategy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;controlBehavior&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;clusterMode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">]</span><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Spring Cloud</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Spring Security Oauth</title>
    <link href="/2022/03/28/Spring/Spring%20Security%20Oauth/"/>
    <url>/2022/03/28/Spring/Spring%20Security%20Oauth/</url>
    
    <content type="html"><![CDATA[<p><a href="/2022/03/28/Spring/Spring%20Security/">SpringÂ Security</a> æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å¯é«˜åº¦å®šåˆ¶çš„è®¤è¯å’Œæˆæƒæ¡†æ¶ï¼Œå¯¹äºSpringåº”ç”¨æ¥è¯´å®ƒæ˜¯ä¸€å¥—Webå®‰å…¨æ ‡å‡†ã€‚SpringSecurityæ³¨é‡äºä¸ºJavaåº”ç”¨æä¾›è®¤è¯å’ŒæˆæƒåŠŸèƒ½ï¼Œåƒæ‰€æœ‰çš„Springé¡¹ç›®ä¸€æ ·ï¼Œå®ƒå¯¹è‡ªå®šä¹‰éœ€æ±‚å…·æœ‰å¼ºå¤§çš„æ‰©å±•æ€§ã€‚</p><p>å¦‚æœè¦åšä¸€ä¸ªè®¤è¯ç™»å½•æ¨¡å—, é‚£ä¹ˆæˆ‘ä»¬å°±æ— æ³•ç»•è¿‡JWTçš„æ¦‚å¿µ. <strong>JWT</strong> æ˜¯å°†ç”¨æˆ·ç™»å½•ä¿¡æ¯å­˜å‚¨åœ¨äº†ç”¨æˆ·ç”µè„‘ä¸­, è€Œä¸å†æ˜¯æœåŠ¡å™¨é‡Œ. å¦‚æœé¡¹ç›®ä¸­ç”¨æˆ·é‡åºå¤§. å¹¶ä¸”åˆ†ä¸ºç”µè„‘ç«¯å’Œç§»åŠ¨ç«¯. é‚£ä¹ˆ JWT æ˜¯å¿…ä¸å¯å°‘çš„.</p><p>ä½†æ˜¯åœ¨ä¼ä¸šçº§é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬æ›´å€¾å‘äº<a href="/2022/03/28/Distributed%20System/Oauth2/">Oauth2</a>çš„ä½¿ç”¨ã€‚ä»–ä¿è¯äº†æˆ‘ä»¬å†…éƒ¨ç³»ç»Ÿçš„ç™»é™†è®¤è¯ï¼Œä¹Ÿä¿è¯äº†å¤–éƒ¨ç³»ç»Ÿçš„è®¿é—®æ§åˆ¶ã€‚</p><h2 id="æˆæƒæ¨¡å¼"><a href="#æˆæƒæ¨¡å¼" class="headerlink" title="æˆæƒæ¨¡å¼"></a><strong>æˆæƒæ¨¡å¼</strong></h2><h3 id="Authorization-Mode"><a href="#Authorization-Mode" class="headerlink" title="Authorization Mode"></a>Authorization Mode</h3><hr><ul><li><strong>Authorization Code</strong><a href="/2022/03/28/Distributed%20System/Oauth2/#æˆæƒç ">æˆæƒç </a>ï¼šæ­£å®—çš„OAuth2çš„æˆæƒæ¨¡å¼ï¼Œå®¢æˆ·ç«¯å…ˆå°†ç”¨æˆ·å¯¼å‘è®¤è¯æœåŠ¡å™¨ï¼Œç™»å½•åè·å–æˆæƒç ï¼Œç„¶åè¿›è¡Œæˆæƒï¼Œæœ€åæ ¹æ®æˆæƒç è·å–è®¿é—®ä»¤ç‰Œï¼›</li><li>Implicit (éšå¼æˆæƒæ¨¡å¼) ï¼šé€‚ç”¨äºæ— åº”ç”¨æœåŠ¡å™¨çš„é¡¹ç›®ï¼Œå’Œæˆæƒç æ¨¡å¼ç›¸æ¯”ï¼Œå–æ¶ˆäº†è·å–æˆæƒç çš„è¿‡ç¨‹ï¼Œç›´æ¥è·å–è®¿é—®ä»¤ç‰Œï¼›</li><li>**Resource Owner Password Credentials<a href="/2022/03/28/Distributed%20System/Oauth2/#å¯†ç å¼">å¯†ç å¼</a>ï¼šå®¢æˆ·ç«¯ç›´æ¥å‘ç”¨æˆ·è·å–ç”¨æˆ·åå’Œå¯†ç ï¼Œä¹‹åå‘è®¤è¯æœåŠ¡å™¨è·å–è®¿é—®ä»¤ç‰Œï¼›</li><li>Client Credentials (å®¢æˆ·ç«¯æ¨¡å¼) ï¼šå®¢æˆ·ç«¯ç›´æ¥é€šè¿‡å®¢æˆ·ç«¯è®¤è¯ (æ¯”å¦‚client_idå’Œclient_secret) ä»è®¤è¯æœåŠ¡å™¨è·å–è®¿é—®ä»¤ç‰Œã€‚</li></ul><h2 id="æˆæƒæœåŠ¡é…ç½®é€‚é…å™¨"><a href="#æˆæƒæœåŠ¡é…ç½®é€‚é…å™¨" class="headerlink" title="æˆæƒæœåŠ¡é…ç½®é€‚é…å™¨"></a><strong>æˆæƒæœåŠ¡é…ç½®é€‚é…å™¨</strong></h2><h3 id="AuthorizationServerConfigurerAdapter"><a href="#AuthorizationServerConfigurerAdapter" class="headerlink" title="AuthorizationServerConfigurerAdapter"></a>AuthorizationServerConfigurerAdapter</h3><hr><ul><li>configure(ClientDetailsServiceConfigurer clients): é…ç½®å®¢æˆ·ç«¯çš„æˆæƒæ¨¡å¼ , å®¢æˆ·ç«¯ID , æƒé™èŒƒå›´ , æƒé™ç±»å‹ , tokenæœ‰æ•ˆæœŸç­‰.</li><li>configure(AuthorizationServerEndpointsConfigurer endpoints): é…ç½®å…·ä½“çš„æˆæƒæ¨¡å¼è§„åˆ™ , å¦‚JWT å¯†ç æ¨¡å¼</li></ul><h2 id="è¿‡æ»¤å™¨é“¾"><a href="#è¿‡æ»¤å™¨é“¾" class="headerlink" title="è¿‡æ»¤å™¨é“¾"></a><strong>è¿‡æ»¤å™¨é“¾</strong></h2><h3 id="WebSecurityConfigurerAdapter-ResourceServerConfigurerAdapter"><a href="#WebSecurityConfigurerAdapter-ResourceServerConfigurerAdapter" class="headerlink" title="WebSecurityConfigurerAdapter(ResourceServerConfigurerAdapter)"></a>WebSecurityConfigurerAdapter(ResourceServerConfigurerAdapter)</h3><hr><ul><li>WebSecurityConfigurerAdapter æ˜¯ Spring securityé»˜è®¤æƒ…å†µä¸‹çš„httpé…ç½®ï¼Œè€Œ ResourceServerConfigurerAdapter æ˜¯Spring security oauth2 é»˜è®¤æƒ…å†µä¸‹çš„httpé…ç½®ã€‚ResourceServerConfigurerAdapter çš„ä¼˜å…ˆçº§æ›´é«˜ä¸€äº›</li><li><strong>åŒæ ·çš„èµ„æºåœ°å€ï¼Œåªä¼šåœ¨ä¼˜å…ˆçº§æœ€é«˜çš„ ResourceServerConfigurerAdapter ä¸­ç”Ÿæ•ˆï¼Œå¦‚æœ WebSecurityConfigurerAdapter ä¹Ÿé…ç½®äº†è¿™ä¸ªèµ„æºåœ°å€ï¼Œåˆ™ä¸ä¼šç”Ÿæ•ˆ</strong><ul><li>configure(HttpSecurity httpSecurity)ï¼šç”¨äºé…ç½®éœ€è¦æ‹¦æˆªçš„urlè·¯å¾„ã€jwtè¿‡æ»¤å™¨åŠå‡ºå¼‚å¸¸åçš„å¤„ç†å™¨ï¼›</li><li>configure(AuthenticationManagerBuilder auth)ï¼šç”¨äºé…ç½®UserDetailsServiceåŠPasswordEncoderï¼›</li><li>RestfulAccessDeniedHandler ï¼šå½“ç”¨æˆ·æ²¡æœ‰è®¿é—®æƒé™æ—¶çš„å¤„ç†å™¨ï¼Œç”¨äºè¿”å›JSONæ ¼å¼çš„å¤„ç†ç»“æœ</li><li>RestAuthenticationEntryPoint ï¼šå½“æœªç™»å½•æˆ–tokenå¤±æ•ˆæ—¶ï¼Œè¿”å›JSONæ ¼å¼çš„ç»“æœ</li><li>UserDetailsService:SpringSecurityå®šä¹‰çš„æ ¸å¿ƒæ¥å£ï¼Œç”¨äºæ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ·ä¿¡æ¯ï¼Œéœ€è¦è‡ªè¡Œå®ç°ï¼›</li><li>UserDetailsï¼šSpringSecurityå®šä¹‰ç”¨äºå°è£…ç”¨æˆ·ä¿¡æ¯çš„ç±»ï¼ˆä¸»è¦æ˜¯ç”¨æˆ·ä¿¡æ¯å’Œæƒé™ï¼‰ï¼Œéœ€è¦è‡ªè¡Œå®ç°ï¼›</li><li>PasswordEncoderï¼šSpringSecurityå®šä¹‰çš„ç”¨äºå¯¹å¯†ç è¿›è¡Œç¼–ç åŠæ¯”å¯¹çš„æ¥å£ï¼Œç›®å‰ä½¿ç”¨çš„æ˜¯BCryptPasswordEncoderï¼›</li><li>JwtAuthenticationTokenFilterï¼šåœ¨ç”¨æˆ·åå’Œå¯†ç æ ¡éªŒå‰æ·»åŠ çš„è¿‡æ»¤å™¨ï¼Œå¦‚æœæœ‰jwtçš„tokenï¼Œä¼šè‡ªè¡Œæ ¹æ®tokenä¿¡æ¯è¿›è¡Œç™»å½•ã€‚</li></ul></li></ul><h2 id="è¿‡æ»¤é“¾"><a href="#è¿‡æ»¤é“¾" class="headerlink" title="è¿‡æ»¤é“¾"></a><strong>è¿‡æ»¤é“¾</strong></h2><h3 id="SecurityWebFilterChain"><a href="#SecurityWebFilterChain" class="headerlink" title="SecurityWebFilterChain"></a>SecurityWebFilterChain</h3><hr><ul><li>SpringSecurityFilterChain ä½œä¸º SpringSecurity çš„æ ¸å¿ƒè¿‡æ»¤å™¨é“¾åœ¨æ•´ä¸ªè®¤è¯æˆæƒè¿‡ç¨‹ä¸­èµ·ç€ä¸¾è¶³è½»é‡çš„åœ°ä½ï¼Œæ¯ä¸ªè¯·æ±‚åˆ°æ¥ï¼Œéƒ½ä¼šç»è¿‡è¯¥è¿‡æ»¤å™¨é“¾</li><li>å¦‚æœä½ æƒ³è‡ªå·±å®ç°æ¯ä¸€ä¸ªè‡ªå®šä¹‰çš„æœªæˆæƒ , æœªè®¤è¯ , ç™½åå•ç­‰ç­–ç•¥ , å¯ä»¥å®šåˆ¶è¯¥è¿‡æ»¤å™¨é“¾</li></ul><h2 id="æˆæƒç®¡ç†å™¨"><a href="#æˆæƒç®¡ç†å™¨" class="headerlink" title="æˆæƒç®¡ç†å™¨"></a><strong>æˆæƒç®¡ç†å™¨</strong></h2><h3 id="ReactiveAuthorizationManager"><a href="#ReactiveAuthorizationManager" class="headerlink" title="ReactiveAuthorizationManager"></a>ReactiveAuthorizationManager</h3><hr><ul><li>WebFluxæˆæƒç®¡ç†å™¨ , å¯ä»¥å½“æˆæ˜¯æ‹¦æˆªå™¨çš„ä¸€ç§ , é‡å†™æ–¹æ³•å¯¹æˆæƒåšè‡ªå®šä¹‰å¤„ç† , æ¯”å¦‚ç™½åå• , è·¨åŸŸç­‰.</li><li><strong>å› ä¸ºSpring Cloud Gatewayä½¿ç”¨æ˜¯åŸºäºWebFluxä¸Nettyå¼€å‘çš„ï¼Œæ‰€ä»¥ä¸ä¼ ç»Ÿçš„Servletæ–¹å¼ä¸åŒ</strong></li></ul><h2 id="å¯†ç å¼ç™»é™†"><a href="#å¯†ç å¼ç™»é™†" class="headerlink" title="å¯†ç å¼ç™»é™†"></a>å¯†ç å¼ç™»é™†</h2><p>Tokenç›¸å…³çš„æ¥å£éƒ½åº”è¯¥é‡‡ç”¨Basic base64çš„è¯·æ±‚å¤´ï¼Œä¸šåŠ¡ç›¸å…³çš„æ¥å£éƒ½åº”è¯¥é‡‡ç”¨Bearer tokençš„è¯·æ±‚å¤´</p><h3 id="è®¤è¯é€»è¾‘"><a href="#è®¤è¯é€»è¾‘" class="headerlink" title="è®¤è¯é€»è¾‘"></a><strong>è®¤è¯é€»è¾‘</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></div></td><td class="code"><pre><code class="hljs Java">**# åœ¨å®é™…çš„å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¸ä¸€å®šéœ€è¦Basicçš„æ–¹å¼æ¥å¯¹clientè¿›è¡Œè§£å¯†éªŒè¯æ–¹å¼ï¼Œè¿™åªæ˜¯pigè‡ªå·±çš„æ–¹å¼ã€‚ä½†æ˜¯çš„ç¡®è›®å¥½ç”¨**<br>**# è¯·æ±‚å¤´æ˜¯Authorization=Basic base64.encode(client_id:client_secret) **<br><br><span class="hljs-comment">// ç”¨æˆ·å¡«å†™è´¦æˆ·å¯†ç ï¼Œå‘é€ç™»å½•è¯·æ±‚ï¼Œåå°ç™»å½• API ä¸»åŠ¨å‘èµ·è·å–/oauth/tokençš„è¯·æ±‚ã€‚</span><br><br><span class="hljs-comment">// æˆ‘ä»¬å¯ä»¥åœ¨ä¸­é—´åŠ å…¥ç½‘å…³æ‹¦æˆªï¼ŒéªŒè¯base64çš„è§£å¯†åæ ¼å¼æ˜¯å¦æ­£ç¡®</span><br>ValidateCodeGatewayFilter.apply()<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* è¿‡æ»¤å™¨æ‹¦ä½Basicè¯·æ±‚</span><br><span class="hljs-comment">* Springè®©ä»–é»˜è®¤æ‹¦æˆª/oauth/token</span><br><span class="hljs-comment">*/</span><br>BasicAuthenticationFilter&#123;<br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">// æ‰€ä»¥å†è¿›å…¥BasicAuthenticationFilterè¿‡æ»¤å™¨ä¸­ï¼Œå°†client_idä¸client_secretè§£æï¼Œå˜æˆUsernamePasswordAuthenticationTokenå¯¹è±¡</span><br>    <span class="hljs-type">UsernamePasswordAuthenticationToken</span> <span class="hljs-variable">authRequest</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.authenticationConverter.convert(request);<br>    <br>    <span class="hljs-comment">// å†é€šè¿‡ä¸€ç³»åˆ—è°ƒç”¨å»æ‰¾æ•°æ®åº“å­˜çš„å®¢æˆ·ç«¯ä¿¡æ¯å’Œä¼ å…¥çš„å®¢æˆ·ç«¯ä¿¡æ¯æ¯”è¾ƒï¼Œå¦‚æœclient_idæˆ–client_secretæ˜¯é”™çš„ï¼Œå°±æŠ¥é”™ã€‚</span><br>    <span class="hljs-type">Authentication</span> <span class="hljs-variable">authResult</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.authenticationManager.authenticate(authRequest);<br>    <br>    ProviderManager.authenticate()<br>    â†’AbstractUserDetailsAuthenticationProvider.authenticate()<br>    â†’AbstractUserDetailsAuthenticationProvider.retrieveUser()<br>    â†’DaoAuthenticationProvider.retrieveUser()<br>    â†’ClientDetailsUserDetailsService.loadUserByUsername()<br>    â†’é…ç½®çš„PigClientDetailsService.loadClientByClientId()<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* ä¸“é—¨æ‹¦æˆª/oauth/tokenè¯·æ±‚</span><br><span class="hljs-comment">*/</span><br>ClientCredentialsTokenEndpointFilter <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractAuthenticationProcessingFilter</span>&#123;<br>  <br>  Authentication <span class="hljs-title function_">attemptAuthentication</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">// æ ¹æ®clientIdå’ŒclientSecretæœ€ç»ˆä¼šå»æŸ¥è¯¢clientä¿¡æ¯</span><br>    <span class="hljs-built_in">this</span>.getAuthenticationManager().authenticate(authRequest);<br>    -&gt; DaoAuthenticationProvider.retrieveUser()<br>    -&gt; ClientDetailsUserDetailsService.loadUserByUsername();<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* oauth2.0 tokenè¯·æ±‚æ¥å£</span><br><span class="hljs-comment">*/</span><br>TokenEndPoint&#123;<br>  ResponseEntity&lt;OAuth2AccessToken&gt; <span class="hljs-title function_">postAccessToken</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">// è·å–clientä¿¡æ¯ï¼ŒéªŒè¯è¯·æ±‚ï¼Œæˆæƒç å’Œå¯†ç å¼éƒ½ä¼šè¿›æ¥</span><br>    <br>    <span class="hljs-comment">// åšä¸€äº›éªŒè¯æ“ä½œï¼Œå†…éƒ¨ä¼šå¼€å§‹åˆ›å»ºOAuth2AccessTokenå¯¹è±¡</span><br>    <span class="hljs-type">OAuth2AccessToken</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> getTokenGranter().grant(tokenRequest.getGrantType(), tokenRequest);<br>    <br>    AbstractTokenGranter&#123;<br>      OAuth2AccessToken <span class="hljs-title function_">grant</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">// é€šè¿‡ DefaultTokenServices.createAccessToken() ä»tokenStoreç¼“å­˜å®ç°PigCustomTokenServicesç±»ä¸­åˆ›å»ºOAuth2AccessTokenå¯¹è±¡ï¼Œè¿˜å¯ä»¥ç”¨å¢å¼ºå™¨tokenEnhanceråŠ å…¥é™„åŠ ä¿¡æ¯ï¼Œæ¯”å¦‚ç”¨æˆ·å¯¹è±¡ã€‚</span><br>        <span class="hljs-comment">// å­˜å…¥ç¼“å­˜ï¼Œè¿”å›å¯¹è±¡</span><br>        tokenServices.createAccessToken(getOAuth2Authentication(client, tokenRequest))<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">// ä¸€ç³»åˆ—æ“ä½œç»“æŸåï¼Œè¿”å›ç»™è¯·æ±‚æ–¹tokenå¯¹è±¡</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ­£å¸¸è®¿é—®"><a href="#æ­£å¸¸è®¿é—®" class="headerlink" title="æ­£å¸¸è®¿é—®"></a><strong>æ­£å¸¸è®¿é—®</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs Java">**# è¯·æ±‚å¤´éœ€è¦åŠ å…¥Authorization=Bearer tokençš„æ¨¡å¼ä¾›æœåŠ¡ç«¯éªŒè¯**<br><br>*<span class="hljs-comment">// ç½‘å…³ä¸åšé‰´æƒæ‹¦æˆªï¼Œåªè½¬å‘ï¼Œå…·ä½“çš„é‰´æƒæ“ä½œäº¤ç”±å¯¹åº”çš„ä¸šåŠ¡å¾®æœåŠ¡å¤„ç†ã€‚åªè¦å¼•å…¥Securityä¾èµ–ï¼Œå¹¶è¯»å–Redisä¸­çš„Tokenå³å¯*</span><br><br>*<span class="hljs-comment">// åŒºåˆ«äºAuthå¾®æœåŠ¡çš„AuthorizationServerTokenServices(PigCustomTokenServices)</span><br><span class="hljs-comment">// æˆ‘ä»¬éœ€è¦ä¸€ä¸ªé€šç”¨çš„ResourceServerTokenServicesï¼ˆPigLocalResourceServerTokenServicesï¼‰æ¥å¤„ç†å½“å‰ä¸šåŠ¡å¾®æœåŠ¡çš„ä»¤ç‰Œè®¤è¯é—®é¢˜*</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* è¯·æ±‚è¢«æ‹¦æˆªï¼Œå¼€å§‹æ ¡éªŒå¹¶è½¬æ¢æˆè®¤è¯å¯¹è±¡ï¼Œç»™è°ƒç”¨é“¾ä½¿ç”¨</span><br><span class="hljs-comment">* feignè°ƒç”¨ä¹Ÿè¿›æ¥è¿™ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨feignè°ƒç”¨çš„æ—¶å€™ï¼ŒæŠŠè¯·æ±‚å¤´å¸¦ä¸Š</span><br><span class="hljs-comment">*/</span><br>OAuth2AuthenticationProcessingFilter&#123;<br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">// ä»å½“å‰çº¿ç¨‹ä¸­æŠ½å–è¯·æ±‚å¤´çš„Tokenå€¼</span><br>    <span class="hljs-comment">// è¿™ä¸€æ­¥åœ¨feignè°ƒç”¨çš„æ—¶å€™å¾ˆæ­£å¸¸ï¼Œç”¨äºtokenä¼ é€’</span><br>    <span class="hljs-type">Authentication</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> tokenExtractor.extract(request);<br>    <span class="hljs-keyword">if</span> (authentication == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// è¾“å‡ºç‚¹æ—¥å¿—</span><br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// å¾ˆé•¿çš„è°ƒç”¨ï¼Œä¸»è¦æ˜¯é€šè¿‡tokenè·å–è®¤è¯å¯¹è±¡</span><br>      <span class="hljs-type">Authentication</span> <span class="hljs-variable">authResult</span> <span class="hljs-operator">=</span> authenticationManager.authenticate(authentication);<br>      -&gt; OAuth2AuthenticationManager.authenticate(authentication)<br>      -&gt; ResourceServerTokenServices.loadAuthentication(accessToken)<br>      -&gt; PigLocalResourceServerTokenServices(è‡ªå®šä¹‰).loadAuthentication(accessToken)<br>      <br>      <span class="hljs-comment">// å­˜å…¥çº¿ç¨‹</span><br>      SecurityContextHolder.getContext().setAuthentication(authResult);<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* æƒé™æ‹¦æˆªå™¨,æ–¹æ³•å‰æ‹¦æˆª</span><br><span class="hljs-comment">*/</span><br>FilterSecurityInterceptor <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractSecurityInterceptor</span>&#123;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Tokenç»­æœŸ"><a href="#Tokenç»­æœŸ" class="headerlink" title="Tokenç»­æœŸ"></a>Tokenç»­æœŸ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java">**# å‰ç«¯å¯ä»¥å®šæ—¶è°ƒç”¨/oauth/check_tokenç«¯ç‚¹æ£€æµ‹Tokenæ˜¯å¦å¤±æ•ˆè¿‡æœŸ**<br><br>CheckTokenEndpoint&#123;<br>  checkToken(<span class="hljs-meta">@RequestParam(&quot;token&quot;)</span> String value) &#123;<br>    resourceServerTokenServices.loadAuthentication(token.getValue());<br>  &#125;<br>&#125;<br><br>**# è‹¥å³å°†å¤±æ•ˆï¼Œåˆ™åˆ·æ–°ä»¤ç‰Œ/oauth/token?grant_type=refresh_token**<br>**# å¦‚æœæƒ³è¦ç”¨æˆ·è¯·æ±‚æ—¶å¯¹ä»¤ç‰Œç»­æœŸï¼Œéœ€è¦åœ¨tokenServices#loadAuthenticationä¸­è¿›è¡Œé‡å†™**<br>TokenEndPoint&#123;<br>  ResponseEntity&lt;OAuth2AccessToken&gt; <span class="hljs-title function_">postAccessToken</span><span class="hljs-params">()</span>&#123;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="æˆæƒç ç™»é™†"><a href="#æˆæƒç ç™»é™†" class="headerlink" title="æˆæƒç ç™»é™†"></a>æˆæƒç ç™»é™†</h2><h3 id="è®¤è¯é€»è¾‘-1"><a href="#è®¤è¯é€»è¾‘-1" class="headerlink" title="è®¤è¯é€»è¾‘"></a><strong>è®¤è¯é€»è¾‘</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs Java">**# å¦‚æœæ˜¯å†…éƒ¨å¹³å°åšOauth2çš„é€»è¾‘ï¼Œé‚£å°±å…ˆç™»é™†ï¼Œå†è·³è½¬åˆ°authorizeæ¥å£**<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* æˆæƒç æ¨¡å¼ä¸“ç”¨æˆæƒè¯·æ±‚</span><br><span class="hljs-comment">* oauth/authorize?</span><br><span class="hljs-comment">* response_type=code&amp;</span><br><span class="hljs-comment">* client_id=CLIENT_ID&amp;</span><br><span class="hljs-comment">* redirect_uri=CALLBACK_URL&amp;</span><br><span class="hljs-comment">* scope=read</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-meta">@SessionAttributes</span><br>AuthorizationEndpoint&#123;<br>  <span class="hljs-comment">// æœ€ç»ˆè¿”å›confirmé¡µé¢ï¼Œä¾›ç”¨äºç¡®è®¤æˆæƒ</span><br>  <span class="hljs-comment">// å¯ä»¥è‡ªå®šä¹‰è¯¥é¡µé¢</span><br>  ModelAndView <span class="hljs-title function_">authorize</span><span class="hljs-params">(Principal principal)</span>&#123;<br>    <span class="hljs-comment">// å› ä¸ºç±»åŠ å…¥äº†Sessionæ³¨è§£ï¼Œæ‰€ä»¥å°†modelå†…å®¹å­˜å‚¨åœ¨äº†Sessionä¸­</span><br>    <span class="hljs-comment">// åç»­confirmé¡µé¢æäº¤æ—¶ï¼Œä¹Ÿä¼šæ‹¿åˆ°è¿™æ¬¡çš„å†…å®¹</span><br>    <span class="hljs-comment">// å¦‚æœrediså·²ç»å­˜åœ¨è¯¥clientId+userNameçš„keyï¼Œåˆ™çœç•¥confirmç¡®è®¤ï¼Œç›´æ¥è¿”å›é‡å®šå‘</span><br>  &#125;<br>&#125;<br><br>**# å¦‚æœæ˜¯ç¬¬ä¸‰æ–¹è°ƒç”¨çš„è¯ï¼Œä¼šåœ¨è®¿é—®authorizeæ¥å£çš„æ—¶å€™ï¼Œå› æœªç™»å½•è¢«æ‹¦æˆªå™¨é‡å®šå‘åˆ°ç™»é™†é¡µé¢ï¼Œå…ˆç™»é™†ï¼Œç„¶åå†è¿”å›åˆ°authorizeæ¥å£**<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* confirmé¡µé¢è¯·æ±‚é€šè¿‡ï¼Œå¹¶æºå¸¦äº†**user_oauth_approval**å‚æ•°</span><br><span class="hljs-comment">*/</span><br>AuthorizationEndpoint&#123;<br>  <span class="hljs-comment">// æœ€ç»ˆè¿”å›é‡å®šå‘åœ°å€ï¼Œå¹¶æ‹¼æ¥codeå‚æ•°ä¼ å›</span><br>  View <span class="hljs-title function_">approveOrDeny</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> Map&lt;String, String&gt; approvalParameters, Map&lt;String, ?&gt; model, Principal principal)</span>&#123;<br>    <span class="hljs-comment">// è·å–ä»authorizeæ–¹æ³•å­˜å‚¨è¿›sessionçš„å†…å®¹</span><br>    <span class="hljs-comment">// è¿›è¡Œä¸€ç³»åˆ—éªŒè¯åï¼Œè¿”å›é‡å®šå‘åœ°å€+code</span><br>    <span class="hljs-comment">// codeé»˜è®¤æ”¾è¿›ConcurrentHashMapé‡Œé¢ï¼Œåªè¦ä¸ç”¨ï¼Œå°±ä¼šä¸€ç›´å­˜åœ¨</span><br>  &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* ä¸“é—¨æ‹¦æˆª/oauth/tokenè¯·æ±‚</span><br><span class="hljs-comment">*/</span><br>ClientCredentialsTokenEndpointFilter <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractAuthenticationProcessingFilter</span>&#123;<br>  <br>  Authentication <span class="hljs-title function_">attemptAuthentication</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">// æ ¹æ®clientIdå’ŒclientSecretæœ€ç»ˆä¼šå»æŸ¥è¯¢clientä¿¡æ¯</span><br>    <span class="hljs-built_in">this</span>.getAuthenticationManager().authenticate(authRequest);<br>    -&gt; DaoAuthenticationProvider.retrieveUser()<br>    -&gt; ClientDetailsUserDetailsService.loadUserByUsername(username);<br>    -&gt; ClientDetailsService.loadClientByClientId(username);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* oauth/token?</span><br><span class="hljs-comment">* client_id=CLIENT_ID&amp;</span><br><span class="hljs-comment">* client_secret=CLIENT_SECRET&amp;</span><br><span class="hljs-comment">* grant_type=authorization_code&amp;</span><br><span class="hljs-comment">* code=AUTHORIZATION_CODE&amp;</span><br><span class="hljs-comment">* redirect_uri=CALLBACK_URL</span><br><span class="hljs-comment">*/</span><br>TokenEndPoint&#123;<br><br>  ResponseEntity&lt;OAuth2AccessToken&gt; <span class="hljs-title function_">postAccessToken</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">OAuth2AccessToken</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> getTokenGranter().grant(tokenRequest.getGrantType(), tokenRequest);<br>    -&gt; AuthorizationServerEndpointsConfigurer.grant()<br>    -&gt; CompositeTokenGranter.grant()<br>    <span class="hljs-comment">// åˆ é™¤ä¹‹å‰çš„codeå¹¶è¿”å›å¯¹åº”çš„è®¤è¯å¯¹è±¡ï¼Œä¸tokenå€¼ç»‘å®š</span><br>    -&gt; AuthorizationCodeTokenGranter.grant().getOAuth2Authentication(client, tokenRequest)<br>    <span class="hljs-comment">// ä»¤ç‰Œå¢å¼ºå™¨ä¹Ÿåœ¨è¿™</span><br>    -&gt; PigCustomTokenServices.createAccessToken(oAuth2Authentication)<br>    <span class="hljs-comment">// ä¸€ç³»åˆ—æ“ä½œç»“æŸåï¼Œè¿”å›ç»™è¯·æ±‚æ–¹tokenå¯¹è±¡</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ­£å¸¸è®¿é—®-1"><a href="#æ­£å¸¸è®¿é—®-1" class="headerlink" title="æ­£å¸¸è®¿é—®"></a>æ­£å¸¸è®¿é—®</h3><p>ä¸å¯†ç å¼ç›¸åŒ</p><h3 id="Tokenå¤±æ•ˆ"><a href="#Tokenå¤±æ•ˆ" class="headerlink" title="Tokenå¤±æ•ˆ"></a>Tokenå¤±æ•ˆ</h3><p>ä¸å¯†ç å¼ç›¸åŒ</p><hr><h2 id="SSO"><a href="#SSO" class="headerlink" title="SSO"></a>SSO</h2><p><a href="/2022/03/28/Distributed%20System/SSO%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/">SSOå•ç‚¹ç™»å½•</a></p><p>ä»¥Pigé¡¹ç›®ä¸ºä¾‹ï¼ŒAuthæœåŠ¡é…ç½®äº†ã€ŒSpring Securityã€ã€ŒSpring Security Oauth2å¯†ç æ¨¡å¼ã€ã€ŒSpring Security Oauth2æˆæƒç æ¨¡å¼ã€ä¸‰ç§è®¤è¯æ–¹å¼ã€‚</p><p>ç®€å•çš„Spring Securityé…ç½®æ˜¯ä¸ºäº†åœ¨SSOå•ç‚¹ç™»å½•æ—¶ä¸Sessionç»“åˆï¼Œè®©Oauth2æˆæƒç æ¨¡å¼èƒ½å¤Ÿè®°ä½ç™»å½•çŠ¶æ€ã€‚</p><p>Spring Security Oauth2å¯†ç æ¨¡å¼æ˜¯ä¸ºäº†ç»™é¡¹ç›®å†…å¾®æœåŠ¡è®¤è¯ä½¿ç”¨ã€‚</p><hr><h2 id="æ‹“å±•ç›¸å…³ğŸŒŸğŸŒŸ"><a href="#æ‹“å±•ç›¸å…³ğŸŒŸğŸŒŸ" class="headerlink" title="æ‹“å±•ç›¸å…³ğŸŒŸğŸŒŸ"></a>æ‹“å±•ç›¸å…³ğŸŒŸğŸŒŸ</h2><h3 id="BearerTokenExtractor"><a href="#BearerTokenExtractor" class="headerlink" title="BearerTokenExtractor"></a>BearerTokenExtractor</h3><p>è¯¥ç±»æ˜¯é€šè¿‡<code>OAuth2AuthenticationProcessingFilter</code>è¿‡æ»¤å™¨é»˜è®¤è°ƒç”¨ï¼Œä¸“é—¨å¤„ç†ç”¨æˆ·è®¿é—®è¯·æ±‚ï¼Œå‰¥ç¦»Headerä¸­çš„<code>access_token</code>æ¥ç¡®è®¤ç”¨æˆ·ä»¤ç‰Œã€‚æˆ‘ä»¬å¯ä»¥å®ç°è¯¥ç±»ï¼Œé‡‡ç”¨åˆ«çš„åç§°æ¥æ›¿æ¢<code>access_token</code>ã€‚æ¯”å¦‚æ˜é‡‘çš„å°±æ˜¯<code>X-Legacy-Token</code>è€Œéå¿…é¡»æ˜¯ <code>Authorization</code></p><p>ä¹Ÿå¯ä»¥å‚è€ƒpigé¡¹ç›®ï¼Œå¢åŠ æ³¨è§£AOPå®ç°ï¼Œå¯¹éƒ¨åˆ†æ¥å£å®ç°ç™½åå•ç­–ç•¥ï¼Œåˆ†åˆ«è§£å†³å¤–éƒ¨è®¿é—®ä»¥åŠfeignè°ƒç”¨çš„é—®é¢˜ã€‚</p><p>Inneræ³¨è§£çš„ä½¿ç”¨ <a href="https://www.yuque.com/pig4cloud/pig/hz5ppn">https://www.yuque.com/pig4cloud/pig/hz5ppn</a></p><h3 id="OAuth2FeignRequestInterceptor"><a href="#OAuth2FeignRequestInterceptor" class="headerlink" title="OAuth2FeignRequestInterceptor"></a>OAuth2FeignRequestInterceptor</h3><p>æ˜¯ä¸ºäº†è§£å†³SpringæœåŠ¡ä¸­Feignè°ƒç”¨æ—¶ï¼Œæ— æ³•å°†Tokené€šè¿‡Headerä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡çš„é—®é¢˜ã€‚</p><p>è¯¥ç±»éœ€è¦ç¨‹åºå‘˜å®ç°å­ç±»ï¼Œåœ¨Feignè°ƒç”¨å‰ä»çº¿ç¨‹ä¸­è·å–authenticationå¯¹è±¡å¹¶ä¼ é€’ç»™çˆ¶ç±»åšå†…éƒ¨æŒæœ‰ã€‚ä¸»è¦æ–¹æ³•æ˜¯<code>accessTokenContextRelay.copyToken()</code>ã€‚</p><p>ç„¶å<code>OAuth2FeignRequestInterceptor</code>ä¼šæ ¹æ®å†…éƒ¨æŒæœ‰çš„å¯¹è±¡å¯¹ä¸‹æ¸¸æœåŠ¡å‘èµ·æºå¸¦Headerçš„è¯·æ±‚ã€‚ä¸‹æ¸¸æœåŠ¡å¯ä»¥ä»Headerä¸­è·å–Tokenå€¼ï¼Œå¹¶è½¬æ¢ä¸ºauthenticationå¯¹è±¡ã€‚</p><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p>Oauth2.0çš„æ•°æ®åº“è¯´æ˜ <a href="https://andaily.com/spring-oauth-server/db_table_description.html">https://andaily.com/spring-oauth-server/db_table_description.html</a></p><p>Spring Oauthæµç¨‹è¯´æ˜ <a href="https://www.yuque.com/pig4cloud/pig/dqnyuc">https://www.yuque.com/pig4cloud/pig/dqnyuc</a></p><p>åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹çš„è®¤è¯ä¸æˆæƒ <a href="https://www.bmpi.dev/dev/authentication-and-authorization-in-a-distributed-system/">https://www.bmpi.dev/dev/authentication-and-authorization-in-a-distributed-system/</a></p><hr>]]></content>
    
    
    <categories>
      
      <category>Spring Cloud</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Shiro</title>
    <link href="/2022/03/28/Spring/Shiro/"/>
    <url>/2022/03/28/Spring/Shiro/</url>
    
    <content type="html"><![CDATA[<table><thead><tr><th>è¿‡æ»¤å™¨ç®€ç§°</th><th>ç›¸å¯¹åº”çš„javaç±»</th></tr></thead><tbody><tr><td>anon</td><td>org.apache.shiro.web.filter.authc.AnonymousFilter</td></tr><tr><td>user</td><td>org.apache.shiro.web.filter.authc.UserFilter</td></tr><tr><td>logout</td><td>org.apache.shiro.web.filter.authc.LogoutFilter</td></tr><tr><td>perms</td><td>org.apache.shiro.web.filter.authz.PermissionsAuthorizationFilter</td></tr><tr><td>authc</td><td>org.apache.shiro.web.filter.authc.FormAuthenticationFilter</td></tr><tr><td>authcBasic</td><td>org.apache.shiro.web.filter.authc.BasicHttpAuthenticationFilter</td></tr><tr><td>port</td><td>org.apache.shiro.web.filter.authz.PortFilter</td></tr><tr><td>rest</td><td>org.apache.shiro.web.filter.authz.HttpMethodPermissionFilter</td></tr><tr><td>roles</td><td>org.apache.shiro.web.filter.authz.RolesAuthorizationFilter</td></tr><tr><td>ssl</td><td>org.apache.shiro.web.filter.authz.SslFilter</td></tr></tbody></table><h2 id="è®¤è¯"><a href="#è®¤è¯" class="headerlink" title="è®¤è¯"></a>è®¤è¯</h2><h3 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h3><p>ä»**<code>AbstractShiroFilter</code>**<code>#doFilterInternal</code>è¿›å…¥</p><p><code>DefaultSecurityManager #createSubject</code> è´Ÿè´£è¿”å›ä¸€ä¸ªSubject</p><p>å†…éƒ¨çš„<code>#resolveSession</code>æ–¹æ³•æ˜¯è·å–Sessionä¿¡æ¯, ä¸»è¦èµ°SessionDaoæ–¹æ³•è·å–, å¯ä»ç¼“å­˜æˆ–æ•°æ®åº“è¯»å–, é»˜è®¤èµ°<code>AbstractSessionDao</code>ç±», æ‰€ä»¥ä»ç¼“å­˜èµ°</p><p>å†…éƒ¨çš„<code>#resolvePrincipals</code>ä¸­ä»Sessionè·å–principalsä¿¡æ¯, å¹¶åœ¨**<code>AbstractShiroFilter</code>**ç±»é‡Œè¿›è¡Œçº¿ç¨‹ç»‘å®š</p><h4 id="åˆ›å»º"><a href="#åˆ›å»º" class="headerlink" title="åˆ›å»º"></a>åˆ›å»º</h4><p>Shiroåˆ›å»ºSessionäº¤ç”±<code>SessionFactory</code>è´Ÿè´£, æˆ‘ä»¬å¯ä»¥å®ç°è¯¥ç±», åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„Session, æ¯”å¦‚æœ‰ç”¨æˆ·çš„ä¸€äº›å±æ€§å’Œæ“ä½œç³»ç»Ÿæµè§ˆå™¨çš„å±æ€§.</p><p>ç„¶ååœ¨è¿‡æ»¤å™¨è§¦å‘æ—¶, å°†ç™»å½•åçš„ç”¨æˆ·ä¿¡æ¯å­˜å…¥åˆ°è¯¥Sessionä¸­</p><h4 id="ç¼“å­˜"><a href="#ç¼“å­˜" class="headerlink" title="ç¼“å­˜"></a>ç¼“å­˜</h4><p>å…¶å®åœ¨ä¸šåŠ¡ä¸Šå¦‚æœéœ€è¦Redisæ¥ç®¡ç†Sessionï¼Œé‚£ä¹ˆç›´æ¥ç»§æ‰¿**<code>AbstractSessionDao</code>**, è¯¥ç±»æœ‰3ä¸ªå®ç°, ä½†æ˜¯åªæœ‰2ä¸ªæ˜¯æœ‰ç”¨çš„, ä¸€ä¸ªæ˜¯cacheå­˜å– , ä¸€ä¸ªæ˜¯ ConcurrentHashMapå­˜å–</p><ul><li>å¦‚æœåªæ˜¯åœ¨å•æœºç¯å¢ƒä¸‹éœ€è¦åšSessionæŒä¹…åŒ–ï¼ˆæœåŠ¡å™¨é‡å¯ä¿æŒSessionåœ¨çº¿ï¼‰ï¼Œé‚£ä¹ˆæœ€å¥½ç»§æ‰¿<code>EnterpriseCacheSessionDAO</code>æ¥å¢åŠ æœ¬åœ°Sessionç¼“å­˜ä»¥å‡å°‘I&#x2F;Oå¼€é”€ï¼Œå¦åˆ™å¤§é‡çš„doReadSession()è°ƒç”¨ä¼šé€ æˆI&#x2F;Oç”šè‡³ç½‘ç»œå‹åŠ›ï¼ˆå•æœºç¯å¢ƒä¸‹èƒ½çœä¸€ç‚¹æ˜¯ä¸€ç‚¹å˜›ï¼Œé›†ç¾¤å°±æ²¡åŠæ³•çœäº†ï¼‰ï¼›</li><li>å¦‚æœæ˜¯åœ¨é›†ç¾¤ç¯å¢ƒä¸‹åšSessionå…±äº«ï¼Œåƒä¸‡ä¸è¦ç»§æ‰¿EnterpriseCacheSessionDAOï¼Œä¼šäº§ç”ŸæœåŠ¡å™¨é—´çš„æœ¬åœ°Sessionç¼“å­˜ä¸åŒæ­¥é—®é¢˜ï¼Œç›´æ¥ç»§æ‰¿AbstractSessionDAOå³å¯ï¼›</li></ul><h4 id="å¤±æ•ˆ"><a href="#å¤±æ•ˆ" class="headerlink" title="å¤±æ•ˆ"></a>å¤±æ•ˆ</h4><p> <strong><code>AbstractShiroFilter</code></strong> <code> #doFilterInternal</code>è¿‡æ»¤å™¨æ¯ä¸€æ¬¡ä¼šè§¦å‘æ›´æ–°Sessionçš„æ“ä½œ<code>updateSessionLastAccessTime</code>, æœ€ç»ˆä¼šè§¦å‘<code>SessionDao.update()</code>, å°†æ›´æ–°åçš„sessionå­˜å…¥ç¼“å­˜</p><p>Shiroé»˜è®¤ä¼šé‡‡ç”¨å®šæ—¶çº¿ç¨‹æ£€æµ‹sessionæ˜¯å¦å¤±æ•ˆ, å…·ä½“å¯æŸ¥çœ‹å®šæ—¶å™¨ç±» <strong><code>ExecutorServiceSessionValidationScheduler</code></strong> ä¸å¤±æ•ˆsessionç®¡ç†ç±» <strong><code>AbstractValidatingSessionManager</code></strong> </p><p>ç ”å‘äººå‘˜å¯å®ç°è¿™ä¸¤ä¸ªç±», è‡ªå·±å®ç°ç›¸å…³sessionå¤±æ•ˆåçš„ä¸šåŠ¡é€»è¾‘</p><h3 id="è®¤è¯æ‹¦æˆª"><a href="#è®¤è¯æ‹¦æˆª" class="headerlink" title="è®¤è¯æ‹¦æˆª"></a>è®¤è¯æ‹¦æˆª</h3><p>ä»ç»Ÿä¸€å…¥å£ <strong><code>OncePerRequestFilter</code></strong> å„¿å­ç±» <strong><code>AdviceFilter</code></strong> <code>#doFilterInternal</code>è¿›å…¥, å¦‚æœçŠ¶æ€ä¸ºtrue, åˆ™è°ƒç”¨<code>executeChain</code>åšåç»­filterè´£ä»»é“¾å¤„ç†, å¹¶å¯ä»¥è‡ªå®šä¹‰<code>postHandle</code>æ–¹æ³•</p><p>å†äº¤ç”±å­™å­ç±» <strong><code>PathMatchingFilte</code></strong> <code>#preHandle #isFilterChainContinued </code></p><p>æ¥ç€å­™å­™å­ç±» <strong><code>AccessControlFilter</code></strong> <code>#onPreHandle</code> è¿›è¡Œæƒé™è®¤è¯é‰´æƒ</p><p>å½“è®¿é—®éanonæ‹¦æˆªæ—¶, ä¼šäº¤ç”±UserFilterå¤„ç†è®¤è¯é€»è¾‘, è‹¥è®¤è¯å¤±è´¥åˆ™è½¬åˆ°ç™»å½•é¡µé¢.</p><p>ä¸»è¦æ˜¯åœ¨<code>filterChainDefinitionMap.put(&quot;/**&quot;, &quot;user,kickout,onlineSession,syncOnlineSession&quot;)</code>é…ç½®</p><h2 id="é‰´æƒ"><a href="#é‰´æƒ" class="headerlink" title="é‰´æƒ"></a>é‰´æƒ</h2><p>å½“æˆ‘ä»¬è®¿é—®å¸¦æœ‰Shiroæƒé™æ³¨é‡Šçš„æ–¹æ³•æ—¶, ä¼šè¢«<code>AnnotationsAuthorizingMethodInterceptor</code>æ‹¦æˆªåˆ°, å…¶å†…éƒ¨ä¼šé€šè¿‡å¾ªç¯å¯¹å¤šä¸ªæƒé™æ³¨é‡Šçš„handlerå¤„ç†ç±»è¿›è¡Œé‰´æƒå¤„ç†, å¦‚æœæƒé™ä¸å¯¹, åˆ™æŠ¥é”™</p><p>å¤šä¸ªhandleræœ€ç»ˆè¿˜æ˜¯ä¼šäº¤ç”±<code>AuthorizingSecurityManager</code>æ¥åšç²¾ç»†åŒ–çš„æƒé™å¤„ç†.</p><p>è€Œåœ¨æ›´å†…éƒ¨åˆ™ä¼šè°ƒç”¨ <strong><code>AuthorizingRealm</code></strong> <code>#getAuthorizationInfo</code>æ–¹æ³•, è¯¥æ–¹æ³•å†…éƒ¨å…ˆä»Cacheè·å–ç”¨æˆ·å®ä½“, å¦‚æœè·å–ä¸åˆ°, åˆ™è°ƒç”¨è‡ªå®šä¹‰æ–¹æ³•ä»æ•°æ®åº“æ‹¿</p><h3 id="ç¼“å­˜-1"><a href="#ç¼“å­˜-1" class="headerlink" title="ç¼“å­˜"></a>ç¼“å­˜</h3><p>åœ¨é‰´æƒçš„æ—¶å€™, <strong><code>AuthorizingRealm</code></strong><code>#getAuthorizationInfo</code>ä¼šç»è¿‡ç¼“å­˜</p>]]></content>
    
    
    <categories>
      
      <category>Spring Cloud</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>ShardingJDBC</title>
    <link href="/2022/03/28/Spring/ShardingJDBC/"/>
    <url>/2022/03/28/Spring/ShardingJDBC/</url>
    
    <content type="html"><![CDATA[<h3 id="åˆ†ç‰‡ç®—æ³•"><a href="#åˆ†ç‰‡ç®—æ³•" class="headerlink" title="åˆ†ç‰‡ç®—æ³•"></a><a href="https://shardingsphere.apache.org/document/current/cn/dev-manual/sharding/">åˆ†ç‰‡ç®—æ³•</a></h3><ul><li>ç²¾å‡†åˆ†ç‰‡ StandardShardingStrategy</li><li>èŒƒå›´åˆ†ç‰‡ RangeShardingAlgorithm</li><li>è¡Œè¡¨è¾¾å¼åˆ†ç‰‡ InlineShardingAlgorithm</li><li>å¤åˆåˆ†ç‰‡ ComplexShardingStrategy</li><li>Hintåˆ†ç‰‡ HintShardingStrategy</li><li>ä¸åˆ†ç‰‡ NoneShardingStrategy</li></ul><h3 id="å¦‚æœSQLä¸­æ²¡æœ‰åˆ†ç‰‡é”®ï¼Œä½†æ˜¯ä»£ç ä¸­æœ‰æ€ä¹ˆåŠ"><a href="#å¦‚æœSQLä¸­æ²¡æœ‰åˆ†ç‰‡é”®ï¼Œä½†æ˜¯ä»£ç ä¸­æœ‰æ€ä¹ˆåŠ" class="headerlink" title="å¦‚æœSQLä¸­æ²¡æœ‰åˆ†ç‰‡é”®ï¼Œä½†æ˜¯ä»£ç ä¸­æœ‰æ€ä¹ˆåŠ"></a>å¦‚æœSQLä¸­æ²¡æœ‰åˆ†ç‰‡é”®ï¼Œä½†æ˜¯ä»£ç ä¸­æœ‰æ€ä¹ˆåŠ</h3><h4 id="åŠ¨æœº"><a href="#åŠ¨æœº" class="headerlink" title="åŠ¨æœº"></a>åŠ¨æœº</h4><p>é€šè¿‡è§£æ SQL è¯­å¥æå–åˆ†ç‰‡é”®åˆ—ä¸å€¼å¹¶è¿›è¡Œåˆ†ç‰‡æ˜¯ Apache ShardingSphere å¯¹ SQL é›¶ä¾µå…¥çš„å®ç°æ–¹å¼ã€‚è‹¥ SQL è¯­å¥ä¸­æ²¡æœ‰åˆ†ç‰‡æ¡ä»¶ï¼Œåˆ™æ— æ³•è¿›è¡Œåˆ†ç‰‡ï¼Œéœ€è¦å…¨è·¯ç”±ã€‚</p><p>åœ¨ä¸€äº›åº”ç”¨åœºæ™¯ä¸­ï¼Œåˆ†ç‰‡æ¡ä»¶å¹¶ä¸å­˜åœ¨äº SQLï¼Œè€Œå­˜åœ¨äºå¤–éƒ¨ä¸šåŠ¡é€»è¾‘ã€‚å› æ­¤éœ€è¦æä¾›ä¸€ç§é€šè¿‡å¤–éƒ¨æŒ‡å®šåˆ†ç‰‡ç»“æœçš„æ–¹å¼ï¼Œåœ¨ Apache ShardingSphere ä¸­å«åš Hintã€‚</p><h4 id="æœºåˆ¶"><a href="#æœºåˆ¶" class="headerlink" title="æœºåˆ¶"></a>æœºåˆ¶</h4><p>Apache ShardingSphere ä½¿ç”¨ <code>ThreadLocal</code> ç®¡ç†åˆ†ç‰‡é”®å€¼ã€‚å¯ä»¥é€šè¿‡ç¼–ç¨‹çš„æ–¹å¼å‘ <code>HintManager</code> ä¸­æ·»åŠ åˆ†ç‰‡æ¡ä»¶ï¼Œè¯¥åˆ†ç‰‡æ¡ä»¶ä»…åœ¨å½“å‰çº¿ç¨‹å†…ç”Ÿæ•ˆã€‚</p><p>é™¤äº†é€šè¿‡ç¼–ç¨‹çš„æ–¹å¼ä½¿ç”¨å¼ºåˆ¶åˆ†ç‰‡è·¯ç”±ï¼ŒApache ShardingSphere è¿˜è®¡åˆ’é€šè¿‡ SQL ä¸­çš„ç‰¹æ®Šæ³¨é‡Šçš„æ–¹å¼å¼•ç”¨ Hintï¼Œä½¿å¼€å‘è€…å¯ä»¥é‡‡ç”¨æ›´åŠ é€æ˜çš„æ–¹å¼ä½¿ç”¨è¯¥åŠŸèƒ½ã€‚</p><p>æŒ‡å®šäº†å¼ºåˆ¶åˆ†ç‰‡è·¯ç”±çš„ SQL å°†ä¼šæ— è§†åŸæœ‰çš„åˆ†ç‰‡é€»è¾‘ï¼Œç›´æ¥è·¯ç”±è‡³æŒ‡å®šçš„çœŸå®æ•°æ®èŠ‚ç‚¹ã€‚</p><h2 id="é«˜å¯ç”¨æ–¹æ¡ˆ"><a href="#é«˜å¯ç”¨æ–¹æ¡ˆ" class="headerlink" title="é«˜å¯ç”¨æ–¹æ¡ˆ"></a>é«˜å¯ç”¨æ–¹æ¡ˆ</h2><h2 id="ä¸»ä»å¤åˆ¶åŸç†"><a href="#ä¸»ä»å¤åˆ¶åŸç†" class="headerlink" title="ä¸»ä»å¤åˆ¶åŸç†"></a>ä¸»ä»å¤åˆ¶åŸç†</h2><h4 id="å¼ºåˆ¶åˆ†ç‰‡è·¯ç”±-Hint"><a href="#å¼ºåˆ¶åˆ†ç‰‡è·¯ç”±-Hint" class="headerlink" title="å¼ºåˆ¶åˆ†ç‰‡è·¯ç”± Hint"></a>å¼ºåˆ¶åˆ†ç‰‡è·¯ç”± Hint</h4><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">HintManager</span> <span class="hljs-variable">hintManager</span> <span class="hljs-operator">=</span> HintManager.getInstance() ;<br>hintManager.setMasterRouteOnly();<br></code></pre></td></tr></table></figure><p>æ¯”å¦‚æˆ’æ¯’ç³»ç»Ÿï¼Œæ›´æ–°åéœ€è¦ç«‹å³åˆ·æ–°åˆ—è¡¨ã€‚å¦‚æœé‡‡ç”¨äº†ä¸»ä»å¤åˆ¶æŠ€æœ¯çš„è¯ï¼Œå¯èƒ½è¯»å–ä»åº“ä¼šå¯¼è‡´æš‚æ—¶æ€§çš„ç¼ºå°‘æ•°æ®ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åœ¨æ›´æ–°çš„æ–¹æ³•ä¸­æ·»åŠ è¯¥ä»£ç ï¼Œä»£ç ä¸‹æ–¹è¿›è¡Œæ›´æ–°å’ŒæŸ¥è¯¢æ“ä½œï¼Œé‚£ä¹ˆè‡ªç„¶å°±ä¼šå»è¯»å–ä¸»åº“æ•°æ®ã€‚</p><h4 id="ç­‰GTID-æ–¹æ¡ˆ"><a href="#ç­‰GTID-æ–¹æ¡ˆ" class="headerlink" title="ç­‰GTID æ–¹æ¡ˆ"></a>ç­‰GTID æ–¹æ¡ˆ</h4><p>MySQL æä¾›äº†ä¸€æ¡åŸºäº GTID çš„å‘½ä»¤ï¼Œç”¨äºåœ¨ä»èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œç­‰å¾…ä»åº“åŒæ­¥åˆ°äº†å¯¹åº”çš„ GTIDï¼ˆbinlogæ–‡ä»¶ä¸­ä¼šåŒ…å« GTIDï¼‰ï¼Œæˆ–è€…è¶…æ—¶è¿”å›ã€‚</p><p>select wait_for_executed_gtid_set(gtid_set, timeout);</p><p>MySQL åœ¨æ‰§è¡Œå®Œäº‹åŠ¡åï¼Œä¼šå°†è¯¥äº‹åŠ¡çš„ GTID ä¼šç»™å®¢æˆ·ç«¯ï¼Œç„¶åå®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨è¯¥å‘½ä»¤å»è¦æ‰§è¡Œè¯»æ“ä½œçš„ä»åº“ä¸­æ‰§è¡Œï¼Œç­‰å¾…è¯¥ GTIDï¼Œç­‰å¾…æˆåŠŸåï¼Œå†æ‰§è¡Œè¯»æ“ä½œï¼›å¦‚æœç­‰å¾…è¶…æ—¶ï¼Œåˆ™å»ä¸»åº“æ‰§è¡Œè¯»æ“ä½œï¼Œæˆ–è€…å†æ¢ä¸€ä¸ªä»åº“æ‰§è¡Œä¸Šè¿°æµç¨‹ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼ŒåŸæ¥è¦æ‰§è¡Œè¯»æ“ä½œçš„ SQL å’Œæ·»åŠ äº†å‰ç¼€çš„ SQL å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> city; <span class="hljs-keyword">SET</span> <span class="hljs-variable">@maxscale</span>_secret_variable<span class="hljs-operator">=</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> WAIT_FOR_EXECUTED_GTID_SET(<span class="hljs-string">&#x27;232-1-1&#x27;</span>, <span class="hljs-number">10</span>) <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">ELSE</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> INFORMATION_SCHEMA.ENGINES) <span class="hljs-keyword">END</span>); <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> city;<br></code></pre></td></tr></table></figure><p>å½“ WAIT_FOR_EXECUTED_GTID_SET æ‰§è¡Œå¤±è´¥åï¼ŒåŸ SQL å°±ä¸ä¼šå†æ‰§è¡Œï¼Œè€Œæ˜¯å°†è¯¥ SQL å»ä¸»èŠ‚ç‚¹æ‰§è¡Œã€‚</p><h4 id="ç¼“å­˜ä¸»åº“æŸ¥è¯¢æ¬¡æ•°"><a href="#ç¼“å­˜ä¸»åº“æŸ¥è¯¢æ¬¡æ•°" class="headerlink" title="ç¼“å­˜ä¸»åº“æŸ¥è¯¢æ¬¡æ•°"></a>ç¼“å­˜ä¸»åº“æŸ¥è¯¢æ¬¡æ•°</h4><p>æ¦‚å¿µå¾ˆç®€å•, ç”¨æˆ·æ–°å¢æˆ–ä¿®æ”¹å, å¾€Redisä¸­æ’å…¥ä¸€æ¡æ•°æ®primaryRead:useridä¸º1, è‹¥å¤šæ¬¡æ’å…¥, åˆ™è¿›è¡Œç´¯åŠ .</p><p>å½“ç”¨æˆ·è°ƒç”¨æŸ¥è¯¢æ¥å£æ—¶, åˆ¤æ–­ç”¨æˆ·çš„æŸ¥è¯¢ç¼“å­˜æ¬¡æ•°æ˜¯å¦å­˜åœ¨, å¹¶å‡ä¸€æ“ä½œåèµ°ä¸»åº“æŸ¥è¯¢. è‹¥ä¸å­˜åœ¨æˆ–å‡ä¸€åå°äº0åˆ™èµ°ä»åº“æŸ¥è¯¢</p>]]></content>
    
    
    <categories>
      
      <category>Spring Cloud</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Database</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Spring Security</title>
    <link href="/2022/03/28/Spring/Spring%20Security/"/>
    <url>/2022/03/28/Spring/Spring%20Security/</url>
    
    <content type="html"><![CDATA[<h2 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h2><h3 id="åˆ›å»º"><a href="#åˆ›å»º" class="headerlink" title="åˆ›å»º"></a>åˆ›å»º</h3><p>Spring Securityæ²¡æœ‰åƒShiroä¸€æ ·ï¼Œåˆ›å»ºä¸€ä¸ªè‡ªå·±æŒæ§çš„Sessionå‡ºæ¥ï¼Œ è€Œæ˜¯é»˜è®¤äº¤ç”±Tomcatå¤„ç†ã€‚è™½ç„¶Securityæ²¡æœ‰è‡ªå·±åˆ›å»ºï¼Œä½†æ˜¯ç»™äº†æˆ‘ä»¬å¯ä»¥å®ç°çš„<code>SessionRegistry</code>ï¼Œä»¥åŠç”¨äºç®¡ç†ç”¨æˆ·å’ŒSessionçš„<code>SessionInformation</code></p><p><code>SessionManagementFilter</code>æ˜¯ä¸“é—¨ç”¨äºç®¡ç†SessionçŠ¶æ€çš„ï¼Œå¦‚æ£€æµ‹ç”¨æˆ·å¹¶å‘Sessionï¼Œå¤±æ•ˆSessionçš„é€»è¾‘å¤„ç†ç­‰</p><ul><li>expiredUrlï¼šæ˜¯ç”¨æˆ·å¹¶å‘ä¼šè¯è¿‡å¤šï¼Œè¢«æŒ¤ä¸‹çº¿åçš„é‡å®šå‘åœ°å€ã€‚</li><li>invalidSessionUrlï¼šSessionè¶…æ—¶çš„é‡å®šå‘åœ°å€</li></ul><h3 id="ç¼“å­˜"><a href="#ç¼“å­˜" class="headerlink" title="ç¼“å­˜"></a>ç¼“å­˜</h3><p>spring-session-data-redisä¾èµ–, å°†Sessionè¿›è¡Œåˆ†å¸ƒå¼ç¼“å­˜</p><h3 id="å¤±æ•ˆ"><a href="#å¤±æ•ˆ" class="headerlink" title="å¤±æ•ˆ"></a>å¤±æ•ˆ</h3><p>Spring Securityé‡‡ç”¨äº†äº‹ä»¶å¹¿æ’­åœ¨Sessionå¤±æ•ˆæ—¶ï¼Œåˆ é™¤äº†å¯¹åº”çš„<code>SessionInformation</code>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨**<code>SessionRegistryImpl</code>**<code>#onApplicationEvent</code>è¿›è¡Œæ·±å…¥çš„ç ”ç©¶</p><h3 id="ç™»é™†è®¤è¯"><a href="#ç™»é™†è®¤è¯" class="headerlink" title="ç™»é™†è®¤è¯"></a>ç™»é™†è®¤è¯</h3><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></div></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* ç”¨æˆ·ç™»å½•å, äº¤ç”± AbstractAuthenticationProcessingFilter è¿‡æ»¤å™¨æ£€æµ‹æ˜¯å¦ä¸ºç™»å½•åœ°å€</span><br><span class="hljs-comment">*/</span><br>AbstractAuthenticationProcessingFilter&#123;<br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>    <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦æ˜¯é…ç½®å¥½çš„éªŒè¯ç™»å½•è¯·æ±‚</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.requiresAuthentication(request, response)) &#123;<br>      chain.doFilter(request, response);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// å°è¯•èº«ä»½éªŒè¯</span><br>      authResult = <span class="hljs-built_in">this</span>.attemptAuthentication(request, response);<br>    &#125;<br>  &#125;<br>  <br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* ç¡®å®šåé»˜è®¤å†ç”± UsernamePasswordAuthenticationFilterè¿›è¡Œç”¨æˆ·è·å–è®¤è¯</span><br><span class="hljs-comment">*/</span><br>UsernamePasswordAuthenticationFilter&#123;<br>  Authentication <span class="hljs-title function_">attemptAuthentication</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getAuthenticationManager().authenticate(authRequest);<br>  &#125;<br>  <br>  <span class="hljs-comment">// ç„¶å AbstractUserDetailsAuthenticationProvider#authenticate </span><br>  <span class="hljs-comment">// ä¼šé€šè¿‡usernameå’Œç”Ÿæˆçš„Authenticationå¯¹è±¡ç”Ÿæˆä¸€ä¸ªUserDetailså¯¹è±¡ï¼Œå¹¶æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span><br>  Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> authentication.getPrincipal() == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;NONE_PROVIDED&quot;</span> : authentication.getName();<br>    <span class="hljs-comment">// å»æ‰¾ç¼“å­˜, å¯ä»¥é€šè¿‡ehcacheå®ç°è¯¥ç±», é»˜è®¤æ˜¯NullUserCacheç©ºå®ç°</span><br>    <span class="hljs-type">UserDetails</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.userCache.getUserFromCache(username);<br>    <span class="hljs-keyword">if</span>(user == <span class="hljs-literal">null</span>)&#123;<br>      <span class="hljs-comment">// æ²¡æœ‰ç¼“å­˜, åˆ™é€šè¿‡DetailServiceçš„å®ç°ç±»å»æ•°æ®åº“æŸ¥è¯¢, ä¹Ÿå¯ä»¥ä»ç¼“å­˜èµ°</span><br>      user = <span class="hljs-built_in">this</span>.retrieveUser(username, (UsernamePasswordAuthenticationToken)authentication)&#123;<br>        <span class="hljs-type">UserDetails</span> <span class="hljs-variable">loadedUser</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getUserDetailsService().loadUserByUsername(username);<br>        <span class="hljs-keyword">return</span> loadedUser;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="æ­£å¸¸è®¿é—®"><a href="#æ­£å¸¸è®¿é—®" class="headerlink" title="æ­£å¸¸è®¿é—®"></a>æ­£å¸¸è®¿é—®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* è¿‡æ»¤å™¨é“¾çš„ç¬¬äºŒä½</span><br><span class="hljs-comment">*/</span><br>SecurityContextPersistenceFilter&#123;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">// è·å–sessionä¸­çš„ç”¨æˆ·ä¿¡æ¯</span><br>    <span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> request.getSession();<br>    <span class="hljs-type">HttpRequestResponseHolder</span> <span class="hljs-variable">holder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpRequestResponseHolder</span>(request, response);<br>    <span class="hljs-type">SecurityContext</span> <span class="hljs-variable">contextBeforeChainExecution</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.repo.loadContext(holder);<br>    <span class="hljs-comment">// å­˜å…¥å½“å‰çº¿ç¨‹</span><br>    SecurityContextHolder.setContext(contextBeforeChainExecution);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* å¼‚å¸¸è¿‡æ»¤å™¨</span><br><span class="hljs-comment">*/</span><br>ExceptionTranslationFilter&#123;<br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">// åç½®è¿‡æ»¤å™¨ï¼Œæœ€ç»ˆä¼šèµ°åˆ°FilterSecurityInterceptor</span><br>    <span class="hljs-keyword">try</span> &#123;<br>      chain.doFilter(request, response);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>      <span class="hljs-comment">// æ‰§è¡ŒexceptionEntrypoint</span><br>      handleSpringSecurityException(request, response, chain, securityException);<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* æƒé™æ‹¦æˆªå™¨,æ–¹æ³•å‰æ‹¦æˆª</span><br><span class="hljs-comment">*/</span><br>FilterSecurityInterceptor <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractSecurityInterceptor</span>&#123;<br>  <br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">// å‰ç½®, æ£€æµ‹è®¿é—®è¯·æ±‚æ˜¯å¦æ˜¯ç™½åå•ï¼Œè·å–çº¿ç¨‹å†…è®¤è¯å¯¹è±¡å¹¶åšæƒé™æ ¡éªŒï¼Œå¦‚@PreAuthorize</span><br>    <span class="hljs-built_in">super</span>.beforeInvocation(filterInvocation);<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// </span><br>      filterInvocation.getChain().doFilter(filterInvocation.getRequest(), filterInvocation.getResponse());<br>    &#125;<br>    <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-comment">// åç½®</span><br>      <span class="hljs-built_in">super</span>.finallyInvocation(token);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ç”¨æˆ·ç¼“å­˜"><a href="#ç”¨æˆ·ç¼“å­˜" class="headerlink" title="ç”¨æˆ·ç¼“å­˜"></a>ç”¨æˆ·ç¼“å­˜</h3><p><code>UserCache</code> å…è®¸é…ç½®Ehcacheç¼“å­˜, ç”¨äºç¼“å­˜ <code>UserDetails</code> å¯¹è±¡ , åœ¨  CachingUserDetailsService ç±»ä¸­è·å–ç”¨æˆ·å®ä½“</p><p>æ„Ÿè§‰æ²¡å•¥ç”¨, æ•²äº†æ–­ç‚¹å‘ç°åªæœ‰ç™»å½•çš„æ—¶å€™èƒ½ç”¨ä¸Šè¯¥ç¼“å­˜.</p><h2 id="é‰´æƒç®¡ç†"><a href="#é‰´æƒç®¡ç†" class="headerlink" title="é‰´æƒç®¡ç†"></a>é‰´æƒç®¡ç†</h2><hr><p>spring securityçš„è®¤è¯ä¸é‰´æƒè¿‡æ»¤å™¨éƒ½åœ¨<code>AbstractSecurityInterceptor</code>æ‹¦æˆªå™¨ä¸­. å…¶ä¸­é‰´æƒéƒ¨åˆ†äº¤ç”±<code>AbstractAccessDecisionManager</code>å®ç°, é‡‡ç”¨äº†æŠ•ç¥¨æœºåˆ¶è¿›è¡Œé‰´æƒ.é»˜è®¤æœ‰ä¸‰ä¸ªå®ç°ç±»</p><ul><li><strong>AffirmativeBased(é»˜è®¤)</strong> : åªè¦ä»»ä¸€ AccessDecisionVoter è¿”å›è‚¯å®šçš„ç»“æœï¼Œä¾¿æˆäºˆè®¿é—®æƒé™</li><li>UnanimousBased : åªè¦ä»»ä¸€ AccessDecisionVoter è¿”å›å¤±è´¥çš„ç»“æœï¼Œä¾¿å…¨ä½“å¤±è´¥</li><li>ConsensusBased : å°‘æ•°æœä»å¤šæ•°æˆæƒè®¿é—®å†³ç­–æ–¹æ¡ˆ</li></ul><h2 id="å¸¸ç”¨é…ç½®"><a href="#å¸¸ç”¨é…ç½®" class="headerlink" title="å¸¸ç”¨é…ç½®"></a>å¸¸ç”¨é…ç½®</h2><hr><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs Java">http<br>  <span class="hljs-comment">// è·¨åŸŸ</span><br>  .cors(AbstractHttpConfigurer::disable)<br>  <span class="hljs-comment">// csrfæ”»å‡»</span><br>  .csrf(AbstractHttpConfigurer::disable)<br>  <span class="hljs-comment">// å®Œå…¨æ”¾å¼€frameé¡µé¢</span><br>  .headers(h -&gt; h.frameOptions().disable())<br>  <span class="hljs-comment">// å¼‚å¸¸å¤„ç†é…ç½® ExceptionTranslationFilter</span><br>  <span class="hljs-comment">// åœ¨è¿‡æ»¤å™¨</span><br>  .exceptionHandling(<br>          <span class="hljs-comment">// ç”¨æ¥è§£å†³åŒ¿åç”¨æˆ·è®¿é—®æ— æƒé™èµ„æºæ—¶çš„å¼‚å¸¸</span><br>          e-&gt;e.authenticationEntryPoint(customAuthenticationEntryPoint)<br>          <span class="hljs-comment">// ç”¨æ¥è§£å†³è®¤è¯è¿‡çš„ç”¨æˆ·è®¿é—®æ— æƒé™èµ„æºæ—¶çš„å¼‚å¸¸</span><br>                  .accessDeniedHandler(customAccessDeniedHandler)<br>  <span class="hljs-comment">// sessionç®¡ç†å™¨</span><br>  ).sessionManagement(<br>  <span class="hljs-comment">// åŒä¸€ç”¨æˆ·æœ€å¤§å…è®¸åŒæ—¶å­˜åœ¨å‡ ä¸ª</span><br>  s-&gt;s.maximumSessions(<span class="hljs-number">10</span>)<br>          <span class="hljs-comment">// ç®¡ç†æ‰€æœ‰ç”¨æˆ·ç™»å½•çš„session</span><br>          .sessionRegistry(sessionRegistry())<br>          <span class="hljs-comment">// sessionå¤±æ•ˆå¤„ç†</span><br>          .expiredSessionStrategy(ssoSessionInformationExpiredStrategy)<br>  <span class="hljs-comment">// è®¤è¯è¯·æ±‚æ‹¦æˆªç­–ç•¥, ä»¥ä¸‹éƒ½ä¸æ‹¦æˆªå¤„ç†ï¼Œä½†æ˜¯ä¼šèµ°è¿‡æ»¤å™¨</span><br>  <span class="hljs-comment">// web.ignoreçš„ä¸æ‹¦æˆªå¤„ç†ï¼Œæ˜¯ä¸èµ°è¿‡æ»¤å™¨çš„ï¼Œä¸€èˆ¬ç”¨äºé™æ€èµ„æºæ–‡ä»¶</span><br>).authorizeRequests(<br>  a-&gt; a.antMatchers(<span class="hljs-string">&quot;/sso/*&quot;</span>,<span class="hljs-string">&quot;/logout&quot;</span>)<br>          .permitAll().anyRequest().authenticated()<br>  <span class="hljs-comment">// ç™»é™†å¤±è´¥çš„å¤„ç†</span><br>).failureHandler(authenticationFailureHandler())<br>  <span class="hljs-comment">// é€€å‡ºç™»é™†æˆåŠŸå¤„ç†</span><br>.logoutSuccessHandler(logoutSuccessHandler())<br>  <span class="hljs-comment">// ç™»å½•é¡µé¢åœ°å€</span><br>.formLogin(<br>  f-&gt;f.loginPage(accessTokenUri)<br>        <span class="hljs-comment">// å¯ä»¥ä¸é…ç½®,è¡¨ç¤ºç™»å½•æäº¤çš„åœ°å€,ç”¨äºæ ¡éªŒåç«¯ç™»å½•çš„url</span><br>        .loginProcessingUrl(<span class="hljs-string">&quot;/login&quot;</span>)<br>          <span class="hljs-comment">// ç™»å½•æˆåŠŸåå›è°ƒ</span><br>          .successHandler(customAuthenticationSuccessHandler)<br><span class="hljs-comment">// åœ¨userfilterå‰æ‰§è¡ŒvalidateFilter</span><br>).addFilterBefore(validateCodeFilter, UsernamePasswordAuthenticationFilter.class)<br><span class="hljs-comment">// åœ¨validateFilterå‰æ‰§è¡ŒdecryptFilter</span><br>.addFilterBefore(decryptParameterFilter, ValidateCodeFilter.class)<br>.apply(ssoAuthenticationSecurityConfig);<br><br><span class="hljs-comment">//ç¦ç”¨sessionç®¡ç†</span><br>http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* ssoAuthenticationSecurityConfig extends SecurityConfigurerAdapter</span><br><span class="hljs-comment">* å¯ä»¥åœ¨CASä¸­é…ç½®ä¸šåŠ¡è®¤è¯é€»è¾‘</span><br><span class="hljs-comment">*/</span><br><br># **åŸºäºé…ç½®å¥½çš„è·¯å¾„æ¥è¿›è¡Œè®¤è¯çš„è¿‡æ»¤å™¨ AbstractAuthenticationProcessingFilter**<br><span class="hljs-comment">// å­ç±»å®ç°attemptAuthentication()æ¥åšé€»è¾‘å¤„ç†</span><br><span class="hljs-comment">// äº¤ç”±ä¸‹é¢çš„AuthenticationManageræ¥åšè®¤è¯å¤„ç†</span><br><br><span class="hljs-comment">// ä½†æ˜¯è¯¥æŠ½è±¡ç±»ä¸­doFilteræ–¹æ³•é‡Œæœ‰this.requiresAuthenticationçš„è°ƒç”¨, é‡Œé¢æ˜¯AntPathRequestMatcherç±»</span><br><span class="hljs-comment">// è¯¥ç±»é»˜è®¤è®°è½½äº†/loginçš„url, è¡¨ç¤ºåªæœ‰å½“ç”¨æˆ·è¯·æ±‚åœ°å€ä¸ä¹‹ç›¸åŒæ—¶, æ‰ä¼šèµ°ä¸‹é¢çš„è®¤è¯é€»è¾‘, å¦åˆ™éƒ½ä¼šäº¤ç”±å…¶ä»–è¿‡æ»¤å™¨è§£å†³.</span><br><span class="hljs-comment">// æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨å­ç±»æ„é€ ä¸­, é‡å†™è¯¥åœ°å€, å°†ç™»é™†åçš„è¯·æ±‚åœ°å€æ”¾è¿›å».*</span><br>AbstractAuthenticationProcessingFilter filter<br><br><span class="hljs-comment">// ç”¨äºå¤„ç†èº«ä»½éªŒè¯çš„æ ¸å¿ƒé€»è¾‘, åœ¨CASä¸­å¯ä»¥æ ¹æ®authenticationå‚æ•°åˆ¤æ–­æœ‰æ²¡æœ‰è¢«CASä¸­å¿ƒè®¤è¯è¿‡</span><br><span class="hljs-comment">// æœ€ç»ˆéœ€è¦è¿”å›è®¤è¯å¯¹è±¡</span><br>filter.setAuthenticationManager(providerManager);<br><span class="hljs-comment">// è®¤è¯æˆåŠŸå,Securityä¼šå‘å¸ƒæ¶ˆæ¯,ç”¨æˆ·å¯ä»¥è®¢é˜…å®ç°è®°å½•æˆåŠŸä¿¡æ¯</span><br>providerManager.setAuthenticationEventPublisher();<br><span class="hljs-comment">// ä¸šåŠ¡æ¨¡å—è®¤è¯é€šè¿‡å,å¯ä»¥æ ¹æ®savedRequeståšè·³è½¬ä¹‹ç±»çš„</span><br>filter.setAuthenticationSuccessHandler(customAuthenticationSuccessHandler)<br></code></pre></td></tr></table></figure><h2 id="JWTæ— çŠ¶æ€"><a href="#JWTæ— çŠ¶æ€" class="headerlink" title="JWTæ— çŠ¶æ€"></a>JWTæ— çŠ¶æ€</h2><p>åœ¨è®¤è¯çš„è¿‡ç¨‹ä¸­ï¼ŒSpring Securityä¼šè¿è¡Œä¸€ä¸ªè¿‡æ»¤å™¨<code>SecurityContextPersistenceFilter</code>æ¥å­˜å‚¨è¯·æ±‚çš„Security Contextï¼Œè¿™ä¸ªä¸Šä¸‹æ–‡çš„å­˜å‚¨æ˜¯ä¸€ä¸ªç­–ç•¥æ¨¡å¼ï¼Œä½†é»˜è®¤çš„æ˜¯ä¿å­˜åœ¨HTTP Sessionä¸­çš„<code>HttpSessionSecurityContextRepository</code>ã€‚ç°åœ¨æˆ‘ä»¬è®¾ç½®äº† create-session&#x3D;â€statelessâ€ï¼Œå°±ä¼šä¿å­˜åœ¨<code>NullSecurityContextRepository</code>ï¼Œé‡Œé¢æ²¡æœ‰ä»»ä½•sessionåœ¨ä¸Šä¸‹æ–‡ä¸­ä¿æŒã€‚</p><p>æ—¢ç„¶æ²¡æœ‰ä¸ºä½•è¿˜è¦è°ƒç”¨è¿™ä¸ªç©ºçš„filterï¼Ÿå› ä¸ºéœ€è¦è°ƒç”¨è¿™ä¸ªfilteræ¥ä¿è¯æ¯æ¬¡è¯·æ±‚å®Œäº†<code>SecurityContextHolder</code>è¢«æ¸…ç©ºäº†ï¼Œä¸‹ä¸€æ¬¡è¯·æ±‚å¿…é¡»<strong>re-authentication</strong>ã€‚</p><h3 id="ç™»å½•è®¤è¯"><a href="#ç™»å½•è®¤è¯" class="headerlink" title="ç™»å½•è®¤è¯"></a>ç™»å½•è®¤è¯</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-number">1.</span> å¯ä»¥ç»§æ‰¿UsernamePasswordAuthenticationFilterç±»ï¼Œå»é€šè¿‡UserDetailServiceè·å–ç”¨æˆ·ã€‚<br><br><span class="hljs-number">2.</span> ç™»å½•æ ¡éªŒæˆåŠŸåç”±é…ç½®å¥½çš„ http.successHandler(JwtLoginSuccessHandler)æ¥è¿”å›Tokenç»™å‰ç«¯ã€‚<br></code></pre></td></tr></table></figure><h3 id="æ­£å¸¸è®¿é—®-1"><a href="#æ­£å¸¸è®¿é—®-1" class="headerlink" title="æ­£å¸¸è®¿é—®"></a>æ­£å¸¸è®¿é—®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><br><span class="hljs-comment">// ç¦ç”¨sessionç®¡ç†</span><br><span class="hljs-comment">// è·³è¿‡ HttpSessionSecurityContextRepository, SessionManagementFilter, RequestCacheFilter. </span><br>http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);<br><span class="hljs-comment">// ç™¾åº¦æ–¹æ³•ä¸€èˆ¬æ˜¯ç»§æ‰¿è¯¥ç±»</span><br><span class="hljs-comment">// ä¹Ÿæœ‰ç»§æ‰¿OncePerRequestFilterç±»çš„</span><br>JwtAuthorizationFilter <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BasicAuthenticationFilter</span><br><span class="hljs-comment">// ç„¶åé€šè¿‡é…ç½®åŠ å…¥è¯¥è¿‡æ»¤å™¨</span><br>http.addFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtAuthorizationFilter</span>(authenticationManager()));<br><br></code></pre></td></tr></table></figure><h2 id="è®¤è¯å…¥å£ç‚¹AuthenticationEntryPoint"><a href="#è®¤è¯å…¥å£ç‚¹AuthenticationEntryPoint" class="headerlink" title="è®¤è¯å…¥å£ç‚¹AuthenticationEntryPoint"></a>è®¤è¯å…¥å£ç‚¹AuthenticationEntryPoint</h2><hr><ul><li>å®ƒåœ¨ç”¨æˆ·è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­é‡åˆ°è®¤è¯å¼‚å¸¸æ—¶ï¼Œè¢«<code>ExceptionTranslationFilter</code>æˆ–è€…<code>AuthenticationFailureHandler</code>ç”¨äºå¼€å¯ç‰¹å®šè®¤è¯æ–¹æ¡ˆçš„è®¤è¯æµç¨‹ã€‚<ul><li><code>Http403ForbiddenEntryPoint</code>: è®¾ç½®å“åº”çŠ¶æ€å­—ä¸º403,å¹¶éè§¦å‘ä¸€ä¸ªçœŸæ­£çš„è®¤è¯æµç¨‹ã€‚é€šå¸¸åœ¨ä¸€ä¸ªé¢„éªŒè¯(pre-authenticated authentication)å·²ç»å¾—å‡ºç»“è®ºéœ€è¦æ‹’ç»ç”¨æˆ·è¯·æ±‚çš„æƒ…å†µè¢«ç”¨äºæ‹’ç»ç”¨æˆ·è¯·æ±‚ã€‚</li><li><code>HttpStatusEntryPoint</code>: è®¾ç½®ç‰¹å®šçš„å“åº”çŠ¶æ€å­—ï¼Œå¹¶éè§¦å‘ä¸€ä¸ªçœŸæ­£çš„è®¤è¯æµç¨‹ã€‚</li><li><code>LoginUrlAuthenticationEntryPoint</code>: æ ¹æ®é…ç½®è®¡ç®—å‡ºç™»å½•é¡µé¢url,å°†ç”¨æˆ·é‡å®šå‘åˆ°è¯¥ç™»å½•é¡µé¢ä»è€Œå¼€å§‹ä¸€ä¸ªè®¤è¯æµç¨‹ã€‚</li><li><code>BasicAuthenticationEntryPoint</code>: å¯¹åº”æ ‡å‡†Http Basicè®¤è¯æµç¨‹çš„è§¦å‘åŠ¨ä½œï¼Œå‘å“åº”å†™å…¥çŠ¶æ€å­—401å’Œå¤´éƒ¨WWW-Authenticate:â€Basic realm&#x3D;â€xxxâ€è§¦å‘æ ‡å‡†Http Basicè®¤è¯æµç¨‹ã€‚</li><li><code>DigestAuthenticationEntryPoint</code>: å¯¹åº”æ ‡å‡†Http Digestè®¤è¯æµç¨‹çš„è§¦å‘åŠ¨ä½œï¼Œå‘å“åº”å†™å…¥çŠ¶æ€å­—401å’Œå¤´éƒ¨WWW-Authenticate:â€Digest realm&#x3D;â€xxxâ€è§¦å‘æ ‡å‡†Http Digestè®¤è¯æµç¨‹ã€‚</li><li><code>DelegatingAuthenticationEntryPoint</code>: è¿™æ˜¯ä¸€ä¸ªä»£ç†ï¼Œå°†è®¤è¯ä»»åŠ¡å§”æ‰˜ç»™æ‰€ä»£ç†çš„å¤šä¸ªAuthenticationEntryPointå¯¹è±¡ï¼Œå…¶ä¸­ä¸€ä¸ªè¢«æ ‡è®°ä¸ºç¼ºçœAuthenticationEntryPointã€‚</li></ul></li></ul><h2 id="ç”¨æˆ·å®ä½“UserDetailService"><a href="#ç”¨æˆ·å®ä½“UserDetailService" class="headerlink" title="ç”¨æˆ·å®ä½“UserDetailService"></a><strong>ç”¨æˆ·å®ä½“UserDetailService</strong></h2><hr><ul><li>Spring Securityä¸­è¿›è¡Œèº«ä»½éªŒè¯çš„æ˜¯ AuthenticationManager æ¥å£ï¼ŒProviderManager æ˜¯å®ƒçš„ä¸€ä¸ªé»˜è®¤å®ç°ï¼Œä½†å®ƒå¹¶ä¸ç”¨æ¥å¤„ç†èº«ä»½è®¤è¯ï¼Œè€Œæ˜¯å§”æ‰˜ç»™é…ç½®å¥½çš„ AuthenticationProvider ï¼Œæ¯ä¸ª AuthenticationProvider ä¼šè½®æµæ£€æŸ¥èº«ä»½è®¤è¯ã€‚æ£€æŸ¥åæˆ–è€…è¿”å› Authentication å¯¹è±¡æˆ–è€…æŠ›å‡ºå¼‚å¸¸ã€‚</li><li>loadUserByUsernameï¼šé€šè¿‡ç”¨æˆ·åè·å–ä¸€ä¸ªçœŸå®ç”¨æˆ·ï¼Œè¿”å›ä¸€ä¸ª UserDetails çš„å®ç°ç±»</li><li>å¯†ç éªŒè¯ç”± AuthenticationProvider çš„ DaoAuthenticationProvider#additionalAuthenticationChecks å¤„ç†ï¼Œä¹Ÿå¯ä»¥è‡ªå·±å®šä¹‰</li><li>UserDetailç›®å‰å‘ç°ä»…åœ¨ç™»å½•æ—¶ä¸Authenticationåšæ¯”è¾ƒæ“ä½œ, é™¤æ­¤ä»¥å¤–æ— ä»–ç”¨</li></ul>]]></content>
    
    
    <categories>
      
      <category>Spring Cloud</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Zipkin Sleuth</title>
    <link href="/2022/03/28/Spring/Zipkin%20Sleuth/"/>
    <url>/2022/03/28/Spring/Zipkin%20Sleuth/</url>
    
    <content type="html"><![CDATA[<blockquote><p>Spring Cloud Sleuth æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­è·Ÿè¸ªæœåŠ¡é—´è°ƒç”¨çš„å·¥å…·ï¼Œå®ƒå¯ä»¥ç›´è§‚åœ°å±•ç¤ºå‡ºä¸€æ¬¡è¯·æ±‚çš„è°ƒç”¨è¿‡ç¨‹ï¼Œæœ¬æ–‡å°†å¯¹å…¶ç”¨æ³•è¿›è¡Œè¯¦ç»†ä»‹ç»ã€‚</p></blockquote><h3 id="Zipkin"><a href="#Zipkin" class="headerlink" title="Zipkin"></a>Zipkin</h3><p>Zipkinæ˜¯Twitterçš„ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œå¯ä»¥ç”¨æ¥è·å–å’Œåˆ†æSpring Cloud Sleuth ä¸­äº§ç”Ÿçš„è¯·æ±‚é“¾è·¯è·Ÿè¸ªæ—¥å¿—ï¼Œå®ƒæä¾›äº†Webç•Œé¢æ¥å¸®åŠ©æˆ‘ä»¬ç›´è§‚åœ°æŸ¥çœ‹è¯·æ±‚é“¾è·¯è·Ÿè¸ªä¿¡æ¯ã€‚</p><p>Zipkinæ˜¯ä¸€ä¸ªå•ç‹¬çš„æœåŠ¡ï¼ŒSpringé¡¹ç›®å¼•å…¥ä¾èµ–åï¼Œå†ä¸‹è½½Zipkinçš„jaråå¯åŠ¨ã€‚</p><p>Zipkiné»˜è®¤è®°å½•åªæ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ŒZipkinå…³é—­åˆ™å…¨éƒ¨ä¸¢å¤±ã€‚</p><ul><li>åœ¨user-serviceå’Œribbon-serviceä¸­æ·»åŠ ç›¸å…³ä¾èµ–ï¼š</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li>ä¿®æ”¹application.ymlæ–‡ä»¶ï¼Œé…ç½®æ”¶é›†æ—¥å¿—çš„zipkin-serverè®¿é—®åœ°å€ï¼š</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">zipkin:</span><br>    <span class="hljs-attr">base-url:</span> <span class="hljs-string">http://localhost:9411</span><br>  <span class="hljs-attr">sleuth:</span><br>    <span class="hljs-attr">sampler:</span><br>      <span class="hljs-attr">probability:</span> <span class="hljs-number">0.1</span> <span class="hljs-comment">#è®¾ç½®Sleuthçš„æŠ½æ ·æ”¶é›†æ¦‚ç‡</span><br></code></pre></td></tr></table></figure><h3 id="ElasticSearchå­˜å‚¨"><a href="#ElasticSearchå­˜å‚¨" class="headerlink" title="ElasticSearchå­˜å‚¨"></a>ElasticSearchå­˜å‚¨</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs PowerShell"><span class="hljs-comment"># STORAGE_TYPEï¼šè¡¨ç¤ºå­˜å‚¨ç±»å‹ ES_HOSTSï¼šè¡¨ç¤ºESçš„è®¿é—®åœ°å€</span><br>java <span class="hljs-literal">-jar</span> zipkin<span class="hljs-literal">-server-2</span>.<span class="hljs-number">12.9</span><span class="hljs-literal">-exec</span>.jar <span class="hljs-literal">--STORAGE_TYPE</span>=elasticsearch <span class="hljs-literal">--ES_HOSTS</span>=localhost:<span class="hljs-number">9200</span> <br></code></pre></td></tr></table></figure><h3 id="Used-Config"><a href="#Used-Config" class="headerlink" title="Used Config"></a>Used Config</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-number">1</span>ã€ä½¿ç”¨rabbitmq+elasticsearchçš„å¯åŠ¨æ–¹å¼<br><br>java -jar zipkin<span class="hljs-selector-class">.jar</span> <span class="hljs-attr">--zipkin</span><span class="hljs-selector-class">.collector</span><span class="hljs-selector-class">.rabbitmq</span><span class="hljs-selector-class">.addresses</span>=<span class="hljs-number">62.234</span>.<span class="hljs-number">66.186</span> <span class="hljs-attr">--zipkin</span><span class="hljs-selector-class">.collector</span><span class="hljs-selector-class">.rabbitmq</span><span class="hljs-selector-class">.username</span>=root <span class="hljs-attr">--zipkin</span><span class="hljs-selector-class">.collector</span><span class="hljs-selector-class">.rabbitmq</span><span class="hljs-selector-class">.password</span>=<span class="hljs-number">123456</span> <span class="hljs-attr">--zipkin</span><span class="hljs-selector-class">.storage</span><span class="hljs-selector-class">.type</span>=elasticsearch <span class="hljs-attr">--zipkin</span><span class="hljs-selector-class">.storage</span><span class="hljs-selector-class">.elasticsearch</span><span class="hljs-selector-class">.host</span>=http://<span class="hljs-number">62.234</span>.<span class="hljs-number">66.186</span>:<span class="hljs-number">9200</span> --zipkin.storage.elasticsearch.http-logging=BASIC<br><br><span class="hljs-number">2</span>ã€ä½¿ç”¨rabbitmq+mysqlå¯åŠ¨æ–¹å¼<br><br>java -jar zipkin.jar --zipkin.collector.rabbitmq.addresses=<span class="hljs-number">62.234</span>.<span class="hljs-number">66.186</span> --zipkin.collector.rabbitmq.username=root --zipkin.collector.rabbitmq.password=<span class="hljs-number">123456</span> --zipkin.storage.type=mysql --zipkin.storage.mysql.host=<span class="hljs-number">62.234</span>.<span class="hljs-number">66.186</span> --zipkin.storage.mysql.port=<span class="hljs-number">3306</span> --zipkin.storage.mysql.username=root --zipkin.storage.mysql.password=root --zipkin.storage.mysql.db=psych<br><br><span class="hljs-number">3</span>ã€ä½¿ç”¨activemq+mysqlå¯åŠ¨æ–¹å¼<br><br>java -jar zipkin.jar --zipkin.collector.activemq.url=tcp://<span class="hljs-number">62.234</span>.<span class="hljs-number">66.186</span>:<span class="hljs-number">61616</span> --zipkin.collector.activemq.username=admin --zipkin.collector.activemq.password=admin --zipkin.storage.type=mysql --zipkin.storage.mysql.host=<span class="hljs-number">62.234</span>.<span class="hljs-number">66.186</span> --zipkin.storage.mysql.port=<span class="hljs-number">3306</span> --zipkin.storage.mysql.username=root --zipkin.storage.mysql.password=root --zipkin.storage.mysql.db=psych<br><br><span class="hljs-number">4</span>ã€ä½¿ç”¨activemq+elasticsearchæ–¹å¼é›·åŒï¼Œåªéœ€è¦å°†æ•°æ®æºæ”¹ä¸ºelasticsearchå³å¯<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Spring Cloud</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>OpenResty</title>
    <link href="/2022/03/28/Distributed%20System/OpenResty/"/>
    <url>/2022/03/28/Distributed%20System/OpenResty/</url>
    
    <content type="html"><![CDATA[<h2 id="OpenResty"><a href="#OpenResty" class="headerlink" title="OpenResty"></a><a href="https://openresty.org/cn/">OpenResty</a></h2><p>OpenRestyÂ® æ˜¯ä¸€ä¸ªåŸºäº Nginx ä¸ Lua çš„é«˜æ€§èƒ½ Web å¹³å°ï¼Œå…¶å†…éƒ¨é›†æˆäº†å¤§é‡ç²¾è‰¯çš„ Lua åº“ã€ç¬¬ä¸‰æ–¹æ¨¡å—ä»¥åŠå¤§å¤šæ•°çš„ä¾èµ–é¡¹ã€‚ç”¨äºæ–¹ä¾¿åœ°æ­å»ºèƒ½å¤Ÿå¤„ç†è¶…é«˜å¹¶å‘ã€æ‰©å±•æ€§æé«˜çš„åŠ¨æ€ Web åº”ç”¨ã€Web æœåŠ¡å’ŒåŠ¨æ€ç½‘å…³ã€‚</p><p>OpenRestyÂ® é€šè¿‡æ±‡èšå„ç§è®¾è®¡ç²¾è‰¯çš„ Nginx æ¨¡å—ï¼ˆä¸»è¦ç”± OpenResty å›¢é˜Ÿè‡ªä¸»å¼€å‘ï¼‰ï¼Œä»è€Œå°† Nginx æœ‰æ•ˆåœ°å˜æˆä¸€ä¸ªå¼ºå¤§çš„é€šç”¨ Web åº”ç”¨å¹³å°ã€‚è¿™æ ·ï¼ŒWeb å¼€å‘äººå‘˜å’Œç³»ç»Ÿå·¥ç¨‹å¸ˆå¯ä»¥ä½¿ç”¨ Lua è„šæœ¬è¯­è¨€è°ƒåŠ¨ Nginx æ”¯æŒçš„å„ç§ C ä»¥åŠ Lua æ¨¡å—ï¼Œå¿«é€Ÿæ„é€ å‡ºè¶³ä»¥èƒœä»» 10K ä¹ƒè‡³ 1000K ä»¥ä¸Šå•æœºå¹¶å‘è¿æ¥çš„é«˜æ€§èƒ½ Web åº”ç”¨ç³»ç»Ÿã€‚</p><p>OpenRestyÂ® çš„ç›®æ ‡æ˜¯è®©ä½ çš„WebæœåŠ¡ç›´æ¥è·‘åœ¨ Nginx æœåŠ¡å†…éƒ¨ï¼Œå……åˆ†åˆ©ç”¨ Nginx çš„éé˜»å¡ I&#x2F;O æ¨¡å‹ï¼Œä¸ä»…ä»…å¯¹ HTTP å®¢æˆ·ç«¯è¯·æ±‚,ç”šè‡³äºå¯¹è¿œç¨‹åç«¯è¯¸å¦‚ MySQLã€PostgreSQLã€Memcached ä»¥åŠ Redis ç­‰éƒ½è¿›è¡Œä¸€è‡´çš„é«˜æ€§èƒ½å“åº”ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Distributed System</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2022/03/28/hello-world/"/>
    <url>/2022/03/28/hello-world/</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo server<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo generate<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo deploy<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>MapReduce</title>
    <link href="/2022/03/27/Computer%20Science/MapReduce/"/>
    <url>/2022/03/27/Computer%20Science/MapReduce/</url>
    
    <content type="html"><![CDATA[<p>MapReduce: Simplified Data Processing on Large Clusters</p><span id="more"></span><p><a href="https://www.cnblogs.com/YaoDD/p/6017397.html">åŸå§‹ç¿»è¯‘ç‰ˆæœ¬ç½‘å€ï¼šã€ŠMapReduce: Simplified Data Processing on Large Cluster ã€‹ç¿»è¯‘</a></p><h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p>MapReduce æ˜¯ä¸€ç§ç¼–ç¨‹æ¨¡å‹å’Œä¸€ç§ç”¨æ¥å¤„ç†å’Œäº§ç”Ÿå¤§æ•°æ®é›†çš„ç›¸å…³å®ç°ã€‚ç”¨æˆ·å®šä¹‰ map å‡½æ•°ï¼ˆmap functionï¼‰æ¥å¤„ç† key&#x2F;value é”®å€¼å¯¹æ¥äº§ç”Ÿä¸€ç³»åˆ—çš„ä¸­é—´çš„ key&#x2F;value é”®å€¼å¯¹ã€‚è¿˜è¦å®šä¹‰ä¸€ä¸ª reduce å‡½æ•°(reduce function)ç”¨æ¥åˆå¹¶æœ‰ç€ç›¸åŒä¸­é—´ key å€¼çš„ä¸­é—´ valueã€‚è®¸å¤šç°å®ä¸–ç•Œä¸­çš„ä»»åŠ¡éƒ½å¯ä»¥ç”¨è¿™ç§æ¨¡å‹æ¥è¡¨è¾¾ï¼Œå°±åƒä¸‹æ–‡æ‰€å±•ç¤ºçš„é‚£æ ·ã€‚</p><p>ç”¨è¿™ä¸ªé£æ ¼ï¼ˆå‡½æ•°å¼ï¼‰ç¼–å†™çš„ç¨‹åºå¯ä»¥è‡ªåŠ¨å¹¶è¡Œåœ°åœ¨å¤§è§„æ¨¡é›†ç¾¤ä¸Šå·¥ä½œã€‚è¿è¡Œæ—¶ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†ä¾‹å¦‚åˆ‡å‰²è¾“å…¥æ•°æ®ï¼Œåœ¨æœºå™¨ä¹‹é—´è°ƒåº¦ç¨‹åºçš„æ‰§è¡Œï¼Œå¤„ç†æœºå™¨æ•…éšœä»¥åŠç®¡ç†å¿…è¦çš„æœºå™¨é—´é€šä¿¡ç­‰ç»†èŠ‚é—®é¢˜ã€‚è¿™å¯ä»¥è®©é‚£äº›å¯¹äºå¹¶è¡Œåˆ†å¸ƒå¼ç³»ç»Ÿ<strong>æ²¡æœ‰ä»»ä½•ç»éªŒ</strong>çš„ç¨‹åºå‘˜ä¹Ÿèƒ½<strong>å¾ˆç®€å•</strong>åœ°åˆ©ç”¨èµ·ä¸€ä¸ªå¤§çš„åˆ†å¸ƒå¼ç³»ç»Ÿçš„èµ„æºã€‚</p><p>æˆ‘ä»¬çš„ MapReduce çš„å®ç°è¿è¡Œåœ¨ä¸€ä¸ªç”±å¤§çš„å•†ä¸šæœºæ„æˆçš„é›†ç¾¤å½“ä¸­å¹¶ä¸”æ˜¯é«˜åº¦å¯æ‰©å±•çš„ï¼šä¸€ä¸ªå…¸å‹çš„ MapReduce è®¡ç®—è¦åœ¨ä¸Šåƒå°æœºå™¨ä¸­å¤„ç† TB æ•°é‡çº§çš„æ•°æ®ã€‚ç¨‹åºå‘˜ä¼šè§‰å¾—è¿™ä¸ªç³»ç»Ÿéå¸¸å¥½ç”¨ï¼šå·²ç»æœ‰æˆåƒä¸Šä¸‡çš„ MapReduce ç¨‹åºè¢«å®ç°å‡ºæ¥å¹¶ä¸”æ¯å¤©æœ‰ä¸Šåƒä¸ª MapReduce ä»»åŠ¡è¿è¡Œåœ¨ Google çš„é›†ç¾¤ä¸Šã€‚</p><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>åœ¨è¿‡å»äº”å¹´ä¸­ï¼Œä½œè€…å’Œè®¸å¤š Google çš„å…¶ä»–äººå·²ç»å®ç°äº†æˆç™¾ä¸Šåƒä¸ªç”¨äºç‰¹æ®Šç›®çš„çš„è®¡ç®—ç¨‹åºç”¨äºå¤„ç†å¤§é‡çš„ raw dataï¼ˆå¦‚æŠ“å–æ–‡ä»¶ï¼ŒWeb è¯·æ±‚æ—¥å¿—ç­‰ï¼‰ï¼Œç”¨äºè®¡ç®—äº§ç”Ÿå„ç§å„æ ·çš„ derived dataï¼ˆå¦‚å€’æ’ç´¢å¼•ã€Web æ–‡ä»¶ç»“æ„çš„å›¾ç‰‡å±•ç¤ºã€æ¯ä¸ª host æŠ“å–çš„æ–‡ä»¶æ•°é‡æ€»ç»“ã€æŒ‡å®šæ—¥æœŸæœ€é¢‘ç¹çš„è®¿é—®è¯·æ±‚ç­‰ï¼‰ã€‚è®¸å¤šè¿™ç§è®¡ç®—ç¨‹åºåœ¨æ¦‚å¿µä¸Šéƒ½æ˜¯éå¸¸ç›´æ¥çš„ã€‚ç„¶è€Œè¾“å…¥çš„æ•°æ®é‡å¾€å¾€å¾ˆå¤§ï¼Œå¹¶ä¸”è®¡ç®—éœ€è¦åˆ†å¸ƒåœ¨æˆç™¾ä¸Šåƒå°æœºå™¨ä¸­ä¸ºäº†åœ¨ä¸€ä¸ªå¯æ¥å—çš„æ—¶é—´å†…å®Œæˆä»»åŠ¡ã€‚ä½†æ˜¯é™¤äº†ç®€å•çš„è®¡ç®—æ¨¡å‹ä»¥å¤–ï¼Œæˆ‘ä»¬éœ€è¦å¤§é‡å¤æ‚çš„ä»£ç ç”¨æ¥å¤„ç†ä¾‹å¦‚å¦‚ä½•å¹¶è¡ŒåŒ–è®¡ç®—ã€åˆ†å‘æ•°æ®ã€å¤„ç†æ•…éšœç­‰ç­‰é—®é¢˜ã€‚</p><p>ä¸ºäº†è§£å†³è¿™æ ·çš„å¤æ‚æ€§ï¼Œæˆ‘ä»¬è®¾è®¡äº†ä¸€ç§æ–°çš„æŠ½è±¡ï¼Œå®ƒè®©æˆ‘ä»¬åªéœ€è¦è¡¨ç¤ºå‡ºæˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„è®¡ç®—æ¨¡å‹ï¼Œè€Œå°†èƒŒåå¤æ‚çš„å¹¶è¡ŒåŒ–ï¼Œå®¹é”™ï¼Œæ•°æ®åˆ†å‘ï¼Œè´Ÿè½½å¹³è¡¡ç­‰ç­‰æŠ€æœ¯çš„å®ç°ç»†èŠ‚éšè—åœ¨äº†åº“ä¸­ã€‚æˆ‘ä»¬è¿™ç§æ–°çš„æŠ½è±¡æ˜¯å— Lisp ä»¥åŠå…¶ä»–ä¸€äº›å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ä¸­çš„ map å’Œ reduce åŸè¯­å½±å“è€Œæ¥çš„ã€‚æˆ‘ä»¬æ„è¯†åˆ°ä¸ºäº†è®¡ç®—å‡ºä¸€ç³»åˆ—çš„ä¸­é—´é”®å€¼å¯¹ï¼Œè®¸å¤šçš„è®¡ç®—éƒ½éœ€è¦å¯¹äºè¾“å…¥ä¸­çš„æ¯ä¸ªé€»è¾‘â€œè®°å½•â€è¿›è¡Œ map æ“ä½œã€‚ç„¶åè¿˜éœ€è¦å¯¹æ‰€æœ‰å…±äº«åŒä¸€ä¸ª key çš„ value è¿›è¡Œ reduce æ“ä½œï¼Œä»è€Œèƒ½å¤Ÿå¯¹æ´¾ç”Ÿçš„æ•°æ®è¿›è¡Œé€‚å½“çš„ç»„åˆã€‚æˆ‘ä»¬è¿™ç§è®©ç”¨æˆ·è‡ªå®šä¹‰ map å’Œ reduce æ“ä½œçš„ç¼–ç¨‹æ¨¡å‹èƒ½å¤Ÿè®©æˆ‘ä»¬ç®€å•åœ°å¯¹å¤§é‡æ•°æ®å®ç°å¹¶è¡ŒåŒ–ï¼Œå¹¶ä¸”ä½¿ç”¨é‡æ–°æ‰§è¡Œï¼ˆre-executionï¼‰ä½œä¸ºä¸»è¦çš„å®¹é”™æœºåˆ¶ã€‚</p><p>æˆ‘ä»¬è¿™é¡¹å·¥ä½œçš„ä¸»è¦å…±äº«æ˜¯æä¾›äº†ä¸€ä¸ªç®€å•å¹¶ä¸”å¼ºå¤§çš„æ¥å£èƒ½å¤Ÿè®©æˆ‘ä»¬å®ç°è‡ªåŠ¨çš„å¹¶è¡ŒåŒ–å¹¶ä¸”åˆ†å¸ƒå¤„ç†å¤§è§„æ¨¡çš„è®¡ç®—ï¼ŒåŒæ—¶è¯¥æ¥å£çš„å®ç°èƒ½åœ¨å¤§å‹çš„å•†ç”¨ PC é›†ç¾¤ä¸Šè·å¾—éå¸¸é«˜çš„æ€§èƒ½ã€‚</p><p>Section 2 æè¿°äº†åŸºæœ¬çš„ç¼–ç¨‹æ¨¡å‹ä»¥åŠä¸€äº›ç®€å•çš„ä¾‹å­ã€‚Section 3 æè¿°äº†ä¸ºæˆ‘ä»¬çš„åŸºäºé›†ç¾¤çš„è®¡ç®—ç¯å¢ƒé‡èº«å®šåšçš„ MapReduce æ¥å£ã€‚Section 4 æè¿°äº†ä¸€äº›æˆ‘ä»¬è®¤ä¸ºæœ‰ç”¨çš„å¯¹äºç¼–ç¨‹æ¨¡å‹çš„æ”¹è¿›ã€‚Section 5 æ˜¯å¯¹æˆ‘ä»¬çš„å®ç°åœ¨ä¸åŒä»»åŠ¡ä¸‹çš„æ€§èƒ½æµ‹è¯•ã€‚Section 6 åŒ…å«äº† MapReduce åœ¨ Google å†…çš„ä½¿ç”¨æƒ…å†µï¼ŒåŒ…æ‹¬æˆ‘ä»¬ä»¥å®ƒä¸ºåŸºç¡€é‡å†™æˆ‘ä»¬çš„äº§å“ç´¢å¼•ç³»ç»Ÿçš„ç»éªŒã€‚Section 7 è®¨è®ºäº†ç›¸å…³çš„å·¥ä½œä»¥åŠæœªæ¥çš„å‘å±•ã€‚</p><h2 id="Programming-Model"><a href="#Programming-Model" class="headerlink" title="Programming Model"></a>Programming Model</h2><p>è®¡ç®—æ¨¡å‹ä»¥ä¸€ç³»åˆ—çš„é”®å€¼å¯¹ä½œä¸ºè¾“å…¥å¹¶äº§ç”Ÿä¸€ç³»åˆ—çš„é”®å€¼å¯¹ä½œä¸ºè¾“å‡ºã€‚MapReduce åº“çš„ç”¨æˆ·ä»¥â€œMapâ€å’Œâ€Reduceâ€ä¸¤ä¸ªå‡½æ•°æ¥è¡¨è¾¾è®¡ç®—ã€‚</p><p><strong>Map</strong>ï¼Œæ˜¯ç”±ç”¨æˆ·ç¼–å†™çš„ï¼Œå–ä¸€ä¸ªè¾“å…¥å¯¹ï¼Œå¹¶ä¸”äº§ç”Ÿä¸€ç³»åˆ—ä¸­é—´çš„é”®å€¼å¯¹ã€‚MapReduce åº“å°†é‚£äº›å…·æœ‰ç›¸åŒçš„ä¸­é—´é”®Içš„ä¸­é—´å€¼èšé›†åœ¨ä¸€èµ·ï¼Œç„¶åå°†å®ƒä»¬ä¼ é€’ç»™ Reduce å‡½æ•°ã€‚</p><p><strong>Reduce</strong>ï¼ŒåŒæ ·æ˜¯ç”±ç”¨æˆ·ç¼–å†™çš„ï¼Œæ¥æ”¶ä¸€ä¸ªä¸­é—´é”®Iå’Œè¯¥é”®å¯¹åº”çš„ä¸€ç³»åˆ—çš„ä¸­é—´å€¼ã€‚Reduce å‡½æ•°é€šè¿‡å°†è¿™äº›å€¼åˆå¹¶æ¥ç»„æˆä¸€ä¸ªå¯èƒ½æ›´å°çš„é›†åˆï¼ˆå€¼çš„é›†åˆï¼‰ã€‚é€šå¸¸æ¯ä¸ª Reduce å‡½æ•°åªäº§ç”Ÿ 0 ä¸ªæˆ– 1 ä¸ªè¾“å‡ºå€¼ã€‚Reduce å‡½æ•°ä¸€èˆ¬é€šè¿‡ä¸€ä¸ªè¿­ä»£å™¨ï¼ˆvia an iteratorï¼‰æ¥è·å–ä¸­é—´å€¼ï¼Œä»è€Œåœ¨ä¸­é—´å€¼çš„æ•°ç›®è¿œè¿œå¤§äºå†…å­˜å®¹é‡æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½å¤Ÿå¤„ç†ã€‚</p><h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><p>ä¸‹é¢æ¥è€ƒè™‘è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šç»Ÿè®¡å¤§é‡æ–‡æ¡£ä¸­æ¯ä¸€ä¸ªå•è¯å‡ºç°çš„æ¬¡æ•°ã€‚å¯¹æ­¤ï¼Œç”¨æˆ·éœ€è¦ç¼–å†™ç±»ä¼¼äºå¦‚ä¸‹çš„ä¼ªä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">map</span>(String key, String value):<br>ã€€ã€€ã€€ã€€<span class="hljs-comment">// key: document name</span><br>ã€€ã€€ã€€ã€€<span class="hljs-comment">// value: document contents</span><br>ã€€ã€€ã€€ã€€<span class="hljs-keyword">for</span> each word w in value:<br>ã€€ã€€ã€€ã€€ã€€ã€€EmitIntermediate(w, <span class="hljs-string">&quot;1&quot;</span>);<br><br>ã€€ã€€reduce(String key, Iterator values):<br>ã€€ã€€ã€€ã€€<span class="hljs-comment">// key: a word</span><br>ã€€ã€€ã€€ã€€<span class="hljs-comment">// values: a list of counts</span><br>ã€€ã€€ã€€ã€€<span class="hljs-type">int</span> result = <span class="hljs-number">0</span>;<br>ã€€ã€€ã€€ã€€<span class="hljs-keyword">for</span> each v in values:<br>ã€€ã€€ã€€ã€€ã€€ã€€result += ParseInt(v);<br>ã€€ã€€ã€€ã€€Emit(AsString(result));<br></code></pre></td></tr></table></figure><p>Map å‡½æ•°ä¸ºåœ¨æ¯ä¸€ä¸ªå•è¯å‡ºç°çš„æ—¶å€™ï¼Œä¸ºå®ƒåŠ ä¸Šä¸€ä¸ªè®¡æ•°ï¼ˆåœ¨è¿™ä¸ªç®€å•çš„ä¾‹å­ä¸­å°±æ˜¯åŠ  1ï¼‰ã€‚Reduce å‡½æ•°å¯¹æ¯ä¸ªå•è¯ï¼ˆä½œä¸ºä¸­é—´é”®å€¼å¯¹çš„é”®ï¼‰çš„æ‰€æœ‰è®¡æ•°è¿›è¡Œå åŠ ã€‚</p><p>å¦å¤–ï¼Œç”¨æˆ·éœ€è¦ç”¨è¾“å…¥è¾“å‡ºæ–‡ä»¶çš„åå­—ï¼Œä»¥åŠä¸€ä¸ªå¯é€‰çš„ tuning paramete å» fill in ä¸€ä¸ªå« mapreduce specification çš„å¯¹è±¡ã€‚ä¹‹åï¼Œç”¨æˆ·è°ƒç”¨ MapReduce å‡½æ•°ï¼Œå°†ä¸Šè¿°å®šä¹‰çš„å¯¹è±¡ä¼ é€’è¿›å»ã€‚ç”¨æˆ·çš„ä»£ç å°†å’Œ MapReduce åº“ç›¸è¿ï¼ˆç”± C++å®ç°ï¼‰ã€‚Appendix A ä¸­æœ‰è¿™ä¸ªä¾‹å­æ‰€æœ‰çš„ä»£ç æ–‡æ¡£ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">map</span>     (k1,v1)  -&gt;  <span class="hljs-built_in">list</span>(k2,v2)<br>reduce  (k2,<span class="hljs-built_in">list</span>(v2)) -&gt; <span class="hljs-built_in">list</span>(v2)<br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¾“å…¥çš„ key å’Œ value ä¸è¾“å‡ºçš„ key å’Œ value æ˜¯ä¸åŒçš„ç±»å‹ï¼Œè€Œä¸­é—´çš„ key å’Œ value ä¸è¾“å‡ºçš„ key å’Œ value æ˜¯ç›¸åŒçš„ç±»å‹ï¼ˆç”¨ k1 å’Œ k2 è¡¨ç¤ºï¼‰ã€‚æˆ‘ä»¬çš„ C++å®ç°éƒ½æ˜¯ä»¥å­—ç¬¦ä¸²çš„å½¢å¼å’Œç”¨æˆ·ä»£ç è¿›è¡Œäº¤äº’çš„ï¼Œè‡³äºå°†å­—ç¬¦ä¸²ç±»å‹è½¬æ¢æˆç›¸åº”åˆé€‚çš„ç±»å‹çš„å·¥ä½œåˆ™ç”±ç”¨æˆ·ä»£ç æ¥å®Œæˆäº†ã€‚</p><h3 id="More-Example"><a href="#More-Example" class="headerlink" title="More Example"></a>More Example</h3><p>æ¥ä¸‹æ¥æ˜¯ä¸€äº›èƒ½å¤Ÿç®€å•åœ°ç”¨ MapReduce è®¡ç®—æ¨¡å‹è¿›è¡Œè¡¨è¾¾çš„ä¾‹å­</p><p>Distributed Grepï¼ˆåˆ†å¸ƒå¼æŸ¥æ‰¾ï¼‰ï¼šMap å‡½æ•°è·å–åŒ¹é…æä¾›çš„æ¨¡å¼çš„è¡Œï¼ŒReduce å‡½æ•°åªæ˜¯ç®€å•åœ°å°†è¿™äº›ä¸­é—´æ•°æ®æ‹·è´åˆ°è¾“å‡ºã€‚</p><p>Count of URL Access Frequencyï¼ˆè®¡ç®— URL è®¿é—®é¢‘ç‡ï¼‰ï¼šMap å‡½æ•°å¤„ç† web è¯·æ±‚çš„æ—¥å¿—ï¼Œå¹¶ä¸”è¾“å‡ºã€‚Reduce å‡½æ•°å°†æ‹¥æœ‰ç›¸åŒ URL çš„ value ç›¸åŠ ï¼Œå¾—åˆ°å¯¹</p><p>Reverse Web-Link Graphï¼šMap å‡½æ•°è¾“å‡ºå¯¹ï¼Œå…¶ä¸­ source æ‰€åœ¨çš„ page éƒ½æœ‰è¿å‘ target è¿™ä¸ª URL çš„é“¾æ¥ã€‚Reduce å‡½æ•°å°†ç»™å®š target çš„æ‰€æœ‰çš„ source URL è¿æ¥èµ·æ¥ï¼Œè¾“å‡ºå¯¹</p><p>Term-Vector per Hostï¼šä¸€ä¸ª term vector è¡¨ç¤ºä¸€ç³»åˆ—çš„é”®å€¼å¯¹ï¼Œword è¡¨ç¤ºä¸€ç¯‡æˆ–è€…ä¸€ç³»åˆ—æ–‡ç« ä¸­å‡ºç°çš„æ¯”è¾ƒé‡è¦çš„å•è¯ï¼Œfrequency è¡¨ç¤ºå®ƒä»¬å‡ºç°çš„æ¬¡æ•°ã€‚Map å‡½æ•°å¯¹äºæ¯ç¯‡è¾“å…¥çš„æ–‡ç« è¾“å‡ºé”®å€¼å¯¹ï¼ˆå…¶ä¸­ hostname æ˜¯ä»æ–‡ç« æ‰€åœ¨çš„ URL ä¸­æŠ½å–å‡ºæ¥çš„ï¼‰Reduce å‡½æ•°è·å–ç»™å®š host çš„ term vectorsã€‚å®ƒå°†è¿™äº› term vectors ç´¯åŠ èµ·æ¥ï¼Œä¸¢å¼ƒéé¢‘ç¹å‡ºç°çš„ termï¼Œå¹¶äº§ç”Ÿä¸€ä¸ªæœ€ç»ˆçš„å¯¹ã€‚</p><p>Inverted Indexï¼šMap å‡½æ•°å¯¹æ¯ç¯‡æ–‡ç« è¿›è¡Œå¤„ç†ï¼Œå¹¶è¾“å‡ºä¸€ç³»åˆ—çš„å¯¹ã€‚Reduce å‡½æ•°æ¥æ”¶ç»™å®š word çš„æ‰€æœ‰é”®å€¼å¯¹ï¼Œå¯¹ç›¸åº”çš„ document ID è¿›è¡Œæ’åºå¹¶ä¸”è¾“å‡º&gt;å¯¹ã€‚æ‰€æœ‰è¾“å‡ºå¯¹çš„é›†åˆæ„æˆäº†ä¸€ä¸ªç®€å•çš„å€’æ’ç´¢å¼•ã€‚ç”¨äº† MapReduce æ¨¡å‹ï¼Œå¯¹å•è¯ä½ç½®çš„è¿½è¸ªå°±å˜å¾—éå¸¸ç®€å•äº†ã€‚</p><p>Distributed Sortï¼šMap å‡½æ•°ä»æ¯ä¸ª record ä¸­æŠ½å–å‡º keyï¼Œäº§ç”Ÿé”®å€¼å¯¹ã€‚Reduce å‡½æ•°åªæ˜¯ç®€å•åœ°å°†æ‰€æœ‰å¯¹è¾“å‡ºã€‚è¿™ä¸ªè®¡ç®—æ¨¡å‹ä¾èµ–äº Section 4.1 ä¸­æè¿°çš„åˆ’åˆ†æŠ€å·§ä»¥åŠ Section 4.2 ä¸­æè¿°çš„æ’åºç‰¹æ€§ã€‚</p><p>ï¼ˆä¸Šè¿°å¯ä»¥å…¨éƒ¨ç†è§£äº†ï¼‰</p><h2 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h2><p>å¯¹äº MapReduce çš„æ¥å£ï¼Œå„ç§å„æ ·ä¸åŒçš„å®ç°éƒ½æ˜¯å¯èƒ½çš„ã€‚æ‰€æœ‰æ­£ç¡®çš„é€‰æ‹©éƒ½æ˜¯åŸºäºå½“ä¸‹ç¯å¢ƒçš„ã€‚æ¯”å¦‚ï¼Œä¸€ç§å®ç°å¯èƒ½é€‚åˆäºå°çš„å…±äº«å†…å­˜çš„æœºå™¨ï¼Œå¦ä¸€ç§å¯èƒ½é€‚åˆäºå¤§å‹çš„ NUMA å¤šå¤„ç†å™¨æœºå™¨ï¼Œç”šè‡³æœ‰çš„æ˜¯ä¸ºæ›´å¤§çš„äº’è”çš„æœºå™¨é›†ç¾¤è®¾è®¡çš„ã€‚</p><p>æœ¬èŠ‚ä¸­æè¿°çš„å®ç°åŸºäºçš„æ˜¯ Google ä¸­æœ€å¸¸ç”¨çš„è®¡ç®—ç¯å¢ƒï¼šä¸€ä¸ªç”±å¤§é‡å•†ç”¨ PC æœºé€šè¿‡äº¤æ¢ä»¥å¤ªç½‘äº’è”çš„é›†ç¾¤ã€‚åœ¨æˆ‘ä»¬çš„ç¯å¢ƒä¸­ï¼š</p><ol><li>æœºå™¨é€šå¸¸éƒ½æ˜¯ x86 çš„åŒæ ¸å¤„ç†å™¨ï¼Œå…¶ä¸Šè¿è¡Œ Linuxï¼Œæ¯å°æœºå™¨æ‹¥æœ‰ 2-4G çš„å†…å­˜</li><li>å•†ç”¨ç½‘ç»œç¡¬ä»¶â€”-é€šå¸¸æ˜¯ 100 M&#x2F;s æˆ–è€… 1 G&#x2F;sï¼Œä½†æ˜¯ç»¼åˆèµ·æ¥è¦å°äºå¹³å‡å¸¦å®½</li><li>ä¸€ä¸ªé›†ç¾¤ç”±æˆåƒä¸Šä¸‡å°æœºå™¨ç»„æˆï¼Œå› æ­¤æœºå™¨æ•…éšœæ˜¯å¸¸æœ‰çš„äº‹</li><li>å­˜å‚¨ç”±ä¾¿å®œçš„ IDE ç£ç›˜æä¾›ï¼Œå®ƒä»¬éƒ½ä¸ç‹¬ç«‹çš„æœºå™¨ç›´æ¥ç›¸è¿ã€‚ä¸€ä¸ªå†…éƒ¨ç ”å‘çš„æ–‡ä»¶ç³»ç»Ÿç”¨äºç®¡ç†æ‰€æœ‰å­˜å‚¨äºè¿™äº›ç¡¬ç›˜ä¸Šçš„æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶ç³»ç»Ÿé€šè¿‡ Replication åœ¨ä¸å¯é çš„ç¡¬ä»¶ä¸Šæä¾›äº†å¯ç”¨æ€§å’Œå¯é æ€§</li><li>ç”¨æˆ·æäº¤ jobs ç»™è°ƒåº¦ç³»ç»Ÿã€‚æ¯ä¸ª job ç”±ä¸€ç³»åˆ—çš„ task ç»„æˆï¼Œå¹¶ä¸”ç”±è°ƒåº¦å™¨åˆ†é…åˆ°é›†ç¾¤ä¸­ä¸€ç³»åˆ—å¯ç”¨çš„æœºå™¨ä¸Š</li></ol><h3 id="Execution-Overview"><a href="#Execution-Overview" class="headerlink" title="Execution Overview"></a>Execution Overview</h3><p>é€šè¿‡å°†è¾“å…¥æ•°æ®è‡ªåŠ¨åˆ†å‰²æˆ M ä»½ï¼ŒMap å‡½æ•°å¾—ä»¥åœ¨å¤šå°æœºå™¨ä¸Šåˆ†å¸ƒå¼æ‰§è¡Œã€‚æ¯ä¸€ä¸ªè¾“å…¥å—éƒ½èƒ½å¹¶è¡Œåœ°åœ¨ä¸åŒçš„æœºå™¨ä¸Šæ‰§è¡Œã€‚é€šè¿‡åˆ’åˆ†å‡½æ•°(ä¾‹å¦‚ï¼Œhash(key) mod R)å°†ä¸­é—´é”®åˆ’åˆ†ä¸º R ä»½ï¼ŒReduce å‡½æ•°ä¹Ÿèƒ½è¢«åˆ†å¸ƒå¼åœ°è°ƒç”¨ã€‚å…¶ä¸­åˆ’åˆ†çš„æ•°ç›® R å’Œåˆ’åˆ†å‡½æ•°éƒ½æ˜¯ç”±ç”¨æˆ·æŒ‡å®šçš„ã€‚</p><p><img src="/image/MapReduce/OS_3_1-20220327162940686.png" alt="OS_3_1"></p><p>ä¸Šå›¾ 1 å±•ç¤ºäº†åœ¨æˆ‘ä»¬çš„å®ç°ä¸­ MapReduce å…¨éƒ¨çš„æµç¨‹ã€‚å½“ç”¨æˆ·ç¨‹åºè°ƒç”¨ MapReduce å‡½æ•°æ—¶ï¼Œæ¥ä¸‹æ¥çš„åŠ¨ä½œå°†æŒ‰åºå‘ç”Ÿï¼ˆå›¾ 1 ä¸­æ ‡è®°çš„æ•°å­—ä¸ä¸‹é¢çš„æ•°å­—æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼‰ï¼š</p><ol><li>ç”¨æˆ·ç¨‹åºä¸­çš„ MapReduce åº“é¦–å…ˆå°†è¾“å…¥æ–‡ä»¶åˆ’åˆ†ä¸ºMç‰‡ï¼Œæ¯ç‰‡å¤§å°ä¸€èˆ¬åœ¨ 16MB åˆ° 64MB ä¹‹é—´ï¼ˆç”±ç”¨æˆ·é€šè¿‡ä¸€ä¸ªå¯é€‰çš„å‚æ•°æŒ‡å®šï¼‰ã€‚ä¹‹åï¼Œå®ƒåœ¨é›†ç¾¤çš„å¾ˆå¤šå°æœºå™¨ä¸Šéƒ½å¯åŠ¨äº†ç›¸åŒçš„ç¨‹åºæ‹·è´ã€‚</li><li>å…¶ä¸­æœ‰ä¸€ä¸ªæ‹·è´ç¨‹åºæ˜¯ç‰¹åˆ«çš„â€”â€”masterã€‚å‰©ä¸‹çš„éƒ½æ˜¯ workerï¼Œå®ƒä»¬æ¥æ”¶ master åˆ†é…çš„ä»»åŠ¡ã€‚å…¶ä¸­æœ‰ M ä¸ª Map ä»»åŠ¡å’Œ R ä¸ª Reduce ä»»åŠ¡è¦åˆ†é…ã€‚master æŒ‘é€‰ä¸€ä¸ªç©ºé—²çš„ worker å¹¶ä¸”ç»™å®ƒåˆ†é…ä¸€ä¸ª map ä»»åŠ¡æˆ–è€… reduce ä»»åŠ¡ã€‚</li><li>è¢«åˆ†é…åˆ° Map ä»»åŠ¡çš„ worker ä¼šå»è¯»å–ç›¸åº”çš„è¾“å…¥å—çš„å†…å®¹ã€‚å®ƒä»è¾“å…¥æ–‡ä»¶ä¸­è§£æå‡ºé”®å€¼å¯¹å¹¶ä¸”å°†æ¯ä¸ªé”®å€¼å¯¹ä¼ é€ç»™ç”¨æˆ·å®šä¹‰çš„ Map å‡½æ•°ã€‚è€Œç”± Map å‡½æ•°äº§ç”Ÿçš„ä¸­é—´é”®å€¼å¯¹ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚</li><li>è¢«ç¼“å­˜çš„é”®å€¼å¯¹ä¼šé˜¶æ®µæ€§åœ°å†™å›æœ¬åœ°ç£ç›˜ï¼Œå¹¶ä¸”è¢«åˆ’åˆ†å‡½æ•°åˆ†å‰²æˆ R ä»½ã€‚è¿™äº›ç¼“å­˜å¯¹åœ¨ç£ç›˜ä¸Šçš„ä½ç½®ä¼šè¢«å›ä¼ ç»™ masterï¼Œmaster å†è´Ÿè´£å°†è¿™äº›ä½ç½®è½¬å‘ç»™ Reduce workerã€‚</li><li>å½“ Reduce worker ä» master é‚£é‡Œæ¥æ”¶åˆ°è¿™äº›ä½ç½®ä¿¡æ¯æ—¶ï¼Œå®ƒä¼šä½¿ç”¨è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ä» Map worker çš„æœ¬åœ°ç£ç›˜ä¸­è·å–ç¼“å­˜çš„æ•°æ®ã€‚å½“ Reduce worker è¯»å…¥å…¨éƒ¨çš„ä¸­é—´æ•°æ®ä¹‹åï¼Œå®ƒä¼šæ ¹æ®ä¸­é—´é”®å¯¹å®ƒä»¬è¿›è¡Œæ’åºï¼Œè¿™æ ·æ‰€æœ‰å…·æœ‰ç›¸åŒé”®çš„é”®å€¼å¯¹å°±éƒ½èšé›†åœ¨ä¸€èµ·äº†ã€‚æ’åºæ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºä¼šæœ‰è®¸å¤šä¸åŒçš„é”®è¢«æ˜ å°„åˆ°åŒä¸€ä¸ª reduce task ä¸­ã€‚å¦‚æœä¸­é—´æ•°æ®çš„æ•°é‡å¤ªå¤§ï¼Œä»¥è‡³äºä¸èƒ½å¤Ÿè£…å…¥å†…å­˜çš„è¯ï¼Œè¿˜éœ€è¦å¦å¤–çš„æ’åºã€‚</li><li>Reduce worker éå†å·²ç»æ’å®Œåºçš„ä¸­é—´æ•°æ®ã€‚æ¯å½“é‡åˆ°ä¸€ä¸ªæ–°çš„ä¸­é—´é”®ï¼Œå®ƒä¼šå°† key å’Œç›¸åº”çš„ä¸­é—´å€¼ä¼ é€’ç»™ç”¨æˆ·å®šä¹‰çš„ Reduce å‡½æ•°ã€‚Reduce å‡½æ•°çš„è¾“å‡ºä¼šè¢«æ·»åŠ åˆ°è¿™ä¸ª Reduce éƒ¨åˆ†çš„è¾“å‡ºæ–‡ä»¶ä¸­ã€‚</li><li>å½“æ‰€æœ‰çš„ Map tasks å’Œ Reduce tasks éƒ½å·²ç»å®Œæˆçš„æ—¶å€™ï¼Œmaster å°†å”¤é†’ç”¨æˆ·ç¨‹åºã€‚åˆ°æ­¤ä¸ºæ­¢ï¼Œç”¨æˆ·ä»£ç ä¸­çš„ MapReduce è°ƒç”¨è¿”å›ã€‚</li></ol><p>å½“æˆåŠŸæ‰§è¡Œå®Œä¹‹åï¼ŒMapReduce çš„æ‰§è¡Œç»“æœè¢«å­˜æ”¾åœ¨ R ä¸ªè¾“å‡ºæ–‡ä»¶ä¸­ï¼ˆæ¯ä¸ª Reduce task å¯¹åº”ä¸€ä¸ªï¼Œæ–‡ä»¶åç”±ç”¨æˆ·æŒ‡å®šï¼‰ã€‚é€šå¸¸ç”¨æˆ·å¹¶ä¸éœ€è¦å°† R ä¸ªè¾“å‡ºæ–‡ä»¶å½’å¹¶æˆä¸€ä¸ªã€‚å› ä¸ºå®ƒä»¬é€šå¸¸å°†è¿™äº›æ–‡ä»¶ä½œä¸ºå¦ä¸€ä¸ª MapReduce è°ƒç”¨çš„è¾“å…¥ï¼Œæˆ–è€…å°†å®ƒä»¬ç”¨äºå¦å¤–ä¸€ä¸ªèƒ½å¤Ÿä»¥å¤šä¸ªæ–‡ä»¶ä½œä¸ºè¾“å…¥çš„åˆ†å¸ƒå¼åº”ç”¨ã€‚</p><p>ï¼ˆä¸ªäººç†è§£ï¼šmodule R å°†ä¸­é—´é”®å€¼å¯¹åˆ†ä¸º R ä»½ä¸€æ–¹é¢æ˜¯ä¸ºäº†æ‰§è¡Œ Reduce work çš„å¤„ç†å™¨è¿›è¡Œåˆ†å¸ƒå¼å¹¶è¡Œè®¡ç®—ï¼Œå¦ä¸€æ–¹é¢ï¼Œäº§ç”Ÿçš„åˆ†å¸ƒå¼æ•°æ®ä¹Ÿå¯ä»¥æ¥ç€ç”¨äºå…¶ä»–èƒ½ä»¥å¤šæ–‡ä»¶ä¸ºè¾“å…¥çš„åˆ†å¸ƒå¼åº”ç”¨ã€‚ï¼‰</p><h3 id="Master-Data-Structures"><a href="#Master-Data-Structures" class="headerlink" title="Master Data Structures"></a>Master Data Structures</h3><p>åœ¨ master ä¸­ä¿å­˜äº†è®¸å¤šçš„æ•°æ®ç»“æ„ã€‚å¯¹äºæ¯ä¸ª Map task å’Œ Reduce taskï¼Œmaster éƒ½ä¿å­˜äº†å®ƒä»¬çš„çŠ¶æ€ï¼ˆidleï¼Œin-progress æˆ–è€…æ˜¯ completedï¼‰ä»¥åŠ worker æ‰€åœ¨æœºå™¨çš„æ ‡è¯†ï¼ˆå¯¹äºé idle ç©ºè½¬çŠ¶æ€çš„ tasks è€Œè¨€ï¼‰ã€‚</p><p>master ç›¸å½“äºæ˜¯ä¸€ä¸ªç®¡é“ï¼Œé€šè¿‡å®ƒ Map task æ‰€äº§ç”Ÿçš„ä¸­é—´æ–‡ä»¶è¢«ä¼ é€’ç»™äº† Reduce taskã€‚å› æ­¤ï¼Œå¯¹äºæ¯ä¸€ä¸ªå·²ç»å®Œæˆçš„ Map taskï¼Œmaster ä¼šå­˜å‚¨ç”±å®ƒäº§ç”Ÿçš„ R ä¸ªä¸­é—´æ–‡ä»¶çš„ä½ç½®å’Œå¤§å°ï¼ˆåˆ†é…ç»™ R ä¸ª Reduce task æ‰§è¡Œï¼Œéœ€è¦è¿œç¨‹è¯»å–è¿™äº›æ•°æ®ï¼Œæ‰€ä»¥è¦è®°å½•ä½ç½®å’Œå¤§å°ï¼‰ã€‚å½“ Map task å®Œæˆçš„æ—¶å€™ï¼Œmaster å°±ä¼šæ”¶åˆ°ä½ç½®å’Œå¤§å°çš„æ›´æ–°ä¿¡æ¯ã€‚è€Œè¿™äº›ä¿¡æ¯æ¥ä¸‹æ¥å°±ä¼šé€æ¸è¢«æ¨é€åˆ°å¤„äº in-progress çŠ¶æ€çš„ Reduce task ä¸­ã€‚</p><h3 id="Fault-Tolerance"><a href="#Fault-Tolerance" class="headerlink" title="Fault Tolerance"></a>Fault Tolerance</h3><p>å®¹é”™å¤„ç†</p><p>å› ä¸º MapReduce åº“çš„è®¾è®¡åˆè¡·æ˜¯ç”¨æˆåƒä¸Šä¸‡çš„æœºå™¨å»å¤„ç†å¤§é‡çš„æ•°æ®ï¼Œæ‰€ä»¥å®ƒå°±å¿…é¡»èƒ½ç”¨ä¼˜é›…çš„æ–¹å¼å¯¹æœºå™¨æ•…éšœè¿›è¡Œå¤„ç†ã€‚</p><h4 id="Worker-Failure"><a href="#Worker-Failure" class="headerlink" title="Worker Failure"></a>Worker Failure</h4><p>master ä¼šå‘¨æœŸæ€§åœ° ping æ¯ä¸€ä¸ª workerã€‚å¦‚æœç»è¿‡äº†ä¸€ä¸ªç‰¹å®šçš„æ—¶é—´è¿˜æœªä»æŸä¸€ä¸ª worker ä¸Šè·å¾—å“åº”ï¼Œé‚£ä¹ˆ master ä¼šå°† worker æ ‡è®°ä¸º failedã€‚æ‰€æœ‰ç”±è¯¥ worker å®Œæˆçš„ Map task éƒ½è¢«å›é€€ä¸º idle çŠ¶æ€ï¼Œå› æ­¤èƒ½å¤Ÿè¢«é‡æ–°è°ƒåº¦åˆ°å…¶ä»–çš„ worker ä¸Šã€‚åŒæ ·çš„ï¼Œæ‰€æœ‰ failed worker æ­£åœ¨æ‰§è¡Œçš„ Map task æˆ–è€… Reduce task ä¹Ÿä¼šè¢«å›é€€ä¸º idle çŠ¶æ€ï¼Œå¹¶ä¸”è¢«é‡æ–°è°ƒåº¦ã€‚</p><p><strong>å‘ç”Ÿæ•…éšœçš„æœºå™¨ä¸Šå·²ç»å®Œæˆçš„ Map task éœ€è¦é‡æ–°æ‰§è¡Œçš„åŸå› æ˜¯ï¼Œå®ƒä»¬çš„è¾“å…¥æ˜¯ä¿å­˜åœ¨æœ¬åœ°ç£ç›˜çš„ï¼Œå› æ­¤å‘ç”Ÿæ•…éšœä¹‹åå°±ä¸èƒ½è·å–äº†ã€‚è€Œå·²ç»å®Œæˆçš„ Reduce task å¹¶ä¸éœ€è¦è¢«é‡æ–°æ‰§è¡Œï¼Œå› ä¸ºå®ƒä»¬çš„è¾“å‡ºæ˜¯å­˜æ”¾åœ¨å…¨å±€çš„æ–‡ä»¶ç³»ç»Ÿä¸­çš„ã€‚</strong></p><p>å½“ä¸€ä¸ª Map task å¼€å§‹ç”± worker A æ‰§è¡Œï¼Œåæ¥åˆç”± worker B æ‰§è¡Œï¼ˆå› ä¸º A æ•…éšœäº†ï¼‰ã€‚æ‰€æœ‰æ‰§è¡Œ Reduce task çš„ worker éƒ½ä¼šæ”¶åˆ°è¿™ä¸ªé‡æ–°æ‰§è¡Œçš„é€šçŸ¥ã€‚é‚£äº›è¿˜æœªä» worker A ä¸­è¯»å–æ•°æ®çš„ Reduce task å°†ä¼šä» worker B ä¸­è¯»å–æ•°æ®ã€‚</p><p>MapReduce å¯¹äºå¤§é¢ç§¯çš„æœºå™¨æ•…éšœæ˜¯éå¸¸å…·æœ‰å¼¹æ€§çš„ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€æ¬¡ MapReduce æ“ä½œä¸­ï¼Œç½‘ç»œç»´æŠ¤é€ æˆäº†é›†ç¾¤ä¸­å…«åå°æœºå™¨åœ¨å‡ åˆ†é’Ÿçš„æ—¶é—´å†…å¤„äºä¸å¯è¾¾çš„çŠ¶æ€ã€‚MapReduce çš„ master åªæ˜¯ç®€å•åœ°å°†ä¸å¯è¾¾çš„ worker æœºå™¨ä¸Šçš„å·¥ä½œé‡æ–°æ‰§è¡Œäº†ä¸€éï¼Œæ¥ç€å†ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œæœ€ç»ˆå®Œæˆäº† MapReduce çš„æ“ä½œã€‚</p><h4 id="Master-Failure"><a href="#Master-Failure" class="headerlink" title="Master Failure"></a>Master Failure</h4><p>å¯¹äº masterï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°å¯¹ä¸Šæ–‡æ‰€è¿°çš„ master æ•°æ®ç»“æ„åšå‘¨æœŸæ€§çš„å¿«ç…§ã€‚å¦‚æœä¸€ä¸ª master task æ­»äº†ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¿«åœ°æ ¹æ®æœ€æ–°çš„å¿«ç…§æ¥é‡æ–°å¯åŠ¨ä¸€ä¸ª master taskã€‚ä½†æ˜¯ï¼Œå› ä¸ºæˆ‘ä»¬åªæœ‰ä¸€ä¸ª masterï¼Œå› æ­¤æ•…éšœçš„æ¦‚ç‡æ¯”è¾ƒä½ã€‚æ‰€ä»¥ï¼Œåœ¨æˆ‘ä»¬çš„å®ç°ä¸­å¦‚æœ master å‡ºç°äº†æ•…éšœå°±åªæ˜¯ç®€å•åœ°åœæ­¢ MapReduce æ“ä½œã€‚ç”¨æˆ·å¯ä»¥æ£€æµ‹åˆ°è¿™ç§æƒ…å†µï¼Œå¹¶ä¸”å¦‚æœä»–ä»¬éœ€è¦çš„è¯å¯ä»¥é‡æ–°å¼€å§‹ä¸€æ¬¡ MapReduce æ“ä½œã€‚</p><h4 id="Semantics-in-the-Presence-of-Failures"><a href="#Semantics-in-the-Presence-of-Failures" class="headerlink" title="Semantics in the Presence of Failures"></a>Semantics in the Presence of Failures</h4><p>å¦‚æœç”¨æˆ·æä¾›çš„ Map å’Œ Reduce æ“ä½œæ˜¯å…³äºè¾“å…¥å€¼çš„ç¡®å®šæ€§å‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬åˆ†å¸ƒå¼çš„å®ç°å°†ä¼šäº§ç”ŸåŒæ ·çš„è¾“å‡ºï¼Œåœ¨æ•´ä¸ªç¨‹åºç»è¿‡æ²¡æœ‰å‡ºç°æ•…éšœçš„é¡ºåºæ‰§è¡Œä¹‹åã€‚</p><p>æˆ‘ä»¬ä¾èµ– Map task å’Œ Reduce task åŸå­æ€§åœ°æäº¤è¾“å‡ºæ¥å®ç°ä¸Šè¿°ç‰¹æ€§ã€‚æ¯ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„ task éƒ½ä¼šå°†å®ƒçš„è¾“å‡ºå†™åˆ°ä¸€ä¸ªç§æœ‰çš„ä¸´æ—¶æ–‡ä»¶ä¸­ã€‚ä¸€ä¸ª Reduce task äº§ç”Ÿä¸€ä¸ªè¿™æ ·çš„æ–‡ä»¶ï¼Œè€Œä¸€ä¸ª Map task äº§ç”Ÿ R ä¸ªè¿™æ ·çš„æ–‡ä»¶ï¼ˆæ¯ä¸ª Reduce work ä¸€ä¸ªï¼‰ã€‚å½“ä¸€ä¸ª Map task å®Œæˆçš„æ—¶å€™ï¼Œworker å°±ä¼šç»™ master å‘é€ä¸€ä¸ªä¿¡æ¯ï¼Œï¼Œå…¶ä¸­åŒ…å«äº† R ä¸ªä¸´æ—¶æ–‡ä»¶çš„åå­—ã€‚å¦‚æœ master æ”¶åˆ°äº†ä¸€ä¸ªæ¥è‡ªäºå·²ç»å®Œæˆäº†çš„ Map task çš„å®Œæˆä¿¡æ¯ï¼Œé‚£ä¹ˆå®ƒå°±å°†å®ƒè‡ªåŠ¨å¿½ç•¥ã€‚å¦åˆ™ï¼Œå°† R ä¸ªæ–‡ä»¶çš„åç§°è®°å½•åˆ°ä¸€ä¸ª master æ•°æ®ç»“æ„ä¸­ã€‚</p><p>å½“ä¸€ä¸ª Reduce task å®Œæˆçš„æ—¶å€™ï¼ŒReduce worker ä¼šè‡ªåŠ¨å°†ä¸´æ—¶è¾“å‡ºæ–‡ä»¶å‘½åä¸ºæœ€ç»ˆè¾“å‡ºæ–‡ä»¶ã€‚å¦‚æœåŒä¸€ä¸ª Reduce task åœ¨å¤šå°æœºå™¨ä¸Šè¿è¡Œï¼Œé‚£ä¹ˆå¤šä¸ªé‡å‘½åæ“ä½œäº§ç”Ÿçš„æœ€ç»ˆè¾“å‡ºæ–‡ä»¶åå°†ä¼šäº§ç”Ÿå†²çªã€‚å¯¹æ­¤ï¼Œæˆ‘ä»¬ä¾èµ–åº•å±‚æ–‡ä»¶ç³»ç»Ÿæä¾›çš„åŸå­é‡å‘½åæ“ä½œæ¥ä¿è¯æœ€ç»ˆæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ•°æ®æ¥è‡ªä¸€ä¸ª Reduce taskã€‚</p><p>å¤§å¤šæ•°çš„ Map å’Œ Reduce æ“ä½œéƒ½æ˜¯ç¡®å®šæ€§çš„ï¼Œäº‹å®ä¸Šï¼Œæˆ‘ä»¬çš„è¯­ä¹‰ç­‰åŒäºé¡ºåºæ‰§è¡Œã€‚å› æ­¤è¿™è®©ç¨‹åºå‘˜éå¸¸å®¹æ˜“åœ°èƒ½å¤Ÿè§£é‡Šä»–ä»¬ç¨‹åºçš„è¡Œä¸ºã€‚å½“ Map å’Œ Reduce æ“ä½œæ˜¯éç¡®å®šæ€§çš„æ—¶å€™ï¼Œæˆ‘ä»¬æä¾›è¾ƒå¼±ï¼Œä½†ä»ç„¶åˆç†çš„è¯­ä¹‰ã€‚åœ¨éç¡®å®šæ€§çš„æ“ä½œä¸­ï¼Œå¯¹äºä¸€ä¸ªç‰¹å®šçš„ Reduce task $R_1$ çš„è¾“å‡ºæ˜¯å¯¹åº”éç¡®å®šæ€§ç¨‹åºé¡ºåºæ‰§è¡Œäº§ç”Ÿçš„ä¸€ä¸ªç»“æœã€‚ç„¶è€Œï¼Œå¯¹äºå¦ä¸€ä¸ª Reduce task $R_2$ï¼Œå®ƒçš„è¾“å‡ºå¯¹åº”äºéç¡®å®šæ€§ç¨‹åºå¦ä¸€ä¸ªé¡ºåºæ‰§è¡Œçš„ç»“æœã€‚</p><p>ä¸‹é¢è€ƒè™‘ Map task $M$å’Œ Reduce task $R_1$å’Œ$R_2$ã€‚è®©$e(R_i)$è¡¨ç¤º$R_i$çš„æ‰§è¡Œç»“æœã€‚æ›´å¼±çš„è¯­ä¹‰æ„å‘³ç€ï¼Œ$e(R_1)$å¯èƒ½ä» M çš„ä¸€æ¬¡æ‰§è¡Œç»“æœä¸­è¯»å–è¾“å…¥ï¼Œè€Œ$e(R_2)$å¯èƒ½ä» M çš„å¦ä¸€æ¬¡æ‰§è¡Œä¸­è¯»å–è¾“å…¥ã€‚</p><h3 id="Locality"><a href="#Locality" class="headerlink" title="Locality"></a>Locality</h3><p>ç½‘ç»œå¸¦å®½åœ¨æˆ‘ä»¬çš„è®¡ç®—ç¯å¢ƒä¸­æ˜¯ç›¸å¯¹ç¨€ç¼ºçš„èµ„æºã€‚æˆ‘ä»¬é€šè¿‡å°†è¾“å…¥æ•°æ®ï¼ˆç”± GFS ç®¡ç†ï¼‰å­˜å‚¨åœ¨é›†ç¾¤ä¸­æ¯å°æœºå™¨çš„æœ¬åœ°ç£ç›˜çš„æ–¹æ³•æ¥èŠ‚çœå¸¦å®½ã€‚GFS å°†è¾“å…¥æ–‡ä»¶åˆ‡åˆ†æˆ 64MB å¤§å°çš„å—ï¼Œå¹¶ä¸”å°†æ¯ä¸ªå—çš„å¤šä»½æ‹·è´ï¼ˆé€šå¸¸ä¸º 3 ä»½ï¼‰å­˜å‚¨åœ¨ä¸åŒçš„æœºå™¨ä¸Šã€‚MapReduce çš„ master è·å–æ‰€æœ‰è¾“å…¥æ–‡ä»¶çš„ä½ç½®ä¿¡æ¯ï¼Œç„¶åå°† Map task è°ƒåº¦åˆ°æœ‰ç›¸åº”è¾“å…¥æ–‡ä»¶å‰¯æœ¬çš„æœºå™¨ä¸Šã€‚å½“å‘ç”Ÿæ•…éšœæ—¶ï¼Œå†å°† Map task è°ƒåº¦åˆ°é‚»è¿‘çš„å…·æœ‰è¯¥ task è¾“å…¥æ–‡ä»¶å‰¯æœ¬çš„æœºå™¨ï¼ˆå³åœ¨åŒä¸€å°äº¤æ¢æœºå†…å…·æœ‰ç›¸åŒæ•°æ®çš„æœºå™¨ï¼‰ã€‚å½“åœ¨ä¸€ä¸ªé›†ç¾¤çš„å¤§é‡æœºå™¨ä¸Šåš MapReduce æ“ä½œæ—¶ï¼Œå¤§å¤šæ•°çš„è¾“å…¥æ•°æ®éƒ½æ˜¯ä»æœ¬åœ°è¯»å–çš„ï¼Œè€Œä¸ç”¨æ¶ˆè€—å¸¦å®½ã€‚</p><h3 id="Task-Granularity"><a href="#Task-Granularity" class="headerlink" title="Task Granularity"></a>Task Granularity</h3><p>å¦‚ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬å°† Map æ“ä½œåˆ†æˆ M ä»½ï¼ŒReduce æ“ä½œåˆ†æˆ R ä»½ã€‚åœ¨ç†æƒ³çš„æƒ…å†µä¸‹ï¼ŒM å’Œ R çš„å€¼åº”è¯¥è¦æ¯”é›†ç¾¤ä¸­ worker machine çš„æ•°é‡å¤šå¾—å¤šã€‚è®©ä¸€ä¸ª worker åŒæ—¶è¿›è¡Œè®¸å¤šä¸åŒçš„ task æœ‰åˆ©äºæé«˜åŠ¨æ€çš„è´Ÿè½½å‡è¡¡ï¼ŒåŒæ—¶åœ¨ä¸€ä¸ª worker æ•…éšœçš„æ—¶å€™èƒ½å°½å¿«æ¢å¤ã€‚è®¸å¤šå·²ç»å®Œæˆçš„ Map task ä¹Ÿèƒ½å°½å¿«åœ°ä¼ æ’­åˆ°å…¶ä»–æ‰€æœ‰çš„ worker machine ä¸Šã€‚</p><p>åœ¨æˆ‘ä»¬çš„å®ç°ä¸­ï¼ŒM å’Œ R çš„å¤§å°æ˜¯æœ‰ä¸€ä¸ªå®ç”¨èŒƒå›´çš„ã€‚å› ä¸ºæˆ‘ä»¬çš„ master éœ€è¦åš$O(M+R)$ä¸ªè°ƒåº¦å†³å®šï¼Œå¹¶ä¸”è¿˜è¦åœ¨å†…å­˜ä¸­ä¿å­˜$O(M * R)$ä¸ªçŠ¶æ€ï¼ˆæºè‡ªå‰é¢æ‰€è¯´ï¼š<strong>å¯¹äºæ¯ä¸€ä¸ªå·²ç»å®Œæˆçš„ Map taskï¼Œmaster ä¼šå­˜å‚¨ç”±å®ƒäº§ç”Ÿçš„ R ä¸ªä¸­é—´æ–‡ä»¶çš„ä½ç½®å’Œå¤§å°ã€‚</strong>ï¼‰ã€‚ï¼ˆä½†æ˜¯å†…å­˜ä½¿ç”¨çš„å¸¸æ•°è¿˜æ˜¯æ¯”è¾ƒå°çš„ï¼Œ$O(M*R)$ä¸ª Map task&#x2F;Reduce task çŠ¶æ€å¯¹ï¼Œæ¯ä¸ªçš„å¤§å°å¤§æ¦‚åœ¨ä¸€ä¸ªå­—èŠ‚ï¼‰</p><p>å¦å¤–ï¼ŒRé€šå¸¸å—é™äºç”¨æˆ·ï¼Œå› ä¸ºæ¯ä¸ª Reduce task çš„è¾“å‡ºéƒ½åˆ†æ•£åœ¨ä¸åŒçš„è¾“å‡ºæ–‡ä»¶ä¸­ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬ä¼šé€‰æ‹©Mï¼Œä½¿å¾—æ¯ä¸ªè¾“å…¥æ–‡ä»¶å¤§æ¦‚ 16MB åˆ° 64MB çš„è¾“å…¥æ–‡ä»¶ï¼ˆå› æ­¤ä¸Šæ–‡æ‰€è¿°çš„å±€éƒ¨æ€§ä¼˜åŒ–ä¼šè¾¾åˆ°æœ€ä¼˜ï¼Œå‡å°‘å¸¦å®½è´Ÿæ‹…ï¼Œå°½é‡åˆ©ç”¨æœ¬åœ°å­˜å‚¨æ•°æ®è¿›è¡Œ Map taskï¼‰ã€‚è€Œæˆ‘ä»¬ä¼šè®© R æˆä¸º worker machine æ•°é‡çš„ä¸€ä¸ªè¾ƒå°çš„å€æ•°ã€‚å› æ­¤ï¼Œæˆ‘ä»¬é€šå¸¸åœ¨è¿›è¡Œ MapReduce æ“ä½œæ—¶ï¼Œ$M&#x3D;200000ï¼ŒR&#x3D;5000$ï¼Œä½¿ç”¨ 2000 ä¸ª worker machineã€‚</p><h3 id="Backup-Tasks"><a href="#Backup-Tasks" class="headerlink" title="Backup Tasks"></a>Backup Tasks</h3><p>â€œstragglerâ€ï¼ˆè½ä¼çš„å£«å…µï¼‰çš„å­˜åœ¨æ˜¯æ‹–æ…¢æ•´ä¸ª MapReduce æ“ä½œçš„é€šå¸¸çš„åŸå› ä¹‹ä¸€ã€‚æ‰€è°“çš„â€stragglerâ€æ˜¯æŒ‡ä¸€å°æœºå™¨ç”¨äº†è¿‡é•¿çš„æ—¶é—´å»å®Œæˆæ•´ä¸ªè®¡ç®—ä»»åŠ¡ä¸­æœ€åå‡ ä¸ª Map task æˆ–è€… Reduce taskã€‚Straggler å‡ºç°çš„åŸå› æœ‰å¾ˆå¤šã€‚æ¯”å¦‚ä¸€å°æœºå™¨ä¸Šç¡¬ç›˜åäº†ï¼Œå®ƒå°±ä¼šç»å†å¤§é‡çš„å¯çº æ­£é”™è¯¯ï¼Œä»è€Œè®©å®ƒçš„æ€§èƒ½ä» 30MB&#x2F;s ä¸‹é™åˆ° 1MB&#x2F;sã€‚é›†ç¾¤çš„è°ƒåº¦ç³»ç»Ÿå¯èƒ½å°†å…¶ä»– task è°ƒåº¦åˆ°è¯¥æœºå™¨ä¸Šï¼Œå¯¼è‡´å®ƒæ‰§è¡Œ MapReduce ä»£ç çš„é€Ÿåº¦å˜æ…¢å¾ˆå¤šï¼Œå› ä¸º CPUï¼Œå†…å­˜ï¼Œæœ¬åœ°ç£ç›˜ï¼Œç½‘ç»œå¸¦å®½çš„ç«äº‰åŠ å‰§ã€‚æˆ‘ä»¬æœ€è¿‘é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜æ˜¯ä¸€å°æœºå™¨çš„åˆå§‹åŒ–ä»£ç æœ‰ç‚¹é—®é¢˜ï¼Œå®ƒä¼šå¯¼è‡´å¤„ç†å™¨çš„ç¼“å­˜è¢«ç¦ç”¨ï¼Œåœ¨è¿™äº›å—å½±å“çš„æœºå™¨ä¸Šè¿›è¡Œçš„è®¡ç®—é€Ÿåº¦ä¼šä¸‹é™åˆ°åŸæ¥çš„ç™¾åˆ†ä¹‹ä¸€ã€‚ï¼ˆping å¾—åˆ°ä¸åˆ¤å®šä¸ºæ•…éšœæœºï¼Œä½†æ˜¯è‡ªèº«é€Ÿåº¦è¿‡æ…¢ä¼šæ‹–ç´¯æ•´ä½“ï¼Œå‡ºç°çŸ­æ¿æ•ˆåº”ï¼‰</p><p>å¯¹æ­¤ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªé€šç”¨çš„æœºåˆ¶ç”¨æ¥ç¼“è§£ straggler çš„é—®é¢˜ã€‚å½“ MapReduce æ“ä½œæ¥è¿‘ç»“æŸçš„æ—¶å€™ï¼Œmaster ä¼šå°†é‚£äº›ä»åœ¨æ‰§è¡Œçš„ task çš„å¤‡ä»½è¿›è¡Œè°ƒåº¦æ‰§è¡Œã€‚æ— è®ºæ˜¯åŸæ¥çš„è¿˜æ˜¯å¤‡ä»½æ‰§è¡Œå®Œæˆï¼Œè¯¥ task éƒ½å°†è¢«æ ‡è®°ä¸ºå·²å®Œæˆã€‚æˆ‘ä»¬é€šè¿‡è°ƒæ•´å°†è¯¥æ“ä½œå¯¼è‡´çš„è®¡ç®—èµ„æºæ¶ˆè€—ä»…ä»…æé«˜äº†å‡ ä¸ªç™¾åˆ†ç‚¹ï¼ˆåªåœ¨å³å°†ç»“æŸçš„æ—¶å€™è¿›è¡Œå¤‡ä»½ç«äº‰æ‰§è¡Œï¼‰ã€‚ä½†æ˜¯åœ¨å®Œæˆå¤§å‹çš„ MapReduce æ“ä½œæ—¶ï¼Œå´è®©æ•´ä¸ªæ‰§è¡Œæ—¶é—´ä¸‹é™äº†å¥½å¤šã€‚ä¾‹å¦‚ï¼ŒSection 5.3 ä¸­æ‰€æè¿°çš„æ’åºç®—æ³•åœ¨å¤‡ä»½æœºåˆ¶å…³é—­çš„æƒ…å†µä¸‹ï¼Œéœ€è¦å¤šæ¶ˆè€— 44%çš„æ—¶é—´ã€‚</p><h2 id="Refinements"><a href="#Refinements" class="headerlink" title="Refinements"></a>Refinements</h2><p>è™½ç„¶å¯¹äºå¤§å¤šæ•°éœ€æ±‚ç”± Map å’Œ Reduce å‡½æ•°æä¾›çš„åŠŸèƒ½å·²ç»è¶³å¤Ÿäº†ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯å‘ç°äº†ä¸€äº›æœ‰ç”¨çš„æ‰©å±•ã€‚å¯¹å®ƒä»¬çš„æè¿°å¦‚ä¸‹ã€‚</p><h3 id="Partitioning-Function"><a href="#Partitioning-Function" class="headerlink" title="Partitioning Function"></a>Partitioning Function</h3><p>MapReduce ç”¨æˆ·å†³å®šä»–ä»¬çš„ Reduce task æˆ–è€…è¾“å‡ºæ–‡ä»¶çš„æ•°ç›® Rã€‚é€šè¿‡ä¸€ä¸ªåˆ’åˆ†å‡½æ•°ï¼Œæ ¹æ®ä¸­é—´é”®å€¼å°†å„ä¸ª task çš„æ•°æ®è¿›è¡Œåˆ’åˆ†ã€‚é»˜è®¤çš„åˆ’åˆ†å‡½æ•°æ˜¯é€šè¿‡å“ˆå¸Œï¼ˆæ¯”å¦‚ï¼Œhash(key) mod Rï¼‰ã€‚è¿™é€šå¸¸ä¼šäº§ç”Ÿéå¸¸å¥½çš„è¾ƒä¸ºå‡è¡¡çš„åˆ’åˆ†ã€‚ä½†æ˜¯åœ¨å…¶ä»–ä¸€äº›æƒ…å†µä¸‹ï¼Œé€šè¿‡é”®å€¼çš„å…¶ä»–å‡½æ•°æ¥åˆ’åˆ†è¦æ›´å¥½ä¸€äº›ã€‚ä¾‹å¦‚ï¼Œæœ‰çš„æ—¶å€™è¾“å‡ºé”®å€¼æ˜¯ä¸€äº› URLï¼Œæˆ‘ä»¬å¸Œæœ›åŒä¸€ä¸ª host çš„å†…å®¹èƒ½æ”¾åœ¨åŒä¸€ä¸ªè¾“å‡ºæ–‡ä»¶ä¸­ã€‚ä¸ºäº†æ”¯æŒè¿™ç§æƒ…å†µï¼ŒMapReduce åº“çš„ç”¨æˆ·å¯ä»¥æä¾›ä¸€ä¸ªç‰¹æ®Šçš„åˆ’åˆ†å‡½æ•°ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨â€œhash(Hostname(urlKey)) mod Râ€ä½œä¸ºåˆ’åˆ†å‡½æ•°ï¼Œä»è€Œè®©æ‰€æœ‰æ¥è‡ªäºåŒä¸€ä¸ª host çš„ URL çš„å†…å®¹éƒ½è¾“å‡ºåˆ°åŒä¸€ä¸ªè¾“å‡ºæ–‡ä»¶ã€‚</p><p>ï¼ˆä¸ªäººç†è§£ï¼Œhash ä¹‹å‰å¯ä»¥æ ¹æ®éœ€æ±‚ï¼ˆkey çš„ç›¸ä¼¼æ€§ã€urlhost ç›¸åŒï¼‰å¯¹ key æå‰è¿›è¡Œä¸€æ¬¡åˆ†ç»„ï¼‰</p><h3 id="Ordering-Guarantees"><a href="#Ordering-Guarantees" class="headerlink" title="Ordering Guarantees"></a>Ordering Guarantees</h3><p>æˆ‘ä»¬ç¡®ä¿åœ¨ä¸€ä¸ªç»™å®šçš„åˆ’åˆ†ä¸­ï¼Œä¸­é—´é”®å€¼å¯¹éƒ½æŒ‰ç…§é”®å€¼çš„å‡åºè¿›è¡Œå¤„ç†ã€‚è¿™æ ·çš„å¤„ç†é¡ºåºç¡®ä¿äº†æ¯ä¸€ä¸ªåˆ’åˆ†äº§ç”Ÿä¸€ä¸ªæ’å¥½åºçš„è¾“å‡ºæ–‡ä»¶ã€‚è¿™æ ·çš„è¯ï¼Œå¦‚æœè¾“å‡ºæ–‡ä»¶æ ¼å¼éœ€è¦æ”¯æŒæ ¹æ® key è¿›è¡Œæœ‰æ•ˆçš„éšæœºæŸ¥æ‰¾ä¼šæ¯”è¾ƒæ–¹ä¾¿ã€‚åŒæ—¶ï¼Œè¾“å‡ºæ–‡ä»¶ï¼ˆåº”ç”¨ï¼‰çš„ç”¨æˆ·ä¹Ÿä¼šè§‰å¾—å·²ç»æ’å¥½åºçš„æ•°æ®ä½¿ç”¨èµ·æ¥ç‰¹åˆ«æ–¹ä¾¿ã€‚</p><h3 id="Combiner-Function"><a href="#Combiner-Function" class="headerlink" title="Combiner Function"></a>Combiner Function</h3><p>åœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œæ¯ä¸ª Map task éƒ½ä¼šäº§ç”Ÿå¤§é‡çš„ä¸­é—´é”®çš„é‡å¤è€Œç”¨æˆ·æŒ‡å®šçš„ Reduce å‡½æ•°æ˜¯äº¤äº’å’Œå…³è”çš„ã€‚Section 2.1 ä¸­çš„å•è¯ç»Ÿè®¡å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚å› ä¸ºå•è¯çš„å‡ºç°é¢‘ç‡æœä»äº Zipf åˆ†å¸ƒï¼Œæ¯ä¸ª Map Task éƒ½ä¼šäº§ç”Ÿæˆç™¾ä¸Šåƒä¸ªè¿™æ ·çš„è®°å½•ã€‚æ‰€æœ‰è¿™äº›è®°å½•éƒ½ä¼šé€šè¿‡ç½‘ç»œè¢«é€åˆ°ä¸€ä¸ª Reduce task ä¸­ï¼Œå¹¶ä¸”ç”± Reduce å‡½æ•°åŠ åœ¨ä¸€èµ·å»äº§ç”Ÿä¸€ä¸ªæ•°ã€‚æˆ‘ä»¬å…è®¸ç”¨æˆ·ä½¿ç”¨äº†å¯é€‰çš„ Cominer å‡½æ•°ï¼Œç”¨äºåœ¨ç½‘ç»œä¼ è¾“ä¹‹å‰éƒ¨åˆ†åœ°è¿›è¡Œå½’å¹¶æ“ä½œã€‚</p><p>Combiner å‡½æ•°åœ¨æ¯ä¸ªæ‰§è¡Œ Map task çš„æœºå™¨ä¸Šæ‰§è¡Œã€‚é€šå¸¸ Combiner å’Œ Reduce å‡½æ•°ä½¿ç”¨çš„æ˜¯ç›¸åŒçš„ä»£ç ã€‚Reduce å‡½æ•°å’Œ Combiner å‡½æ•°<strong>å”¯ä¸€çš„ä¸åŒ</strong>æ˜¯ MapReduce åº“<strong>å¦‚ä½•å¤„ç†å‡½æ•°çš„è¾“å‡º</strong>ã€‚Reduce å‡½æ•°çš„è¾“å‡ºå†™åˆ°æœ€ç»ˆçš„è¾“å‡ºæ–‡ä»¶ä¸­ã€‚è€Œ Combiner å‡½æ•°çš„è¾“å‡ºä¼šè¢«å†™åˆ°ä¸€ä¸ªæœ€ç»ˆå°†è¢«é€ç»™ Reduce task çš„ä¸­é—´æ–‡ä»¶ä¸­ï¼ˆåˆå¹¶åæ›¿ä»£åŸæœ‰çš„ä¸­é—´é”®å€¼å¯¹é›†åˆä¼ é€’ç»™ Reduce Task æœºå™¨ï¼Œè¿™æ ·å‡å°‘äº†å¸¦å®½çš„å ç”¨ï¼‰ã€‚</p><p>éƒ¨åˆ†çš„åˆå¹¶æ“ä½œèƒ½æå¤§åœ°åŠ é€ŸæŸç±»ç‰¹å®šçš„ MapReduce æ“ä½œã€‚Appendix A åŒ…å«äº†ä¸€ä¸ªä½¿ç”¨ Combiner çš„ä¾‹å­ã€‚</p><h3 id="Input-and-Output-Types"><a href="#Input-and-Output-Types" class="headerlink" title="Input and Output Types"></a>Input and Output Types</h3><p>MapReduce åº“æä¾›äº†å¯¹è¯»å…¥æ•°æ®æ–‡ä»¶å¤šç§çš„æ ¼å¼æ”¯æŒã€‚ä¾‹å¦‚ï¼Œâ€textâ€æ ¼å¼çš„è¾“å…¥å°†æ¯ä¸€è¡Œä½œä¸ºé”®å€¼å¯¹ï¼škey æ˜¯æ–‡ä»¶å†…çš„åç§»ï¼Œvalue æ˜¯è¯¥è¡Œçš„å†…å®¹ã€‚å¦å¤–ä¸€ç§æ¯”è¾ƒå¸¸ç”¨çš„æ ¼å¼å­˜å‚¨ä¸€ç³»åˆ—æŒ‰ç…§é”®è¿›è¡Œæ’åºçš„é”®å€¼å¯¹ã€‚æ¯ä¸€ä¸ªè¾“å‡ºæ ¼å¼çš„å®ç°éƒ½çŸ¥é“å¦‚ä½•å°†è‡ªå·±è¿›è¡Œåˆç†çš„åˆ’åˆ†ä»è€Œèƒ½è®©ä¸åŒçš„ Map task è¿›è¡Œå¤„ç†ï¼ˆä¾‹å¦‚ï¼Œtext æ¨¡å¼å°±çŸ¥é“å°†åŒºåŸŸåˆ’åˆ†åˆ°ä»¥è¡Œä¸ºè¾¹ç•Œï¼‰ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡ç®€å•åœ°å®šä¹‰ä¸€ä¸ª reader æ¥å£æ¥æä¾›ä¸€ä¸ªæ–°çš„è¾“å…¥ç±»å‹çš„å®ç°ã€‚äº‹å®ä¸Šï¼Œå¤§å¤šæ•°ç”¨æˆ·åªä½¿ç”¨äº†é¢„å®šä¹‰è¾“å…¥ç±»å‹çš„å¾ˆå°ä¸€éƒ¨åˆ†ã€‚</p><p>reader å¹¶ä¸ä¸€å®šè¦ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°å®šä¹‰ä¸€ä¸ªä»æ•°æ®åº“ï¼Œæˆ–è€…å†…å­˜ä¸­æ˜ å°„çš„æ•°æ®ç»“æ„ä¸­è¯»å–è®°å½•çš„ readerã€‚</p><p>åŒç†ï¼Œæˆ‘ä»¬ä¹Ÿæ”¯æŒäº§ç”Ÿä¸åŒæ ¼å¼çš„è¾“å‡ºæ•°æ®ï¼Œç”¨æˆ·ä¹Ÿèƒ½ç¼–å†™æ–°çš„è¾“å‡ºæ•°æ®æ ¼å¼ã€‚</p><h3 id="Side-effects"><a href="#Side-effects" class="headerlink" title="Side-effects"></a>Side-effects</h3><p>åœ¨æœ‰äº›æƒ…å†µä¸‹ï¼ŒMapReduce çš„ç”¨æˆ·ä¼šå¾ˆå®¹æ˜“å‘ç° Map æˆ–è€… Reduce æ“ä½œä¼šäº§ç”Ÿä¸€äº›è¾…åŠ©æ–‡ä»¶ä½œä¸ºé¢å¤–çš„è¾“å‡ºæ–‡ä»¶ã€‚æˆ‘ä»¬ä¾èµ–åº”ç”¨çš„ç¼–å†™è€…å»ä¿è¯è¿™äº›å‰¯ä½œç”¨æ˜¯åŸå­å’Œå¹‚ç­‰çš„ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œåº”ç”¨ä¼šå†™åˆ°ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”åœ¨å®ƒå®Œå…¨äº§ç”Ÿä¹‹åï¼Œé€šè¿‡ä¸€ä¸ªåŸå­æ“ä½œå°†å®ƒé‡å‘½åã€‚</p><p>å¯¹äºä¸€ä¸ªå•ä¸€çš„ task äº§ç”Ÿçš„å¤šä¸ªè¾“å‡ºæ–‡ä»¶ï¼Œæˆ‘ä»¬ä¸æä¾›åŸå­æ€§çš„ä¸¤ç›¸æäº¤æ”¯æŒã€‚å› æ­¤ï¼Œäº§ç”Ÿå¤šä¸ªè¾“å‡ºæ–‡ä»¶å¹¶ä¸”æœ‰è·¨æ–‡ä»¶ä¸€è‡´æ€§è¦æ±‚çš„ task éœ€è¦æ˜¯ç¡®å®šæ€§çš„ã€‚ä½†æ˜¯è¿™æ ·çš„é™åˆ¶åœ¨å®è·µè¿‡ç¨‹ä¸­å¹¶ä¸æ˜¯ä»€ä¹ˆé—®é¢˜ã€‚</p><h3 id="Skipping-Bad-Records"><a href="#Skipping-Bad-Records" class="headerlink" title="Skipping Bad Records"></a>Skipping Bad Records</h3><p>æœ‰æ—¶å€™ï¼Œå¦‚æœç”¨æˆ·çš„ä»£ç ä¸­æœ‰ bug çš„è¯ï¼Œä¼šå¯¼è‡´ Map æˆ–è€… Reduce æ“ä½œåœ¨æŸäº›è®°å½•ä¸Šå´©æºƒã€‚è¿™äº› bug ä¼šå¯¼è‡´ MapReduce æ“ä½œçš„æ­£å¸¸å®Œæˆã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œé€šå¸¸å°±æ˜¯å»ä¿® bugã€‚ä¸è¿‡æœ‰æ—¶å€™è¿™æ˜¯ä¸å¯è¡Œçš„ï¼Œä¹Ÿè®¸ bug æ˜¯ç¬¬ä¸‰æ–¹åº“é€ æˆçš„ï¼Œè€Œæˆ‘ä»¬å¹¶ä¸èƒ½å¾—åˆ°å®ƒçš„æºä»£ç ã€‚è€Œä¸”ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬å…è®¸å¿½ç•¥æ‰ä¸€äº›è®°å½•ï¼Œä¾‹å¦‚åœ¨å¯¹ä¸€ä¸ªå¤§æ•°æ®é›†åšåˆ†æçš„æ—¶å€™ã€‚å› æ­¤æˆ‘ä»¬æä¾›äº†ä¸€ç§å¯é€‰çš„æ‰§è¡Œæ¨¡å¼ï¼Œå½“ MapReduce åº“æ£€æµ‹åˆ°ä¸€äº›è®°å½•ä¼šé€ æˆå´©æºƒæ—¶ï¼Œå°±ä¼šä¸»åŠ¨è·³è¿‡å®ƒä»¬ï¼Œä»è€Œä¿è¯æ­£å¸¸åœ°è¿è¡Œã€‚</p><p>æ¯ä¸€ä¸ª worker è¿›ç¨‹éƒ½å®‰è£…äº†ä¸€ä¸ª signal handler ç”¨äºæ•æ‰æ®µé”™è¯¯å’Œ bugã€‚åœ¨è°ƒç”¨ç”¨æˆ·çš„ Map å’Œ Reduce æ“ä½œä¹‹å‰ï¼ŒMapReduce åº“ä¼šå°†å‚æ•°çš„åºå·ä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€å˜é‡ä¸­ã€‚å¦‚æœç”¨æˆ·ä»£ç äº§ç”Ÿäº†ä¸€ä¸ªä¿¡å·ï¼Œsignal handler å°±ä¼šä¼ è¾“ä¸€ä¸ªå‚æ•°å«æœ‰åºå·çš„â€last gaspâ€UDP åŒ…ç»™ MapReduce çš„ masterã€‚å½“ master åœ¨ä¸€ä¸ªç‰¹å®šçš„è®°å½•ä¸­å‘ç°äº†ä¸çŸ¥ä¸€æ¬¡çš„é”™è¯¯ï¼Œè¿™è¡¨ç¤ºåœ¨ä¸‹ä¸€æ¬¡æ‰§è¡Œç›¸åº”çš„ Map æˆ–è€… Reduce æ“ä½œçš„æ—¶å€™ä¸€ä¸ªå°†å®ƒè·³è¿‡ã€‚</p><h3 id="Local-Execution"><a href="#Local-Execution" class="headerlink" title="Local Execution"></a>Local Execution</h3><p>Map æˆ–è€… Reduce å‡½æ•°çš„è°ƒè¯•é—®é¢˜æ˜¯éå¸¸ tricky çš„ã€‚å› ä¸ºå®é™…çš„è®¡ç®—å‘ç”Ÿåœ¨åˆ†å¸ƒå¼çš„ç³»ç»Ÿä¸­ï¼Œé€šå¸¸ç”±æˆç™¾ä¸Šåƒå°æœºå™¨ç»„æˆï¼Œå¹¶ä¸”å·¥ä½œçš„åˆ†é…ç”± master åŠ¨æ€æ‰§è¡Œã€‚ä¸ºäº†å¸®åŠ©è°ƒè¯•ï¼Œåˆ†æï¼Œä»¥åŠå°è§„æ¨¡çš„æµ‹è¯•ï¼Œæˆ‘ä»¬å¼€å‘äº†å¦å¤–ä¸€ä¸ª MapReduce åº“çš„å®ç°ï¼Œå®ƒèƒ½å¤Ÿåœ¨æœ¬åœ°æœºå™¨ä¸Šé¡ºåºæ‰§è¡Œä¸€ä¸ª MapReduce æ“ä½œçš„æ‰€æœ‰å·¥ä½œã€‚å®ƒçš„æ§åˆ¶äº¤ç»™ç”¨æˆ·ï¼Œå› æ­¤è®¡ç®—å¯ä»¥è¢«é™å®šåˆ°åˆ¶å®šçš„ Map task ä¸­æ‰§è¡Œã€‚ç”¨æˆ·åˆ©ç”¨æŒ‡å®šçš„ flag å¯åŠ¨ç¨‹åºï¼Œç„¶åå°±èƒ½éå¸¸ç®€å•åœ°ä½¿ç”¨ä»»ä½•å®ƒä»¬è§‰å¾—æœ‰ç”¨çš„è°ƒè¯•æˆ–è€…æµ‹è¯•å·¥å…·äº†ã€‚</p><h3 id="Status-Information"><a href="#Status-Information" class="headerlink" title="Status Information"></a>Status Information</h3><p>master è¿è¡Œäº†ä¸€ä¸ªå†…ç½®çš„ HTTP server å¹¶ä¸”è¾“å‡ºäº†ä¸€ç³»åˆ—ä¾›äººä»¬ä½¿ç”¨çš„çŠ¶æ€é¡µã€‚çŠ¶æ€é¡µä¼šæ˜¾ç¤ºç¨‹åºçš„è®¡ç®—è¿‡ç¨‹ï¼Œä¾‹å¦‚å·²ç»å®Œæˆäº†å¤šå°‘ä¸ª taskï¼Œè¿˜æœ‰å¤šå°‘ä¸ª task æ­£åœ¨æ‰§è¡Œï¼Œè¾“å…¥çš„å­—èŠ‚æ•°ï¼Œä¸­é—´æ•°æ®çš„å­—èŠ‚æ•°ï¼Œè¾“å‡ºçš„å­—èŠ‚æ•°ï¼Œä»¥åŠå¤„ç†é€Ÿåº¦ç­‰ç­‰ã€‚è¯¥é¡µè¿˜åŒ…å«äº†æŒ‡å‘å„ä¸ª task çš„æ ‡å‡†é”™è¯¯å’Œæ ‡å‡†è¾“å‡ºé“¾æ¥ã€‚ç”¨æˆ·å¯ä»¥åˆ©ç”¨è¿™äº›æ•°æ®æ¥åˆ¤æ–­è®¡ç®—ä¼šæŒç»­å¤šé•¿æ—¶é—´ï¼Œä»¥åŠè®¡ç®—æ˜¯å¦éœ€è¦æ·»åŠ æ›´å¤šçš„èµ„æºã€‚è¿™äº›é¡µé¢è¿˜èƒ½ç”¨æ¥å‘ç°ä»€ä¹ˆæ—¶å€™å¤„ç†é€Ÿåº¦æ¯”é¢„æœŸåœ°ä¸‹é™å¥½å¤šã€‚</p><p>å¦å¤–ï¼Œé¡¶å±‚çš„çŠ¶æ€é¡µæ˜¾ç¤ºäº†é‚£äº› worker å‡ºé”™äº†ï¼Œä»¥åŠåœ¨å®ƒä»¬å‡ºé”™æ—¶æ­£åœ¨æ‰§è¡Œå“ªäº› Map å’Œ Reduce taskã€‚è¿™äº›ä¿¡æ¯åœ¨è¯Šæ–­ç”¨æˆ·ä»£ç å‡ºç°çš„ bug æ—¶æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚</p><p>MapReduce åº“æä¾›äº†ä¸€ä¸ªå« counter çš„è®¾æ–½ç”¨äºç»Ÿè®¡å„ç§ä¸åŒäº‹ä»¶å‡ºç°çš„æ¬¡æ•°ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·å¯èƒ½æƒ³è¦ç»Ÿè®¡å·²ç»å¤„ç†è¿‡çš„å•è¯çš„æ•°ç›®æˆ–è€…å¾·å›½æ–‡ä»¶çš„ç´¢å¼•æ•°é‡ã€‚</p><p>ä¸ºäº†ä½¿ç”¨è¿™ä¸€ç‰¹æ€§ï¼Œç”¨æˆ·ä»£ç åˆ›å»ºä¸€ä¸ªå‘½åçš„ counter å¯¹è±¡ï¼Œå¹¶ä¸”åœ¨ Map ä»¥åŠ Reduce å‡½æ•°ä¸­å¯¹ counter è¿›è¡Œå¢åŠ ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">Counter* uppercase;<br>uppercase = GetCounter(<span class="hljs-string">&quot;uppercase&quot;</span>);<br><br><span class="hljs-built_in">map</span>(String name, String contents):<br>ã€€ã€€<span class="hljs-keyword">for</span> each word w in contents:<br>ã€€ã€€ã€€ã€€<span class="hljs-keyword">if</span>(IsCapitalized(w)):<br>ã€€ã€€ã€€ã€€ã€€ã€€uppercase-&gt;Increment();<br>ã€€ã€€ã€€ã€€EmitIntermediate(w, <span class="hljs-string">&quot;1&quot;</span>);<br></code></pre></td></tr></table></figure><p>æ¯ä¸ª worker æœºå™¨ä¸Š counter çš„å€¼ä¼šå®šæœŸä¼ ç»™ masterï¼ˆæå¸¦åœ¨ç»™ master çš„ ping å›å¤ä¸­ï¼‰ã€‚master å°†æ¥è‡ªæˆåŠŸæ‰§è¡Œçš„ Map å’Œ Reduce task çš„ counter å€¼èšé›†èµ·æ¥ã€‚ç„¶ååœ¨ MapReduce æ“ä½œå®Œæˆä¹‹åè¿”å›ç»™ç”¨æˆ·ä»£ç ã€‚å½“å‰çš„ counter å€¼ä¹Ÿä¼šæ˜¾ç¤ºåœ¨ master çš„çŠ¶æ€é¡µä¸Šï¼ˆå‰è¿°çš„ state pagesï¼‰ï¼Œæ‰€ä»¥ç”¨æˆ·èƒ½ä»å®æ—¶è§‚çœ‹è®¡ç®—çš„è¿›è¡Œã€‚åœ¨èšé›† counter çš„å€¼çš„æ—¶å€™ï¼Œmaster ä¼šæ¶ˆé™¤ Map æˆ–è€… Reduce task çš„é‡å¤æ‰§è¡Œé€ æˆçš„é‡å¤è®¡ç®—ã€‚ï¼ˆé‡å¤æ‰§è¡Œå¯èƒ½ç”± backup tasks æˆ–è€…å› ä¸ºé”™è¯¯é‡æ–°æ‰§è¡Œçš„ task å¼•èµ·ï¼‰ã€‚</p><p>æœ‰äº› counter çš„å€¼æ˜¯ç”± MapReduce åº“è‡ªåŠ¨ç»´æŠ¤çš„ï¼Œä¾‹å¦‚å·²ç»å¤„ç†çš„è¾“å…¥é”®å€¼å¯¹æ•°ç›®ä»¥åŠå·²ç»äº§ç”Ÿçš„è¾“å‡ºé”®å€¼å¯¹æ•°ç›®ã€‚</p><p>ç”¨æˆ·å‘ç° counter ç‰¹æ€§å¯¹äºæ£€æŸ¥ MapReduce æ“ä½œçš„æ‰§è¡Œæ˜¯éå¸¸æœ‰ç”¨çš„ã€‚ä¾‹å¦‚ï¼Œåœ¨æœ‰äº› MapReduce æ“ä½œä¸­ï¼Œç”¨æˆ·ä»£ç æƒ³è¦ç¡®ä¿äº§ç”Ÿçš„è¾“å‡ºå¯¹çš„æ•°ç›®å’Œå·²ç»å¤„ç†çš„è¾“å…¥å¯¹çš„æ•°ç›®æ˜¯æ°å¥½ç›¸ç­‰çš„ï¼ˆæ¯”å¦‚æ£€æŸ¥æ»¡å°„ï¼‰ï¼Œæˆ–è€…å¤„ç†çš„å¾·è¯­æ–‡ä»¶çš„æ•°ç›®å æ€»å¤„ç†æ–‡ä»¶æ•°ç›®çš„æ¯”é‡åœ¨ä¸€ä¸ªå¯å®¹å¿çš„èŒƒå›´å†…ã€‚</p><h2 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h2><p>åœ¨è¿™ä¸ª section ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è¿è¡Œåœ¨ä¸€ä¸ªé›†ç¾¤ä¸Šçš„ä¸¤ä¸ª computation æ¥æµ‹è¯• MapReduce çš„æ€§èƒ½ã€‚ä¸€ä¸ª Computation æœç´¢ä¸€ä¸ª T çš„æ•°æ®ï¼Œä»ä¸­è·å–ä¸€ä¸ªç‰¹å®šçš„æ¨¡å¼ã€‚å¦ä¸€ä¸ª computation å¯¹ä¸€ä¸ª T çš„æ•°æ®è¿›è¡Œæ’åºã€‚</p><p>è¿™ä¸¤ä¸ªç¨‹åºä»£è¡¨äº†ç”±ç”¨æˆ·å®é™…ç¼–å†™çš„ MapReduce ç¨‹åºçš„ä¸€ä¸ªå­é›†â€”â€”â€”ä¸€ç±»ç¨‹åºç”¨äºå°†æ•°æ®ä»ä¸€ç§è¡¨ç¤ºæ–¹æ³•åˆ‡æ¢åˆ°å¦ä¸€ç§è¡¨ç¤ºæ–¹æ³•ã€‚å¦ä¸€ç±»ç¨‹åºåˆ™ä»å¤§æ•°æ®é›†ä¸­æŠ½å–å‡ºä¸€å°éƒ¨åˆ†æœ‰è¶£çš„æ•°æ®ã€‚</p><h3 id="Cluster-Configuration"><a href="#Cluster-Configuration" class="headerlink" title="Cluster Configuration"></a>Cluster Configuration</h3><p>æ‰€æœ‰ç¨‹åºéƒ½è¿è¡Œåœ¨ä¸€ä¸ªç”± 1800 å°æœºå™¨ç»„æˆçš„æœºå™¨ä¸Šã€‚æ¯ä¸€å°æœºå™¨éƒ½æœ‰ä¸¤ä¸ª 2GHz çš„ Intel Xeon å¤„ç†å™¨ï¼Œå¹¶ä¸”å…è®¸ Hper-Threadingï¼ˆè¶…çº¿ç¨‹ï¼‰ï¼Œ 4GB å†…å­˜ï¼Œä¸¤ä¸ª 160GB çš„ IDE ç£ç›˜ï¼Œä»¥åŠä¸€ä¸ª G æ¯”ç‰¹çš„ä»¥å¤ªç½‘é“¾è·¯ã€‚è¿™äº›æœºå™¨è¢«å®‰æ’åœ¨ä¸€ä¸ªä¸¤å±‚æ ‘çŠ¶çš„äº¤æ¢ç½‘ç»œä¸­ï¼Œæ ¹èŠ‚ç‚¹çš„å¸¦å®½å¤§æ¦‚åœ¨ 100-200Gbpsã€‚å› ä¸ºæ‰€æœ‰æœºå™¨éƒ½åœ¨åŒä¸€ä¸ªæ‰˜ç®¡è®¾å¤‡ä¸­ï¼Œå› æ­¤ä»»æ„ä¸¤å°æœºå™¨é—´çš„ RTT å°‘äº 1msã€‚</p><p>å…¶ä¸­ 4GB ä¸­çš„ 1-1.5G æ˜¯ä¸ºé›†ç¾¤ä¸­è¿è¡Œçš„å…¶ä»–ä»»åŠ¡é¢„ç•™çš„ã€‚ç¨‹åºåœ¨ä¸€ä¸ªå‘¨æœ«çš„ä¸‹åˆè¿è¡Œï¼Œæ­¤æ—¶ CPUï¼Œç£ç›˜ï¼Œç½‘ç»œåŸºæœ¬éƒ½å¤„äºç©ºé—²çŠ¶æ€ã€‚</p><h3 id="Grep"><a href="#Grep" class="headerlink" title="Grep"></a>Grep</h3><p>grep ç¨‹åºéœ€è¦æ‰«æ 10 çš„åæ¬¡æ–¹æ¡ 100-byte çš„è®°å½•ï¼Œæœç´¢ä¸€ä¸ªç›¸å¯¹ç½•è§çš„ä¸‰å­—ç¬¦æ¨¡å¼ï¼ˆå‡ºç°äº† 92337 æ¬¡ï¼‰ã€‚è¾“å…¥è¢«åˆ†æˆå¤§æ¦‚ 64MB ä»½ï¼ˆM &#x3D; 15000ï¼‰ï¼Œæ‰€æœ‰çš„è¾“å‡ºæ–‡ä»¶éƒ½å­˜æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼ˆR &#x3D; 1ï¼‰ã€‚</p><p>Figure 2 æ˜¾ç¤ºäº† Computation éšç€æ—¶é—´çš„å˜åŒ–è¿‡ç¨‹ã€‚Y è½´ä»£è¡¨äº†è¾“å…¥æ•°æ®çš„æ‰«æé€Ÿåº¦ã€‚éšç€æœºå™¨é€æ¸åŠ å…¥ MapReduce çš„è®¡ç®—å½“ä¸­ï¼Œé€Ÿåº¦è¶Šæ¥è¶Šå¿«ï¼Œå½“æœ‰ 1764 ä¸ª worker åŠ å…¥æ—¶ï¼Œè¾¾åˆ°å³°å€¼ 30GB&#x2F;sã€‚éšç€ Map task çš„ç»“æŸï¼Œé€Ÿåº¦å¼€å§‹ä¸‹é™å¹¶ä¸”åœ¨ 80s çš„æ—¶å€™åˆ°è¾¾ 0,ã€‚æ•´ä¸ª Computation ä»å¼€å§‹åˆ°ç»“æŸæ€»å…±èŠ±è´¹äº†å¤§æ¦‚ 150sã€‚è¿™å…¶ä¸­è¿˜åŒ…æ‹¬äº† 1 åˆ†é’Ÿçš„å¯åŠ¨å¼€é”€ã€‚å¼€é”€ä¸»è¦æ¥æºäºå°†ç¨‹åºåˆ†å‘åˆ° worker machine ä¸­ï¼Œå’Œ GFS äº¤äº’å¹¶æ‰“å¼€ 1000 ä¸ªè¾“å…¥æ–‡ä»¶ï¼Œä»¥åŠè·å–å±€éƒ¨æ€§ä¼˜åŒ–æ‰€éœ€çš„ä¿¡æ¯çš„å»¶æ—¶ã€‚</p><h3 id="Sort"><a href="#Sort" class="headerlink" title="Sort"></a>Sort</h3><p>æ’åºç¨‹åºç”¨äºå¯¹ 10 çš„åæ¬¡æ–¹æ¡è®°å½•ï¼ˆå¤§æ¦‚ 1T çš„æ•°æ®ï¼‰è¿›è¡Œæ’åºã€‚ç¨‹åºä»¥ TeraSort benchmark ä¸ºæ¨¡å‹ã€‚</p><p>æ’åºç¨‹åºç”±ä¸è¶…è¿‡ 50 è¡Œç”¨æˆ·ä»£ç ç»„æˆï¼Œä¸€ä¸ªä¸‰è¡Œçš„ Map function ä» text çš„ä¸€è¡Œä¸­æå–ä¸€ä¸ª 10-byte çš„æ’åº keyï¼Œä¸åŸå§‹çš„ text line ç»„åˆæˆä¸€ä¸ªä¸­é—´ key&#x2F;value pairã€‚æˆ‘ä»¬ä½¿ç”¨å†…ç½®çš„ Identity å‡½æ•°ä½œä¸º Reduce çš„è¿ç®—ç¬¦ã€‚è¿™ä¸€å‡½æ•°å°†ä¸­é—´é”®å€¼å¯¹ä¼ é€’å‡ºä½œä¸ºè¾“å‡ºå¯¹ã€‚æœ€ç»ˆçš„æ’åºè¾“å‡ºæ˜¯ä¸€ä¸ªäºŒè·¯å¤åˆ¶çš„ GFS æ–‡ä»¶ã€‚</p><p>è¾“å…¥è¢«åˆ†æˆ 64MB ä»½ï¼ˆM &#x3D; 15000ï¼‰ï¼Œè€Œå°†è¾“å‡ºåˆ†ä¸º 4000 ä»½ï¼ˆR &#x3D; 4000ï¼‰ã€‚åˆ†å‰²æˆè®¸æ ¹æ®åˆå§‹çš„ key å°†å…¶åˆ†å‰²åˆ° R ä»½ä¸­çš„ä¸€ä¸ªã€‚</p><p><img src="/image/MapReduce/OS_3_2-20220327170521059.png" alt="OS_3_2"></p><p>å›¾ 3ï¼ˆaï¼‰å±•ç¤ºäº†æ’åºç¨‹åºçš„æ­£å¸¸æ‰§è¡Œï¼Œå·¦ä¸Šæ–¹çš„å›¾è¡¨ç¤ºè¯»å…¥çš„é€Ÿç‡ï¼Œåœ¨è¾¾åˆ°å³°å€¼ 13GB&#x2F;s åè¿…é€Ÿæ»‘è½å› ä¸ºæ‰€æœ‰çš„ map tasks åœ¨ 200 ç§’å†…å°±å·²ç»å®Œæˆã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¾“å…¥çš„é€Ÿç‡æ…¢äº grep æ“ä½œï¼ˆå¯¹äºç›¸åŒçš„ M åˆ’åˆ†ï¼‰ï¼Œè¿™æ˜¯å› ä¸ºå¯¹äº sort æ“ä½œï¼ŒèŠ±è´¹äº†ä¸€åŠçš„äº‹ä»¶ä»¥åŠ I&#x2F;O å¸¦å®½ç”¨äºå°†ä¸­é—´é”®å€¼å¯¹ç»“æœå†™å…¥æœ¬åœ°ç£ç›˜ï¼Œè€Œ grep æ“ä½œå¯¹åº”çš„è¾“å‡ºåˆ™å¯ä»¥å°åˆ°å¿½ç•¥ä¸è®¡ã€‚</p><p>ä¸­é—´å·¦è¾¹çš„å›¾è¡¨ç¤ºç»å† map tasks åé€šè¿‡ç½‘ç»œå‘ reduce tasks ä¼ è¾“æ•°æ®çš„é€Ÿç‡ã€‚è¿™ä¸€æ··æ’åœ¨é¦–ä¸ªå®Œæˆçš„ map task åå¯åŠ¨ã€‚ç¬¬ä¸€ä¸ªçªèµ·è¡¨ç¤ºæ‰€æœ‰ reduce tasks è¿è¡Œçš„ç¬¬ä¸€ä¸ªæ‰¹æ¬¡ï¼ˆR &#x3D; 1700 nearly allï¼‰ï¼Œå¼€å§‹è®¡ç®—å 300 ç§’å·¦å³ï¼Œç¬¬ä¸€æ‰¹æ¬¡çš„éƒ¨åˆ† reduce tasks å®Œæˆï¼Œæˆ‘ä»¬å¼€å§‹å‘å®Œæˆçš„æœºå™¨è¿›ä¸€æ­¥é€’é€å‰©ä½™ reduce tasks çš„æ•°æ®ã€‚</p><p>å·¦ä¸‹çš„å›¾è¡¨ç¤ºæ’åºå¥½çš„æ•°æ®å‘æœ€ç»ˆæ–‡ä»¶å†™å‡ºçš„é€Ÿç‡ã€‚ä»ç¬¬ä¸€æ‰¹æ¬¡ reduce tasks å®Œæˆåˆ°å¼€å§‹å†™æ•°æ®æœ‰ä¸€æ®µæ—¶é—´é—´éš”ï¼Œè¿™æ˜¯å› ä¸ºæœºå™¨å¿™äºå¯¹ä¸­é—´æ•°æ®è¿›è¡Œæ’åºã€‚</p><p>å…³äºé€Ÿåº¦çš„æ¯”è¾ƒï¼Œè¾“å…¥æ•°æ®é«˜äº shuffle é€Ÿç‡å’Œè¾“å‡ºé€Ÿç‡ï¼Œè¿™æ˜¯å› ä¸ºè¾“å…¥æ˜¯åŸºäºæœ¬åœ°å­˜å‚¨ï¼Œè€Œåˆå› ä¸ºç½‘ç»œå¸¦å®½çš„é™åˆ¶ï¼Œä»¥åŠè¾“å‡ºè¦æ±‚ä¸¤ä»½ replica çš„è¦æ±‚ï¼Œshuffle é€Ÿç‡é«˜äºè¾“å‡ºé€Ÿç‡ã€‚æˆ‘ä»¬å†™æˆä¸¤ä¸ªå‰¯æœ¬ï¼Œå› ä¸ºè¿™æ˜¯æˆ‘ä»¬çš„åº•å±‚æ–‡ä»¶ç³»ç»Ÿæä¾›çš„å¯é æ€§å’Œå¯ç”¨æ€§æœºåˆ¶è¦æ±‚ã€‚ å¦‚æœåº•å±‚æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨æ“¦é™¤ç¼–ç ï¼ˆerasure codingï¼‰è€Œä¸æ˜¯å¤åˆ¶ï¼ˆreplicationï¼‰ï¼Œåˆ™å¯ä»¥å‡å°‘å†™å…¥æ•°æ®çš„ç½‘ç»œå¸¦å®½è¦æ±‚ã€‚</p><p>ï¼ˆGFS ä»‹ç»çš„è®ºæ–‡é‡Œåº”è¯¥ä¼šè§£é‡Šä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä»½ replicaï¼‰ã€‚</p><h3 id="Effect-of-Backup-Tasks"><a href="#Effect-of-Backup-Tasks" class="headerlink" title="Effect of Backup Tasks"></a>Effect of Backup Tasks</h3><p>åœ¨å›¾ 3ï¼ˆbï¼‰ä¸­ï¼Œæˆ‘ä»¬å±•ç¤ºäº†ç¦æ­¢ backup tasks æƒ…å†µä¸‹æ‰§è¡Œæ’åºæ“ä½œçš„ç»“æœã€‚æµç¨‹ä¸å›¾ 3ï¼ˆaï¼‰å¾ˆç›¸ä¼¼ï¼Œä½†å­˜åœ¨ä¸€ä¸ªç›¸å½“é•¿çš„ä¸”çœ‹ä¸å‡ºæœ‰æ˜æ˜¾æ´»åŠ¨çš„å°¾éƒ¨ã€‚960 ç§’åï¼Œé™¤äº†å‰©ä½™çš„ 5 ä¸ªï¼Œå…¶ä½™ reduce tasks å‡å·²å®Œæˆï¼Œç„¶è€Œå‰©ä½™çš„ stragglers ç›´åˆ° 300 ç§’åæ‰å®Œæˆä»»åŠ¡ï¼Œç€å¯¼è‡´æ•´ä½“è€—æ—¶ 1283 ç§’ï¼Œæ¯”å…·å¤‡ backup tasksï¼ˆæœ€ç»ˆå¤‡ä»½å¤„ç†ä»»åŠ¡ï¼‰æƒ…å†µä¸‹å¤šè€—æ—¶ 44%ã€‚</p><h3 id="Machine-Failures"><a href="#Machine-Failures" class="headerlink" title="Machine Failures"></a>Machine Failures</h3><p>åœ¨å›¾ 3ï¼ˆcï¼‰ä¸­ï¼Œæˆ‘ä»¬å±•ç¤ºäº†å°† 1746 å°å·¥ä½œæœºå™¨ä¸­çš„ 200 å°æœºå™¨æ•…æ„å®•æœºå‡ åˆ†é’Ÿä»¥æ¨¡æ‹Ÿæœºå™¨æ•…éšœæƒ…å†µä¸‹æ’åºæ“ä½œçš„æ‰§è¡Œç»“æœï¼Œåº•å±‚çš„é›†ç¾¤ç«‹åˆ»é‡å¯æ–°çš„å·¥ä½œè¿›ç¨‹ï¼ˆå› ä¸ºä»…ä»…æ˜¯ kill è¿›ç¨‹ï¼Œå®é™…ä¸Šæœºå™¨åŠŸèƒ½è‰¯å¥½ï¼‰ã€‚</p><p>worker çš„ deaths é€šè¿‡å›¾è¡¨ä¸­è´Ÿå€¼è¾“å…¥é€Ÿç‡æ¥è¡¨ç¤ºï¼Œå› ä¸ºå…ˆå‰ä¸€äº›å·²å®Œæˆçš„ map work ä¸¢å¤±è€Œéœ€è¦è¢«é‡æ–°æ‰§è¡Œï¼ˆæ ¹æ®å…ˆå‰åˆ†æï¼Œç”±äº map task å¾—åˆ°çš„ä¸­é—´ç»“æœå­˜å‚¨åœ¨æœ¬åœ°ï¼Œå®•æœºåæ— æ³•æ­£ç¡®è®¿é—®ï¼Œä½¿å¾—ä¹‹å‰çš„ä»»åŠ¡éœ€è¦è¢«é‡æ–°æ‰§è¡Œ re-executeï¼‰ã€‚é‡æ‰§è¡Œå¼€å§‹å¾—ååˆ†è¿…é€Ÿï¼Œæ•´ä½“è€—æ—¶ä»…ä»…æ¯”æ­£å¸¸æƒ…å†µå¤šè€—æ—¶ 5%ã€‚</p><h2 id="Experience"><a href="#Experience" class="headerlink" title="Experience"></a>Experience</h2><p>æˆ‘ä»¬å¾— MapReduce åº“é¦–ä¸ªç‰ˆæœ¬äº 2003 å¹´ 2 æœˆå†™æˆï¼Œå¹¶åœ¨ 2003 å¹´ 8 æœˆè¿›è¡Œäº†é‡è¦åŠ å¼ºï¼ŒåŒ…æ‹¬å¼•å…¥å±€éƒ¨ä¼˜åŒ–ï¼Œworker æ‰§è¡Œä»»åŠ¡é—´åŠ¨æ€è´Ÿè½½å‡è¡¡ç­‰ç­‰ã€‚ä»é‚£æ—¶èµ·ï¼Œæˆ‘ä»¬éå¸¸æ¬£å–œå¾—çœ‹åˆ° MapReduce åœ¨è§£å†³å„ç±»é—®é¢˜ä¸Šçš„å¹¿æ³›åº”ç”¨ã€‚ç°åœ¨ï¼Œå®ƒå·² Google ç”¨äºä»¥ä¸‹å¹¿æ³›é¢†åŸŸçš„ç ”ç©¶ã€‚</p><ul><li>å¤§è§„æ¨¡æœºå™¨å­¦ä¹ é—®é¢˜</li><li>Google News å’Œ Froogle productsï¼ˆGoogle è´­ç‰©ï¼‰çš„èšç±»é—®é¢˜</li><li>æå–ç”¨äºç”Ÿæˆçƒ­é—¨æŸ¥è¯¢æŠ¥å‘Šçš„æ•°æ®ï¼ˆå¦‚ Google Zeitgeiestï¼‰</li><li>æå–ç½‘é¡µä¸Šè¿›è¡Œçš„è¯•éªŒæˆ–äº§å“æ€§èƒ½</li><li>å¤§è§„æ¨¡å›¾å½¢è®¡ç®—</li></ul><h2 id="Large-Scale-Indexing"><a href="#Large-Scale-Indexing" class="headerlink" title="Large-Scale Indexing"></a>Large-Scale Indexing</h2><p>ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬æœ€é‡è¦çš„ MapReduce åº”ç”¨ä¹‹ä¸€æ˜¯é‡å†™ä¸€ä¸ªäº§ç”Ÿè°·æ­Œæœç´¢å¼•æ“éœ€è¦çš„æ•°æ®ç»“æ„çš„å¤æ‚ç³»ç»Ÿã€‚ç´¢å¼•ç³»ç»Ÿä»¥è¢«æŠ“å–ç³»ç»Ÿæ£€ç´¢åˆ°çš„æ–‡ä»¶ï¼ˆGFS æ–‡ä»¶å½¢å¼å‚¨å­˜ï¼‰ä¸ºè¾“å…¥ï¼Œraw content å¤§å°çº¦ 20Tï¼Œç´¢å¼•è¿›ç¨‹è¿›è¡Œçº¦ 10 æ¬¡ MapReduce ç»„æˆçš„åºåˆ—æ“ä½œã€‚ç›¸è¾ƒäºå…ˆå‰ ad-hoc åˆ†å¸ƒå¼ç´¢å¼•ç³»ç»Ÿï¼Œç°åœ¨åº”ç”¨ MapReduce åï¼Œç³»ç»Ÿå…·å¤‡ä»¥ä¸‹ä¼˜ç‚¹ï¼š</p><ul><li>å› ä¸ºä¸å®¹é”™ã€åˆ†å¸ƒå¼ã€å¹¶è¡ŒåŒ–ç›¸å…³å†…å®¹éšè—åœ¨åº“é‡ï¼Œç´¢å¼•ä»£ç æ›´åŠ ç®€å•ã€ç²¾å·§ã€æ˜“äºç†è§£ã€‚æ¯”å¦‚ï¼Œè®¡ç®—çš„ä¸€ä¸ªé˜¶æ®µä»åŸæœ‰ 3800 è¡Œ C++ä»£ç å‰Šå‡è‡³ 700 è¡Œã€‚</li><li>æ¦‚å¿µä¸Šå¯ä¸è®¡ç®—åˆ†å¼€ï¼Œä»è€Œä½¿æ”¹åŠ¨å˜å¾—ç®€å•ã€‚</li><li>å†…éƒ¨å¯¹ä¸€äº›æœºå™¨æ•…éšœçš„è§£å†³ä½¿å¾—æ•´ä¸ªè¿‡ç¨‹æ›´å®¹æ˜“æˆåŠŸæ‰§è¡Œã€‚è¿›ä¸€æ­¥çš„ï¼Œä¹Ÿæ›´å®¹æ˜“å‘ç³»ç»Ÿä¸­åŠ å…¥æ–°çš„æœºå™¨ã€‚</li></ul><h2 id="Related-Work"><a href="#Related-Work" class="headerlink" title="Related Work"></a>Related Work</h2><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>ç°åœ¨ MapReduce å·²æˆåŠŸè¢« Google åº”ç”¨äºå„ç§ç›®çš„ï¼Œæˆ‘ä»¬å°†è¿™ç§æˆåŠŸå½’åŠŸäºä»¥ä¸‹åŸå› ã€‚</p><ul><li>ç”šè‡³å¯¹äºå¹¶è¡Œå’Œåˆ†å¸ƒå¼ç³»ç»Ÿç¼ºä¹ç›¸å…³ç»éªŒçš„ç¼–ç¨‹äººå‘˜ï¼Œç”±äºç›¸å…³ç»†èŠ‚éšè—åœ¨åº“ä¸­ï¼Œæ¨¡å‹ä»å…·å¤‡æ˜“ç”¨æ€§ã€‚</li><li>å¤§é‡é—®é¢˜æ˜“äºä»¥ MapReduce åœ°æ–¹å¼è§£å†³ã€‚</li><li>æˆ‘ä»¬å°†å…¶å®ç°åœ¨å¤§è§„æ¨¡é›†ç¾¤ä¸Šï¼Œå› è€Œé€‚äºå¾ˆå¤šå¤§å‹é—®é¢˜ã€‚</li></ul><p>åœ¨è¿™é¡¹å·¥ä½œä¸­æˆ‘ä»¬å­¦ä¹ åˆ°å¾ˆå¤šï¼Œ</p><ul><li>é‡æ–°å®šä¹‰ç¼–ç¨‹èŒƒå¼ä½¿å¾—å¹¶è¡Œ&#x2F;åˆ†å¸ƒå¼è¿ç®—æ˜“äºå®ç°ï¼Œä¹Ÿè·å¾—äº†ç›¸å½“çš„å®¹é”™æ€§èƒ½ã€‚</li><li>ç½‘ç»œå¸¦å®½ä½œä¸ºç¨€ç¼ºèµ„æºï¼Œä½¿å¾—æˆ‘ä»¬çš„å¾ˆå¤šä¼˜åŒ–éƒ½æ„åœ¨å‡å°‘é€šè¿‡ç½‘ç»œä¼ è¾“çš„æ•°æ®ã€‚</li><li>å†—ä½™çš„ä»»åŠ¡æ‰§è¡Œï¼ˆbackup tasksï¼‰å¯ä»¥ç”¨äºå‡å°‘ç¼“æ…¢æœºå™¨çš„å½±å“ï¼Œä»¥åŠè§£å†³æœºå™¨æ•…éšœå’Œæ•°æ®ä¸¢å¤±ã€‚</li></ul>]]></content>
    
    
    <categories>
      
      <category>Paper</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>hexoå¤šç«¯åŒæ­¥</title>
    <link href="/2022/03/26/git/hexo%E5%A4%9A%E7%AB%AF%E5%90%8C%E6%AD%A5/"/>
    <url>/2022/03/26/git/hexo%E5%A4%9A%E7%AB%AF%E5%90%8C%E6%AD%A5/</url>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦"><a href="#æ‘˜è¦" class="headerlink" title="æ‘˜è¦"></a>æ‘˜è¦</h2><p>è¿™æ˜¯ä¸€ç¯‡å…³äºHexoåšå®¢æ¡†æ¶å¦‚ä½•åœ¨gitä¸­å¤šç«¯åŒæ­¥çš„å­¦ä¹ è®°å½•</p><h2 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h2><h3 id="æ–‡ä»¶åŒæ­¥"><a href="#æ–‡ä»¶åŒæ­¥" class="headerlink" title="æ–‡ä»¶åŒæ­¥"></a>æ–‡ä»¶åŒæ­¥</h3><figure class="highlight bash"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><pre><code class="hljs bash">git init  //åˆå§‹åŒ–æœ¬åœ°ä»“åº“<br>git remote add origin git@github.com:yourname/yourname.github.io.git  //å°†æœ¬åœ°ä¸Githubé¡¹ç›®å¯¹æ¥<br>git checkout -b hexo  //æ–°å»ºå¹¶åˆ‡æ¢åˆ°hexoåˆ†æ”¯ä¸Š<br>git add . //å°†å¿…è¦çš„æ–‡ä»¶ä¾æ¬¡æ·»åŠ <br>git commit -m <span class="hljs-string">&quot;Blog Source Hexo&quot;</span><br>git push origin hexo  //pushåˆ°Githubé¡¹ç›®çš„hexoåˆ†æ”¯ä¸Š<br></code></pre></td></tr></table></figure><h3 id="å›¾ç‰‡åŒæ­¥"><a href="#å›¾ç‰‡åŒæ­¥" class="headerlink" title="å›¾ç‰‡åŒæ­¥"></a>å›¾ç‰‡åŒæ­¥</h3><p>å½“æˆ‘æƒ³è¦åœ¨åšå®¢ä¸Typoraè½¯ä»¶ä¸­éƒ½æƒ³è¦çœ‹åˆ°æ–‡ç« å†…å¼•ç”¨çš„æœ¬åœ°å›¾ç‰‡æ—¶ï¼Œå‘ç”Ÿäº†æ¸²æŸ“é”™è¯¯ã€‚åšå®¢çš„æœåŠ¡å™¨ç«¯ä¸æ”¯æŒTyporaçš„æœ¬åœ°è·¯å¾„å¼•ç”¨æ–¹å¼ã€‚</p><p>ä¸ºæ­¤æˆ‘æŸ¥çœ‹äº†ä¸€ä¸‹Hexoçš„æ–‡æ¡£ï¼Œå‘ç°å®˜æ–¹é»˜è®¤æŒ‡å®šäº†å›¾ç‰‡å­˜æ”¾è·¯å¾„ <code>source/image</code> ä¸‹ã€‚</p><p>æ—¢ç„¶å®˜æ–¹è¦æ±‚äº†ï¼Œé‚£æˆ‘ä¾¿åªå¥½æ›´æ”¹Typoraæ’å…¥å›¾ç‰‡æ—¶çš„ç›¸å…³è§„åˆ™</p><ol><li><p>Typora -&gt; åå¥½è®¾ç½® -&gt; å›¾åƒ -&gt; æ’å…¥å›¾ç‰‡æ—¶ (å¤åˆ¶åˆ°æŒ‡å®šè·¯å¾„) <code>~/hexo/blog/source/image/$&#123;filename&#125;</code> å¹¶å‹¾é€‰ä¸‹æ–¹çš„æ‰€æœ‰å­é¡¹</p></li><li><p>æ ¼å¼ -&gt; å›¾åƒ -&gt; è®¾ç½®å›¾ç‰‡æ ¹ç›®å½• -&gt; é€‰ä¸­ <code>~/hexo/blog/source</code> è·¯å¾„ï¼Œè¿™ä¸€æ­¥æ˜¯ä¿è¯äº†åšå®¢ä¸Typoraéƒ½èƒ½é¢„è§ˆåˆ°å›¾ç‰‡å†…å®¹</p><p>è¿™ä¸€æ­¥ç­‰åŒäºåœ¨æ–‡ç« å¤´éƒ¨æ·»åŠ  <code>typora-root-url: ../../</code> é…ç½®é¡¹ï¼Œæ³¨æ„è¦é€‰åˆ°blogæ–‡ä»¶å¤¹ä¸­</p></li></ol><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>å­¦ä¹ æ—¶åœ¨æœ€ç»ˆçš„ <code>git push origin hero</code>å‘½ä»¤ä¸­é‡åˆ°äº† <font color='red'>Permission denied</font> ç›¸å…³é—®é¢˜ï¼Œå‘ç°éœ€è¦ç”Ÿæˆæ–°çš„ssh keyï¼Œæ¥æ·»åŠ ç»™gitã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh-keygen -t rsa -C <span class="hljs-string">&#x27;githubæ³¨å†Œæ—¶çš„é‚®ç®±&#x27;</span><br><span class="hljs-comment"># ä¸€è·¯å›è½¦ï¼Œæœ€åä¼šåœ¨ï½/.sshç›®å½•ä¸­ç”Ÿæˆå¯†é’¥æ–‡ä»¶</span><br><span class="hljs-comment"># å°†id_rsa.pubå…¬é’¥æ·»åŠ åˆ°gitä¸­</span><br><span class="hljs-comment"># å†æ‰§è¡Œ git push origin hexo å³å¯</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
