---
title: 负载均衡策略
date: 2022-03-28 15:43:12
excerpt: 在分布式调用过程中，负载均衡是我们绕不开的性能优化手段
categories: Distributed System
tags: 
typora-root-url: ../../
---

## 随机调用

- 顾名思义，就是全随机的，无法控制。

## 顺序轮询

- 获取到服务消费者列表后，按照顺序循环调用。

## 随机权重

- 可以对 provider 不同实例设置不同的权重，会按照权重来负载均衡，权重越大分配流量越高。
- 算法思想很简单。假设有一组服务器 servers = [A, B, C]，他们对应的权重为 weights = [5, 3, 2]，权重总和为 10。现在把这些权重值平铺在一维坐标值上，[0, 5) 区间属于服务器 A，[5, 8) 区间属于服务器 B，[8, 10) 区间属于服务器 C。接下来通过随机数生成器生成一个范围在 [0, 10) 之间的随机数，然后计算这个随机数会落到哪个区间上。比如数字 3 会落到服务器 A 对应的区间上，此时返回服务器 A 即可。权重越大的机器，在坐标轴上对应的区间范围就越大，因此随机数生成器生成的数字就会有更大的概率落到此区间内。只要随机数生成器产生的随机数分布性很好，在经过多次选择后，每个服务器被选中的次数比例接近其权重比例。比如，经过一万次选择后，服务器 A 被选中的次数大约为 5000 次，服务器 B 被选中的次数约为 3000 次，服务器 C 被选中的次数约为 2000 次。

## 轮询权重(加权轮询)

- 生成一个服务器序列，该序列中包含n个服务器。n是所有服务器的权重之和。在该序列中，每个服务器的出现的次数，等于其权重值。并且，生成的序列中，服务器的分布应该尽可能的均匀。比如序列{a, a, a, a, a, b, c}中，前五个请求都会分配给服务器a，这就是一种不均匀的分配方法，更好的序列应该是：{a, a, b, a, c, a, a}。

## 平滑加权轮询

![img](/image/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5/iShot2021-09-03%2011.19.39.png)

- 以A举例，初始化为5
- 1. 当前权重默认值为每个服务器的权重值，每次请求获取最大的一个。
- 1. 服务器请求结束后，将选择的服务器的权重改为权重=当前权重-总权重和。5-5-1-1=-2
- 1. 在每次请求前，将他们的默认权重值加进当前权重值中。-2+5=3

## 最小活跃数

- 每个服务提供者会对应着一个活跃数 active。初始情况下，所有服务提供者的 active 均为 0。每当收到一个请求，对应的服务提供者的 active 会加 1，处理完请求后，active 会减 1。所以，如果服务提供者性能较好，处理请求的效率就越高，那么 active 也会下降的越快。因此可以给这样的服务提供者优先分配请求。
- 当然，除了最小活跃数，`LeastActiveLoadBalance` 在实现上还引入了权重值。所以准确的来说，`LeastActiveLoadBalance` 是基于加权最小活跃数算法实现的。

## 一致性HASH算法

- 一致性 Hash 算法，相同参数的请求一定分发到一个 provider 上去，provider 挂掉的时候，会基于虚拟节点均匀分配剩余的流量，抖动不会太大。如果你需要的不是随机负载均衡，是要一类请求都到一个节点，那就走这个一致性 Hash 策略。